---
webr: 
  show-startup-message: true
  packages: [
            'dplyr',
            'ggplot2',
            'purrr',
            'fixest',
            'tidyr',
            'readr'
            ]
---

```{=html}
<style>
.qwebr-code-output-stdout {background-color: powderblue;}

.qwebr-button-run, .qwebr-button-reset, .qwebr-button-copy {
  background-color:  rgba(0, 0, 0, 0);
  border-style: none;
  font-weight: 400;
  color: white; 
  transition: none;
}

.qwebr-editor-toolbar {
  width: 100%;
  display: flex;
  justify-content: space-between;
  box-sizing: border-box;
  border-radius: 0 0 6px 6px;
  background-color: darkgreen;
  border-color: darkgreen;
  border-width: 1px;
  border-style: solid;
  padding: 0 0; 
  transition: color .1s ease-in-out, background-color .1s ease-in-out,border-color .1s ease-in-out,box-shadow .1s ease-in-out;
}

.qwebr-editor-toolbar:hover {
  background-color: white;
  border-color: darkgreen;
  border-width: 1px;
}

.qwebr-editor-toolbar:hover * {
  color: darkgreen;
}

.overflow-guard, .qwebr-editor, .monaco-editor {
  border-radius: 6px 6px 0 0;
  border-width: 1px 1px 0 1px;
  border-color: darkgreen;
}

</style>
```

# Difference-in-Differences

```{r, echo=F,message=F,warning=F}
# Formatierung von gt-Tabellen
library(gt)
tabopts <- function(x) {
    fmt_number(x, decimals = 3, drop_trailing_zeros = T) %>%
    tab_options(table_body.hlines.color = "white",
              column_labels.border.bottom.color = "black", 
             column_labels.border.top.color = "black",
             table_body.border.bottom.color = "black", 
             table.border.bottom.color = "black",
             column_labels.font.weight = "bold", 
             table.font.color = "black", 
             table.font.size = 16)
}

library(tidyverse)
# load the brexit data
download.file(
    "https://raw.githubusercontent.com/mca91/kausal_data/main/brexit.csv",
    'datasets/brexit.csv',
)
brexit <- read_csv("datasets/brexit.csv") %>% as.data.frame

# load the Synth package
library(Synth)
options(pillar.sigfig = 2)
```


Der Difference-in-Differences (DID) Ansatz erlaubt die Schätzung kausaler Effekte in quasi-experimentellen Forschungsdesigns, in denen Boebachtungen für Kontroll- und Behandlungsgruppe zu mindestens zwei Zeitpunkten vorliegen und die Behandlung zwischen diesen Zeitpunkten stattfindet: Wir beobachten sowohl die Kontroll- als auch die Behandlungsgruppe vor und nachdem die Behandlung erfolgt ist. Die Motivation für die Anwendung des DID-Ansatzes liegt in der Fähigkeit, typische Risiken einer Verzerrungen zu umgehen, die bei einfachen Vorher-Nachher-Vergleichen oder reinen Querschnittsvergleichen auftreten können. Die Kernidee ist eine Schätzung des ATT durch einen Vergleich durchschnittlicher Differenzen der Outcome-Variable beider Gruppen zwischen den Perdioden vor und nach der Intervention. @fig-CDDID zeigt ein kausales Diagramm für ein Forschungsdesign, in dem DID den ATT identifizieren kann.

```{dot}
//| fig-width: 5
//| fig-height: 3
//| fig-align: 'center'
//| fig-cap: "Kausales Diagramm für DID"
//| label: "fig-CDDID" 
digraph "Causal Diagramm RDD" {
  layout=neato
  fontname="Helvetica,Arial,sans-serif"
  node [fontname="Helvetica,Arial,sans-serif"]
  edge [fontname="Helvetica,Arial,sans-serif"]
  node [shape=none];
  "Behandlung B" [pos="0,0!"]
  "Outcome Y" [pos="4,0!"]
  "Gruppenzugehörigkeit" [pos="2,-1.5!"]
  "Zeit t" [pos="2,1.5!"]
  "Behandlung B" -> "Outcome Y" [color="green"]
  "Zeit t" -> "Outcome Y" [color="purple"]
  "Zeit t" -> "Behandlung B" [color="purple"]
  "Gruppenzugehörigkeit" -> "Outcome Y" [color="purple"]
  "Gruppenzugehörigkeit" -> "Behandlung B" [color="purple"]
}
```

 @fig-CDDID illustriert Confounding bei der Bestimmung des Behandlungseffekts durch Backdoors in der Zeit $t$ und der Gruppenzugehörigkeit: 
 
- **Zeit**: Der Behandlungszustand der behandelten Gruppe ändert sich durch die Intervention zwischen der Vor- und der Nachbehandlungsperiode. Die Outcome-Variable $Y$ ändert sich für beide Gruppen über die Zeit hinweg.
 
 - **Gruppenzugehörigkeit**: Die Gruppenzugehörigkeit legt fest, ob eine Behandlung erfolgt. Systematische Unterschiede zwischen Behandlungs- und Kontrollgruppe wirken sich auf die Outcome-Variable $Y$ aus.

In einem DID-Ansatz ermöglicht die Beobachtung von Kontroll- und Behandlungsgruppen vor und nach einer Intervention das herausrechnen systematischer Unterschiede zwischen Behandlungs- und Kontrollgruppe und von Zeiteffekten, sodass die Backdoors durch Gruppenzugehörigkeit und Zeit geschlossen. Die Schätzung eines durchschnittlichen Behandlungseffekts erfolgt hierbei unter der Annahme, dass die Outcome-Variable beider Gruppen *ohne die Intervention* einen hinreichend ähnlichen Verlauf aufweisen würde.

## Einordnung im Potential Outcomes Framework

Im Potential Outcomes Framework nehmen wir an, dass jede Einheit $i$ in Abhänigkeit ihres Behandlungsstatus zwei potentielle Ergebnisse hat. Wir unterscheiden zwischen Beobachtungen in Behandlungs- und Kontrollgruppe:

- $Y_{i,B}(1)$: $Y$ für Einheit $i$ in der Behandlungsgruppe, wenn diese behandelt wird.
- $Y_{i,B}(0)$: $Y$ für Einheit $i$ in der Behandlungsgruppe, wenn diese *nicht* behandelt wird.
- $Y_{i,K}(1)$: $Y$ für Einheit $i$ in der Kontrollgruppe, wenn diese behandelt wird.
- $Y_{i,K}(0)$: $Y$ für Einheit $i$ in der Kontrollgruppe, wenn diese *nicht* behandelt wird.

In einem DID-Forschungsdesign hängen tatsächliche und potentielle Outcomes von der Zeit $t$ ab: Die Behandlungsgruppe wird zwischen den Zeitpunkten $t = 0$ und $t = 1$ behandelt, während die Kontrollgruppe unbehandelt bleibt. Für die Identifizierung des Behandlungseffekts wird unterstellt, dass $Y$ sich zwischen $t=0$ und $t=1$ in der Behandlungsgruppe *ohne eine Behandlung* (im Erwartungswert) mit demselben Trend entwickelt hätte, mit dem sich die Kontrollgruppe tatsächlich entwickelt hat (parallele Trends). Die Gültigkeit paralleler Trends ist entscheidend für die Validität der DID-Methode, da so sicherstellt ist, dass die beobachteten Unterschiede in den Ergebnissen auf die Behandlung zurückzuführen sind und nicht auf andere zeitgleich auftretende Faktoren. Der Behandlungseffekt kann dann als eine *Differenz von Differenzen* geschrieben werden: 

\begin{align}
  \begin{split}
    \beta_\textup{DID} =& \, \bigg({\color{red}\textup{E}\big[Y_B(1)\vert t=1\big] - \textup{E}\big[Y_B(0)\vert t=0\big]} \bigg)\\
  -&\, \bigg({\color{blue}\textup{E}\big[Y_K(0)\vert t=1\big] -  \textup{E}\big[Y_K(0)\vert t=0\big]} \bigg)
  \end{split}\label{eq:DID-ATT1}
\end{align}

Der Effekt $\beta_\textup{DID}$ ist ein ATT, der über das Schließen der Backdoor in der Zeit (rote und blaue Differenzen der Erwartungswerte zwischen $t=0$ und $t=1$) sowie der Backdoor in der Gruppenzugehörigkeit (Differenz der Erwartungswert-Differenzen) identifiziert wird.

Eine Null-Ergänzung von \eqref{eq:DID-ATT1} mit ${\color{blue}\textup{E}\big[Y_K(0)\vert t=1\big] -  \textup{E}\big[Y_K(0)\vert t=1\big]}$ zeigt die Wichtigkeit der Gültigkeit paralleler Trends:

\begin{align*}
    \beta_\textup{DID} =& \, \bigg({\color{red}\textup{E}\big[Y_B(1)\vert t=1\big] - \textup{E}\big[Y_B(0)\vert t=0\big]} \bigg)
  - \bigg({\color{blue}\textup{E}\big[Y_K(0)\vert t=1\big] -  \textup{E}\big[Y_K(0)\vert t=0\big]} \bigg)\\ + &\,
{\color{blue}\textup{E}\big[Y_K(0)\vert t=1\big] -  \textup{E}\big[Y_K(0)\vert t=1\big]}\\
    \\
    =&\, \underbrace{{\color{red}\textup{E}\big[Y_B(1)\vert t=1\big]} - {\color{blue}\textup{E}\big[Y_B(1)\vert t=1\big]}}_{=\textup{ATT}}\\
    +&\, \underbrace{\bigg({\color{red}\textup{E}\big[Y_B(0)\vert t=1\big] - \textup{E}\big[Y_B(0)\vert t=0\big]} \bigg) - \bigg({\color{blue}\textup{E}\big[Y_K(0)\vert t=1\big] -  \textup{E}\big[Y_K(0)\vert t=0\big]} \bigg)}_{ = \textup{Verzerrung durch nicht-parallele Trends}}
\end{align*}

Diese Zerlegung zeigt, dass der ATT nur bei parallelen Trends identifziert werden kann, d.h. wir benötigen

\begin{align*}
{\color{red}\textup{E}\big[Y_B(0)\vert t=1\big] - \textup{E}\big[Y_B(0)\vert t=0\big]} = {\color{blue}\textup{E}\big[Y_K(0)\vert t=1\big] -  \textup{E}\big[Y_K(0)\vert t=0\big]}.
\end{align*}

Beachte, dass ${\color{red}\textup{E}\big[Y_B(0)\vert t=1\big]}$ der Erwartungswert des potentiellen Outcomes einer unbehandelten Behandlungsgruppe in $t=1$ ist. Somit kann die Verzerrung durch nicht-parallele Trends nicht empirisch überprüft werden und muss ausschließlich durch das Forschungsdesign gewährleistet sein. In Anwendungen kann die Plausibilität der Annahme graphisch anhand geschätzter Trends in der Outcome-Variable oder durch Placebo-Tests untersucht werden.

**Annahmen für DID**

1. **Parallele Trends**: Die Trends in der Outcome Variable $Y$ in Behandlungs- und Kontrollgruppe würden bis einschließlich $t=1$ parallel verlaufen, wenn es keine Behandlung gäbe. Diese Annahme ist Voraussetzung dafür, dass Veränderungen im Outcome $Y$ für die Behandlungsgruppe, die sich von $Y$ für die Kontrollgruppe unterscheidet, auschließlich dem Effekt der Behandlung zugeschrieben werden kann.

2. **Keine Interferenz zwischen Gruppen (SUTVA)**: Die Behandlung einer Gruppe sollte keinen Einfluss auf die andere Gruppe haben.

3. **Konsistete Behandlungseffekte**: Der Effekt der Intervention ist konstant über Individuen und Zeit hinweg.

## Schätzung des ATT mit DID

Für die Schätzung von $\beta_\text{DID}$ ersetzen wir die Erwartungswerte in \eqref{eq:DID-ATT1} durch ihre Stichprobenmomente:

\begin{align}
  \widehat{\beta}_\textup{DID} = \bigg({\color{red}\overline{Y_B(1)\vert t=1} - \overline{Y_B(0)\vert t=0}} \bigg) -  \bigg({\color{blue}\overline{Y_K(0)\vert t=1} - \overline{Y_K(0)\vert t=0}}\bigg) \label{eq:DIDMOMENTS}
\end{align}

Die nachfolgende interaktive Grafik illustriert die Schätzung des ATT mit DID für simulierte Daten. 

**Interaktive Elemente der Visualisierung**

- Die Beobachtungen der Individuen zu 6 verschiedenen Zeitpunkten werden als Punkte dargestellt. Die Datenpunkte könn mit *Zeige Daten* ein- und ausgeblendet werden.

- Die geschätzten Trends beider Gruppen für den gesamten Beobachtungszeitraum und die Gruppenzugehörigkeit können mit *Zeige Trends* ein- und ausgeblendet werden. Die Auswahl *Parallele Trends* stellt sicher, dass beide Gruppen (mit Ausnahme des Behandlungseffekts in der Behandlungsgruppe) dem selben zeitlichen Trend folgen. Bei nicht-parallelen Trends folgt die Behandlungsgruppe einem positiven Trend mit größerer positiver Steigung als in der Kontrollgruppe.

- Die Behandlung erfolgt zwischen der mit dem Slider *Zeitpunkt* ausgewählten und der darauf folgenden Periode. Der tatsächliche Behandlungseffekt kann über den Slider *Effekt* festgelegt werden.


**Anatomie der Schätzung des ATT bei *parallelen* Trends**

- Wir illustrieren die Schätzen des ATT mit Formel \eqref{eq:DIDMOMENTS}. Kreise zeigen Mittelwerte für Kontroll- und Behandlungsgruppe *vor* der Intervention. Dreiecke zeigen Mittelwerte *nach* der Intervention.

- Die gestrichelte rote Linie zeigt den (kontrafaktischen) Verlauf der Behandlungsgruppe *ohne* Behandlung. Hierbei wird unterstellt, dass sich die Behandlungsgruppe mit demselben Trend *wie die Kontrollgruppe entwickelt hätte* (blaue Linie).

- Der geschätzte Behandlungseffekt wird als orangene vertikale Linie dargestellt. Dies ist die Differenz zwischen dem tatsächlichen post-Behandlungs-Mittelwert und dem kontrafaktischen Mittelwert der Behandlungsgruppe.

**Anatomie der Schätzung des ATT bei *nicht-parallelen* Trends**

- Für nicht-parallele Trends zeigt die Grafik den unterstellten kontrafaktischen Trend der Behandlungsgruppe als gestrichelte blaue linie. Der" "tatsächliche" kontrafaktische Verlauf der Behandlungsgruppe wird als gestrichelte rote Linie dargestellt.

- Aufgrund des steileren (positiven) Trends in der Behandlungsgruppe ergibt sich eine *positive* Verzerrung von $\color{orange}\widehat{\beta}_\text{DID}$. Diese Verzerrung wird durch die gestrichelte vertikale schwarze Linie kenntlich gemacht. 

  - Für *positive* Behandlungseffekte wird der ATT *überschätzt*: die Verzerrung entspricht der Überlagerung der gestrichelten schwarzen linie mit der orangenen Linie des geschätzten Effekts. 
  
  - Für *negative* Behandlungseffekte wird der ATT unterschätzt: die Verzerrung entspricht der gestrichelten schwarzen linie oberhalb der orangenen Linie des geschätzten Effekts.

<iframe width="100%" height="813" frameborder="0"
  src="https://observablehq.com/embed/@mca91/did?cells=didformula%2Cchart%2Cviewof+ptrends%2Cviewof+showTrends%2Cviewof+showData%2Cviewof+treatPeriod%2Cviewof+effect"></iframe>

Die Implementierung von DID-Schätzern erfolgt meist anhand linearer Regression. Das Modell für zwei Zeitperioden ist

\begin{align}
  Y_{i,\,t} = \alpha + \beta_1 B_i + \beta_2 Z_t + \beta_3 (B_i \times Z_t) + \epsilon_{i,\,t}, \quad t\in\{0,1\}, \label{eq:DIDREG}
\end{align}

wobei $\beta_3$ der interessierende Behandlungseffekt ist. Der Regressor $B_i \times Z_t$ ergibt sich als die Interaktion zwischen der Behandlungsgruppenzugehörigkeit $B_i$ und einem Indikator für den Zeitpunkt *nach* der Intervention, $Z_i = \mathbb{I}_{\{t=1\}}$. Es ist $\widehat\beta_3 = \widehat{\beta}_\text{DID}$, d.h. der KQ-Schätzer von $\beta_3$ ist der DID-Schätzer des ATT und numerisch äquivalent zu \eqref{eq:DIDMOMENTS}.

Die Berechnung von $\widehat\beta_\text{DID}$ anhand von Modell \eqref{eq:DIDREG} ist praktisch, da wir so Inferenzstatistiken mit etablierten R-Funktionen wie gewohnt berechnen können.

::: callout-note
#### Key Facts zum einfachen DID-Schätzer

- DID benötigt Beobachtungen einer Behandlungs- und einer Kontrollgruppe zu mindestens zwei verschiedenen Zeitpunkten.  

- Im DID-Forschungsdesign kann der ATT durch einen Vergleich von Differenzen in den Ergebnissen vor und nach einer Behandlung zwischen Behandlungs- und Kontrollgruppen identifiziert werden. 

- DID ist empfindlich gegenüber Verletzungen der Annahme, dass die zeitlichen Trends in den Ergebnissen für beide Gruppen vor der Intervention parallel verlaufen.

- Der DID-Schätzer kann in einem Regressionsmodell mit Interaktionsterm zwischen Zeit- und Gruppenvariablen implementiert werden.

:::

## Beispiel: Effekt von Steuererleichterungen auf weibliche Beschäftigungsquote 

Der Earned Income Tax Credit (EITC) ist ein Steuerguthaben für US-Amerkanische Familien die unterhalb einer gesetztlich festgelegten Einkoemmnsgrenze liegen. Der genaue Betrag des EITC hängt gestaffelt vom Einkommen ab und, ähnlich zum Kindergeld in Deutschland, steigt mit der Anzahl der zu versorgenden Kinder. Ein wichtiger Unterschied zum Kindergeld ist, dass der EITC nicht beantragt werden muss: Qualifizierten Familien wird der Betrag automatisch durch die Behörden im Steuerausgleich gutgeschrieben. Somit kann Selbstselektion in die Behandlungsgruppe ausgeschlossen werden, da sich die Behandlung ausschließlich durch die im Rahmen der EITC-Ausweitung geänderten Anspruchsgrundlagen ergibt.

@EissaLiebman1996 betrachten Veränderungen in der EITC-Gesetzgebung als Intervention, deren Auswirkungen mit sozio-ökonimischen Paneldaten in einem DID-Ansatz untersucht werden können. Die Studie analysiert die Auswirkungen der ersten Ausweitung des EITC im Jahr 1986 auf die Beschäftigung und Löhne von Frauen. Diese Erweiterung erhöhte die gewährten Steuererleichterungen und die für eine Qualifikation für das Programm zu unterschreitende Einkommensgrenze. 

Ein zentraler Befund der Studie ist, dass die EITC-Ausweitung von 1986 einen statistisch signifikanten Anstieg der Arbeitsbeteiligung alleinerziehender Frauen von geschätzten 3\% bewirkt hat. Weiterhin gab es signifikante positive Effekte auf die geleisteten Arbeitsstunden und Nachweise für Einkommensverbesserungen in dieser Gruppe. Diese Ergebnisse sind starke Evidenz, dass Maßnahmen wie der EITC effektiv dazu beitragen können, die Erwerbssituation in der Zielgruppe zu steigern und somit die wirtsschafts- und sozialpolitische Ziele derartiger Programme realisierbar sind.

Im Jahr 1993 wurde das Programm erneut ausgweitet: Vor 1993 gab es lediglich eine Einkommensstufe für Familien mit Kindern. 1993 wurde eine zusätzliche Stufe für Familien mit zwei oder mehr Kindern eigeführt, die damit einen höheren maximalen Kreditbetrag erhalten konnten als Familien mit nur einem Kind. Dies führte zu einer größeren finanziellen Unterstützung einkommensschwacher Familien.

@Adireksombat2010 untersucht die Effekte der zweiten EITC-Ausweitung ebenfalls mit einem DID Ansatz und findet Evidenz für einen Anstieg der Arbeitbeteiligung von etwa 5\% in der Zielgruppe alleinerziehender Frauen mit mindestens 2 Kindern.

Zur Illustration der empirischen Anwendung von DID mit R untersuchen wir Effekte der EITC-Ausweitung von 1993 nachfolgend anhand eines ähnlichen Datensatzes wie in der Studie von @Adireksombat2010. Diese Daten sind im Datensatz XYZ verfügbar und erfassen jährliche sozio-ökonomische Merkmale für Familien im Zeitraum von 1991 bis 1996.


```{r}
eitc_data <- read_csv("datasets/eitc_data.csv")
```

Eine Zusammenfassung des Datensatzes ist in Tabelle XYZ dargestellt.

```{r}
# Kategorische Variable für Anz. Kinder hinzufügen
eitc_data <- eitc_data %>%
  mutate(
    nchildren = case_when(
      children == 0 ~ "0",
      children == 1 ~ "1",
      children >= 2 ~ "2+"
    )
  )
```



## Terrorism

```{r}
polizeipraesenz <- read_csv("datasets/polizeipraesenz.csv")
```

```{r}
# Table 2
dat_listcol <- polizeipraesenz %>% 
  group_by(observ, monat) %>%
  mutate(totrob = sum(totrob)) %>%
  transmute(
    d2more = list(totrob[distanz > 2]),
    d2 = list(totrob[distanz == 2]),
    d1 = list(totrob[distanz == 1]),
    same = list(totrob[institut == 1])
    ) 
```




# means and SDs
dat_listcol %>%
  group_by(monat) %>%
  summarise(
    across(d2more:same,
           list(mean = ~ mean(unlist(.)), sd = ~ sd(unlist(.)))
    ),
  )

the_diffs <- dat_listcol %>%
  group_by(monat) %>%
  summarise(
    diff1 = list( t.test(x = unlist(same), y = unlist(d2more)) ),
    diff2 = list( t.test(x = unlist(d1), y = unlist(same)) ),
    diff3 = list( t.test(x = unlist(d2), y = unlist(d2more)) ), 
    .groups = "keep"
  ) %>%
  transmute(
    across(diff1:diff3, 
           list(
             m = ~ map_dbl(., \(x) diff(x$estimate)), 
             sd = ~ map_dbl(., \(x) x$stderr)
           )
    )
  )
  

form <- the_diffs %>%
  transmute(across(contains("_m"), ~sprintf("%.4f (%.4f)", ., get(sub(".m$", "_sd", cur_column()))), .names = "{.col}_formatted"))

form %>% gt::gt()

# Table 3
library(AER)



# (A)
dat_DID <- dat %>%
  mutate(
    treated = institut == 1,
    group = monat > "Juli (1 - 17)",
    oneblock = distanz == 1,
    twoblocks = distanz == 2
  ) %>% 
  filter(monat != "Juli (18 - 31)")

# fixest
feols(fml = totrob ~ I(treated * group) | observ + monat, data = dat_DID, vcov = "HC1")

# plm
pdata <- pdata.frame(dat_DID, index = c("observ", "monat"))

model <- plm(formula = totrob ~ I(treated * group) , data = pdata, model = "within", effect = "twoway")
summary(model, vcov = vcovHC(model, method = "white1"))


# (B)
# fixest
feols(fml = totrob ~ I(treated * group) + I(oneblock * group) | observ + monat, data = dat_DID, vcov = "HC1")

# plm
model <- plm(formula = totrob ~ (treated + oneblock) * group, data = pdata, model = "within", effect = "twoway")
summary(model, vcov = vcovHC(model, method = "white1"))

# (C)
# fixest
feols(fml = totrob ~ I(treated * group) + I(oneblock * group) + I(twoblocks * group) | observ + monat, data = dat_DID, vcov = "HC1")

model <- plm(formula = totrob ~ (treated + oneblock + twoblocks) * group, data = pdata, model = "within", effect = "twoway")
summary(model, vcov = vcovHC(model, method = "white1"))

# (D)
pdata <- pdata.frame(dat_DID %>% filter(monat >= "August"), index = c("observ", "monat"))
model <- plm(formula = totrob ~ (treated + oneblock + twoblocks) * group, data = pdata, model = "within", effect = "time")
summary(model, vcov = vcovHC(model, method = "white1"))

# (E)
# (doesnt match for some reason)
# fixest
feols(fml = totrob ~ I(treated * group) + I(oneblock * group) + I(twoblocks * group), 
      data = dat_DID %>% filter(distanz <= 2), 
      vcov = "HC1")

pdata <- pdata.frame(dat_DID %>% filter(distanz <= 2), index = c("observ", "monat"))
model <- plm(formula = totrob ~ (treated + oneblock + twoblocks) : group, data = pdata, model = "within", effect = "individual")
summary(model, vcov = vcovHC(model, method = "white1"))


#### Table 4 ####

# (A)
dat_DID <- dat %>%
  mutate(
    treated = institut == 1,
    group = dplyr::between(mes, 5, 7),
    oneblock = distanz == 1,
    twoblocks = distanz == 2
  ) %>% 
  filter(mes <= 7)

# fixest
mod4_A <- feols(
  fml = totrob ~ 
    I(treated * group) 
  + I(oneblock * group) 
  + I(twoblocks * group) 
  | observ + monat, 
  data = dat_DID, 
  vcov = "HC1"
)

# (B)
dat_DID <- dat_DID %>%
  mutate(
    group = dplyr::between(mes, 6, 7)
  ) 

# fixest
mod4_B <- feols(
  fml = totrob ~ 
    I(treated * group) 
  + I(oneblock * group) 
  + I(twoblocks * group) 
  | observ + monat, 
  data = dat_DID, 
  vcov = "HC1"
)

# (C)
dat_DID <- dat_DID %>%
  mutate(
    group = mes == 7,
  )

# fixest
mod4_C <- feols(
  fml = totrob ~ 
    I(treated * group) 
  + I(oneblock * group) 
  + I(twoblocks * group) 
  | observ + monat, 
  data = dat_DID, 
  vcov = "HC1"
)


modelsummary(
  models = list(
    A = mod4_A,
    B = mod4_B,
    C = mod4_C
  ), 
  stars = T,
  gof_omit   = "^(?!(R2|Num.Obs.)$).*"
)

#### Table 5 ####

dat_DID_T5 <- dat_DID %>%
  mutate(
    mbc = paste0(barrio, "_", monat)
  )

# (A)
# fixest
feols(
  fml = totrob ~ 
    I(treated * group) 
  + I(oneblock * group) 
  + I(twoblocks * group) 
  | observ + monat,
  data = dat_DID_T5,
  vcov = "HC1"
)

# (B)
# fixest
feols(fml = totrob ~ 
    I(treated * group) 
  + I(oneblock * group) 
  + I(twoblocks * group) 
  | observ + monat,
  data = dat_DID_T5, 
  vcov = vcov_cluster("observ")
)

# (C)
# fixest
feols(fml = totrob ~ 
        I(treated * group) 
      + I(oneblock * group) 
      + I(twoblocks * group) 
      | observ + monat,
      data = dat_DID_T5, 
      vcov = vcov_cluster("mbc")
)

# (E)
# fixest
feols(fml = totrob ~ 
        I(treated * group) 
      + I(oneblock * group) 
      + I(twoblocks * group) 
      | observ + mbc,
      data = dat_DID_T5,
      vcov = "HC1"
)

# (F)
# fixest
feols(fml = totrob ~ 
        I(treated * group) 
      + I(oneblock * group) 
      + I(twoblocks * group) 
      | observ + monat,
      data = dat_DID_T5 %>% 
        group_by(observ) %>% 
        filter(
          sum(totrob) > 0
        ),
      vcov = "HC1"
)

## Zusammenfassung

Der DID-Schätzer liefert uns eine Schätzung des ATT, indem er die Veränderung der Ergebnisse in der Behandlungsgruppe vor und nach der Intervention mit der entsprechenden Veränderung in der Kontrollgruppe vergleicht. Die Annahme paralleler Trends ist entscheidend: Nur wenn diese Annahme gilt, können wir sicher sein, dass die Differenz in den Differenzen tatsächlich den kausalen Effekt der Behandlung widerspiegelt und nicht durch andere zeitgleiche Faktoren beeinflusst wird.

Zusammenfassend bietet der DID-Ansatz im Potential Outcomes Framework eine robuste Methode zur Schätzung kausaler Effekte, insbesondere wenn randomisierte Experimente nicht durchführbar sind. Durch den Vergleich von Zeitverläufen in Behandlungs- und Kontrollgruppen unter der Annahme paralleler Trends können wir verlässliche Schätzungen des ATT gewinnen.

