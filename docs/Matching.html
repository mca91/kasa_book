<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="de" xml:lang="de"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Kausalanalyse und Machinelles Lernen mit R - 3&nbsp; Matching</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./RDD.html" rel="next">
<link href="./R_Einfuehrung.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Keine Treffer",
    "search-matching-documents-text": "Treffer",
    "search-copy-link-title": "Link in die Suche kopieren",
    "search-hide-matches-text": "Zus√§tzliche Treffer verbergen",
    "search-more-match-text": "weitere Treffer in diesem Dokument",
    "search-more-matches-text": "weitere Treffer in diesem Dokument",
    "search-clear-button-title": "Zur√ºcksetzen",
    "search-detached-cancel-button-title": "Abbrechen",
    "search-submit-button-title": "Abschicken",
    "search-label": "Suchen"
  }
}</script><meta name="robots" content="noindex">
<script>
  MathJax = {
    tex: {
      tags: 'ams'  // should be 'ams', 'none', or 'all'
    }
  };
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.js" integrity="sha512-aoZChv+8imY/U1O7KIHXvO87EOzCuKO0GhFtpD6G2Cyjo/xPeTgdf3/bchB10iB+AojMTDkMHDPLKNxPJVqDcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
<style>
.qwebr-code-output-stdout {background-color: powderblue;}

.qwebr-button-run {
 width = 100%; 
}

</style>
<script src="https://cdn.jsdelivr.net/npm/quizdown@latest/public/build/quizdown.js"></script><script>quizdown.init();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/editor/editor.main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>
  .monaco-editor pre {
    background-color: unset !important;
  }

  .qwebr-icon-status-spinner {
    color: darkgreen;
  }

  .qwebr-icon-run-code {
    color: #0d9c29
  }

  .qwebr-output-code-stdout {
    color: #111;
  }

  .qwebr-output-code-stderr {
    color: #db4133;
  }
  
  .qwebr-editor {
    border: 1px solid #EEEEEE;
  }
  
  .qwebr-button-run {
    background-color: #EEEEEE;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0; /* Extra styling for consistency */
    display: inline-block;
    font-weight: 600;
    line-height: 1;
    color: #000;
    text-align: center;
    text-decoration: none;
    -webkit-text-decoration: none;
    -moz-text-decoration: none;
    -ms-text-decoration: none;
    -o-text-decoration: none;
    /* vertical-align: middle; */ /* Prevents a space from appearing between the code cell and button */
    -webkit-user-select: none;
    border-color: #dee2e6;
    border: 1px solid rgba(0,0,0,0);
    padding: 0.375rem 0.75rem 0.75rem;
    font-size: .8rem;
    border-top-right-radius: 0.25rem;
    border-top-left-radius: 0.25rem;
    transition: color .15s ease-in-out,
    background-color .15s ease-in-out,
    border-color .15s ease-in-out,
    box-shadow .15s ease-in-out;
  }

  .qwebr-button-run:hover {
    color: #000;
    background-color: #e3e6ea;
    border-color: #e1e5e9;
  }

  .qwebr-button-run:disabled,
  .qwebr-button-run.disabled,
  fieldset:disabled 
  .qwebr-button-run {
    pointer-events: none;
    cursor: not-allowed;
    opacity: .5
  }
  
  .qwebr-output-code-area > pre {
    background-color: #F2F2F2;
    border-radius: 15px;
    margin-top: .8rem;
    padding: .1rem;
  }
  
  .qwebr-output-code-area > pre > div {
    margin: .4rem;
    margin-left: .6rem;
  }
  
  .monaco-editor {
    z-index: 0;
    -webkit-box-shadow: 5px 5px 15px 5px rgba(0, 0, 0, 0.3);
    box-shadow: 5px 5px 15px 5px rgba(0, 0, 0, 0.3);    
  }

  
  /* Custom styling for RevealJS Presentations*/

  /* Reset the style of the interactive area */
  .reveal div.qwebr-interactive-area {
    display: block;
    box-shadow: none;
    max-width: 100%;
    max-height: 100%;
    margin: 0;
    padding: 0;
  } 

  /* Provide space to entries */
  .reveal div.qwebr-output-code-area pre div {
    margin: 1px 2px 1px 10px;
  }

  /* Collapse the inside code tags to avoid extra space between line outputs */
  .reveal pre div code.qwebr-output-code-stdout, .reveal pre div code.qwebr-output-code-stderr {
    padding: 0;
    display: contents;
  }

  .reveal pre div code.qwebr-output-code-stdout {
    color: #111;
  }

  .reveal pre div code.qwebr-output-code-stderr {
    color: #db4133;
  }


  /* Create a border around console and output (does not effect graphs) */
  .reveal div.qwebr-console-area {
    border: 1px solid #EEEEEE;
    box-shadow: 2px 2px 10px #EEEEEE;
  }

  /* Cap output height and allow text to scroll */
  /* TODO: Is there a better way to fit contents/max it parallel to the monaco editor size? */
  .reveal div.qwebr-output-code-area pre {
    max-height: 400px;
    overflow: scroll;
  }
</style>
<script type="module">

  // Start a timer
  const initializeWebRTimerStart = performance.now();

  // Determine if we need to install R packages
  var installRPackagesList = ['boot', 'cobalt', 'marginaleffects', 'MatchIt', 'sandwich', 'ggplot2'];
  // Check to see if we have an empty array, if we do set to skip the installation.
  var setupRPackages = !(installRPackagesList.indexOf("") !== -1);
  var autoloadRPackages = true;

  // Display a startup message?
  var showStartupMessage = true;
  var showHeaderMessage = false;
  if (showStartupMessage) {

    // Get references to header elements
    const headerHTML = document.getElementById("title-block-header");
    const headerRevealJS = document.getElementById("title-slide");

    // Create the outermost div element for metadata
    const quartoTitleMeta = document.createElement("div");
    quartoTitleMeta.classList.add("quarto-title-meta");

    // Create the first inner div element
    const firstInnerDiv = document.createElement("div");
    firstInnerDiv.setAttribute("id", "qwebr-status-message-area");

    // Create the second inner div element for "WebR Status" heading and contents
    const secondInnerDiv = document.createElement("div");
    secondInnerDiv.setAttribute("id", "qwebr-status-message-title");
    secondInnerDiv.classList.add("quarto-title-meta-heading");
    secondInnerDiv.innerText = "WebR-Status";

    // Create another inner div for contents
    const secondInnerDivContents = document.createElement("div");
    secondInnerDivContents.setAttribute("id", "qwebr-status-message-body");
    secondInnerDivContents.classList.add("quarto-title-meta-contents");

    // Describe the WebR state
    var startupMessageWebR = document.createElement("p");
    startupMessageWebR.innerText = "Starte..."
    startupMessageWebR.setAttribute("id", "qwebr-status-message-text");
    // Add `aria-live` to auto-announce the startup status to screen readers
    startupMessageWebR.setAttribute("aria-live", "assertive");

    // Append the startup message to the contents
    secondInnerDivContents.appendChild(startupMessageWebR);

    // Add a status indicator for COOP and COEP Headers if needed
    if (showHeaderMessage) {
      const crossOriginMessage = document.createElement("p");
      crossOriginMessage.innerText = `${crossOriginIsolated ? 'üü¢' : 'üü°'} COOP & COEP Headers`;
      crossOriginMessage.setAttribute("id", "qwebr-coop-coep-header");
      secondInnerDivContents.appendChild(crossOriginMessage);
    }

    // Combine the inner divs and contents
    firstInnerDiv.appendChild(secondInnerDiv);
    firstInnerDiv.appendChild(secondInnerDivContents);
    quartoTitleMeta.appendChild(firstInnerDiv);

    // Determine where to insert the quartoTitleMeta element
    if (headerHTML) {
      // Append to the existing "title-block-header" element
      headerHTML.appendChild(quartoTitleMeta);
    } else if (headerRevealJS) {
      // If using RevealJS, add to the "title-slide" div
      headerRevealJS.appendChild(firstInnerDiv);
    } else {
      // If neither headerHTML nor headerRevealJS is found, insert after "webr-monaco-editor-init" script
      const monacoScript = document.getElementById("qwebr-monaco-editor-init");
      const header = document.createElement("header");
      header.setAttribute("id", "title-block-header");
      header.appendChild(quartoTitleMeta);
      monacoScript.after(header);
    }
  }

  // Retrieve the webr.mjs
  import { WebR, ChannelType } from "https://webr.r-wasm.org/v0.2.2/webr.mjs";

  // Populate WebR options with defaults or new values based on 
  // webr meta
  globalThis.webR = new WebR({
    "baseURL": "https://webr.r-wasm.org/v0.2.2/",
    "serviceWorkerUrl": "",
    "homedir": "/home/web_user", 
    "channelType": ChannelType.Automatic
  });

  // Initialization WebR
  await globalThis.webR.init();

  // Setup a shelter
  globalThis.webRCodeShelter = await new globalThis.webR.Shelter();

  // Setup a pager to allow processing help documentation 
  await globalThis.webR.evalRVoid('webr::pager_install()'); 

  // Function to set the button text
  function qwebrSetInteractiveButtonState(buttonText, enableCodeButton = true) {
    document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
      btn.innerHTML = buttonText;
      btn.disabled = !enableCodeButton;
    });
  }

  // Function to update the status message
  function qwebrUpdateStatusHeader(message) {
    startupMessageWebR.innerHTML = `
      <i class="fas fa-cog fa-spin qwebr-icon-status-spinner"></i>
      <span>${message}</span>`;
  }

  // Function to install a single package
  async function qwebrInstallRPackage(packageName) {
    await globalThis.webR.installPackages([packageName]);
  }

  // Function to load a single package
  async function qwebrLoadRPackage(packageName) {
    await globalThis.webR.evalRVoid(`library(${packageName});`);
  }

  // Generic function to process R packages
  async function qwebrProcessRPackagesWithStatus(packages, processType, displayStatusMessageUpdate = true) {
    // Switch between contexts
    const messagePrefix = processType === 'install' ? 'Installiere' : 'Lade';

    // Modify button state
    qwebrSetInteractiveButtonState(`<i class="fas fa-cog fa-spin qwebr-icon-status-spinner"></i> ${messagePrefix} Pakete ...`, false);

    // Iterate over packages
    for (let i = 0; i < packages.length; i++) {
      const activePackage = packages[i];
      const formattedMessage = `${messagePrefix} Paket ${i + 1} von ${packages.length}: <code style="background-color:white; color:darkgreen;">${activePackage}</code>`;
      
      // Display the update
      if (displayStatusMessageUpdate) {
        qwebrUpdateStatusHeader(formattedMessage);
      }

      // Run package installation
      if (processType === 'install') {
        await qwebrInstallRPackage(activePackage);
      } else {
        await qwebrLoadRPackage(activePackage);
      }
    }

    // Clean slate
    if (processType === 'load') {
      await globalThis.webR.flush();
    }
  }


  // Check to see if any packages need to be installed
  if (setupRPackages) {
    // Obtain only a unique list of packages
    const uniqueRPackageList = Array.from(new Set(installRPackagesList));

    // Install R packages one at a time (either silently or with a status update)
    await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'install', showStartupMessage);

    if(autoloadRPackages) {
      // Load R packages one at a time (either silently or with a status update)
      await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'load', showStartupMessage);
    }
  }

  // Stop timer
  const initializeWebRTimerEnd = performance.now();

  // Release document status as ready
  if (showStartupMessage) {
    startupMessageWebR.innerText = "‚úÖ Bereit!"
  }
  
  qwebrSetInteractiveButtonState(
    `<span>R-Code ausf√ºhren <i class="fa fa-sign-in"></i></span>`, 
    true
  );

</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Matching.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Matching</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"></a><a href="./index.html">Kausalanalyse mit R</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Lesemodus umschalten">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Suchen"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Start</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R_Einfuehrung.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistische Programmierung mit R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Matching.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Matching</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./RDD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Discontiniuty Designs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./RegReg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regularisierte Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Literatur.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Literatur</span></a>
  </div>
</li>
    </ul>
</div>
    <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title"><a href="./index.html">√úbersicht</a></h2>
   
  <ul>
<li>
<a href="#sec-balance" id="toc-sec-balance" class="nav-link active" data-scroll-target="#sec-balance"><span class="header-section-number">3.1</span> <em>Balance</em>: Vergleichbarkeit von Behandlungs- und Kontrollgruppe</a>
  <ul class="collapse">
<li><a href="#matching-durch-gewichtung" id="toc-matching-durch-gewichtung" class="nav-link" data-scroll-target="#matching-durch-gewichtung"><span class="header-section-number">3.1.1</span> Matching durch Gewichtung</a></li>
  <li><a href="#entropy-balancing" id="toc-entropy-balancing" class="nav-link" data-scroll-target="#entropy-balancing"><span class="header-section-number">3.1.2</span> Entropy Balancing</a></li>
  <li><a href="#sec-PSM" id="toc-sec-PSM" class="nav-link" data-scroll-target="#sec-PSM"><span class="header-section-number">3.1.3</span> Mehrere Matching-Variablen und der Propensity Score</a></li>
  </ul>
</li>
  <li>
<a href="#selektierende-matching-verfahren" id="toc-selektierende-matching-verfahren" class="nav-link" data-scroll-target="#selektierende-matching-verfahren"><span class="header-section-number">3.2</span> Selektierende Matching-Verfahren</a>
  <ul class="collapse">
<li><a href="#exaktes-matching" id="toc-exaktes-matching" class="nav-link" data-scroll-target="#exaktes-matching"><span class="header-section-number">3.2.1</span> Exaktes Matching</a></li>
  <li><a href="#coarsened-exact-matching" id="toc-coarsened-exact-matching" class="nav-link" data-scroll-target="#coarsened-exact-matching"><span class="header-section-number">3.2.2</span> Coarsened Exact Matching</a></li>
  <li><a href="#matching-mit-der-mahalanobis-distanz" id="toc-matching-mit-der-mahalanobis-distanz" class="nav-link" data-scroll-target="#matching-mit-der-mahalanobis-distanz"><span class="header-section-number">3.2.3</span> Matching mit der Mahalanobis-Distanz</a></li>
  <li><a href="#propensity-score-matching" id="toc-propensity-score-matching" class="nav-link" data-scroll-target="#propensity-score-matching"><span class="header-section-number">3.2.4</span> Propensity Score Matching</a></li>
  </ul>
</li>
  <li>
<a href="#sch%C3%A4tzung-und-inferenz-f%C3%BCr-den-behandlungseffekt-nach-matching" id="toc-sch√§tzung-und-inferenz-f√ºr-den-behandlungseffekt-nach-matching" class="nav-link" data-scroll-target="#sch%C3%A4tzung-und-inferenz-f%C3%BCr-den-behandlungseffekt-nach-matching"><span class="header-section-number">3.3</span> Sch√§tzung und Inferenz f√ºr den Behandlungseffekt nach Matching</a>
  <ul class="collapse">
<li><a href="#cluster-robuste-standardfehler" id="toc-cluster-robuste-standardfehler" class="nav-link" data-scroll-target="#cluster-robuste-standardfehler"><span class="header-section-number">3.3.1</span> Cluster-robuste Standardfehler</a></li>
  </ul>
</li>
  <li><a href="#sec-bootmatching" id="toc-sec-bootmatching" class="nav-link" data-scroll-target="#sec-bootmatching"><span class="header-section-number">3.4</span> Bootstrap-Sch√§tzung kausaler Effekte bei Matching</a></li>
  <li><a href="#doubly-robust-sch%C3%A4tzung" id="toc-doubly-robust-sch√§tzung" class="nav-link" data-scroll-target="#doubly-robust-sch%C3%A4tzung"><span class="header-section-number">3.5</span> Doubly-Robust-Sch√§tzung</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script><script type="module" id="qwebr-monaco-editor-init">

  // Configure the Monaco Editor's loader
  require.config({
    paths: {
      'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs'
    }
  });
</script><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Matching</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="cell">

</div>
<script type="module">
// Initialization WebR
await globalThis.webR.init();

// Run R code without focusing on storing data.
await globalThis.webR.evalRVoid(`
webr::install("dplyr")
webr::install("tidyr")

# create dataset directory
dir.create("datasets")
# Download the dataset
download.file(
    "https://raw.githubusercontent.com/mca91/kausal_data/main/darkmode.csv",
    'datasets/darkmode.csv',
)
`)
</script><script type="module">
// Initialization WebR
await globalThis.webR.init();

// Run R code without focusing on storing data.
await globalThis.webR.evalRVoid(`
library(dplyr)
# make darkmode available using read.csv for now
# because there's some issue with readr::read_csv
# I can't fix right now
darkmode <- read.csv(
    file = "datasets/darkmode.csv", 
    colClasses = c("numeric", "logical", "numeric", "numeric", "numeric") 
)

options(pillar.bold = TRUE, pillar.subtle = FALSE)
`)
</script><p>In randomisierten kontrollierten Studien stellt eine randomisierte Behandlung sicher, dass die Individuen beider Gruppen im Mittel vergleichbar sind, dass hei√üt es gibt keine systematischen Unterschiede der Studiensubjekte hinsichtlich der Verteilung von Charakteristika zwischen den Gruppen. Dann ist es plausibel eine beobachtete mittlere Differenz in der Outcome-Variable alleine auf die Behandlung zur√ºckzuf√ºhren.</p>
<p>In der Praxis, insbesondere in √∂konomischen Studien, sind randomisierte kontrollierte Studien aus ethischen und/oder finanziellen Gr√ºnden nicht durchf√ºhrbar. Stattdessen werden nicht-experimentelle Daten genutzt, die jedoch nur sehr selten eine Vergleichbarkeit von Behandlungs- und Kontrollgruppe gew√§hrleisten.</p>
<p>In diesem Kapitel betrachten wir Methoden, die in solchen Forschungsdesigns ‚Äì bei hinreichenden Informationen √ºber die Studiensubjekte ‚Äì eine Sch√§tzung kausaler Effekte erm√∂glichen, indem eine Vergleichbarkeit von Behandlungs- und Kontrollgruppe hergestellt wird. Dies kann durch eine gezielte Gewichtung von Beobachtungen anhand invididueller Merkmale bei der Sch√§tzung des Behandlungseffekts erfolgen. Andere etablierte Methoden sch√§tzen den kausalen Effekt nach Selektion von vergleichbaren Teilmengen von Subjekten beider Gruppen aus der urspr√ºnglichen Stichprobe, sogenanntes <em>Matching</em>.</p>
<p>Da <em>Matching</em> √§hnliche Beobachtungen basierend auf beobachtbaren Merkmalen vergleicht, kann die Wahrscheinlichkeit einer verzerrten Sch√§tzung des kausalen Effekt durch falsche Modellspezifikationen geringer sein als f√ºr eine Sch√§tzung des Effekts anhand multipler Regression. Weiterhin basieren Matching-Methoden nicht auf der Annahme eines linearen Zusammenhangs zwischen Kovariablen und der erkl√§renden Variable und k√∂nnen f√ºr die Sch√§tzung unterschiedlicher Spezifikationen von Behandlungseffekten herangezogen werden.</p>
<p>F√ºr die G√ºltigkeit eines Sch√§tzers basierend auf <em>Matching</em> sind zwei Annahmen erforderlich.</p>
<ol type="1">
<li><p><strong><em>Bedingte Unabh√§ngigkeit.</em></strong> Seien <span class="math inline">\(Y^{(0)}_i\)</span> und <span class="math inline">\(Y^{(1)}_i\)</span> potentielle Ergebnisse der Outcome-Variable <span class="math inline">\(Y\)</span> f√ºr ein Subjekt <span class="math inline">\(i\)</span> mit <span class="math inline">\(B_i=0\)</span> (keine Zuweisung zur Behandlung) beziehungsweise <span class="math inline">\(B_i=1\)</span> (Behandlung) und <span class="math inline">\(X_i\)</span> die beobachteten Kovariablen. Wir nehmen an, dass <span class="math display">\[\begin{align}
  \left\{Y^{(0)}_i, Y^{(1)}_i\right\} \perp B_i\vert X_i, \label{eq:cia}
\end{align}\]</span> d.h. die Behandlungszuweisung/-selektion ist unanabh√§ngig von den potentielle Ergebnissen <span class="math inline">\(Y^{(0)}_i\)</span> und <span class="math inline">\(Y^{(1)}_i\)</span>, wenn wir f√ºr die Kovariablen <span class="math inline">\(X\)</span> kontrollieren.</p></li>
<li><p><strong><em>√úberlappung.</em></strong> F√ºr jede m√∂gliche Kombination von Kovariablen <span class="math inline">\(X_i\)</span> gibt es eine positive Wahrscheinlichkeit <span class="math inline">\(&lt;1\)</span>, sowohl zur Behandlungsgruppe (<span class="math inline">\(B_i = 1\)</span>) als auch zur Kontrollgruppe (<span class="math inline">\(B_i = 0\)</span>) zugewiesen zu werden, <span class="math display">\[\begin{align}
  0 &lt; \text{P}(B_i=1\lvert X_i) &lt; 1, \label{eq:overlap}
\end{align}\]</span> d.h. keine Beobachtung hat eine Behandlungswahrscheinlichkeit von exakt <span class="math inline">\(0\)</span> oder <span class="math inline">\(1\)</span>.</p></li>
</ol>
<p>Annahme 1 stellt sicher, dass die Zuweisung zur Behandlungsgruppe nach Kontrolle f√ºr die Kovariablen <span class="math inline">\(X\)</span> als zuf√§llig betracht werden kann. Somit ist es m√∂glich den kausalen Effekt der Behandlung zu identifizieren, indem wir hinsichtlich der Kovariablen <span class="math inline">\(X\)</span> √§hnliche Subjekte (vgl. Annahme 2) aus Kontroll- und Behandlungsgruppe vergleichen.</p>
<p>Annahme 2 setzt vorraus, dass es eine ausreichende √úberlappung in den Verteilungen der Kovariablen zwischen Behandlungs- und Kontrollgruppe gibt. Dann ist sichergestellt, dass f√ºr jedes Subjekt in einer Gruppe ein hinsichtlich seiner Charakteristika vergleichbares Subjekt in der anderen Gruppe geben kann, sodass ein Vergleich m√∂glich ist.</p>
<section id="sec-balance" class="level2 page-columns page-full" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="sec-balance">
<span class="header-section-number">3.1</span> <em>Balance</em>: Vergleichbarkeit von Behandlungs- und Kontrollgruppe</h2>
<p>Der Lehrstuhl f√ºr √ñkonometrie an der Universit√§t Duisburg-Essen betreibt einen √ñkonometrie-Blog und interessiert sich f√ºr den kausalen Effekt der Einf√ºhrung eines <a href="https://en.wikipedia.org/wiki/Wikipedia:Dark_mode">darkmode</a> auf die Verweildauer der User auf der Webseite. Die Webseite ist zwar nicht-kommerziell, hat sich allerdings insb. f√ºr die Aquise internationaler Studierender f√ºr den Studiengang MSc. Econometrics als wichtiges Marketing-Instrument erwiesen. Ein anprechendes Design wird daher als hoch-relevant erachtet.</p>
<p>Idealerweise sollte der Effekt des Design-Relaunches auf die Nutzungsintensit√§t in einem kontrollierten randomisierten Experiment untersucht werden. Hierbei w√ºrden wir Nutzern zuf√§llig das neue oder das alte Design zuweisen und den Effekt als Differnz des durchschnittlichen Verweildauer f√ºr die Gruppen bestimmen. Eine solche Studie ist jedoch aus technischen und finanziellen Gr√ºnden nicht realisierbar, sodass die Auswirkungen des darkmode mit vorliegenden nicht-experimenellen Nutzungsstatistiken f√ºr die Webseite gesch√§tzt werden sollen.</p>
<p>Die Nutzungsstatistiken sind im Datensatz <a href="https://raw.githubusercontent.com/mca91/kasa_data/main/darkmode.csv"><em>darkmode.csv</em></a> enthalten und sollen der Analyse des Effekts des darkmode (<code>dark_mode</code>) auf die Verweildauer der Leser auf der Webseite (<code>read_time</code>) dienen.</p>
<p><a href="#tbl-darkmode">Tabelle&nbsp;<span>3.1</span></a> zeigt die Definitionen der Variablen in <em>darkmode.csv</em>.</p>
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div id="tbl-darkmode" class="anchored page-columns page-full">

<div id="iftzmymqxx" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;" class="page-columns page-full">
<style>#iftzmymqxx table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#iftzmymqxx thead, #iftzmymqxx tbody, #iftzmymqxx tfoot, #iftzmymqxx tr, #iftzmymqxx td, #iftzmymqxx th {
  border-style: none;
}

#iftzmymqxx p {
  margin: 0;
  padding: 0;
}

#iftzmymqxx .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #000000;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#iftzmymqxx .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#iftzmymqxx .gt_title {
  color: #000000;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#iftzmymqxx .gt_subtitle {
  color: #000000;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#iftzmymqxx .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#iftzmymqxx .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#iftzmymqxx .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #000000;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#iftzmymqxx .gt_col_heading {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#iftzmymqxx .gt_column_spanner_outer {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#iftzmymqxx .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#iftzmymqxx .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#iftzmymqxx .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#iftzmymqxx .gt_spanner_row {
  border-bottom-style: hidden;
}

#iftzmymqxx .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#iftzmymqxx .gt_empty_group_heading {
  padding: 0.5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#iftzmymqxx .gt_from_md > :first-child {
  margin-top: 0;
}

#iftzmymqxx .gt_from_md > :last-child {
  margin-bottom: 0;
}

#iftzmymqxx .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#iftzmymqxx .gt_stub {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#iftzmymqxx .gt_stub_row_group {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#iftzmymqxx .gt_row_group_first td {
  border-top-width: 2px;
}

#iftzmymqxx .gt_row_group_first th {
  border-top-width: 2px;
}

#iftzmymqxx .gt_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#iftzmymqxx .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#iftzmymqxx .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#iftzmymqxx .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#iftzmymqxx .gt_grand_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#iftzmymqxx .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#iftzmymqxx .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#iftzmymqxx .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#iftzmymqxx .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
}

#iftzmymqxx .gt_footnotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#iftzmymqxx .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#iftzmymqxx .gt_sourcenotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#iftzmymqxx .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#iftzmymqxx .gt_left {
  text-align: left;
}

#iftzmymqxx .gt_center {
  text-align: center;
}

#iftzmymqxx .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#iftzmymqxx .gt_font_normal {
  font-weight: normal;
}

#iftzmymqxx .gt_font_bold {
  font-weight: bold;
}

#iftzmymqxx .gt_font_italic {
  font-style: italic;
}

#iftzmymqxx .gt_super {
  font-size: 65%;
}

#iftzmymqxx .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#iftzmymqxx .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#iftzmymqxx .gt_indent_1 {
  text-indent: 5px;
}

#iftzmymqxx .gt_indent_2 {
  text-indent: 10px;
}

#iftzmymqxx .gt_indent_3 {
  text-indent: 15px;
}

#iftzmymqxx .gt_indent_4 {
  text-indent: 20px;
}

#iftzmymqxx .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">

  <thead><tr class="gt_col_headings">
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Variable">Variable</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Beschreibung">Beschreibung</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td headers="Variable" class="gt_row gt_left">read_time</td>
<td headers="Beschreibung" class="gt_row gt_left">Lesezeit (Minuten/Woche)</td>
</tr>
<tr>
<td headers="Variable" class="gt_row gt_left">dark_mode</td>
<td headers="Beschreibung" class="gt_row gt_left">Indikator: Beobachtung nach Einf√ºhrung darkmode</td>
</tr>
<tr>
<td headers="Variable" class="gt_row gt_left">male</td>
<td headers="Beschreibung" class="gt_row gt_left">Indikator: Individuum m√§nnlich</td>
</tr>
<tr>
<td headers="Variable" class="gt_row gt_left">age</td>
<td headers="Beschreibung" class="gt_row gt_left">Alter (in Jahren)</td>
</tr>
<tr>
<td headers="Variable" class="gt_row gt_left">hours</td>
<td headers="Beschreibung" class="gt_row gt_left">Bisherige Verweildauer auf der Seite</td>
</tr>
</tbody>
</table>
<div class="quarto-table-caption margin-caption">Tabelle&nbsp;3.1:  <p>Variablen im Datensatz <em>darkmode</em></p> </div></div>
</div>
</div>
</div>
<p>F√ºr die Analyse lesen wir zun√§chst den Datensatz <em>darkmode.csv</em> mit <code><a href="https://readr.tidyverse.org/reference/read_delim.html">readr::read_csv()</a></code> ein und verschaffen uns einen √úberblick √ºber die verf√ºgbaren Variablen.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Paket `tidyverse` laden</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Datensatz 'darkmode' einlesen</span></span>
<span><span class="va">darkmode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="st">"datasets/darkmode.csv"</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>dark_mode</code> hat den Typ <code>logical</code>. Mit <code><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">dplyr::mutate_all()</a></code> k√∂nnen wir komfortabel alle Spalten in den Typ <code>numeric</code> transformieren.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Alle Variablen zu typ 'numeric' formatieren...</span></span>
<span><span class="va">darkmode</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span>.funs <span class="op">=</span> <span class="va">as.numeric</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ... und √ºberpr√ºfen</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">darkmode</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 300
Columns: 5
$ read_time &lt;dbl&gt; 14.4, 15.4, 20.9, 20.0, 21.5, 19.5, 22.0, 17.4, 23.6, 15.7, ‚Ä¶
$ dark_mode &lt;dbl&gt; 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, ‚Ä¶
$ male      &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, ‚Ä¶
$ age       &lt;dbl&gt; 43, 55, 23, 41, 29, 64, 18, 53, 59, 53, 43, 38, 42, 23, 39, ‚Ä¶
$ hours     &lt;dbl&gt; 65.6, 125.4, 642.6, 129.1, 190.2, 185.3, 333.5, 279.3, 1302.‚Ä¶</code></pre>
</div>
</div>
<p>Eine naive Sch√§tzung des durchschnittlichen Behandlungseffekts (ATE) <span class="math inline">\(\widehat{\tau}^{\text{naiv}}\)</span> erhalten wir als Mittelwertdifferenz von <code>read_time</code> f√ºr die Behandlungsgruppe (<code>dark_mode == 1</code>) und die Kontrollgruppe (<code>dark_mode == 0</code>) <span class="math display">\[\begin{align}
  \widehat{\tau}^{\text{naiv}} = \overline{\text{read\_time}}_{\text{Behandlung}} - \overline{\text{read\_time}}_{\text{Kontrolle}}.\label{eq:naivATEdarkmode}
\end{align}\]</span></p>
<p>Diese Berechnung ist schnell mit R durchgef√ºhrt.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Naiver Sch√§tzer f√ºr ATE: </span></span>
<span><span class="co"># Differenz der Gruppen-Durchschnitte</span></span>
<span></span>
<span><span class="co"># Outcome in Behandlungsgruppe</span></span>
<span><span class="va">read_time_mTG</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"read_time"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Outcome in Kontrollgruppe</span></span>
<span><span class="va">read_time_mKG</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"read_time"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mittelwert-Differenz</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">read_time_mTG</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">read_time_mKG</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.4446331</code></pre>
</div>
</div>
<p>Die Sch√§tzung ergibt einen negativen Behandlungseffekt, mit der Interpreation, dass das neue Design zu einer Reduktion der Lesezeit um etwa 0.44 Minuten pro Woche f√ºhrt. Dieses Ergebnis ist allerdings zweifelhaft, weil eine Isolierung des Behandlungseffekts aufgrund von Backdoor-Pfaden im DGP vermutlich nicht gew√§hleistet ist. Ein Indikator hierf√ºr sind systematische Unterschiede hinsichtlich von (m√∂glicherweise unbeobachtbaren) Charakteristika von Kontrollgruppe und Behandlungsgruppe.</p>
<p>Da die User sich beim Aufrufen der Seite aktiv f√ºr oder gegen den das neue Design entscheiden m√ºssen (und somit selektieren, ob Sie in der Behandlungs- oder Kontrollgruppe landen), liegt wahrscheinlich <em>Confounding</em> vor: Unsere Hypothese ist zun√§chst, dass m√§nnliche User eine durchschnittlich l√§ngere Lesezeit aufweisen <em>und</em> mit gr√∂√üerer Wahrscheinlichkeit auf das neue Design wechseln als nicht-m√§nnliche Leser. Dann ist <code>male</code> eine Backdoor-Variable. Diese Situation ist unter der Annahme, dass nur diese Faktoren den DGP bestimmen, in <a href="#fig-maleCDdarkmode">Abbildung&nbsp;<span>3.1</span></a> dargestellt.</p>
<div class="cell page-columns page-full" data-fig-width="4" data-fig-height="3" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-maleCDdarkmode" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full"><div>
<svg width="384" height="288" viewbox="0.00 0.00 371.48 152.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)"><polygon fill="white" stroke="transparent" points="-4,4 -4,-148 367.48,-148 367.48,4 -4,4"></polygon><!-- read_time --><g id="node1" class="node"><title>
read_time
</title>
<text text-anchor="middle" x="327.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">read_time</text></g><!-- dark_mode --><g id="node2" class="node"><title>
dark_mode
</title>
<text text-anchor="middle" x="39.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">dark_mode</text></g><!-- dark_mode&#45;&gt;read_time --><g id="edge1" class="edge"><title>
dark_mode-&gt;read_time
</title>
<path fill="none" stroke="green" d="M79.23,-126C132,-126 225.02,-126 280.99,-126"></path><polygon fill="green" stroke="green" points="281.33,-129.5 291.33,-126 281.33,-122.5 281.33,-129.5"></polygon></g><!-- male --><g id="node3" class="node"><title>
male
</title>
<text text-anchor="middle" x="183.49" y="-13.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">male</text></g><!-- male&#45;&gt;read_time --><g id="edge3" class="edge"><title>
male-&gt;read_time
</title>
<path fill="none" stroke="red" d="M207.59,-36.08C231.58,-54.07 268.54,-81.79 295.09,-101.7"></path><polygon fill="red" stroke="red" points="293.21,-104.66 303.31,-107.86 297.41,-99.06 293.21,-104.66"></polygon></g><!-- male&#45;&gt;dark_mode --><g id="edge2" class="edge"><title>
male-&gt;dark_mode
</title>
<path fill="none" stroke="red" d="M159.39,-36.08C135.4,-54.07 98.44,-81.79 71.89,-101.7"></path><polygon fill="red" stroke="red" points="69.57,-99.06 63.67,-107.86 73.77,-104.66 69.57,-99.06"></polygon></g></g></svg>
</div>
<figcaption class="figure-caption margin-caption">Abbildung&nbsp;3.1: Backdoor durch ‚Äòmale‚Äô im Website-Design-Bespiel</figcaption></figure>
</div>
</div>
</div>
<p>Der DGP in <a href="#fig-maleCDdarkmode">Abbildung&nbsp;<span>3.1</span></a> f√ºhrt zu einer verzerrten Sch√§tzung des kausalen Effekts von <code>dark_mode</code> auf <code>read_time</code> mit <span class="math inline">\(\eqref{eq:naivATEdarkmode}\)</span>, wenn das Verh√§ltnis von m√§nnlichen und nicht-m√§nnlichen Usern in Bahandlungs- und Kontrollgruppe nicht ausgeglichen ist. Wir √ºberpr√ºfen dies mit R.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Anteile m√§nnlicher und nicht-m√§nnlicher User</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">anteile</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    gesamt <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    ant_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">male</span><span class="op">)</span>,</span>
<span>    ant_nm <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ant_m</span>,</span>
<span>    anz_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">male</span><span class="op">)</span>,</span>
<span>    anz_nm <span class="op">=</span> <span class="va">gesamt</span> <span class="op">-</span> <span class="va">anz_m</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 √ó 6
  dark_mode gesamt ant_m ant_nm anz_m anz_nm
      &lt;dbl&gt;  &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1         0    151 0.338  0.662    51    100
2         1    149 0.658  0.342    98     51</code></pre>
</div>
</div>
<p>Die Zusammenfassung <code>anteile_m</code> zeigt, dass der Anteil m√§nnlicher User in der Behandlungsgruppe deutlich h√∂her ist als in der Kontrollgruppe.</p>
<section id="matching-durch-gewichtung" class="level3 page-columns page-full" data-number="3.1.1"><h3 data-number="3.1.1" class="anchored" data-anchor-id="matching-durch-gewichtung">
<span class="header-section-number">3.1.1</span> Matching durch Gewichtung</h3>
<p>Matching eliminiert die Variation von <code>male</code> zwischen den Gruppen. Eine M√∂glichkeit hierf√ºr ist die Gewichtung der Beobachtungen in der Kontrollgruppe entsprechend der Anteile von M√§nnern und Nicht-M√§nnern in der Behandlungsgruppe, sodass die Vergleichbarkeit mit der Behandlungsgruppe hinsichtlich des Geschlechts gew√§hrleistet ist. Dies wird in der Literatur als <em>Balance</em> bezeichnet. Der Behandlungseffekt wird dann analog zu <span class="math inline">\(\eqref{eq:naivATEdarkmode}\)</span> gesch√§tzt.</p>
<p>Die Gewichte f√ºr Beobachtungen in der Kontrollgruppe <span class="math inline">\(w_i\)</span> werden berechnet als <span class="math display">\[\begin{align}
  w_i =
  \begin{cases}
    \text{ant\_m}_B/\text{anz\_m}_{K}, &amp; \text{falls } \text{male}_i = 1\\
        \text{ant\_nm}_B/\text{anz\_nm}_{K}, &amp; \text{sonst.}\\
  \end{cases}\label{eq:darkmodeweights}
\end{align}\]</span> Anhand der Formel f√ºr einen gewichteten Durchschnitt, <span class="math display">\[\begin{align}
  \overline{X}_w = \frac{\sum_i w_i \cdot X_i}{\sum_i w_i},
\end{align}\]</span> berechnen wir die gewichteten Mittelwerte f√ºr <code>male</code> und <code>read_time</code> in der Kontrollgruppe.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Anteile und Anzahlen aus `anteile` auslesen</span></span>
<span><span class="va">anz_m_K</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">anz_m</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anz_nm_K</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">anz_nm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ant_m_B</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">ant_m</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ant_nm_B</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">ant_nm</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Gewichtete Mittel f√ºr Kontrollgruppe berechnen</span></span>
<span><span class="op">(</span></span>
<span><span class="va">gew_K</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">read_time</span>, <span class="va">male</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">male</span> <span class="op">==</span> <span class="fl">1</span>, </span>
<span>    <span class="va">ant_m_B</span><span class="op">/</span><span class="va">anz_m_K</span>, </span>
<span>    <span class="va">ant_nm_B</span><span class="op">/</span><span class="va">anz_nm_K</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    male_k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">male</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span>,</span>
<span>    mean_read_time_wK <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 √ó 2
  male_k mean_read_time_wK
   &lt;dbl&gt;             &lt;dbl&gt;
1  0.658              18.1</code></pre>
</div>
</div>
<p>Ein Vergleich des gewichteten Mittelwertes von <code>male</code> in der Kontrollgruppe mit dem Mittelwert in der Behandlungsgruppe (<code>male_k</code>) zeigt, dass die Gewichte die Variation in <code>male</code> zwischen beiden Gruppen eliminieren, sodass die Backdoor durch <code>male</code> geschlossen ist. Mit <code>wmean_read_time_K</code> haben wir einen entsprechend gewichteten Mittelwert der Verweildauer f√ºr die Kontrollgruppe berechnet. Wir sch√§tzen den Behandlungseffekt nun als <span class="math display">\[\begin{align}
  \widehat{\tau}^{\text{w}} = \overline{\text{read\_time}}_{B} - \overline{\text{read\_time}}_{w,K}.\label{eq:weightedATEdarkmode}
\end{align}\]</span></p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">read_time_mTG</span><span class="op">)</span>  <span class="op">-</span> <span class="va">gew_K</span><span class="op">$</span><span class="va">mean_read_time_wK</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6383579</code></pre>
</div>
</div>
<p>Entgegen der naiven Sch√§tzung andhand von <span class="math inline">\(\eqref{eq:naivATEdarkmode}\)</span> erhalten wir nach Matching f√ºr <code>male</code> eine positive Sch√§tzung des Behandlungseffekts von etwa <span class="math inline">\(0.64\)</span>.</p>
<p>Die Sch√§tzung des Behandlungseffekts anhand von <span class="math inline">\(\eqref{eq:weightedATEdarkmode}\)</span> entspricht dem gesch√§tzten Koeffizienten <span class="math inline">\(\widehat{\beta}_1\)</span> aus einer gewichteten KQ-Regression im Modell <span class="math display">\[\begin{align*}
  \text{read\_time} = \beta_0 + \beta_1 \text{dark\_mode} + u,
\end{align*}\]</span> wobei die Beobachtungen der Kontrollgruppe wie in <span class="math inline">\(\eqref{eq:darkmodeweights}\)</span> gewichtet werden und <span class="math inline">\(w_i=1\)</span> f√ºr Beobachtungen der Behandlungsgruppe ist. Wir √ºberpr√ºfen dies mit R.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_w</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    w <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">male</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">ant_m_B</span><span class="op">/</span><span class="va">anz_m_K</span>,</span>
<span>      <span class="va">male</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">ant_nm_B</span><span class="op">/</span><span class="va">anz_nm_K</span>,</span>
<span>      <span class="cn">T</span> <span class="op">~</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">~</span> <span class="va">dark_mode</span>, weights <span class="op">=</span> <span class="va">w</span>, data <span class="op">=</span> <span class="va">darkmode_w</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ dark_mode, data = darkmode_w, weights = w)

Weighted Residuals:
     Min       1Q   Median       3Q      Max 
-11.4302  -0.6929   0.0814   0.7230  12.8698 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  18.0918     3.4796   5.199 3.72e-07 ***
dark_mode     0.6384     3.4912   0.183    0.855    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.48 on 298 degrees of freedom
Multiple R-squared:  0.0001122, Adjusted R-squared:  -0.003243 
F-statistic: 0.03343 on 1 and 298 DF,  p-value: 0.855</code></pre>
</div>
</div>
<p>Der gesch√§tzte Koeffizient von <code>dark_mode</code> entspricht <span class="math inline">\(\widehat{\tau}^w\)</span>.</p>
<p>Da <code>male</code> eine bin√§re Variable ist, reduziert sich eine Beurteilung der Vergleichbarkeit der Verteilungen von <code>male</code> in Behandlungs- und Kontrollgruppe auf einen simplen Vergleich des M√§nneranteils beider Gruppen. In der Praxis gibt es meist eine Vielzahl potentieller Backdoor-Variablen, die zudem kontinuierlich verteilt sind. Es scheint plausibel, dass das Alter der Nutzer sowohl die Akzeptanz des Design-Updates als auch die Lesezeit beeinflusst. Die bisherige Verweildauer ist mindestens eine plausible Determinante der Lesezeit.</p>
<p>Der erweiterte DGP ist in Abbildung <a href="#fig-CDdarkmode">Abbildung&nbsp;<span>3.2</span></a> dargestellt, wobei der zus√§tzliche Backdoor-Pfad durch <code>age</code> ebenfalls mit roten Pfeilen gekennzeichnet sind.</p>
<div class="cell page-columns page-full" data-fig-width="4" data-fig-height="3" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-CDdarkmode" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full"><div>
<svg width="384" height="288" viewbox="0.00 0.00 371.48 260.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)"><polygon fill="white" stroke="transparent" points="-4,4 -4,-256 367.48,-256 367.48,4 -4,4"></polygon><!-- read_time --><g id="node1" class="node"><title>
read_time
</title>
<text text-anchor="middle" x="327.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">read_time</text></g><!-- dark_mode --><g id="node2" class="node"><title>
dark_mode
</title>
<text text-anchor="middle" x="39.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">dark_mode</text></g><!-- dark_mode&#45;&gt;read_time --><g id="edge4" class="edge"><title>
dark_mode-&gt;read_time
</title>
<path fill="none" stroke="green" d="M79.23,-126C132,-126 225.02,-126 280.99,-126"></path><polygon fill="green" stroke="green" points="281.33,-129.5 291.33,-126 281.33,-122.5 281.33,-129.5"></polygon></g><!-- male --><g id="node3" class="node"><title>
male
</title>
<text text-anchor="middle" x="183.49" y="-13.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">male</text></g><!-- male&#45;&gt;read_time --><g id="edge6" class="edge"><title>
male-&gt;read_time
</title>
<path fill="none" stroke="red" d="M207.59,-36.08C231.58,-54.07 268.54,-81.79 295.09,-101.7"></path><polygon fill="red" stroke="red" points="293.21,-104.66 303.31,-107.86 297.41,-99.06 293.21,-104.66"></polygon></g><!-- male&#45;&gt;dark_mode --><g id="edge5" class="edge"><title>
male-&gt;dark_mode
</title>
<path fill="none" stroke="red" d="M159.39,-36.08C135.4,-54.07 98.44,-81.79 71.89,-101.7"></path><polygon fill="red" stroke="red" points="69.57,-99.06 63.67,-107.86 73.77,-104.66 69.57,-99.06"></polygon></g><!-- age --><g id="node4" class="node"><title>
age
</title>
<text text-anchor="middle" x="183.49" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">age</text></g><!-- age&#45;&gt;read_time --><g id="edge3" class="edge"><title>
age-&gt;read_time
</title>
<path fill="none" stroke="red" d="M207.59,-215.92C231.58,-197.93 268.54,-170.21 295.09,-150.3"></path><polygon fill="red" stroke="red" points="297.41,-152.94 303.31,-144.14 293.21,-147.34 297.41,-152.94"></polygon></g><!-- age&#45;&gt;dark_mode --><g id="edge2" class="edge"><title>
age-&gt;dark_mode
</title>
<path fill="none" stroke="red" d="M159.39,-215.92C135.4,-197.93 98.44,-170.21 71.89,-150.3"></path><polygon fill="red" stroke="red" points="73.77,-147.34 63.67,-144.14 69.57,-152.94 73.77,-147.34"></polygon></g><!-- hours --><g id="node5" class="node"><title>
hours
</title>
<text text-anchor="middle" x="327.49" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">hours</text></g><!-- hours&#45;&gt;read_time --><g id="edge1" class="edge"><title>
hours-&gt;read_time
</title>
<path fill="none" stroke="black" d="M327.49,-215.68C327.49,-198.82 327.49,-173.57 327.49,-154.15"></path><polygon fill="black" stroke="black" points="330.99,-154.05 327.49,-144.05 323.99,-154.05 330.99,-154.05"></polygon></g></g></svg>
</div>
<figcaption class="figure-caption margin-caption">Abbildung&nbsp;3.2: Erweiterter DGP im Website-Design-Beispiel</figcaption></figure>
</div>
</div>
</div>
<p>Die Beurteilung der <em>Balance</em> von Kontrollgruppe und Behandlungsgruppe kann durch eine grafische Gegen√ºberstellung der empirischen Verteilungen der Kovariablen beider Gruppen erfolgen. Wir visualisieren die empirischen Verteilungen mit <code>ggplot2</code>. Hierzu standardisieren wir <code>age</code> und <code>hours</code> zun√§chst mit <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz f√ºr graphische Darstellung formatieren</span></span>
<span><span class="va">darkmode_p</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Standardisierung mit 'scale()'</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    dark_mode <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, </span>
<span>    hours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">hours</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">darkmode_p</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 √ó 5
  read_time dark_mode  male age[,1] hours[,1]
      &lt;dbl&gt; &lt;fct&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
1      14.4 0             0  0.0377    -0.591
2      15.4 0             1  1.11      -0.459
3      20.9 1             0 -1.74       0.684
4      20   0             0 -0.141     -0.451
5      21.5 1             0 -1.21      -0.316
6      19.5 0             0  1.91      -0.327</code></pre>
</div>
</div>
<p>F√ºr <code>age</code> und <code>hours</code> eignen sich die gesch√§tzten Dichtefunktionen f√ºr einen Vergleich der Verteilungen in Behandlungs- und Kontrollgruppe.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Vergleich mit Dichtesch√§tzungen</span></span>
<span><span class="va">darkmode_p</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dark_mode</span>, <span class="va">hours</span>, <span class="va">age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># in langes Format √ºberf√ºhren</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">dark_mode</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    facets <span class="op">=</span> <span class="op">~</span> <span class="va">name</span>, </span>
<span>    scales <span class="op">=</span> <span class="st">"free"</span>, </span>
<span>    nrow <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Matching_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Die graphische Analyse zeigt deutliche Unterschiede in den Verteilungen von <code>age</code> zwischen Kontroll- und Behandlungsgruppe. F√ºr einen Beurteilung mit deskriptiven Statistiken wird h√§ufig eine sogenannte <em>Balance Table</em> herangezogen. Wir berechnen diese f√ºr <code>age</code>, <code>hours</code> und <code>male</code> mit <code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">cobalt::bal.tab()</a></code></p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/">cobalt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Balance table mit 'cobalt::bal.tab()'</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">hours</span>, <span class="va">male</span><span class="op">)</span>, </span>
<span>  treat <span class="op">=</span> <span class="va">darkmode</span><span class="op">$</span><span class="va">dark_mode</span>, </span>
<span>   <span class="co"># berechne SMD f√ºr KG und TG:</span></span>
<span>  disp <span class="op">=</span> <span class="st">"m"</span>, </span>
<span>  s.d.denom <span class="op">=</span> <span class="st">"pooled"</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
         Type   M.0.Un   M.1.Un Diff.Un
age   Contin.  46.0132  39.0940 -0.6469
hours Contin. 337.7775 328.5738 -0.0203
male   Binary   0.3377   0.6577  0.3200

Sample sizes
    Control Treated
All     151     149</code></pre>
</div>
</div>
<div class="page-columns page-full"><p>Die Eintr√§ge <code>M.0.Un</code> und <code>M.1.Un</code> zeigen die jeweiligen Stichprobenmittelwerte der Variablen f√ºr Kontroll- und Behandlungsgruppe. <code>Diff.Un</code> gibt eine standardisierte Mittelwertdifferenz <span class="math inline">\(SMD\)</span> an, wobei <span class="math display">\[\begin{align*}
  SMD_j := \left(\overline{X}_{j,B} - \overline{X}_{j,K}\right) \bigg/ \sqrt{\frac{1}{2}\left(\widehat{\text{Var}}(X_{j,B}) + \widehat{\text{Var}}(X_{j,K})\right)},
\end{align*}\]</span> mit Stichprobenmitteln <span class="math inline">\(\overline{X}_{j,B}\)</span> und <span class="math inline">\(\overline{X}_{j,K}\)</span> und Stichprobenvarianzen <span class="math inline">\(\widehat{\text{Var}}(X_{j,B})\)</span> und <span class="math inline">\(\widehat{\text{Var}}(X_{j,K})\)</span> f√ºr eine kontinuierliche Kovariable <span class="math inline">\(j\)</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Obwohl es keinen einheitlichen Schwellenwert f√ºr die standardisierte Differenz gibt, der ein erhebliches Ungleichgewicht anzeigt, gilt f√ºr kontinuierliche Variablen eine standardisierte (absolute) Differenz von weniger als <span class="math inline">\(0.1\)</span> als Hinweis auf einen vernachl√§ssigbaren Unterschied zwischen den Gruppen.</p><div class="no-row-height column-margin column-container"><li id="fn1"><p><sup>1</sup>&nbsp;Siehe <span class="citation" data-cites="Austin2011">P. Austin (<a href="Literatur.html#ref-Austin2011" role="doc-biblioref">2011</a>)</span> f√ºr einen √úberblick zu Balance-Statistiken.</p></li></div></div>
<p>Die Balance Table weist also auf einen vernachl√§ssigbaren Unterschied f√ºr <code>hours</code> hin und best√§tigt den aus den Grafiken abgeleiteten Eindruck einer relevanten Differenzen f√ºr <code>age</code>.</p>
</section><section id="entropy-balancing" class="level3" data-number="3.1.2"><h3 data-number="3.1.2" class="anchored" data-anchor-id="entropy-balancing">
<span class="header-section-number">3.1.2</span> Entropy Balancing</h3>
<p><em>Entropy Balancing</em> <span class="citation" data-cites="Hainmueller2012">(<a href="Literatur.html#ref-Hainmueller2012" role="doc-biblioref">Hainmueller 2012</a>)</span> ist eine weitere Methode zur Gew√§hrleistung der Vergleichbarkeit von Behandlungs- und Kontrollgruppe anhand von Gewichten. Das Verfahren nutzt Konzepte aus der <a href="https://de.wikipedia.org/wiki/Informationstheorie">Informationstheorie</a> um die Gewichte f√ºr Subjekte in der Kontrollgruppe so anzupassen, dass die Verteilung der Matchingvariablen in der Kontrollgruppe die Verteilung in der Behandlungsgruppe m√∂glichst gut approximiert. Dies geschieht unter der Restriktion, dass bestimmte empirische Momente (meist Mittelwerte und Varianzen) der Matchingvariablen exakt √ºbereinstimmen. Mathematisch werden die Gewichte f√ºr Kontrollgruppenbeobachtungen durch Minimierung der <a href="https://de.wikipedia.org/wiki/Kullback-Leibler-Divergenz">Kullback-Leibler-Divergenz</a> zwischen den Verteilungen gefunden, wobei die Divergenz ein Ma√ü f√ºr den Unterschied von Wahrscheinlichkeitsverteilungen ist.</p>
<p>Entropy Balancing ist im R-Paket <code>WeightIt</code> implementiert. Wir zeigen, wie die ben√∂tigten Gewichte f√ºr eine Sch√§tzungen des ATT im Website-Beispiel mit <code>WeightIt::wightit()</code> bestimmt werden k√∂nnen. √úber das Argument <code>moments</code> legen wir fest, dass die Gewichte unter der Restriktion √ºbereinstimmender Mittelwerte aller Matching-Variablen zwischen Behandlungs- und Kontrollgruppe erfolgen soll.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/">WeightIt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Gewichte f√ºr Entropy Balancing</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html">weightit</a></span><span class="op">(</span></span>
<span>  <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"ebal"</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  moments <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span> <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A weightit object
 - method: "ebal" (entropy balancing)
 - number of obs.: 300
 - sampling weights: none
 - treatment: 2-category
 - estimand: ATT (focal: 1)
 - covariates: age, male, hours</code></pre>
</div>
</div>
<p>Wir sch√§tzen den Behandlungseffekt nach Entropy Balancing mit gewichteter Regression.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mittelwert-Vergleich mit lm()</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">dark_mode</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">W1</span><span class="op">$</span><span class="va">weights</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ dark_mode, data = darkmode, weights = W1$weights)

Weighted Residuals:
     Min       1Q   Median       3Q      Max 
-16.6662  -2.3552   0.8786   2.9583  27.1840 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  17.7598     0.4093  43.394   &lt;2e-16 ***
dark_mode     0.9704     0.5807   1.671   0.0958 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.029 on 298 degrees of freedom
Multiple R-squared:  0.009283,  Adjusted R-squared:  0.005958 
F-statistic: 2.792 on 1 and 298 DF,  p-value: 0.09578</code></pre>
</div>
</div>
<p>Beachte, dass die von <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> berechneten Standardfehler bei Entropy Balancing ung√ºltig sind. In Abschnitt <a href="#sec-bootmatching"><span>Kapitel&nbsp;3.4</span></a> erl√§utern wir die Berechnung von Standardfehlern f√ºr Matching-Sch√§tzer mit dem Bootstrap.</p>
</section><section id="sec-PSM" class="level3 page-columns page-full" data-number="3.1.3"><h3 data-number="3.1.3" class="anchored" data-anchor-id="sec-PSM">
<span class="header-section-number">3.1.3</span> Mehrere Matching-Variablen und der Propensity Score</h3>
<p>Bei mehreren Backdoor-Variablen kann eine Gewichtung anhand der Behandlungswahrscheinlichkeit (<em>Treatment Propensity</em>) erfolgen. Die Idee hierbei ist, dass der DGP wie in <a href="#fig-propCDdarkmode">Abbildung&nbsp;<span>3.3</span></a> dargestellt werden kann.</p>
<div class="cell page-columns page-full" data-fig-width="4" data-fig-height="3" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-propCDdarkmode" class="quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="figure page-columns page-full"><div>
<svg width="384" height="288" viewbox="0.00 0.00 398.69 260.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)"><polygon fill="white" stroke="transparent" points="-4,4 -4,-256 394.69,-256 394.69,4 -4,4"></polygon><!-- read_time --><g id="node1" class="node"><title>
read_time
</title>
<text text-anchor="middle" x="354.71" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">read_time</text></g><!-- dark_mode --><g id="node2" class="node"><title>
dark_mode
</title>
<text text-anchor="middle" x="66.71" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">dark_mode</text></g><!-- dark_mode&#45;&gt;read_time --><g id="edge4" class="edge"><title>
dark_mode-&gt;read_time
</title>
<path fill="none" stroke="green" d="M106.45,-126C159.22,-126 252.24,-126 308.21,-126"></path><polygon fill="green" stroke="green" points="308.55,-129.5 318.55,-126 308.55,-122.5 308.55,-129.5"></polygon></g><!-- TreatmentPropensity --><g id="node3" class="node"><title>
TreatmentPropensity
</title>
<text text-anchor="middle" x="66.71" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">TreatmentPropensity</text></g><!-- TreatmentPropensity&#45;&gt;dark_mode --><g id="edge7" class="edge"><title>
TreatmentPropensity-&gt;dark_mode
</title>
<path fill="none" stroke="red" d="M66.71,-215.68C66.71,-198.82 66.71,-173.57 66.71,-154.15"></path><polygon fill="red" stroke="red" points="70.21,-154.05 66.71,-144.05 63.21,-154.05 70.21,-154.05"></polygon></g><!-- male --><g id="node4" class="node"><title>
male
</title>
<text text-anchor="middle" x="210.71" y="-13.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">male</text></g><!-- male&#45;&gt;read_time --><g id="edge6" class="edge"><title>
male-&gt;read_time
</title>
<path fill="none" stroke="red" d="M234.81,-36.08C258.8,-54.07 295.76,-81.79 322.3,-101.7"></path><polygon fill="red" stroke="red" points="320.43,-104.66 330.53,-107.86 324.63,-99.06 320.43,-104.66"></polygon></g><!-- male&#45;&gt;TreatmentPropensity --><g id="edge5" class="edge"><title>
male-&gt;TreatmentPropensity
</title>
<path fill="none" stroke="red" d="M198.68,-36.04C173.32,-74.08 114.27,-162.66 84.52,-207.29"></path><polygon fill="red" stroke="red" points="81.44,-205.59 78.8,-215.85 87.26,-209.48 81.44,-205.59"></polygon></g><!-- age --><g id="node5" class="node"><title>
age
</title>
<text text-anchor="middle" x="210.71" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">age</text></g><!-- age&#45;&gt;read_time --><g id="edge3" class="edge"><title>
age-&gt;read_time
</title>
<path fill="none" stroke="red" d="M234.81,-215.92C258.8,-197.93 295.76,-170.21 322.3,-150.3"></path><polygon fill="red" stroke="red" points="324.63,-152.94 330.53,-144.14 320.43,-147.34 324.63,-152.94"></polygon></g><!-- age&#45;&gt;TreatmentPropensity --><g id="edge2" class="edge"><title>
age-&gt;TreatmentPropensity
</title>
<path fill="none" stroke="red" d="M183.62,-234C172.15,-234 158.14,-234 143.86,-234"></path><polygon fill="red" stroke="red" points="143.45,-230.5 133.45,-234 143.45,-237.5 143.45,-230.5"></polygon></g><!-- hours --><g id="node6" class="node"><title>
hours
</title>
<text text-anchor="middle" x="354.71" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">hours</text></g><!-- hours&#45;&gt;read_time --><g id="edge1" class="edge"><title>
hours-&gt;read_time
</title>
<path fill="none" stroke="black" d="M354.71,-215.68C354.71,-198.82 354.71,-173.57 354.71,-154.15"></path><polygon fill="black" stroke="black" points="358.21,-154.05 354.71,-144.05 351.21,-154.05 358.21,-154.05"></polygon></g></g></svg>
</div>
<figcaption class="figure-caption margin-caption">Abbildung&nbsp;3.3: Propensity im Website-Design-Beispiel</figcaption></figure>
</div>
</div>
</div>
<p>Hierbei beeinflussen die Backdoor-Variablen <em>age</em> und <em>male</em> die Behandlungsvariable <em>dark_mode</em> lediglich durch die Behandlungswahrscheinlichkeit <em>Treatment Propensity</em>. Diese Darstellung zeigt, das die mehrdimensionale Information bzgl. der √Ñhnlichkeit von Subjekten hinsichtlich der beobachteten Kovariablen in einer einzigen Variable zusammengefasst werden kann. Die Backdoor-Pfade k√∂nnen daher geschlossen werden, indem wir Subjekte anhand von <em>Treatment Propensity</em> derart gewichten, dass beide Gruppen hinsichtlich der Verteilung der Behandlungswahrscheinlichkeit vergleichbar sind. Betrachte erneut <span class="math inline">\(\eqref{eq:cia}\)</span> und beachte, dass <span class="math display">\[\begin{align}
  Y_i = Y_i^{(1)} D_i + Y_i^{(0)} (1-D_i).
\end{align}\]</span> <span class="citation" data-cites="RosenbaumRubin1983">Rosenbaum und Rubin (<a href="Literatur.html#ref-RosenbaumRubin1983" role="doc-biblioref">1983</a>)</span> zeigen, dass es hinsichtlich <span class="math inline">\(\eqref{eq:cia}\)</span> √§quivalent ist f√ºr die <em>Treatment Propensity</em> <span class="math inline">\(P_i(X_i):=P(B_i=1\vert X_i = x)\)</span> zu kontrollieren, d.h. <span class="math display">\[\begin{align}
  \left\{Y_i^{(1)},Y_i^{(0)}\right\} \perp B_i\vert X_i \quad\Leftrightarrow\quad \left\{Y_i^{(1)},Y_i^{(0)}\right\} \perp B_i\vert P_i(X_i).
\end{align}\]</span></p>
<p>Der Behandlungseffekt kann so als Differenz von gewichteten Gruppenmittelwerten berechnet werden, mit inversem Wahrscheinlichkeitsgewicht (IPW) <span class="math inline">\(w_{i,B} = 1/P_i(X_i)\)</span> f√ºr Beobachtungen in der Behandlungsgruppe und <span class="math inline">\(w_{i,K} = 1/(1-P_i(X_i))\)</span> f√ºr Beobachtungen in der Kontrollgruppe, <span class="math display">\[\begin{align}
  \tau^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left[\frac{B_i Y_i}{P_i(X_i)} - \frac{(1-B_i)Y_i}{1-P_i(X_i)} \right].\label{eq:tauipw}
\end{align}\]</span></p>
<p>Grunds√§tzlich ist <em>TreatmentPropensity</em> eine nicht beobachtbare Variable und muss daher aus den Daten gesch√§tzt werden. Eine gesch√§tzte Behandlungswahrscheinlichkeiten <span class="math inline">\(\widehat{P}_i(X_i)\)</span> wird als <em>Propensity Score</em> bezeichnet. In der Praxis erfolgt die Sch√§tzung von <em>Propensity Scores</em> meist mit logistischer Regression. Ein erwartungstreuer Sch√§tzer des ATE ist <span class="math display">\[\begin{align}
  \widehat{\tau}^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left[\frac{B_i Y_i}{\widehat{P}_i(X_i)} - \frac{(1-B_i)Y_i}{1-\widehat{P}_i(X_i)} \right].\label{eq:hattauipw}
\end{align}\]</span> <span class="citation" data-cites="Hiranoetal2003">Hirano, Imbens, und Ridder (<a href="Literatur.html#ref-Hiranoetal2003" role="doc-biblioref">2003</a>)</span> diskutieren Alternativen zu <span class="math inline">\(\eqref{eq:hattauipw}\)</span> f√ºr die Sch√§tzung anderer Typen von Behandlungseffekten.</p>
<div class="page-columns page-full"><p>Wir sch√§tzen nachfolgend die <em>Propensity Scores</em> f√ºr unser Anwendungsbeispiel, erl√§utern die Berechnung der Gewichte sowie die Sch√§tzung von Behandlungseffekten mit gewichteter Regression. Hierbei betrachten wir eine Variante von <span class="math inline">\(\eqref{eq:hattauipw}\)</span> mit normalisierten Gewichten <span class="math inline">\(\tilde{w}_{i,B} = w_{i,B}/\sum_i w_{i,B}\)</span> und <span class="math inline">\(\tilde{w}_{i,K} = w_{i,K}/\sum_i w_{i,K}\)</span> die sich jeweils zu 1 summieren.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Dies ergibt den H√°jek-Sch√§tzer<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> <span class="math display">\[\begin{align}
    \widehat{\tau}_N^{\text{IPW}} = \frac{\sum_i\tilde{w}_{i,B}Y_i}{\sum_i\tilde{w}_{i,B}} -  \frac{\sum_i\tilde{w}_{i,K}Y_i}{\sum_i\tilde{w}_{i,K}}.\label{eq:hattauhajek}
\end{align}\]</span></p><div class="no-row-height column-margin column-container"><li id="fn2"><p><sup>2</sup>&nbsp;Eine Normalisierung der Gewichte reduziert die Varianz des Sch√§tzers, vgl. <span class="citation" data-cites="Hiranoetal2003">Hirano, Imbens, und Ridder (<a href="Literatur.html#ref-Hiranoetal2003" role="doc-biblioref">2003</a>)</span></p></li><li id="fn3"><p><sup>3</sup>&nbsp;Siehe <span class="citation" data-cites="Hajek1971">H√°jek (<a href="Literatur.html#ref-Hajek1971" role="doc-biblioref">1971</a>)</span>.</p></li></div></div>
<p>Zun√§chst Sch√§tzen wir ein logistisches Regressionsmodell mit <code>age</code>, <code>male</code> und <code>hours</code> als erkl√§rende Variablen f√ºr <code>dark_mode</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Logit-Modell mit 'glm()' sch√§tzen</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">darkmode_ps_logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>,</span>
<span>    data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>    family <span class="op">=</span> <span class="va">binomial</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glm(formula = dark_mode ~ age + male + hours, family = binomial, 
    data = darkmode)

Coefficients:
(Intercept)          age         male        hours  
  2.330e+00   -7.330e-02    1.623e+00   -9.293e-05  

Degrees of Freedom: 299 Total (i.e. Null);  296 Residual
Null Deviance:      415.9 
Residual Deviance: 346.4    AIC: 354.4</code></pre>
</div>
</div>
<p>Die <em>Propensity Scores</em> erhalten wir als angepasste Werte aus der Regression <code>darkmode_ps_logit</code> mit <code><a href="https://rdrr.io/r/stats/fitted.values.html">fitted()</a></code>. Wir erweitern den Datensatz mit den Ergebnissen.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz um Propensity Scores erweitern</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">darkmode_probs</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      PS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">darkmode_ps_logit</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 300 √ó 6
   read_time dark_mode  male   age  hours     PS
       &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1      14.4         0     0    43   65.6 0.304 
 2      15.4         0     1    55  125.  0.478 
 3      20.9         1     0    23  643.  0.642 
 4      20           0     0    41  129.  0.335 
 5      21.5         1     0    29  190.  0.547 
 6      19.5         0     0    64  185.  0.0849
 7      22           1     0    18  334.  0.727 
 8      17.4         0     0    53  279.  0.171 
 9      23.6         0     0    59 1303.  0.108 
10      15.7         0     0    53   16.1 0.174 
# ‚Ñπ 290 more rows</code></pre>
</div>
</div>
<p>Zur Beurteilung der √úberlappung (vgl. Annahme <span class="math inline">\(\eqref{eq:overlap}\)</span> k√∂nnen wir die Verteilung der <em>Propensity Scores</em> nach Behandlungs-Indikator mit Histogrammen visualisieren.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># √úberlappung pr√ºfen:</span></span>
<span><span class="co"># Histogramme der PS nach Treatment-Indikator</span></span>
<span><span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">PS</span>, </span>
<span>      fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    alpha <span class="op">=</span> <span class="fl">.5</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">25</span>, </span>
<span>    position <span class="op">=</span> <span class="st">"identity"</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Matching_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Ein Vergleich der Histogramme zeigt, dass die √úberlappung der <em>Propensity Scores</em> in der linken Flanken der Verteilungen der Kontrollgruppe und in der rechten Flanke der Behandlungsgruppe schlechter wird. Wir entfernen zun√§chst Beobachtungen aus der Stichprobe deren <em>Propensity Scores</em> wenig bzw. keine √úberlappung aufweisen.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz nach PS trimmen</span></span>
<span><span class="va">darkmode_probs</span> <span class="op">&lt;-</span> <span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">PS</span>,</span>
<span>      left <span class="op">=</span> <span class="fl">.25</span>,</span>
<span>      right <span class="op">=</span> <span class="fl">.75</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># √úberlappung nach trimming pr√ºfen:</span></span>
<span><span class="co"># Dichtesch√§tzung der PS nach Treatment-Indikator</span></span>
<span><span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>  mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">PS</span>, </span>
<span>    fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    alpha <span class="op">=</span> <span class="fl">.5</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">25</span>, </span>
<span>    position <span class="op">=</span> <span class="st">"identity"</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Matching_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>IPWs anhand der <em>Propensity Scores</em> k√∂nnen schnell mit der Vorschrift <span class="math display">\[\begin{align}
  \text{IPW} = \frac{\text{dark\_mode}}{\text{PS}} + \frac{1 - \text{dark\_mode}}{1 - \text{PS}},
\end{align}\]</span> berechnet werden.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz um IPWs erweitern</span></span>
<span><span class="va">darkmode_IPW</span> <span class="op">&lt;-</span> <span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    IPW <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">/</span> <span class="va">PS</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">dark_mode</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">PS</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">darkmode_IPW</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">IPW</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 194 √ó 1
     IPW
   &lt;dbl&gt;
 1  1.44
 2  1.91
 3  1.56
 4  1.50
 5  1.83
 6  1.38
 7  1.43
 8  1.47
 9  2.71
10  1.42
# ‚Ñπ 184 more rows</code></pre>
</div>
</div>
<p>Eine Sch√§tzung des durchschnittlichen Behandlungseffekts gem√§√ü <span class="math inline">\(\eqref{eq:hattauhajek}\)</span> implementieren wir mit <code>dplyr</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_IPW</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="va">IPW</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">IPW</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>weighted_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">weighted_mean</span><span class="op">)</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 √ó 1
   diff
  &lt;dbl&gt;
1  1.90</code></pre>
</div>
</div>
<p>Diese Sch√§tzung des Behandlungseffekts ist √§quivalent zur gewichteten KQ-Sch√§tzung anhand eines einfachen linearen Regressionsmodells.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mit IPWs gewichteter KQ-Schaetzer berechnet den ATE</span></span>
<span><span class="va">model_ipw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">dark_mode</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode_IPW</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">IPW</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_ipw</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ dark_mode, data = darkmode_IPW, weights = IPW)

Weighted Residuals:
     Min       1Q   Median       3Q      Max 
-18.5086  -4.4579   0.6096   4.1345  20.4566 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  17.9709     0.4942  36.362  &lt; 2e-16 ***
dark_mode     1.9011     0.6952   2.735  0.00683 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6.913 on 192 degrees of freedom
Multiple R-squared:  0.03749,   Adjusted R-squared:  0.03248 
F-statistic: 7.478 on 1 and 192 DF,  p-value: 0.006829</code></pre>
</div>
</div>
<p>Unsere Sch√§tzung des ATE ist der gesch√§tzte Koeffizient von <code>dark_mode</code>. Die ausgegebenen Standardfehler und Inferenzstatistiken sind jedoch <em>ung√ºltig</em> aufgrund der Gewichtung mit IPWs, den inversen <em>gesch√§tzten</em> Wahrscheinlichkeiten f√ºr eine Behandlung. Der Grund hierf√ºr ist, dass die Berechnung der Standardfehler in <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> die zus√§tzliche Unsicherheit durch die gesch√§tzen <em>Propensity Scores</em> nicht ber√ºcksichtigt! Sp√§ter im Kapitel erl√§utern wir die Berechnung g√ºltiger Standardfehler f√ºr IPW-Sch√§tzer basierend auf <em>Propensity Scores</em> mit dem Bootstrap.</p>
</section></section><section id="selektierende-matching-verfahren" class="level2 page-columns page-full" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="selektierende-matching-verfahren">
<span class="header-section-number">3.2</span> Selektierende Matching-Verfahren</h2>
<div class="page-columns page-full"><p>Das grunds√§tzliche Konzept von selektierendem Matching wird in der nachstehenden interaktiven Grafik veranschaulicht. Hier betrachten wir beobachtete Auspr√§gungen von zwei (unabh√§ngig und identisch verteilten) Matching-Variablen f√ºr Subjekte in der Behandlungsgruppe (blau) sowie Kontrollgruppe (rot). Per Klick auf eine Beobachtung werden Matches aus der anderen Gruppe in cyan farblich kenntlich gemacht. Als Matches z√§hlen s√§mtliche Beobachtungen der anderen Gruppe, deren <a href="https://de.wikipedia.org/wiki/Euklidischer_Abstand">Euklidische Distanz</a> zu dem ausgew√§hlten Punkt das √ºber den Slider eingestellte Maximum <em>Caliper</em> nicht √ºberschreitet.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Diese Region wird durch den gestrichelten Kreis gekennzeichnet. Die Grafik illustriert inbesondere, dass Beobachtungen mehrfach (s.g. Matching mit zur√ºcklegen) oder gar nicht gematcht werden k√∂nnen.</p><div class="no-row-height column-margin column-container"><li id="fn4"><p><sup>4</sup>&nbsp;Es handelt sich hierbei um einen Spezialfall von Matching anhand der Mahalanobis-Distanz.</p></li></div></div>
<iframe width="100%" height="629" frameborder="0" src="https://observablehq.com/embed/62067a02a72c9f90?cells=theplot%2Cviewof+caliper%2Cstyles">
</iframe>
<div class="page-columns page-full"><p>F√ºr die nachfolgenden Code-Beispiele verwenden wir das R-Paket <code>MatchIt</code>. <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">MatchIt::matchit()</a></code> nutzt standardm√§√üig Eins-zu-Eins-Matching (ohne Zur√ºcklegen) von Beobachtungen der Treatment-Gruppe mit Beobachtungen der Kontrollgruppe.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> Die f√ºr das Matching zu verwendenden Variablen werden √ºber das Argument <code>formula</code> als Funktion des Behandlungsindikators definiert. <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> bereitet das Objekt f√ºr eine Sch√§tzung des ATT mit einer geeigneten Funktionen, s. <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">?matchit</a></code> und hier insb. die Erl√§uterungen der Argumente <code>replace = F</code>, <code>ratio = 1</code> und <code>estimand = "ATT"</code> f√ºr Details. Mit <code>cobalt::balt.tab()</code> erhalten wir eine <em>balance table</em> f√ºr den gematchten Datensatz.</p><div class="no-row-height column-margin column-container"><li id="fn5"><p><sup>5</sup>&nbsp;Dieses Schema zielt auf eine Sch√§tzung des ATT ab.</p></li></div></div>
<p>Wir zeigen als n√§chstes, wie <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">MatchIt::matchit()</a></code> f√ºr Matching anhand der Regressoren <code>age</code>, <code>hours</code>, und <code>male</code> in unserem Website-Beispiel f√ºr unterschiedliche Varianten durchgef√ºhrt werden kann.</p>
<section id="exaktes-matching" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="exaktes-matching">
<span class="header-section-number">3.2.1</span> Exaktes Matching</h3>
<p>Exaktes Matching ordnet einem Subjekt aus der Behandlungsgruppe ein oder mehrere Subjekte aus der Kontrollgruppe zu, wenn die boebachteten Auspr√§gung der Matching-Variablen <em>exakt</em> √ºbereinstimmen. Hierbei muss die ‚ÄòDistanz‚Äô zwischen den Auspr√§gung der Matching-Variablen folglich <span class="math inline">\(0\)</span> sein. Dieses Verfahren findet meist bei ausschlie√ülich diskret verteilten Merkmalen Anwendung. Bei kontinuierlich verteilten Merkmalen (vgl. die obige interaktive Grafik) sind exakte Matches zwar theoretisch unm√∂glich, ergeben sich jedoch in der Praxis aus der Datenerfassung, bspw. durch Rundungsfehler. In <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> erhalten wir exaktes Ein-zu-eins-Matching mit <code>method = "exact"</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/">MatchIt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Exaktes Eins-zu-Eins-Matching durchf√ºhren</span></span>
<span><span class="va">res_em</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"exact"</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `matchit()`:
! No exact matches were found.</code></pre>
</div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">res_em</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'res_em' not found</code></pre>
</div>
</div>
<p>Aufgrund der kontinulierliche Verteilten Variable <code>hours</code> gibt es in unserem Website-Beispiel keine exakten Matches. Dieses Verfahren ist hier folglich ungeeignet.</p>
</section><section id="coarsened-exact-matching" class="level3 page-columns page-full" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="coarsened-exact-matching">
<span class="header-section-number">3.2.2</span> Coarsened Exact Matching</h3>
<div class="page-columns page-full"><p>Bei dieser Methode werden kontinuierliche Matching-Variablen grob (Engl. <em>coarse</em>) klassiert, √§hnlich wie bei einem Histogram. Diese Diskretisierung erm√∂glicht es exakte √úbereinstimmungen zwischen Behandlungs- und Kontrollgruppenbeobachtungen hinsichtlich ihrer klassierten Auspr√§gungen zu finden. Sowohl Behandlungs- als auch Kontrollbeobachtungen die mindestents einen exakten Match haben, werden Teil des gematchten Datensatzes. In <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> wird Coarsened Exact Matching mit <code>method = "cem"</code> durchgef√ºhrt. √úber das Argument <code>cutpoints</code> geben wir an, dass <code>hours</code> in 6 Klassen und <code>age</code> in 4 Klassen eingeteilt werden soll.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> Mit <code>k1k = TRUE</code> erfolgt Eins-zu-eins-Matching: Bei mehreren exakten Matches wird die Beobachtung mit der geringsten Mahalanobis-Distanz (f√ºr die unklassierten Matching-Variablen) gew√§hlt.</p><div class="no-row-height column-margin column-container"><li id="fn6"><p><sup>6</sup>&nbsp;Diese Werte wurden ad-hoc gew√§hlt da sie zu einem guten Ergebnis f√ºhren.</p></li></div></div>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Coarsened Exact Matching</span></span>
<span><span class="va">res_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"cem"</span>, </span>
<span>  k2k <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cutpoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"hours"</span> <span class="op">=</span> <span class="fl">6</span>, </span>
<span>    <span class="st">"age"</span> <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="op">)</span></span>
<span><span class="va">res_CEM</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: Coarsened exact matching
 - number of obs.: 300 (original), 164 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance-Table Coarsened Exact Matching</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_CEM</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
         Type Diff.Adj
age   Contin.   0.0106
male   Binary   0.0000
hours Contin.  -0.0135

Sample sizes
          Control Treated
All           151     149
Matched        82      82
Unmatched      69      67</code></pre>
</div>
</div>
<p>Mit Coarsened Exact Matching erhalten wir einen Datensatz mit 82 Beobachtungen und guter Balance.</p>
</section><section id="matching-mit-der-mahalanobis-distanz" class="level3 page-columns page-full" data-number="3.2.3"><h3 data-number="3.2.3" class="anchored" data-anchor-id="matching-mit-der-mahalanobis-distanz">
<span class="header-section-number">3.2.3</span> Matching mit der Mahalanobis-Distanz</h3>
<p>Die Euklidische Distanz misst den direkten Abstand zwischen zwei Punkten und ist nicht invariant gegen√ºber Transformationen, insbesondere bei unterschiedlichen Skalierungen und bei Korrelation der Matching-Variablen. Die Mahalanobis-Distanz hingegen ist ein standardisiertes Distanzma√ü, das unter Ber√ºcksichtigung der Varianz-Kovarianz-Struktur der Daten angibt, wie viele Standardabweichungen zwei Datenpunkte voneinander entfernt sind. Die Mahalanobis-Distanz ist invariant gegen√ºber linearen Transformationen (Skalierung, Translation und Rotation) der Daten und bietet ein genaueres Ma√ü f√ºr die Un√§hnlichkeit zweier Beobachtungen hinsichtlich ihrer Auspr√§gungen der Matching-Variablen.</p>
<p>Betrachte die Datenpunkte <span class="math inline">\(P_1=(X_1,Y_1)'\)</span> und <span class="math inline">\(P_2=(X_2,Y_2)'\)</span> f√ºr die Matching-Variablen <span class="math inline">\(X\)</span> und <span class="math inline">\(Y\)</span>. Die Mahalanobis-Distanz zwischen <span class="math inline">\(P_1\)</span> und <span class="math inline">\(P_2\)</span> ist definiert als <span class="math display">\[\begin{align*}
  d_M(P_1,\,P_2) = \sqrt{(P_1 - P_2)'\boldsymbol{S}^{-1} (P_1 - P_2)},
\end{align*}\]</span> wobei <span class="math inline">\(\boldsymbol{S}\)</span> die Varianz-Kovarianz-Matrix von <span class="math inline">\(X\)</span> und <span class="math inline">\(Y\)</span> ist. Die Mahalanobis-Distanz <span class="math inline">\(d_M(\cdot,\cdot)\)</span> ist also die Euklidische Distanz zwischen den standardisierten Datenpunkten.</p>
<p>F√ºr beobachtete Daten ersetzen wir die Komponenten der Varianz-Kovarianz-Matrix durch Stichprobenma√üe. Dies ergibt die Formel</p>
<p><span class="math display">\[\begin{align*}
  \widehat{d}_M(P_1,\,P_2) = \sqrt{
  \begin{pmatrix}
    X_1 - X_2\\
    Y_1 - Y_2
  \end{pmatrix}'
  \begin{pmatrix}
    \widehat{\text{Var}}(X^2) &amp; \widehat{\text{Cov}}(X, Y) \\
     \widehat{\text{Cov}}(X, Y) &amp; \widehat{\text{Var}}(X^2)
  \end{pmatrix}^{-1}
    \begin{pmatrix}
    X_1 - X_2\\
    Y_1 - Y_2
  \end{pmatrix}
}.
\end{align*}\]</span></p>
<p>Die nachstehende interaktive Grafik zeigt Beobachtungen zweier Matching-Variablen, die aus einer bivariaten Normalverteilung mit positiver Korrelation generiert wurden. Diese bivariate Verteilung ist identisch f√ºr Beobachtungen aus der Kontrollgruppe (rot) und Beobachtungen aus der Behandlungsgruppe (blau). F√ºr die ausgew√§hlte Beobachtung aus der Behandlungsgruppe (schwarzer Rand) werden potentielle Matches in der Kontrollgruppe innerhalb der vorgegebenen Mahalanobis-Distanz in Cyan kenntlich gemacht. Beachte, dass die Mahalanobis-Distanz Varianzen und Kovarianzen der Daten ber√ºcksichtigt, sodass die gematchten Beobachtungen in einem elliptischen Bereich um die betrachtete behandelte Beobachtung liegen. Eine Euklidische Distanz hingegen (gestrichelte Linie) ignoriert die Skalierung der Daten.</p>
<iframe width="100%" height="648" frameborder="0" src="https://observablehq.com/embed/1338355035acc056@687?cells=theplot%2Cviewof+caliper%2Cstyles">
</iframe>
<p>F√ºr Eins-zu-Eins-Matching im Website-Beispiel anhand der Mahalanobis-Distanz mit <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> setzen wir <code>distance = "mahalanobis"</code> und w√§hlen <code>method = "nearest"</code>. Mit diesen Parametern wird jeder Behandlung aus der Behandlungsgruppe die gem√§√ü <span class="math inline">\(d_M\)</span> am ehesten vergleichbarste Beobachtung aus der Kontrollgruppe zugewiesen, wobei keine mehrfachen Matches zul√§ssig sind.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 1:1 Mahalanobis-Distanz-Matching</span></span>
<span><span class="va">res_maha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  distance <span class="op">=</span> <span class="st">"mahalanobis"</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_maha</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Mahalanobis
 - number of obs.: 300 (original), 298 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance-Table f√ºr 1:1 Mahalanobis-Matching</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_maha</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
         Type Diff.Adj
age   Contin.  -0.5826
male   Binary   0.3154
hours Contin.   0.0106

Sample sizes
          Control Treated
All           151     149
Matched       149     149
Unmatched       2       0</code></pre>
</div>
</div>
<p>Die Ergebnisse zeigen, dass f√ºr s√§mtliche <span class="math inline">\(149\)</span> Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden werden konnte. Es werden lediglich <span class="math inline">\(2\)</span> Beobachtungen der <span class="math inline">\(151\)</span> Beobachtungen in der Kontrollgruppe nicht gematcht.</p>
<p>Entsprechend zeigt die Balance-Table eine √§hnliche Diskrepanz beider Gruppen hinsichtlich der Matching-Variablen an.</p>
<p><strong>Mahalanobis-Distanz mit Caliper .25 f√ºr Propensity Scores basierend auf logistischer Regression</strong></p>
<p>F√ºr eine strengeres Matching-Kriterium kann ein <em>Caliper</em>, d.h. eine maximal zul√§ssige Distanz, herangezogen werden. Die Mahalanobis-Distanz hat jedoch keine einheitliche Skala: Ob eine Distanz als gro√ü oder klein betrachten werden kann, h√§ngt von der Anzahl der Matching-Variablen und dem √úberlappungsgrad zwischen den Gruppen ab. Daher wird die Beschr√§nkung durch einen Caliper nicht auf <span class="math inline">\(\widehat{d}_M\)</span> sondern auf Propensity Scores angewendet.</p>
<p>Im n√§chsten Code-Beispiel spezifizieren wir mit <code>distance = "glm"</code>, dass Propensity Scores gem√§√ü der Vorschrift in <code>formula</code> gesch√§tzt werden. Mit <code>mahvars = ~ age + male + hours</code> legen wir die Matching-Variablen f√ºr die Berechnung von <span class="math inline">\(\widehat{d}_M\)</span> fest. <code>caliper = .25</code> legt fest, dass lediglich Beobachtungen der Kontrollgruppe bei einer absoluten Differenz der Propensity Scores von h√∂chstens <span class="math inline">\(0.25\)</span> Standardabweichungen als Match f√ºr eine Beobachtung in der Behandlungsgruppe qualifiziert sind.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mahalanobis-Matchig mit PS-Caliper</span></span>
<span><span class="va">res_mahaC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  distance <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span>,</span>
<span>  mahvars <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>,</span>
<span>  caliper <span class="op">=</span> <span class="fl">.25</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_mahaC</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Mahalanobis [matching]
             Propensity score [caliper]
             - estimated with logistic regression
 - caliper: &lt;distance&gt; (0.058)
 - number of obs.: 300 (original), 208 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance Table</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_mahaC</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
             Type Diff.Adj
distance Distance   0.1812
age       Contin.  -0.1176
male       Binary   0.0481
hours     Contin.  -0.0001

Sample sizes
          Control Treated
All           151     149
Matched       104     104
Unmatched      47      45</code></pre>
</div>
</div>
<div class="page-columns page-full"><p>Die Balance-Table zeigt einen deutlichen Effekt der Beschr√§nkung qualifizierter Beobachtungen durch <code>caliper = .25</code>: Aufgrund der oberen Grenze f√ºr die Propensity-Score-Differenz von <span class="math inline">\(0.058\)</span> wird f√ºr lediglich <span class="math inline">\(104\)</span> Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> Weiterhin finden wir eine verbesserte Balance f√ºr den gematchten Datensatz.</p><div class="no-row-height column-margin column-container"><li id="fn7"><p><sup>7</sup>&nbsp;Die durch <code>caliper</code> implizierte Obergrenze ergibt sich als <code>.25 * sd(fitted(darkmode_ps_logit)))</code>.</p></li></div></div>
</section><section id="propensity-score-matching" class="level3" data-number="3.2.4"><h3 data-number="3.2.4" class="anchored" data-anchor-id="propensity-score-matching">
<span class="header-section-number">3.2.4</span> Propensity Score Matching</h3>
<p>Eine g√§ngige Variante ist Matching ausschlie√ülich anhand von Propensity Scores innerhalb eines Calipers.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 1:1 Matching mit PS und Caliper</span></span>
<span><span class="va">res_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  distance <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span>, </span>
<span>  caliper <span class="op">=</span> <span class="fl">.25</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_PSC</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Propensity score [caliper]
             - estimated with logistic regression
 - caliper: &lt;distance&gt; (0.058)
 - number of obs.: 300 (original), 208 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance Table</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_PSC</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
             Type Diff.Adj
distance Distance   0.1640
age       Contin.  -0.0976
male       Binary   0.0481
hours     Contin.   0.0134

Sample sizes
          Control Treated
All           151     149
Matched       104     104
Unmatched      47      45</code></pre>
</div>
</div>
<p>Laut Balance-Table f√ºhrt Eins-zu-Eins-Matching basierend auf Propensity Scores zu einem Datensatz mit <span class="math inline">\(104\)</span> gematchten Beobachtungen in der Behandlungsgruppe. Hinsichtlich der standardisierten Mittelwertdifferenz (<code>Diff.Adj</code>) erzielt diese Methode die beste Balance unter den betrachteten Ans√§tzen.</p>
<p><strong>Vergleich der Balance verschiedener Verfahren mit Love-Plot</strong></p>
<p>Standardisierte Mittelwertdifferenzen f√ºr verschiedene Matching-Verfahren k√∂nnen grafisch mit einem Love-Plot <span class="citation" data-cites="Love2004">(<a href="Literatur.html#ref-Love2004" role="doc-biblioref">Love 2004</a>)</span> veranschaulicht werden. Hierzu nutzen wir <code><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html">cobalt::love.plot()</a></code> und √ºbergeben die mit <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> generierten Objekte im Argument <code>weights</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Love-Plot f√ºr</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html">love.plot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    CEM <span class="op">=</span> <span class="va">res_CEM</span>,</span>
<span>    Mahalanobis <span class="op">=</span> <span class="va">res_maha</span>,</span>
<span>    Mahalanobis_Cal <span class="op">=</span> <span class="va">res_mahaC</span>,</span>
<span>    PSC <span class="op">=</span> <span class="va">res_PSC</span></span>
<span>  <span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  line <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  <span class="co"># absolute Mittelwertdifferenz plotten</span></span>
<span>  abs <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Matching_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Die Grafik zeigt, dass Coarsened Exact Matching (CEM) unter allen betrachteten Verfahren die Stichprobe mit der besten Balance ergibt. Diesen gematchten Datensatz erhalten wir mit <code><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">MatchIt::match.data()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># gematchten Datensatz zuweisen</span></span>
<span><span class="va">darkmode_matched_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">res_CEM</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">darkmode_matched_CEM</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 √ó 7
  read_time dark_mode  male   age hours weights subclass
      &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;   
1      15.4         0     1    55  125.       1 26      
2      20.9         1     0    23  643.       1 70      
3      21.5         1     0    29  190.       1 79      
4      22           1     0    18  334.       1 80      
5      17.4         0     0    53  279.       1 11      
6      20.4         0     0    43  138.       1 9       </code></pre>
</div>
</div>
<p><code>darkmode_matched</code> enth√§lt Gewichte (<code>weights</code>) f√ºr die jeweilige Gruppe zu denen gemachte Beobachtungen geh√∂ren (<code>subclass</code>). Dies ist relevant, falls Beobachtungen mehrfach gematcht werden. Wegen Eins-zu-eins-Matching <em>ohne</em> Zur√ºcklegen gibt es in unserem Beispiel 82 Beobachtungspaare und s√§mtliche Gewichte sind 1. Die Ber√ºcksichtigung der Gewicht in den nachfolgenden Aufrufen von Sch√§tzfunktionen (bspw.<code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>) ist daher nicht n√∂tig und erfolgt lediglich zur Illustration der grunds√§tzlichen Vorgehensweise.</p>
<p>Eine Wiederholung der grafischen Analyse in <a href="#sec-balance"><span>Kapitel&nbsp;3.1</span></a> zeigt eine deutlich verbesserte Vergleichbarkeit hinsichtlich der Verteilung der Matching-Variablen in <code>darkmode_matched</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_matched_CEM</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">hours</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">scale</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span> alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    facets <span class="op">=</span> <span class="op">~</span> <span class="va">name</span>, </span>
<span>    scales <span class="op">=</span> <span class="st">"free"</span>, </span>
<span>    nrow <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Matching_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_matched_CEM</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    male <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">male</span><span class="op">)</span>, </span>
<span>    dark_mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dark_mode</span>, fill <span class="op">=</span> <span class="va">male</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Anteil"</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Matching_files/figure-html/unnamed-chunk-38-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Wir beobachten eine bessere Balance bei <code>age</code> und <code>hours</code>. Inbesondere ist <code>male</code> f√ºr Kontroll- und Behandlungsgruppe ausgeglichen.</p>
</section></section><section id="sch√§tzung-und-inferenz-f√ºr-den-behandlungseffekt-nach-matching" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="sch√§tzung-und-inferenz-f√ºr-den-behandlungseffekt-nach-matching">
<span class="header-section-number">3.3</span> Sch√§tzung und Inferenz f√ºr den Behandlungseffekt nach Matching</h2>
<p>Wir sch√§tzen nun den Behandlungseffekt von <code>dark_mode</code> auf <code>read_time</code> f√ºr die mit CEM und Propensity Score Matching ermittelten Datens√§tzen und vergleichen die Ergebniss anschlie√üend mit einer Regressionssch√§tzung ohne Matching.</p>
<p>Wir kombinieren die Matching-Verfahren mit linearer Regression, d.h. wir Sch√§tzen den Behandlungseffekt anhand es gematchten Datensatzes als Mittelwertdifferenz nach zus√§tzlicher Kontrolle f√ºr die Matching-Variablen. Diese Kombination von Matching mit Regression wird in der Literatur als <em>Regression Adjustment</em> bezeichnet und ist insbesondere hilfreich, wenn Backdoors mit Matching geschlossen werden sollen, der kausale Effekt jedoch nur unter Verwendung einer nicht-trivialen Regressionsfunktion ermittelt werden kann. Zum Beispiel kann bei einer kontinuierlichen Behandlungsvariable und einem nicht-linearen Zusammenhang mit <span class="math inline">\(Y\)</span> der kausale Effekt nicht durch einen blo√üen Mittelwertvergleich erfasst werden, sondern erfordert eine ad√§quate Modellierung dieses Zusammenhangs in der Regressionsfunktion. Die zus√§tzliche Kontrolle f√ºr Matching-Variablen kann die Varianz der Sch√§tzung verringern und das Risiko einer verzerrten Sch√§tzung abmildern, falls nach Matching noch Unterschiede in der Balance von Behandlungs- und Kontrollgruppe vorliegen.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ATT mit linearem Modell sch√§tzen: CEM Datensatz</span></span>
<span><span class="va">ATT_mod_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode_matched_CEM</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">weights</span> </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ATT_mod_CEM</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ age + male + hours + dark_mode, data = darkmode_matched_CEM, 
    weights = weights)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.9310 -2.3856 -0.0194  2.5407 14.0020 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 16.6088953  1.5255529  10.887  &lt; 2e-16 ***
age          0.0380982  0.0344699   1.105  0.27072    
male        -4.0915725  0.6858131  -5.966 1.53e-08 ***
hours        0.0050129  0.0006977   7.185 2.45e-11 ***
dark_mode    1.6532234  0.6149439   2.688  0.00794 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.937 on 159 degrees of freedom
Multiple R-squared:  0.414, Adjusted R-squared:  0.3992 
F-statistic: 28.08 on 4 and 159 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz f√ºr Propensity Score Matching zuweisen</span></span>
<span><span class="va">darkmode_matched_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">res_PSC</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ATT mit linearem Modell sch√§tzen: PSM Datensatz</span></span>
<span><span class="va">ATT_mod_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode_matched_PSC</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">weights</span> </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ATT_mod_PSC</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ age + male + hours + dark_mode, data = darkmode_matched_PSC, 
    weights = weights)

Residuals:
   Min     1Q Median     3Q    Max 
-9.972 -2.605 -0.044  2.587 14.951 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 17.3654519  1.2762648  13.606  &lt; 2e-16 ***
age          0.0283941  0.0301484   0.942  0.34741    
male        -3.9858702  0.6480072  -6.151 4.03e-09 ***
hours        0.0046119  0.0006685   6.899 6.53e-11 ***
dark_mode    1.6346636  0.5769812   2.833  0.00507 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.141 on 203 degrees of freedom
Multiple R-squared:  0.3171,    Adjusted R-squared:  0.3037 
F-statistic: 23.57 on 4 and 203 DF,  p-value: 5.098e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ATT mit linearem Modell ohne Matching</span></span>
<span><span class="va">ATT_mod_org</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ATT_mod_org</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ age + male + hours + dark_mode, data = darkmode)

Residuals:
     Min       1Q   Median       3Q      Max 
-10.2697  -2.6710   0.0164   2.5909  14.5739 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 16.859075   1.082303  15.577  &lt; 2e-16 ***
age          0.051332   0.022215   2.311  0.02154 *  
male        -4.485545   0.498957  -8.990  &lt; 2e-16 ***
hours        0.004348   0.000516   8.427 1.58e-15 ***
dark_mode    1.385810   0.523793   2.646  0.00859 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.03 on 295 degrees of freedom
Multiple R-squared:  0.3434,    Adjusted R-squared:  0.3345 
F-statistic: 38.57 on 4 and 295 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Beachte, dass f√ºr die gematchten Datens√§tze jeweils ein durchschnittlicher Behandlungseffekt f√ºr die Beobachtungen <em>mit</em> erfolgter Behandlung ermittelt wird: In s√§mtlichen oben gezeigten Matchibg-Verfahren werden mit <code>estimand = "ATT"</code> vergleichbarere Kontrollbeobachtungen f√ºr die behandelten Beobachtungen ermittelt. Wir sch√§tzen den Effekt der Behandlung, indem wir die Ergebnisse von behandelten Personen mit denen von gematchten Personen vergleichen, die keine Behandlung erhalten haben. Diese Vergleichsgruppe dient als Ersatz f√ºr den hypothetischen Zustand der Behandlungsgruppe, wenn keine Behandlung erfolgt w√§re. Dies entspricht der Definition eines ATT ‚Äî ein average treatment effect <em>on the treated</em>.</p>
<section id="cluster-robuste-standardfehler" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="cluster-robuste-standardfehler">
<span class="header-section-number">3.3.1</span> Cluster-robuste Standardfehler</h3>
<p>F√ºr Matching-Verfahren sind die mit <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> berechneten Standardfehler (und damit auch Konfidenzintervalle, t-Statistiken und p-Werte) f√ºr den Behandlungseffekt <em>grunds√§tzlich ung√ºltig</em>. Je nach Matching-Verfahren liegen unterschiedliche Quellen von Sch√§tzunsicherheit vor, die bei der Berechnung von Standardfehlern zus√§tzlich zu der ‚Äú√ºblichen‚Äù Stichproben-Variabilit√§t ber√ºcksichtig werden m√ºssen. Gr√ºnde hierf√ºr sind der Matching-Prozess ansich oder weitere Unsicherheit durch die Sch√§tzung zus√§tzlicher Parameter, etwa bei der Berechnung von Propensity Scores mit logistischer Regression. Eine weiterere Ursache zus√§tzlicher Variation durch den Matching-Prozess, die wir bisher nicht n√§her betrachtet haben ensteht durch Zur√ºcklegen, d.h. wenn Beobachtungen mehrfach gematcht werden k√∂nnen. Auch dieser Faktor wird in der von <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> verwendeten Formel f√ºr den Standardfehler des Effekt-Sch√§tzers nicht ber√ºcksichtigt.</p>
<p>Standardfehlerberechnung f√ºr Matching-Sch√§tzer von Behandlungseffekten ist Gegenstand aktueller Forschung. <span class="citation" data-cites="AustinSmall2014">P. C. Austin und Small (<a href="Literatur.html#ref-AustinSmall2014" role="doc-biblioref">2014</a>)</span> und <span class="citation" data-cites="AbadieSpiess2022">Abadie und Spiess (<a href="Literatur.html#ref-AbadieSpiess2022" role="doc-biblioref">2022</a>)</span> belegen die G√ºltigkeit von cluster-robusten Standardfehlern mit Clustering auf Ebene der Beobachtungsgruppen (<code>subclass</code> im output von <code><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data()</a></code>) bei Matching ohne Zur√ºcklegen. F√ºr Matching anhand von Propensity Scores (auch mit Zur√ºcklegen) zeigen <span class="citation" data-cites="AbadieImbens2016">Imbens (<a href="Literatur.html#ref-AbadieImbens2016" role="doc-biblioref">2016</a>)</span>, dass ignorieren der zus√§tzlichen Unsicherheit durch die Sch√§tzung der Propensity Scores zu konservativer Inferenz f√ºr den ATE anhand eines cluster-robusten Standardfehlersch√§tzers f√ºhrt, jedoch ung√ºltige Inferenz f√ºr die Sch√§tzung des ATT bedeuten kann. √Ñhnlich zu <span class="citation" data-cites="AustinSmall2014">P. C. Austin und Small (<a href="Literatur.html#ref-AustinSmall2014" role="doc-biblioref">2014</a>)</span> deuten die Ergebnisse der Simulationsstudie von <span class="citation" data-cites="Bodoryetal2020">Bodory u.&nbsp;a. (<a href="Literatur.html#ref-Bodoryetal2020" role="doc-biblioref">2020</a>)</span> auf grunds√§tzlich bessere Eigenschaften der Sch√§tzung hin, wenn die Standardfehler nicht f√ºr die Sch√§tzung der Propensity Scores adjustiert werden.</p>
<p>Weiterhin ist die Kontrolle f√ºr Kovariablen mit Erkl√§rungskraft f√ºr die Outcome-Variable und f√ºr die Matching-Variablen (wie oben erfolgt) mit <em>Regression Adjustment</em> f√ºr die Sch√§tzung des Behandlungseffekts nach Matching eine etablierte Strategie, vgl. <span class="citation" data-cites="HillReiter2006">Hill und Reiter (<a href="Literatur.html#ref-HillReiter2006" role="doc-biblioref">2006</a>)</span> und <span class="citation" data-cites="AbadieSpiess2022">Abadie und Spiess (<a href="Literatur.html#ref-AbadieSpiess2022" role="doc-biblioref">2022</a>)</span>. So k√∂nnen die Varianz der Sch√§tzung und das Risiko einer Verzerrung der Standardfehler aufgrund verbleibender Imbalance von Behandlungs- und Kontrollgruppe nach Matching verringert werden.</p>
<p>Zur Demonstration von (cluster)-robuster Inferenz und f√ºr eine tabellarische Zusammenfassung der Ergebnisse nutzen wir die Pakete <code>marginaleffects</code> und <code>modelsummary</code>. Mit <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html">marginaleffects::avg_comparisons()</a></code> k√∂nnen p-Werte und Kofindenzintervalle unter Ber√ºcksichtigung von robuster Standardfehlern und der Gewichte aus dem Matching-Verfahren berechnet werden.</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inferenz: Multiple Regression, ungematchter Datensatz</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">sum_orig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">ATT_mod_org</span>,</span>
<span>    variables <span class="op">=</span> <span class="st">"dark_mode"</span>,</span>
<span>    <span class="co"># Heteroskedastie-robuste SE:</span></span>
<span>    vcov <span class="op">=</span> <span class="st">"HC3"</span>, </span>
<span>    <span class="co"># Identifizierung der Kontrollgruppe:</span></span>
<span>    newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">darkmode</span>, <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term Contrast Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %
 dark_mode    1 - 0     1.39      0.537 2.58  0.00988 6.7 0.333   2.44

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Inferenz: Multiple Regression bei CEM</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">sum_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">ATT_mod_CEM</span> ,</span>
<span>  variables <span class="op">=</span> <span class="st">"dark_mode"</span>,</span>
<span>  <span class="co"># Cluster-robuste SE</span></span>
<span>  vcov <span class="op">=</span> <span class="op">~</span> <span class="va">subclass</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">darkmode_matched_CEM</span>, <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  wts <span class="op">=</span> <span class="st">"weights"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term Contrast Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %
 dark_mode    1 - 0     1.65      0.549 3.01  0.00262 8.6 0.576   2.73

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Inferenz: Multiple Regression bei PSM</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">sum_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">ATT_mod_PSC</span> ,</span>
<span>    variables <span class="op">=</span> <span class="st">"dark_mode"</span>,</span>
<span>    vcov <span class="op">=</span> <span class="op">~</span> <span class="va">subclass</span>, </span>
<span>    newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">darkmode_matched_PSC</span>, <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    wts <span class="op">=</span> <span class="st">"weights"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term Contrast Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %
 dark_mode    1 - 0     1.63      0.565 2.89  0.00381 8.0 0.527   2.74

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
</div>
<p>Wir fassen die Ergebnisse mit <code><a href="https://modelsummary.com/reference/modelsummary.html">modelsummary::modelsummary()</a></code> tabellarisch zusammen.</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modelsummary.com">modelsummary</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Tabellarische Zusammenfassung erzeugen</span></span>
<span><span class="fu"><a href="https://modelsummary.com/reference/modelsummary.html">modelsummary</a></span><span class="op">(</span></span>
<span>  models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>   <span class="st">"Kein Matching"</span> <span class="op">=</span> <span class="va">sum_orig</span>, </span>
<span>   <span class="st">"Coarsened Exact"</span> <span class="op">=</span> <span class="va">sum_CEM</span>, </span>
<span>   <span class="st">"Propensity Scores"</span> <span class="op">=</span> <span class="va">sum_PSC</span></span>
<span>  <span class="op">)</span>,</span>
<span>  stars <span class="op">=</span> <span class="cn">T</span>, </span>
<span>  gof_map <span class="op">=</span> <span class="st">"nobs"</span>, </span>
<span>  output <span class="op">=</span> <span class="st">"gt"</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tabopts</span><span class="op">(</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="bdicezdqyx" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#bdicezdqyx table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#bdicezdqyx thead, #bdicezdqyx tbody, #bdicezdqyx tfoot, #bdicezdqyx tr, #bdicezdqyx td, #bdicezdqyx th {
  border-style: none;
}

#bdicezdqyx p {
  margin: 0;
  padding: 0;
}

#bdicezdqyx .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #000000;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bdicezdqyx .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#bdicezdqyx .gt_title {
  color: #000000;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bdicezdqyx .gt_subtitle {
  color: #000000;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bdicezdqyx .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bdicezdqyx .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bdicezdqyx .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #000000;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bdicezdqyx .gt_col_heading {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bdicezdqyx .gt_column_spanner_outer {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bdicezdqyx .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bdicezdqyx .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bdicezdqyx .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bdicezdqyx .gt_spanner_row {
  border-bottom-style: hidden;
}

#bdicezdqyx .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#bdicezdqyx .gt_empty_group_heading {
  padding: 0.5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bdicezdqyx .gt_from_md > :first-child {
  margin-top: 0;
}

#bdicezdqyx .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bdicezdqyx .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bdicezdqyx .gt_stub {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#bdicezdqyx .gt_stub_row_group {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#bdicezdqyx .gt_row_group_first td {
  border-top-width: 2px;
}

#bdicezdqyx .gt_row_group_first th {
  border-top-width: 2px;
}

#bdicezdqyx .gt_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bdicezdqyx .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#bdicezdqyx .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#bdicezdqyx .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bdicezdqyx .gt_grand_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bdicezdqyx .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bdicezdqyx .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#bdicezdqyx .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bdicezdqyx .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
}

#bdicezdqyx .gt_footnotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bdicezdqyx .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bdicezdqyx .gt_sourcenotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bdicezdqyx .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bdicezdqyx .gt_left {
  text-align: left;
}

#bdicezdqyx .gt_center {
  text-align: center;
}

#bdicezdqyx .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bdicezdqyx .gt_font_normal {
  font-weight: normal;
}

#bdicezdqyx .gt_font_bold {
  font-weight: bold;
}

#bdicezdqyx .gt_font_italic {
  font-style: italic;
}

#bdicezdqyx .gt_super {
  font-size: 65%;
}

#bdicezdqyx .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#bdicezdqyx .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#bdicezdqyx .gt_indent_1 {
  text-indent: 5px;
}

#bdicezdqyx .gt_indent_2 {
  text-indent: 10px;
}

#bdicezdqyx .gt_indent_3 {
  text-indent: 15px;
}

#bdicezdqyx .gt_indent_4 {
  text-indent: 20px;
}

#bdicezdqyx .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="gt_col_headings">
<th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=" "> </th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Kein Matching">Kein Matching</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Coarsened Exact">Coarsened Exact</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="Propensity Scores">Propensity Scores</th>
    </tr></thead>
<tbody class="gt_table_body">
<tr>
<td headers="" class="gt_row gt_left">dark_mode</td>
<td headers="Kein Matching" class="gt_row gt_center">1.386**</td>
<td headers="Coarsened Exact" class="gt_row gt_center">1.653**</td>
<td headers="Propensity Scores" class="gt_row gt_center">1.635**</td>
</tr>
<tr>
<td headers="" class="gt_row gt_left" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000;"></td>
<td headers="Kein Matching" class="gt_row gt_center" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000;">(0.537)</td>
<td headers="Coarsened Exact" class="gt_row gt_center" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000;">(0.549)</td>
<td headers="Propensity Scores" class="gt_row gt_center" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000;">(0.565)</td>
</tr>
<tr>
<td headers="" class="gt_row gt_left">Num.Obs.</td>
<td headers="Kein Matching" class="gt_row gt_center">300</td>
<td headers="Coarsened Exact" class="gt_row gt_center">164</td>
<td headers="Propensity Scores" class="gt_row gt_center">208</td>
</tr>
</tbody>
<tfoot class="gt_sourcenotes"><tr>
<td class="gt_sourcenote" colspan="4">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td>
    </tr></tfoot>
</table>
</div>
</div>
</div>
</section></section><section id="sec-bootmatching" class="level2 page-columns page-full" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="sec-bootmatching">
<span class="header-section-number">3.4</span> Bootstrap-Sch√§tzung kausaler Effekte bei Matching</h2>
<p>Ein Bootstrap-Verfahren generiert mit Resampling (wiederholtes Ziehen mit Zur√ºcklegen) aus dem Original-Datensatz (viele) k√ºnstliche Datens√§tze, f√ºr die der Sch√§tzer (d.h. das gesamte Verfahren inkl. Matching!) jeweils berechnet wird. Die Verteilung der so gewonnenen Bootstrap-Sch√§tzwerte approximiert die wahre, unbekannte Stichprobenverteilung des Sch√§tzers des Behandlungseffekts. Mit dieser simulierten Verteilung k√∂nnen wir Inferenz betreiben: Wir k√∂nnen einen Bootstrap-Punktsch√§tzer des Behandlungseffekts (Stichprobenmittel der Bootstrap-Sch√§tzungen) sowie Standardfehler (Standardabweichung der der Bootstrap-Sch√§tzungen) und p-Werte berechnen.</p>
<p>Der Bootstrap kann hilfreich sein, wenn unklar ist, wie Standardfehler f√ºr die Unsicherheit des Matching-Prozesses zu adjustieren sind, um g√ºltige Inferenzsstatistiken zu erhalten. <span class="citation" data-cites="AbadieImbens2008">Abadie und Imbens (<a href="Literatur.html#ref-AbadieImbens2008" role="doc-biblioref">2008</a>)</span> zeigen analytisch, dass der Standard-Bootstrap die Stichprobenverteilung f√ºr Sch√§tzer kausaler Effekte anhand von gematchten Datens√§tzen (d.h. bei Zuordnung/Selektion von Beobachtungen mit Matching) nicht korrekt abbilden kann. Grunds√§tzlich problematisch hierbei ist, wenn der Bootstrap eine verzerrte Sch√§tzung produziert und/oder zu kleine Standardfehler liefert. <span class="citation" data-cites="AbadieImbens2008">Abadie und Imbens (<a href="Literatur.html#ref-AbadieImbens2008" role="doc-biblioref">2008</a>)</span> belegen die Tendenz des Bootstraps zu <em>konservative</em> (d.h. zu gro√üe) Standardfehler zu produzieren. Simulationsnachweise <span class="citation" data-cites="Bodoryetal2020 HillReiter2006 AustinSmall2014 AustinStuart2017">(<a href="Literatur.html#ref-Bodoryetal2020" role="doc-biblioref">Bodory u.&nbsp;a. 2020</a>; <a href="Literatur.html#ref-HillReiter2006" role="doc-biblioref">Hill und Reiter 2006</a>; <a href="Literatur.html#ref-AustinSmall2014" role="doc-biblioref">P. C. Austin und Small 2014</a>; <a href="Literatur.html#ref-AustinStuart2017" role="doc-biblioref">P. C. Austin und Stuart 2017</a>)</span> finden, dass Bootstrap-Standardfehler u.a. bei Propensity Score Matching mit Zur√ºcklegen leicht konservativ sind somit das gew√ºnschte nominale Signifikanzniveau eines Bootstrap-Hypothesentests nicht √ºberschritten wird, weshalb der Standard-Bootstrap trotz seiner Schw√§chen in der empirischen Forschung oft angewendet wird.</p>
<p>Wir betrachen als n√§chstes einen Bootstrap-Algorithmus f√ºr Inferenz bez√ºglich eines kausalen Effekts nach Matching und demonstrieren die Sch√§tzung anhand unseres Website-Beispiels f√ºr den ATT nach Propensity-Score-Matching.</p>
<p><strong>Algorithmus: Bootstrap-Sch√§tzer f√ºr Propensity-Score-Matching</strong></p>
<ol type="1">
<li><p>Generiere eine Bootstrap-Stichprobe durch <span class="math inline">\(N\)</span> Z√ºge <em>mit Zur√ºcklegen</em> aus der <span class="math inline">\(N\)</span>-elementigen originalen Stichprobe.</p></li>
<li><p>Wende das Matching-Verfahren f√ºr die Bootstrap-Stichprobe an. Sch√§tze den Behandlungseffekt <span class="math inline">\(\beta\)</span> anhand der gematchten Stichprobe mit Regression. Speichere den Punktsch√§tzer des Behandlungseffekts <span class="math inline">\(\widehat{\beta}_b^*\)</span>.</p></li>
<li><p>F√ºrhre die Schritte 1 und 2 f√ºr <span class="math inline">\(b=1,\dots,B\)</span> aus, wobei <span class="math inline">\(B\)</span> eine hinreichend gro√üe Anzahl von Bootstrap-Replikationen ist.</p></li>
<li><p>Berechne den Bootstrap-Sch√§tzer des Behandlungseffekts <span class="math inline">\(\overline{\beta}^* = \frac{1}{B}\sum_{b=1} \widehat{\beta}_b^*\)</span> und den Standardfehler <span class="math inline">\(\text{SE}(\overline{\beta}^*) = \sqrt{\frac{1}{B-1}\sum_{b=1}^B(\widehat{\beta}_b^*-\overline{\beta}^*)^2}\)</span>. Berechne Inferenz-Statistiken mit den √ºblichen Formeln.</p></li>
</ol>
<p>Wir Implementieren nun einen Bootstrap-Sch√§tzer des ATT im Website-Beispiel f√ºr Propensity-Score-Matching. Hierzu definieren wir eine <code>R</code>-Funktion <code>boot_fun()</code> f√ºr die Schritte 1 und 2 im obigen Algorithmus.</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Funktion f√ºr Schritte 1 und 2</span></span>
<span><span class="va">boot_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>, <span class="co"># originale Stichprobe</span></span>
<span>    <span class="va">i</span>     <span class="co"># Indexmenge f. Bootstrap-Stichprobe</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Bootstrap-Stichprobe</span></span>
<span>  <span class="va">boot_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># 1:1 PS Matching</span></span>
<span>  <span class="va">match_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>    <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>    distance <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>    method <span class="op">=</span> <span class="st">"nearest"</span>, </span>
<span>    caliper <span class="op">=</span> <span class="fl">.25</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boot_data</span></span>
<span>  <span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co"># Gematchten Datensatz zuweisen</span></span>
<span>  <span class="va">darkmode_matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">match_res</span>, </span>
<span>    data <span class="op">=</span> <span class="va">boot_data</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Outcome-Modell sch√§tzen</span></span>
<span>  <span class="va">ATT_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>    data <span class="op">=</span> <span class="va">darkmode_matched</span>, </span>
<span>    weights <span class="op">=</span> <span class="va">weights</span> </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#  ATT-Sch√§tzung zur√ºckgeben</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span></span>
<span>    <span class="va">ATT_mod</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">"dark_mode"</span><span class="op">]</span>  </span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Wir berechnen nun eine Bootstrap-Sch√§tzung des ATT von <code>dark_mode</code> auf <code>readingtime</code> nach Propensity Score Matching mit einem caliper von 0.25 sowie den zugeh√∂rigen Standardfehler und ein 95%-KI mit der zuvor definierten Funktion <code>boot_fun</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"boot"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4321</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Anz. Bootstrap-Replikationen</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">999</span></span>
<span></span>
<span><span class="co"># Bootstrap durchf√ºhren</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">boot_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span><span class="va">darkmode</span>, <span class="va">boot_fun</span>, R <span class="op">=</span> <span class="va">B</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = darkmode, statistic = boot_fun, R = B)


Bootstrap Statistics :
    original      bias    std. error
t1* 1.634664 -0.08144129   0.5935746</code></pre>
</div>
</div>
<p>Den Bootstrap-Sch√§tzer des ATT sowie den Bootstrap-Standardfehler berechnen wir mit <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> und <code><a href="https://rdrr.io/r/stats/sd.html">sd()</a></code> anhand der 999 Bootstrap-Replikationen in <code>boot_out$t</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Sch√§tzer f√ºr den Treatment-Effekt</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">boot_out</span><span class="op">$</span><span class="va">t</span><span class="op">)</span> </span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.553222</code></pre>
</div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># = mean(t0) + bias = mean(Bootstrap_samples)</span></span>
<span><span class="co"># vgl. 't0 = boot_fun(darkmode, i = 1:1e3)'</span></span>
<span></span>
<span><span class="co"># Bootstrap-Standardfehler</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">boot_out</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5935746</code></pre>
</div>
</div>
<div class="page-columns page-full"><p>Ein 95%-Konfidenzintervall f√ºr den kausalen Effekt erhalten wir mit <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot::boot.ci()</a></code>.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p><div class="no-row-height column-margin column-container"><li id="fn8"><p><sup>8</sup>&nbsp;<code>type = "bca"</code> (bias-corrected accelerated) ist eine g√§ngige Implementierung f√ºr die Berechnung des Konfidenz-Intervalls.</p></li></div></div>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 95% Bootstrap-KI f√ºr den Treatment-Effekt</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span></span>
<span>  boot.out <span class="op">=</span> <span class="va">boot_out</span>, </span>
<span>  type <span class="op">=</span> <span class="st">"bca"</span>, </span>
<span>  conf <span class="op">=</span> <span class="fl">.95</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 999 bootstrap replicates

CALL : 
boot.ci(boot.out = boot_out, conf = 0.95, type = "bca")

Intervals : 
Level       BCa          
95%   ( 0.527,  2.839 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
<p>Beachte, dass der Bootstrap-Standardfehler sowie das Bootstrap-Konfidenzintervall nahe der mit <code>avg_comarisons</code> berechneten Werte f√ºr <code>sum_PSC</code> sind.</p>
<p><strong>Bootstrap-Standardfehler f√ºr IPW-Sch√§tzer des ATE</strong></p>
<p>Die obige Bootstrap-Funktion <code>boot_fun</code> kann leicht f√ºr eine Sch√§tzung des Standardfehlers f√ºr den IPW-Sch√§tzer des ATE aus <a href="#sec-PSM"><span>Kapitel&nbsp;3.1.3</span></a> angepasst werden. Statt einer Matching-Prozedur berechnen wir hierzu f√ºr <span class="math inline">\(B\)</span> Bootstrap-Stichproben den Sch√§tzer <span class="math inline">\(\widehat{\tau}^\text{IPW}\)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># IPW estimation with regression adjustment</span></span>
<span><span class="va">ipw_boot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>, </span>
<span>    <span class="va">i</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Bootstrap-Stichprobe erstellen</span></span>
<span>  <span class="va">data_boot</span>  <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Logistischee Regression</span></span>
<span>  <span class="va">glm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>,</span>
<span>    data <span class="op">=</span> <span class="va">data_boot</span>, </span>
<span>    family <span class="op">=</span> <span class="va">binomial</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Propensity Scores berechnen</span></span>
<span>  <span class="va">data_boot</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">glm_fit</span>, type <span class="op">=</span> <span class="st">'response'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Beobachtungen anhand Propensity Scores trimmen</span></span>
<span>  <span class="va">data_boot</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">ps</span>,</span>
<span>        left <span class="op">=</span> <span class="fl">.2</span>,</span>
<span>        right <span class="op">=</span> <span class="fl">.7</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># IPW berechnen</span></span>
<span>  <span class="va">data_boot</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      ipw <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">ps</span>,</span>
<span>        <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ps</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Gewichtete Mittelwerte der Gruppen   </span></span>
<span>  <span class="va">w_means</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">read_time</span>, w <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ATT-Sch√§tzwert</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">w_means</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">w_means</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>          statistic <span class="op">=</span> <span class="va">ipw_boot</span>, </span>
<span>          R <span class="op">=</span> <span class="fl">999</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Sch√§tzer und Standardfehler</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.026179</code></pre>
</div>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6823184</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 95% Bootstrap-KI f√ºr den Treatment-Effekt</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span><span class="va">b</span>, type <span class="op">=</span> <span class="st">"bca"</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 999 bootstrap replicates

CALL : 
boot.ci(boot.out = b, type = "bca")

Intervals : 
Level       BCa          
95%   ( 0.658,  3.225 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
</section><section id="doubly-robust-sch√§tzung" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="doubly-robust-sch√§tzung">
<span class="header-section-number">3.5</span> Doubly-Robust-Sch√§tzung</h2>
<p>Implementieren und berechnen Sie einen Doubly-Robust-Sch√§tzer des ATT, vgl. <span class="citation" data-cites="Wooldrige2010">Wooldridge (<a href="Literatur.html#ref-Wooldrige2010" role="doc-biblioref">2010</a>)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># IPW estimation with regression adjustment</span></span>
<span><span class="va">ipwra</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">br</span>, <span class="va">index</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">br</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># slice bootstrapped observations</span></span>
<span>    <span class="va">br</span> <span class="op">&lt;-</span> <span class="va">br</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># estimate and predict propensity score</span></span>
<span>    <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>      formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>,</span>
<span>      data <span class="op">=</span> <span class="va">br</span>, </span>
<span>      family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">br</span> <span class="op">&lt;-</span> <span class="va">br</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m</span>, type <span class="op">=</span> <span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">br</span> <span class="op">&lt;-</span> <span class="va">br</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span></span>
<span>          x <span class="op">=</span> <span class="va">ps</span>,</span>
<span>          left <span class="op">=</span> <span class="fl">.2</span>,</span>
<span>          right <span class="op">=</span> <span class="fl">.7</span></span>
<span>          <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># compute IPWs</span></span>
<span>    <span class="va">br</span> <span class="op">&lt;-</span> <span class="va">br</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        ipw <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>          <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">ps</span>,</span>
<span>          <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ps</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span><span class="co">#    Simple _ATT_ estimate:</span></span>
<span>    <span class="va">w_means</span> <span class="op">&lt;-</span> <span class="va">br</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">read_time</span>, w <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># simple diff-in-means _ATT_ estimate</span></span>
<span>     <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">w_means</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">w_means</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Do regression adjustment for _ATE_ estimate</span></span>
<span>    <span class="co"># TE prediction for whole sample based on TG model</span></span>
<span>    <span class="co"># mtreat &lt;- br %&gt;%</span></span>
<span>    <span class="co">#   filter(dark_mode == 1) %&gt;%</span></span>
<span>    <span class="co">#   lm(read_time ~ 1 + age + hours + male, data = ., weights = .$ipw) %&gt;%</span></span>
<span>    <span class="co">#   predict(newdata = br) %&gt;%</span></span>
<span>    <span class="co">#   mean()</span></span>
<span>    <span class="co"># </span></span>
<span>    <span class="co"># # TE prediction for whole sample based on CG model</span></span>
<span>    <span class="co"># mcont &lt;- br %&gt;%</span></span>
<span>    <span class="co">#   filter(dark_mode == 0) %&gt;%</span></span>
<span>    <span class="co">#   lm(read_time ~ 1 + age + hours + male, data = ., weights = .$ipw) %&gt;%</span></span>
<span>    <span class="co">#   predict(newdata = br) %&gt;%</span></span>
<span>    <span class="co">#   mean()</span></span>
<span>    <span class="co"># </span></span>
<span>    <span class="co"># return(mtreat - mcont) # Regression adjusted _ATE_ estimate</span></span>
<span><span class="op">}</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">darkmode</span>, <span class="va">ipwra</span>, R <span class="op">=</span> <span class="fl">999</span><span class="op">)</span></span>
<span><span class="co"># Bootstrap estimate and standard error</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.033055</code></pre>
</div>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6966973</code></pre>
</div>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 95% Bootstrap-KI f√ºr den Treatment-Effekt</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span><span class="va">b</span>, type <span class="op">=</span> <span class="st">"perc"</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 999 bootstrap replicates

CALL : 
boot.ci(boot.out = b, type = "perc")

Intervals : 
Level     Percentile     
95%   ( 0.600,  3.301 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-AbadieImbens2008" class="csl-entry" role="listitem">
Abadie, Alberto, und Guido W. Imbens. 2008. <span>‚ÄûOn the Failure of the Bootstrap for Matching Estimators.‚Äú</span> <em>Econometrica. Journal of the Econometric Society</em> 76 (6): 1537‚Äì57. <a href="https://doi.org/10.3982/ECTA6474">https://doi.org/10.3982/ECTA6474</a>.
</div>
<div id="ref-AbadieSpiess2022" class="csl-entry" role="listitem">
Abadie, Alberto, und Jann Spiess. 2022. <span>‚ÄûRobust Post-Matching Inference.‚Äú</span> <em>Journal of the American Statistical Association</em> 117 (538): 983‚Äì95. <a href="https://doi.org/10.1080/01621459.2020.1840383">https://doi.org/10.1080/01621459.2020.1840383</a>.
</div>
<div id="ref-Austin2011" class="csl-entry" role="listitem">
Austin, P. 2011. <span>‚ÄûAn Introduction to Propensity Score Methods for Reducing the Effects of Confounding in Observational Studies‚Äú</span>. <em>Multivariate Behavioral Research</em> 46 (3): 399‚Äì424. <a href="https://doi.org/10.1080/00273171.2011.568786">https://doi.org/10.1080/00273171.2011.568786</a>.
</div>
<div id="ref-AustinSmall2014" class="csl-entry" role="listitem">
Austin, Peter C., und Dylan S. Small. 2014. <span>‚ÄûThe use of bootstrapping when using propensity-score matching without replacement: A simulation study.‚Äú</span> <em>Statistics in Medicine</em> 33 (24): 4306‚Äì19. <a href="https://doi.org/10.1002/sim.6276">https://doi.org/10.1002/sim.6276</a>.
</div>
<div id="ref-AustinStuart2017" class="csl-entry" role="listitem">
Austin, Peter C., und Elizabeth A. Stuart. 2017. <span>‚ÄûEstimating the Effect of Treatment on Binary Outcomes Using Full Matching on the Propensity Score.‚Äú</span> <em>Statistical Methods in Medical Research</em> 26 (6): 2505‚Äì25. <a href="https://doi.org/10.1177/0962280215601134">https://doi.org/10.1177/0962280215601134</a>.
</div>
<div id="ref-Bodoryetal2020" class="csl-entry" role="listitem">
Bodory, Hugo, Lorenzo Camponovo, Martin Huber, und Michael Lechner. 2020. <span>‚ÄûThe Finite Sample Performance of Inference Methods for Propensity Score Matching and Weighting Estimators.‚Äú</span> <em>Journal of Business &amp; Economic Statistics</em>. <a href="https://doi.org/10.2139/ssrn.2731969">https://doi.org/10.2139/ssrn.2731969</a>.
</div>
<div id="ref-Hainmueller2012" class="csl-entry" role="listitem">
Hainmueller, Jens. 2012. <span>‚ÄûEntropy Balancing for Causal Effects: A Multivariate Reweighting Method to Produce Balanced Samples in Observational Studies‚Äú</span>. <em>Political Analysis</em> 20 (1): 25‚Äì46. <a href="https://doi.org/10.1093/pan/mpr025">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-Hajek1971" class="csl-entry" role="listitem">
H√°jek, J. 1971. <span>‚ÄûComment on <span>‚ÄöAn essay on the logical foundations of survey sampling‚Äò</span> by Basu, D‚Äú</span>. <em>Foundations of Statistical Inference</em> 236.
</div>
<div id="ref-HillReiter2006" class="csl-entry" role="listitem">
Hill, Jennifer, und Jerome P. Reiter. 2006. <span>‚ÄûInterval estimation for treatment effects using propensity score matching. Statistics in Medicine‚Äú</span>. <em>Statistics in Medicine</em> 25 (13): 2230‚Äì56. <a href="https://doi.org/10.1002/sim.2277">https://doi.org/10.1002/sim.2277</a>.
</div>
<div id="ref-Hiranoetal2003" class="csl-entry" role="listitem">
Hirano, Keisuke, Guido Imbens, und Geert Ridder. 2003. <span>‚ÄûEfficient Estimation of Average Treatment Effects Using the Estimated Propensity Score.‚Äú</span> <em>Econometrica</em> 71 (4): 1161‚Äì89. <a href="https://doi.org/10.1111/1468-0262.00442">https://doi.org/10.1111/1468-0262.00442</a>.
</div>
<div id="ref-AbadieImbens2016" class="csl-entry" role="listitem">
Imbens. 2016. <span>‚ÄûMatching on the Estimated Propensity Score.‚Äú</span> <em>Econometrica</em> 84 (2): 781‚Äì807. <a href="https://doi.org/10.3982/ecta11293">https://doi.org/10.3982/ecta11293</a>.
</div>
<div id="ref-Love2004" class="csl-entry" role="listitem">
Love, Thomas. 2004. <span>‚ÄûGraphical display of covariate balance‚Äú</span>. Presentation.
</div>
<div id="ref-RosenbaumRubin1983" class="csl-entry" role="listitem">
Rosenbaum, Paul R., und Donald R. Rubin. 1983. <span>‚ÄûThe central role of the propensity score in observational studies for causal effects‚Äú</span>. <em>Biometrika</em> 70 (1): 170‚Äì84. <a href="https://doi.org/10.1017/cbo9780511810725.016">https://doi.org/10.1017/cbo9780511810725.016</a>.
</div>
<div id="ref-Wooldrige2010" class="csl-entry" role="listitem">
Wooldridge, Jeffrey. 2010. <em>Econometric Analysis of Cross Section and Panel Data</em>. Second edition. Cambridge, Massachusetts: MIT.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Kopiert");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Kopiert");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./R_Einfuehrung.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistische Programmierung mit R</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./RDD.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Regression Discontiniuty Designs</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Quellcode</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb99" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span><span class="co"> </span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co">  show-startup-message: true</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co">  packages: [</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co">            'boot', </span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co">            'cobalt', </span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="co">            'marginaleffects', </span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co">            'MatchIt', </span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co">            'sandwich',</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="co">            'ggplot2'</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="co">            ]</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a><span class="fu"># Matching</span></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=F, message=FALSE}</span></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Formatierung von gt-Tabellen</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>tabopts <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(x, <span class="at">decimals =</span> <span class="dv">3</span>, <span class="at">drop_trailing_zeros =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_options</span>(<span class="at">table_body.hlines.color =</span> <span class="st">"white"</span>, </span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">column_labels.border.bottom.color =</span> <span class="st">"black"</span>, </span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>             <span class="at">column_labels.border.top.color =</span> <span class="st">"black"</span>,</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">table_body.border.bottom.color =</span> <span class="st">"black"</span>, </span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">table.border.bottom.color =</span> <span class="st">"black"</span>,</span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">column_labels.font.weight =</span> <span class="st">"bold"</span>, </span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">table.font.color =</span> <span class="st">"black"</span>, </span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>             <span class="at">table.font.size =</span> <span class="dv">16</span>)</span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a><span class="in">#| context: setup</span></span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a><span class="in">webr::install("dplyr")</span></span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a><span class="in">webr::install("tidyr")</span></span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a><span class="in"># create dataset directory</span></span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a><span class="in">dir.create("datasets")</span></span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a><span class="in"># Download the dataset</span></span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a><span class="in">download.file(</span></span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a><span class="in">    "https://raw.githubusercontent.com/mca91/kausal_data/main/darkmode.csv",</span></span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a><span class="in">    'datasets/darkmode.csv',</span></span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb99-45"><a href="#cb99-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-46"><a href="#cb99-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-47"><a href="#cb99-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb99-48"><a href="#cb99-48" aria-hidden="true" tabindex="-1"></a><span class="in">#| context: setup</span></span>
<span id="cb99-49"><a href="#cb99-49" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb99-50"><a href="#cb99-50" aria-hidden="true" tabindex="-1"></a><span class="in"># make darkmode available using read.csv for now</span></span>
<span id="cb99-51"><a href="#cb99-51" aria-hidden="true" tabindex="-1"></a><span class="in"># because there's some issue with readr::read_csv</span></span>
<span id="cb99-52"><a href="#cb99-52" aria-hidden="true" tabindex="-1"></a><span class="in"># I can't fix right now</span></span>
<span id="cb99-53"><a href="#cb99-53" aria-hidden="true" tabindex="-1"></a><span class="in">darkmode &lt;- read.csv(</span></span>
<span id="cb99-54"><a href="#cb99-54" aria-hidden="true" tabindex="-1"></a><span class="in">    file = "datasets/darkmode.csv", </span></span>
<span id="cb99-55"><a href="#cb99-55" aria-hidden="true" tabindex="-1"></a><span class="in">    colClasses = c("numeric", "logical", "numeric", "numeric", "numeric") </span></span>
<span id="cb99-56"><a href="#cb99-56" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb99-57"><a href="#cb99-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-58"><a href="#cb99-58" aria-hidden="true" tabindex="-1"></a><span class="in">options(pillar.bold = TRUE, pillar.subtle = FALSE)</span></span>
<span id="cb99-59"><a href="#cb99-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-60"><a href="#cb99-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-61"><a href="#cb99-61" aria-hidden="true" tabindex="-1"></a>In randomisierten kontrollierten Studien stellt eine randomisierte Behandlung sicher, dass die Individuen beider Gruppen im Mittel vergleichbar sind, dass hei√üt es gibt keine systematischen Unterschiede der Studiensubjekte hinsichtlich der Verteilung von Charakteristika zwischen den Gruppen. Dann ist es plausibel eine beobachtete mittlere Differenz in der Outcome-Variable alleine auf die Behandlung zur√ºckzuf√ºhren.</span>
<span id="cb99-62"><a href="#cb99-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-63"><a href="#cb99-63" aria-hidden="true" tabindex="-1"></a>In der Praxis, insbesondere in √∂konomischen Studien, sind randomisierte kontrollierte Studien aus ethischen und/oder finanziellen Gr√ºnden nicht durchf√ºhrbar. Stattdessen werden nicht-experimentelle Daten genutzt, die jedoch nur sehr selten eine Vergleichbarkeit von Behandlungs- und Kontrollgruppe gew√§hrleisten.</span>
<span id="cb99-64"><a href="#cb99-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-65"><a href="#cb99-65" aria-hidden="true" tabindex="-1"></a>In diesem Kapitel betrachten wir Methoden, die in solchen Forschungsdesigns -- bei hinreichenden Informationen √ºber die Studiensubjekte -- eine Sch√§tzung kausaler Effekte erm√∂glichen, indem eine Vergleichbarkeit von Behandlungs- und Kontrollgruppe hergestellt wird. Dies kann durch eine gezielte Gewichtung von Beobachtungen anhand invididueller Merkmale bei der Sch√§tzung des Behandlungseffekts erfolgen. Andere etablierte Methoden sch√§tzen den kausalen Effekt nach Selektion von vergleichbaren Teilmengen von Subjekten beider Gruppen aus der urspr√ºnglichen Stichprobe, sogenanntes *Matching*.</span>
<span id="cb99-66"><a href="#cb99-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-67"><a href="#cb99-67" aria-hidden="true" tabindex="-1"></a>Da *Matching* √§hnliche Beobachtungen basierend auf beobachtbaren Merkmalen vergleicht, kann die Wahrscheinlichkeit einer verzerrten Sch√§tzung des kausalen Effekt durch falsche Modellspezifikationen geringer sein als f√ºr eine Sch√§tzung des Effekts anhand multipler Regression. Weiterhin basieren Matching-Methoden nicht auf der Annahme eines linearen Zusammenhangs zwischen Kovariablen und der erkl√§renden Variable und k√∂nnen f√ºr die Sch√§tzung unterschiedlicher Spezifikationen von Behandlungseffekten herangezogen werden.</span>
<span id="cb99-68"><a href="#cb99-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-69"><a href="#cb99-69" aria-hidden="true" tabindex="-1"></a>F√ºr die G√ºltigkeit eines Sch√§tzers basierend auf *Matching* sind zwei Annahmen erforderlich.</span>
<span id="cb99-70"><a href="#cb99-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-71"><a href="#cb99-71" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>***Bedingte Unabh√§ngigkeit.*** Seien $Y^{(0)}_i$ und $Y^{(1)}_i$ potentielle Ergebnisse der Outcome-Variable $Y$ f√ºr ein Subjekt $i$ mit $B_i=0$ (keine Zuweisung zur Behandlung) beziehungsweise $B_i=1$ (Behandlung) und $X_i$ die beobachteten Kovariablen. Wir nehmen an, dass \begin{align}</span>
<span id="cb99-72"><a href="#cb99-72" aria-hidden="true" tabindex="-1"></a>      \left<span class="sc">\{</span>Y^{(0)}_i, Y^{(1)}_i\right<span class="sc">\}</span> \perp B_i\vert X_i, \label{eq:cia}</span>
<span id="cb99-73"><a href="#cb99-73" aria-hidden="true" tabindex="-1"></a>    \end{align} d.h. die Behandlungszuweisung/-selektion ist unanabh√§ngig von den potentielle Ergebnissen $Y^{(0)}_i$ und $Y^{(1)}_i$, wenn wir f√ºr die Kovariablen $X$ kontrollieren.</span>
<span id="cb99-74"><a href="#cb99-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-75"><a href="#cb99-75" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>***√úberlappung.*** F√ºr jede m√∂gliche Kombination von Kovariablen $X_i$ gibt es eine positive Wahrscheinlichkeit $&lt;1$, sowohl zur Behandlungsgruppe ($B_i = 1$) als auch zur Kontrollgruppe ($B_i = 0$) zugewiesen zu werden, \begin{align}</span>
<span id="cb99-76"><a href="#cb99-76" aria-hidden="true" tabindex="-1"></a>      0 &lt; \text{P}(B_i=1\lvert X_i) &lt; 1, \label{eq:overlap}</span>
<span id="cb99-77"><a href="#cb99-77" aria-hidden="true" tabindex="-1"></a>    \end{align} d.h. keine Beobachtung hat eine Behandlungswahrscheinlichkeit von exakt $0$ oder $1$.</span>
<span id="cb99-78"><a href="#cb99-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-79"><a href="#cb99-79" aria-hidden="true" tabindex="-1"></a>Annahme 1 stellt sicher, dass die Zuweisung zur Behandlungsgruppe nach Kontrolle f√ºr die Kovariablen $X$ als zuf√§llig betracht werden kann. Somit ist es m√∂glich den kausalen Effekt der Behandlung zu identifizieren, indem wir hinsichtlich der Kovariablen $X$ √§hnliche Subjekte (vgl. Annahme 2) aus Kontroll- und Behandlungsgruppe vergleichen.</span>
<span id="cb99-80"><a href="#cb99-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-81"><a href="#cb99-81" aria-hidden="true" tabindex="-1"></a>Annahme 2 setzt vorraus, dass es eine ausreichende √úberlappung in den Verteilungen der Kovariablen zwischen Behandlungs- und Kontrollgruppe gibt. Dann ist sichergestellt, dass f√ºr jedes Subjekt in einer Gruppe ein hinsichtlich seiner Charakteristika vergleichbares Subjekt in der anderen Gruppe geben kann, sodass ein Vergleich m√∂glich ist.</span>
<span id="cb99-82"><a href="#cb99-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-83"><a href="#cb99-83" aria-hidden="true" tabindex="-1"></a><span class="fu">## *Balance*: Vergleichbarkeit von Behandlungs- und Kontrollgruppe {#sec-balance}</span></span>
<span id="cb99-84"><a href="#cb99-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-85"><a href="#cb99-85" aria-hidden="true" tabindex="-1"></a>Der Lehrstuhl f√ºr √ñkonometrie an der Universit√§t Duisburg-Essen betreibt einen √ñkonometrie-Blog und interessiert sich f√ºr den kausalen Effekt der Einf√ºhrung eines <span class="co">[</span><span class="ot">darkmode</span><span class="co">](https://en.wikipedia.org/wiki/Wikipedia:Dark_mode)</span> auf die Verweildauer der User auf der Webseite. Die Webseite ist zwar nicht-kommerziell, hat sich allerdings insb. f√ºr die Aquise internationaler Studierender f√ºr den Studiengang MSc. Econometrics als wichtiges Marketing-Instrument erwiesen. Ein anprechendes Design wird daher als hoch-relevant erachtet.</span>
<span id="cb99-86"><a href="#cb99-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-87"><a href="#cb99-87" aria-hidden="true" tabindex="-1"></a>Idealerweise sollte der Effekt des Design-Relaunches auf die Nutzungsintensit√§t in einem kontrollierten randomisierten Experiment untersucht werden. Hierbei w√ºrden wir Nutzern zuf√§llig das neue oder das alte Design zuweisen und den Effekt als Differnz des durchschnittlichen Verweildauer f√ºr die Gruppen bestimmen. Eine solche Studie ist jedoch aus technischen und finanziellen Gr√ºnden nicht realisierbar, sodass die Auswirkungen des darkmode mit vorliegenden nicht-experimenellen Nutzungsstatistiken f√ºr die Webseite gesch√§tzt werden sollen.</span>
<span id="cb99-88"><a href="#cb99-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-89"><a href="#cb99-89" aria-hidden="true" tabindex="-1"></a>Die Nutzungsstatistiken sind im Datensatz <span class="co">[</span><span class="ot">*darkmode.csv*</span><span class="co">](https://raw.githubusercontent.com/mca91/kasa_data/main/darkmode.csv)</span> enthalten und sollen der Analyse des Effekts des darkmode (<span class="in">`dark_mode`</span>) auf die Verweildauer der Leser auf der Webseite (<span class="in">`read_time`</span>) dienen.</span>
<span id="cb99-90"><a href="#cb99-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-91"><a href="#cb99-91" aria-hidden="true" tabindex="-1"></a>@tbl-darkmode zeigt die Definitionen der Variablen in *darkmode.csv*.</span>
<span id="cb99-92"><a href="#cb99-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-93"><a href="#cb99-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = F}</span></span>
<span id="cb99-94"><a href="#cb99-94" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Variablen im Datensatz *darkmode*"</span></span>
<span id="cb99-95"><a href="#cb99-95" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-darkmode</span></span>
<span id="cb99-96"><a href="#cb99-96" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb99-97"><a href="#cb99-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variable =</span> <span class="fu">c</span>(</span>
<span id="cb99-98"><a href="#cb99-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">"read_time"</span>, </span>
<span id="cb99-99"><a href="#cb99-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dark_mode"</span>, </span>
<span id="cb99-100"><a href="#cb99-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">"male"</span>, </span>
<span id="cb99-101"><a href="#cb99-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>, </span>
<span id="cb99-102"><a href="#cb99-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours"</span></span>
<span id="cb99-103"><a href="#cb99-103" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb99-104"><a href="#cb99-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">Beschreibung =</span> <span class="fu">c</span>(</span>
<span id="cb99-105"><a href="#cb99-105" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lesezeit (Minuten/Woche)"</span>,</span>
<span id="cb99-106"><a href="#cb99-106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Indikator: Beobachtung nach Einf√ºhrung darkmode"</span>,</span>
<span id="cb99-107"><a href="#cb99-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Indikator: Individuum m√§nnlich"</span>,</span>
<span id="cb99-108"><a href="#cb99-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alter (in Jahren)"</span>,</span>
<span id="cb99-109"><a href="#cb99-109" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bisherige Verweildauer auf der Seite"</span></span>
<span id="cb99-110"><a href="#cb99-110" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-111"><a href="#cb99-111" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb99-112"><a href="#cb99-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb99-113"><a href="#cb99-113" aria-hidden="true" tabindex="-1"></a>  tabopts</span>
<span id="cb99-114"><a href="#cb99-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-115"><a href="#cb99-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-116"><a href="#cb99-116" aria-hidden="true" tabindex="-1"></a>F√ºr die Analyse lesen wir zun√§chst den Datensatz *darkmode.csv* mit <span class="in">`readr::read_csv()`</span> ein und verschaffen uns einen √úberblick √ºber die verf√ºgbaren Variablen.</span>
<span id="cb99-117"><a href="#cb99-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-118"><a href="#cb99-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb99-119"><a href="#cb99-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Paket `tidyverse` laden</span></span>
<span id="cb99-120"><a href="#cb99-120" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb99-121"><a href="#cb99-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-122"><a href="#cb99-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz 'darkmode' einlesen</span></span>
<span id="cb99-123"><a href="#cb99-123" aria-hidden="true" tabindex="-1"></a>darkmode <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb99-124"><a href="#cb99-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"datasets/darkmode.csv"</span></span>
<span id="cb99-125"><a href="#cb99-125" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-126"><a href="#cb99-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-127"><a href="#cb99-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-128"><a href="#cb99-128" aria-hidden="true" tabindex="-1"></a><span class="in">`dark_mode`</span> hat den Typ <span class="in">`logical`</span>. Mit <span class="in">`dplyr::mutate_all()`</span> k√∂nnen wir komfortabel alle Spalten in den Typ <span class="in">`numeric`</span> transformieren.</span>
<span id="cb99-129"><a href="#cb99-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-132"><a href="#cb99-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-133"><a href="#cb99-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Alle Variablen zu typ 'numeric' formatieren...</span></span>
<span id="cb99-134"><a href="#cb99-134" aria-hidden="true" tabindex="-1"></a>darkmode <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-135"><a href="#cb99-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(<span class="at">.funs =</span> as.numeric)</span>
<span id="cb99-136"><a href="#cb99-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-137"><a href="#cb99-137" aria-hidden="true" tabindex="-1"></a><span class="co"># ... und √ºberpr√ºfen</span></span>
<span id="cb99-138"><a href="#cb99-138" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(darkmode)</span>
<span id="cb99-139"><a href="#cb99-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-140"><a href="#cb99-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-141"><a href="#cb99-141" aria-hidden="true" tabindex="-1"></a>Eine naive Sch√§tzung des durchschnittlichen Behandlungseffekts (ATE) $\widehat{\tau}^{\text{naiv}}$ erhalten wir als Mittelwertdifferenz von <span class="in">`read_time`</span> f√ºr die Behandlungsgruppe (<span class="in">`dark_mode == 1`</span>) und die Kontrollgruppe (<span class="in">`dark_mode == 0`</span>) \begin{align}</span>
<span id="cb99-142"><a href="#cb99-142" aria-hidden="true" tabindex="-1"></a>  \widehat{\tau}^{\text{naiv}} = \overline{\text{read<span class="sc">\_</span>time}}_{\text{Behandlung}} - \overline{\text{read\_time}}_{\text{Kontrolle}}.\label{eq:naivATEdarkmode}</span>
<span id="cb99-143"><a href="#cb99-143" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb99-144"><a href="#cb99-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-145"><a href="#cb99-145" aria-hidden="true" tabindex="-1"></a>Diese Berechnung ist schnell mit R durchgef√ºhrt.</span>
<span id="cb99-146"><a href="#cb99-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-149"><a href="#cb99-149" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-150"><a href="#cb99-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Naiver Sch√§tzer f√ºr ATE: </span></span>
<span id="cb99-151"><a href="#cb99-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Differenz der Gruppen-Durchschnitte</span></span>
<span id="cb99-152"><a href="#cb99-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-153"><a href="#cb99-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome in Behandlungsgruppe</span></span>
<span id="cb99-154"><a href="#cb99-154" aria-hidden="true" tabindex="-1"></a>read_time_mTG <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-155"><a href="#cb99-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb99-156"><a href="#cb99-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(<span class="st">"read_time"</span>)</span>
<span id="cb99-157"><a href="#cb99-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-158"><a href="#cb99-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome in Kontrollgruppe</span></span>
<span id="cb99-159"><a href="#cb99-159" aria-hidden="true" tabindex="-1"></a>read_time_mKG <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-160"><a href="#cb99-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb99-161"><a href="#cb99-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(<span class="st">"read_time"</span>)</span>
<span id="cb99-162"><a href="#cb99-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-163"><a href="#cb99-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Mittelwert-Differenz</span></span>
<span id="cb99-164"><a href="#cb99-164" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(read_time_mTG) <span class="sc">-</span> <span class="fu">mean</span>(read_time_mKG)</span>
<span id="cb99-165"><a href="#cb99-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-166"><a href="#cb99-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-167"><a href="#cb99-167" aria-hidden="true" tabindex="-1"></a>Die Sch√§tzung ergibt einen negativen Behandlungseffekt, mit der Interpreation, dass das neue Design zu einer Reduktion der Lesezeit um etwa 0.44 Minuten pro Woche f√ºhrt. Dieses Ergebnis ist allerdings zweifelhaft, weil eine Isolierung des Behandlungseffekts aufgrund von Backdoor-Pfaden im DGP vermutlich nicht gew√§hleistet ist. Ein Indikator hierf√ºr sind systematische Unterschiede hinsichtlich von (m√∂glicherweise unbeobachtbaren) Charakteristika von Kontrollgruppe und Behandlungsgruppe.</span>
<span id="cb99-168"><a href="#cb99-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-169"><a href="#cb99-169" aria-hidden="true" tabindex="-1"></a>Da die User sich beim Aufrufen der Seite aktiv f√ºr oder gegen den das neue Design entscheiden m√ºssen (und somit selektieren, ob Sie in der Behandlungs- oder Kontrollgruppe landen), liegt wahrscheinlich *Confounding* vor: Unsere Hypothese ist zun√§chst, dass m√§nnliche User eine durchschnittlich l√§ngere Lesezeit aufweisen *und* mit gr√∂√üerer Wahrscheinlichkeit auf das neue Design wechseln als nicht-m√§nnliche Leser. Dann ist <span class="in">`male`</span> eine Backdoor-Variable. Diese Situation ist unter der Annahme, dass nur diese Faktoren den DGP bestimmen, in @fig-maleCDdarkmode dargestellt.</span>
<span id="cb99-170"><a href="#cb99-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-173"><a href="#cb99-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{dot}</span></span>
<span id="cb99-174"><a href="#cb99-174" aria-hidden="true" tabindex="-1"></a>//| fig<span class="ot">-w</span>idth: <span class="dv">4</span></span>
<span id="cb99-175"><a href="#cb99-175" aria-hidden="true" tabindex="-1"></a>//| fig-height: <span class="dv">3</span></span>
<span id="cb99-176"><a href="#cb99-176" aria-hidden="true" tabindex="-1"></a>//| fig-align: <span class="ot">'</span><span class="ss">center</span><span class="ot">'</span></span>
<span id="cb99-177"><a href="#cb99-177" aria-hidden="true" tabindex="-1"></a>//| fig<span class="ot">-c</span>ap: <span class="ot">"</span><span class="st">Backdoor durch 'male' im Website-Design-Bespiel</span><span class="ot">"</span></span>
<span id="cb99-178"><a href="#cb99-178" aria-hidden="true" tabindex="-1"></a>//| label: <span class="ot">"</span><span class="st">fig-maleCDdarkmode</span><span class="ot">"</span> </span>
<span id="cb99-179"><a href="#cb99-179" aria-hidden="true" tabindex="-1"></a>digraph {</span>
<span id="cb99-180"><a href="#cb99-180" aria-hidden="true" tabindex="-1"></a>  layout=neato</span>
<span id="cb99-181"><a href="#cb99-181" aria-hidden="true" tabindex="-1"></a>  fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span></span>
<span id="cb99-182"><a href="#cb99-182" aria-hidden="true" tabindex="-1"></a>  node [fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span>]</span>
<span id="cb99-183"><a href="#cb99-183" aria-hidden="true" tabindex="-1"></a>  edge [fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span>]</span>
<span id="cb99-184"><a href="#cb99-184" aria-hidden="true" tabindex="-1"></a>  node [shape=none];</span>
<span id="cb99-185"><a href="#cb99-185" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">4,0.5!</span><span class="ot">"</span>]</span>
<span id="cb99-186"><a href="#cb99-186" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">0,0.5!</span><span class="ot">"</span>]</span>
<span id="cb99-187"><a href="#cb99-187" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">2,-1!</span><span class="ot">"</span>]</span>
<span id="cb99-188"><a href="#cb99-188" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">green</span><span class="ot">"</span>]</span>
<span id="cb99-189"><a href="#cb99-189" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-190"><a href="#cb99-190" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-191"><a href="#cb99-191" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-192"><a href="#cb99-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-193"><a href="#cb99-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-194"><a href="#cb99-194" aria-hidden="true" tabindex="-1"></a>Der DGP in @fig-maleCDdarkmode f√ºhrt zu einer verzerrten Sch√§tzung des kausalen Effekts von <span class="in">`dark_mode`</span> auf <span class="in">`read_time`</span> mit \eqref{eq:naivATEdarkmode}, wenn das Verh√§ltnis von m√§nnlichen und nicht-m√§nnlichen Usern in Bahandlungs- und Kontrollgruppe nicht ausgeglichen ist. Wir √ºberpr√ºfen dies mit R.</span>
<span id="cb99-195"><a href="#cb99-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-198"><a href="#cb99-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-199"><a href="#cb99-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Anteile m√§nnlicher und nicht-m√§nnlicher User</span></span>
<span id="cb99-200"><a href="#cb99-200" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-201"><a href="#cb99-201" aria-hidden="true" tabindex="-1"></a>  anteile <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-202"><a href="#cb99-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span> </span>
<span id="cb99-203"><a href="#cb99-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb99-204"><a href="#cb99-204" aria-hidden="true" tabindex="-1"></a>    <span class="at">gesamt =</span> <span class="fu">n</span>(),</span>
<span id="cb99-205"><a href="#cb99-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">ant_m =</span> <span class="fu">mean</span>(male),</span>
<span id="cb99-206"><a href="#cb99-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">ant_nm =</span> <span class="dv">1</span> <span class="sc">-</span> ant_m,</span>
<span id="cb99-207"><a href="#cb99-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">anz_m =</span> <span class="fu">sum</span>(male),</span>
<span id="cb99-208"><a href="#cb99-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">anz_nm =</span> gesamt <span class="sc">-</span> anz_m</span>
<span id="cb99-209"><a href="#cb99-209" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-210"><a href="#cb99-210" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-211"><a href="#cb99-211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-212"><a href="#cb99-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-213"><a href="#cb99-213" aria-hidden="true" tabindex="-1"></a>Die Zusammenfassung <span class="in">`anteile_m`</span> zeigt, dass der Anteil m√§nnlicher User in der Behandlungsgruppe deutlich h√∂her ist als in der Kontrollgruppe.</span>
<span id="cb99-214"><a href="#cb99-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-215"><a href="#cb99-215" aria-hidden="true" tabindex="-1"></a><span class="fu">### Matching durch Gewichtung</span></span>
<span id="cb99-216"><a href="#cb99-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-217"><a href="#cb99-217" aria-hidden="true" tabindex="-1"></a>Matching eliminiert die Variation von <span class="in">`male`</span> zwischen den Gruppen. Eine M√∂glichkeit hierf√ºr ist die Gewichtung der Beobachtungen in der Kontrollgruppe entsprechend der Anteile von M√§nnern und Nicht-M√§nnern in der Behandlungsgruppe, sodass die Vergleichbarkeit mit der Behandlungsgruppe hinsichtlich des Geschlechts gew√§hrleistet ist. Dies wird in der Literatur als *Balance* bezeichnet. Der Behandlungseffekt wird dann analog zu \eqref{eq:naivATEdarkmode} gesch√§tzt.</span>
<span id="cb99-218"><a href="#cb99-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-219"><a href="#cb99-219" aria-hidden="true" tabindex="-1"></a>Die Gewichte f√ºr Beobachtungen in der Kontrollgruppe $w_i$ werden berechnet als \begin{align}</span>
<span id="cb99-220"><a href="#cb99-220" aria-hidden="true" tabindex="-1"></a>  w_i = </span>
<span id="cb99-221"><a href="#cb99-221" aria-hidden="true" tabindex="-1"></a>  \begin{cases}</span>
<span id="cb99-222"><a href="#cb99-222" aria-hidden="true" tabindex="-1"></a>    \text{ant<span class="sc">\_</span>m}_B/\text{anz\_m}_{K}, &amp; \text{falls } \text{male}_i = 1<span class="sc">\\</span></span>
<span id="cb99-223"><a href="#cb99-223" aria-hidden="true" tabindex="-1"></a>        \text{ant<span class="sc">\_</span>nm}_B/\text{anz\_nm}_{K}, &amp; \text{sonst.}<span class="sc">\\</span></span>
<span id="cb99-224"><a href="#cb99-224" aria-hidden="true" tabindex="-1"></a>  \end{cases}\label{eq:darkmodeweights}</span>
<span id="cb99-225"><a href="#cb99-225" aria-hidden="true" tabindex="-1"></a>\end{align} Anhand der Formel f√ºr einen gewichteten Durchschnitt, \begin{align}</span>
<span id="cb99-226"><a href="#cb99-226" aria-hidden="true" tabindex="-1"></a>  \overline{X}_w = \frac{\sum_i w_i \cdot X_i}{\sum_i w_i},</span>
<span id="cb99-227"><a href="#cb99-227" aria-hidden="true" tabindex="-1"></a>\end{align} berechnen wir die gewichteten Mittelwerte f√ºr <span class="in">`male`</span> und <span class="in">`read_time`</span> in der Kontrollgruppe.</span>
<span id="cb99-228"><a href="#cb99-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-231"><a href="#cb99-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-232"><a href="#cb99-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Anteile und Anzahlen aus `anteile` auslesen</span></span>
<span id="cb99-233"><a href="#cb99-233" aria-hidden="true" tabindex="-1"></a>anz_m_K <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb99-234"><a href="#cb99-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(anz_m)</span>
<span id="cb99-235"><a href="#cb99-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-236"><a href="#cb99-236" aria-hidden="true" tabindex="-1"></a>anz_nm_K <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb99-237"><a href="#cb99-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(anz_nm)</span>
<span id="cb99-238"><a href="#cb99-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-239"><a href="#cb99-239" aria-hidden="true" tabindex="-1"></a>ant_m_B <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb99-240"><a href="#cb99-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ant_m)</span>
<span id="cb99-241"><a href="#cb99-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-242"><a href="#cb99-242" aria-hidden="true" tabindex="-1"></a>ant_nm_B <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb99-243"><a href="#cb99-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ant_nm)</span>
<span id="cb99-244"><a href="#cb99-244" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-245"><a href="#cb99-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-248"><a href="#cb99-248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-249"><a href="#cb99-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Gewichtete Mittel f√ºr Kontrollgruppe berechnen</span></span>
<span id="cb99-250"><a href="#cb99-250" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-251"><a href="#cb99-251" aria-hidden="true" tabindex="-1"></a>gew_K <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-252"><a href="#cb99-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb99-253"><a href="#cb99-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(read_time, male) <span class="sc">%&gt;%</span></span>
<span id="cb99-254"><a href="#cb99-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> <span class="fu">ifelse</span>(</span>
<span id="cb99-255"><a href="#cb99-255" aria-hidden="true" tabindex="-1"></a>    male <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb99-256"><a href="#cb99-256" aria-hidden="true" tabindex="-1"></a>    ant_m_B<span class="sc">/</span>anz_m_K, </span>
<span id="cb99-257"><a href="#cb99-257" aria-hidden="true" tabindex="-1"></a>    ant_nm_B<span class="sc">/</span>anz_nm_K)</span>
<span id="cb99-258"><a href="#cb99-258" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb99-259"><a href="#cb99-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb99-260"><a href="#cb99-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">male_k =</span> <span class="fu">sum</span>(male <span class="sc">*</span> w) <span class="sc">/</span> <span class="fu">sum</span>(w),</span>
<span id="cb99-261"><a href="#cb99-261" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_read_time_wK =</span> <span class="fu">sum</span>(read_time <span class="sc">*</span> w) <span class="sc">/</span> <span class="fu">sum</span>(w)</span>
<span id="cb99-262"><a href="#cb99-262" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-263"><a href="#cb99-263" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-264"><a href="#cb99-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-265"><a href="#cb99-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-266"><a href="#cb99-266" aria-hidden="true" tabindex="-1"></a>Ein Vergleich des gewichteten Mittelwertes von <span class="in">`male`</span> in der Kontrollgruppe mit dem Mittelwert in der Behandlungsgruppe (<span class="in">`male_k`</span>) zeigt, dass die Gewichte die Variation in <span class="in">`male`</span> zwischen beiden Gruppen eliminieren, sodass die Backdoor durch <span class="in">`male`</span> geschlossen ist. Mit <span class="in">`wmean_read_time_K`</span> haben wir einen entsprechend gewichteten Mittelwert der Verweildauer f√ºr die Kontrollgruppe berechnet. Wir sch√§tzen den Behandlungseffekt nun als \begin{align}</span>
<span id="cb99-267"><a href="#cb99-267" aria-hidden="true" tabindex="-1"></a>  \widehat{\tau}^{\text{w}} = \overline{\text{read<span class="sc">\_</span>time}}_{B} - \overline{\text{read\_time}}_{w,K}.\label{eq:weightedATEdarkmode}</span>
<span id="cb99-268"><a href="#cb99-268" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb99-269"><a href="#cb99-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-272"><a href="#cb99-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-273"><a href="#cb99-273" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(read_time_mTG)  <span class="sc">-</span> gew_K<span class="sc">$</span>mean_read_time_wK</span>
<span id="cb99-274"><a href="#cb99-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-275"><a href="#cb99-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-276"><a href="#cb99-276" aria-hidden="true" tabindex="-1"></a>Entgegen der naiven Sch√§tzung andhand von \eqref{eq:naivATEdarkmode} erhalten wir nach Matching f√ºr <span class="in">`male`</span> eine positive Sch√§tzung des Behandlungseffekts von etwa $<span class="in">`r round(mean(read_time_mTG) - gew_K$mean_read_time_wK, 2)`</span>$.</span>
<span id="cb99-277"><a href="#cb99-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-278"><a href="#cb99-278" aria-hidden="true" tabindex="-1"></a>Die Sch√§tzung des Behandlungseffekts anhand von \eqref{eq:weightedATEdarkmode} entspricht dem gesch√§tzten Koeffizienten $\widehat{\beta}_1$ aus einer gewichteten KQ-Regression im Modell \begin{align*}</span>
<span id="cb99-279"><a href="#cb99-279" aria-hidden="true" tabindex="-1"></a>  \text{read<span class="sc">\_</span>time} = \beta_0 + \beta_1 \text{dark<span class="sc">\_</span>mode} + u,</span>
<span id="cb99-280"><a href="#cb99-280" aria-hidden="true" tabindex="-1"></a>\end{align*} </span>
<span id="cb99-281"><a href="#cb99-281" aria-hidden="true" tabindex="-1"></a>wobei die Beobachtungen der Kontrollgruppe wie in \eqref{eq:darkmodeweights} gewichtet werden und $w_i=1$ f√ºr Beobachtungen der Behandlungsgruppe ist. Wir √ºberpr√ºfen dies mit R.</span>
<span id="cb99-282"><a href="#cb99-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-285"><a href="#cb99-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-286"><a href="#cb99-286" aria-hidden="true" tabindex="-1"></a>darkmode_w <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-287"><a href="#cb99-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb99-288"><a href="#cb99-288" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> <span class="fu">case_when</span>(</span>
<span id="cb99-289"><a href="#cb99-289" aria-hidden="true" tabindex="-1"></a>      male <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> ant_m_B<span class="sc">/</span>anz_m_K,</span>
<span id="cb99-290"><a href="#cb99-290" aria-hidden="true" tabindex="-1"></a>      male <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> ant_nm_B<span class="sc">/</span>anz_nm_K,</span>
<span id="cb99-291"><a href="#cb99-291" aria-hidden="true" tabindex="-1"></a>      T <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb99-292"><a href="#cb99-292" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-293"><a href="#cb99-293" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb99-294"><a href="#cb99-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-295"><a href="#cb99-295" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(read_time <span class="sc">~</span> dark_mode, <span class="at">weights =</span> w, <span class="at">data =</span> darkmode_w) <span class="sc">%&gt;%</span></span>
<span id="cb99-296"><a href="#cb99-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb99-297"><a href="#cb99-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-298"><a href="#cb99-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-299"><a href="#cb99-299" aria-hidden="true" tabindex="-1"></a>Der gesch√§tzte Koeffizient von <span class="in">`dark_mode`</span> entspricht $\widehat{\tau}^w$.</span>
<span id="cb99-300"><a href="#cb99-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-301"><a href="#cb99-301" aria-hidden="true" tabindex="-1"></a>Da <span class="in">`male`</span> eine bin√§re Variable ist, reduziert sich eine Beurteilung der Vergleichbarkeit der Verteilungen von <span class="in">`male`</span> in Behandlungs- und Kontrollgruppe auf einen simplen Vergleich des M√§nneranteils beider Gruppen. In der Praxis gibt es meist eine Vielzahl potentieller Backdoor-Variablen, die zudem kontinuierlich verteilt sind. Es scheint plausibel, dass das Alter der Nutzer sowohl die Akzeptanz des Design-Updates als auch die Lesezeit beeinflusst. Die bisherige Verweildauer ist mindestens eine plausible Determinante der Lesezeit.</span>
<span id="cb99-302"><a href="#cb99-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-303"><a href="#cb99-303" aria-hidden="true" tabindex="-1"></a>Der erweiterte DGP ist in Abbildung @fig-CDdarkmode dargestellt, wobei der zus√§tzliche Backdoor-Pfad durch <span class="in">`age`</span> ebenfalls mit roten Pfeilen gekennzeichnet sind.</span>
<span id="cb99-304"><a href="#cb99-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-307"><a href="#cb99-307" aria-hidden="true" tabindex="-1"></a><span class="in">```{dot}</span></span>
<span id="cb99-308"><a href="#cb99-308" aria-hidden="true" tabindex="-1"></a>//| fig<span class="ot">-w</span>idth: <span class="dv">4</span></span>
<span id="cb99-309"><a href="#cb99-309" aria-hidden="true" tabindex="-1"></a>//| fig-height: <span class="dv">3</span></span>
<span id="cb99-310"><a href="#cb99-310" aria-hidden="true" tabindex="-1"></a>//| fig-align: <span class="ot">'</span><span class="ss">center</span><span class="ot">'</span></span>
<span id="cb99-311"><a href="#cb99-311" aria-hidden="true" tabindex="-1"></a>//| fig<span class="ot">-c</span>ap: <span class="ot">"</span><span class="st">Erweiterter DGP im Website-Design-Beispiel</span><span class="ot">"</span></span>
<span id="cb99-312"><a href="#cb99-312" aria-hidden="true" tabindex="-1"></a>//| label: <span class="ot">"</span><span class="st">fig-CDdarkmode</span><span class="ot">"</span> </span>
<span id="cb99-313"><a href="#cb99-313" aria-hidden="true" tabindex="-1"></a>digraph {</span>
<span id="cb99-314"><a href="#cb99-314" aria-hidden="true" tabindex="-1"></a>  layout=neato</span>
<span id="cb99-315"><a href="#cb99-315" aria-hidden="true" tabindex="-1"></a>  fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span></span>
<span id="cb99-316"><a href="#cb99-316" aria-hidden="true" tabindex="-1"></a>  node [fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span>]</span>
<span id="cb99-317"><a href="#cb99-317" aria-hidden="true" tabindex="-1"></a>  edge [fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span>]</span>
<span id="cb99-318"><a href="#cb99-318" aria-hidden="true" tabindex="-1"></a>  node [shape=none];</span>
<span id="cb99-319"><a href="#cb99-319" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">4,0.5!</span><span class="ot">"</span>]</span>
<span id="cb99-320"><a href="#cb99-320" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">0,0.5!</span><span class="ot">"</span>]</span>
<span id="cb99-321"><a href="#cb99-321" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">2,-1!</span><span class="ot">"</span>]</span>
<span id="cb99-322"><a href="#cb99-322" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">age</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">2,2!</span><span class="ot">"</span>]</span>
<span id="cb99-323"><a href="#cb99-323" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">hours</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">4,2!</span><span class="ot">"</span>]</span>
<span id="cb99-324"><a href="#cb99-324" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">hours</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span></span>
<span id="cb99-325"><a href="#cb99-325" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">age</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-326"><a href="#cb99-326" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">age</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-327"><a href="#cb99-327" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">green</span><span class="ot">"</span>]</span>
<span id="cb99-328"><a href="#cb99-328" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-329"><a href="#cb99-329" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-330"><a href="#cb99-330" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-331"><a href="#cb99-331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-332"><a href="#cb99-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-333"><a href="#cb99-333" aria-hidden="true" tabindex="-1"></a>Die Beurteilung der *Balance* von Kontrollgruppe und Behandlungsgruppe kann durch eine grafische Gegen√ºberstellung der empirischen Verteilungen der Kovariablen beider Gruppen erfolgen. Wir visualisieren die empirischen Verteilungen mit <span class="in">`ggplot2`</span>. Hierzu standardisieren wir <span class="in">`age`</span> und <span class="in">`hours`</span> zun√§chst mit <span class="in">`scale()`</span>.</span>
<span id="cb99-334"><a href="#cb99-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-337"><a href="#cb99-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-338"><a href="#cb99-338" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz f√ºr graphische Darstellung formatieren</span></span>
<span id="cb99-339"><a href="#cb99-339" aria-hidden="true" tabindex="-1"></a>darkmode_p <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-340"><a href="#cb99-340" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardisierung mit 'scale()'</span></span>
<span id="cb99-341"><a href="#cb99-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb99-342"><a href="#cb99-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">dark_mode =</span> <span class="fu">as_factor</span>(dark_mode),</span>
<span id="cb99-343"><a href="#cb99-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">scale</span>(age), </span>
<span id="cb99-344"><a href="#cb99-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours =</span> <span class="fu">scale</span>(hours)</span>
<span id="cb99-345"><a href="#cb99-345" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-346"><a href="#cb99-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-347"><a href="#cb99-347" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(darkmode_p)</span>
<span id="cb99-348"><a href="#cb99-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-349"><a href="#cb99-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-350"><a href="#cb99-350" aria-hidden="true" tabindex="-1"></a>F√ºr <span class="in">`age`</span> und <span class="in">`hours`</span> eignen sich die gesch√§tzten Dichtefunktionen f√ºr einen Vergleich der Verteilungen in Behandlungs- und Kontrollgruppe.</span>
<span id="cb99-351"><a href="#cb99-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-354"><a href="#cb99-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-355"><a href="#cb99-355" aria-hidden="true" tabindex="-1"></a><span class="co"># Vergleich mit Dichtesch√§tzungen</span></span>
<span id="cb99-356"><a href="#cb99-356" aria-hidden="true" tabindex="-1"></a>darkmode_p <span class="sc">%&gt;%</span></span>
<span id="cb99-357"><a href="#cb99-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dark_mode, hours, age) <span class="sc">%&gt;%</span></span>
<span id="cb99-358"><a href="#cb99-358" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in langes Format √ºberf√ºhren</span></span>
<span id="cb99-359"><a href="#cb99-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="sc">-</span>dark_mode)) <span class="sc">%&gt;%</span></span>
<span id="cb99-360"><a href="#cb99-360" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-361"><a href="#cb99-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb99-362"><a href="#cb99-362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> dark_mode)</span>
<span id="cb99-363"><a href="#cb99-363" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb99-364"><a href="#cb99-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb99-365"><a href="#cb99-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb99-366"><a href="#cb99-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">facets =</span> <span class="sc">~</span> name, </span>
<span id="cb99-367"><a href="#cb99-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free"</span>, </span>
<span id="cb99-368"><a href="#cb99-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span></span>
<span id="cb99-369"><a href="#cb99-369" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-370"><a href="#cb99-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-371"><a href="#cb99-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-372"><a href="#cb99-372" aria-hidden="true" tabindex="-1"></a>Die graphische Analyse zeigt deutliche Unterschiede in den Verteilungen von <span class="in">`age`</span> zwischen Kontroll- und Behandlungsgruppe. F√ºr einen Beurteilung mit deskriptiven Statistiken wird h√§ufig eine sogenannte *Balance Table* herangezogen. Wir berechnen diese f√ºr <span class="in">`age`</span>, <span class="in">`hours`</span> und <span class="in">`male`</span> mit <span class="in">`cobalt::bal.tab()`</span></span>
<span id="cb99-373"><a href="#cb99-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-376"><a href="#cb99-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-377"><a href="#cb99-377" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb99-378"><a href="#cb99-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-379"><a href="#cb99-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance table mit 'cobalt::bal.tab()'</span></span>
<span id="cb99-380"><a href="#cb99-380" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(</span>
<span id="cb99-381"><a href="#cb99-381" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb99-382"><a href="#cb99-382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(age, hours, male), </span>
<span id="cb99-383"><a href="#cb99-383" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat =</span> darkmode<span class="sc">$</span>dark_mode, </span>
<span id="cb99-384"><a href="#cb99-384" aria-hidden="true" tabindex="-1"></a>   <span class="co"># berechne SMD f√ºr KG und TG:</span></span>
<span id="cb99-385"><a href="#cb99-385" aria-hidden="true" tabindex="-1"></a>  <span class="at">disp =</span> <span class="st">"m"</span>, </span>
<span id="cb99-386"><a href="#cb99-386" aria-hidden="true" tabindex="-1"></a>  <span class="at">s.d.denom =</span> <span class="st">"pooled"</span></span>
<span id="cb99-387"><a href="#cb99-387" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-388"><a href="#cb99-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-389"><a href="#cb99-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-390"><a href="#cb99-390" aria-hidden="true" tabindex="-1"></a>Die Eintr√§ge <span class="in">`M.0.Un`</span> und <span class="in">`M.1.Un`</span> zeigen die jeweiligen Stichprobenmittelwerte der Variablen f√ºr Kontroll- und Behandlungsgruppe. <span class="in">`Diff.Un`</span> gibt eine standardisierte Mittelwertdifferenz $SMD$ an, wobei \begin{align*}</span>
<span id="cb99-391"><a href="#cb99-391" aria-hidden="true" tabindex="-1"></a>  SMD_j := \left(\overline{X}_{j,B} - \overline{X}_{j,K}\right) \bigg/ \sqrt{\frac{1}{2}\left(\widehat{\text{Var}}(X_{j,B}) + \widehat{\text{Var}}(X_{j,K})\right)},</span>
<span id="cb99-392"><a href="#cb99-392" aria-hidden="true" tabindex="-1"></a>\end{align*} mit Stichprobenmitteln $\overline{X}_{j,B}$ und $\overline{X}_{j,K}$ und Stichprobenvarianzen $\widehat{\text{Var}}(X_{j,B})$ und $\widehat{\text{Var}}(X_{j,K})$ f√ºr eine kontinuierliche Kovariable $j$.<span class="ot">[^matching-1]</span> Obwohl es keinen einheitlichen Schwellenwert f√ºr die standardisierte Differenz gibt, der ein erhebliches Ungleichgewicht anzeigt, gilt f√ºr kontinuierliche Variablen eine standardisierte (absolute) Differenz von weniger als $0.1$ als Hinweis auf einen vernachl√§ssigbaren Unterschied zwischen den Gruppen.</span>
<span id="cb99-393"><a href="#cb99-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-394"><a href="#cb99-394" aria-hidden="true" tabindex="-1"></a><span class="ot">[^matching-1]: </span>Siehe @Austin2011 f√ºr einen √úberblick zu Balance-Statistiken.</span>
<span id="cb99-395"><a href="#cb99-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-396"><a href="#cb99-396" aria-hidden="true" tabindex="-1"></a>Die Balance Table weist also auf einen vernachl√§ssigbaren Unterschied f√ºr <span class="in">`hours`</span> hin und best√§tigt den aus den Grafiken abgeleiteten Eindruck einer relevanten Differenzen f√ºr <span class="in">`age`</span>.</span>
<span id="cb99-397"><a href="#cb99-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-398"><a href="#cb99-398" aria-hidden="true" tabindex="-1"></a><span class="fu">### Entropy Balancing</span></span>
<span id="cb99-399"><a href="#cb99-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-400"><a href="#cb99-400" aria-hidden="true" tabindex="-1"></a>*Entropy Balancing* <span class="co">[</span><span class="ot">@Hainmueller2012</span><span class="co">]</span> ist eine weitere Methode zur Gew√§hrleistung der Vergleichbarkeit von Behandlungs- und Kontrollgruppe anhand von Gewichten. Das Verfahren nutzt Konzepte aus der <span class="co">[</span><span class="ot">Informationstheorie</span><span class="co">](https://de.wikipedia.org/wiki/Informationstheorie)</span> um die Gewichte f√ºr Subjekte in der Kontrollgruppe so anzupassen, dass die Verteilung der Matchingvariablen in der Kontrollgruppe die Verteilung in der Behandlungsgruppe m√∂glichst gut approximiert. Dies geschieht unter der Restriktion, dass bestimmte empirische Momente (meist Mittelwerte und Varianzen) der Matchingvariablen exakt √ºbereinstimmen. Mathematisch werden die Gewichte f√ºr Kontrollgruppenbeobachtungen durch Minimierung der <span class="co">[</span><span class="ot">Kullback-Leibler-Divergenz</span><span class="co">](https://de.wikipedia.org/wiki/Kullback-Leibler-Divergenz)</span> zwischen den Verteilungen gefunden, wobei die Divergenz ein Ma√ü f√ºr den Unterschied von Wahrscheinlichkeitsverteilungen ist.</span>
<span id="cb99-401"><a href="#cb99-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-402"><a href="#cb99-402" aria-hidden="true" tabindex="-1"></a>Entropy Balancing ist im R-Paket <span class="in">`WeightIt`</span> implementiert. Wir zeigen, wie die ben√∂tigten Gewichte f√ºr eine Sch√§tzungen des ATT im Website-Beispiel mit <span class="in">`WeightIt::wightit()`</span> bestimmt werden k√∂nnen. √úber das Argument <span class="in">`moments`</span> legen wir fest, dass die Gewichte unter der Restriktion √ºbereinstimmender Mittelwerte aller Matching-Variablen zwischen Behandlungs- und Kontrollgruppe erfolgen soll. </span>
<span id="cb99-403"><a href="#cb99-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-406"><a href="#cb99-406" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-407"><a href="#cb99-407" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb99-408"><a href="#cb99-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-409"><a href="#cb99-409" aria-hidden="true" tabindex="-1"></a><span class="co"># Gewichte f√ºr Entropy Balancing</span></span>
<span id="cb99-410"><a href="#cb99-410" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-411"><a href="#cb99-411" aria-hidden="true" tabindex="-1"></a>  W1 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(</span>
<span id="cb99-412"><a href="#cb99-412" aria-hidden="true" tabindex="-1"></a>  dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours,</span>
<span id="cb99-413"><a href="#cb99-413" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode,</span>
<span id="cb99-414"><a href="#cb99-414" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb99-415"><a href="#cb99-415" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb99-416"><a href="#cb99-416" aria-hidden="true" tabindex="-1"></a>  <span class="at">moments =</span> <span class="dv">1</span></span>
<span id="cb99-417"><a href="#cb99-417" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-418"><a href="#cb99-418" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb99-419"><a href="#cb99-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-420"><a href="#cb99-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-421"><a href="#cb99-421" aria-hidden="true" tabindex="-1"></a>Wir sch√§tzen den Behandlungseffekt nach Entropy Balancing mit gewichteter Regression.</span>
<span id="cb99-422"><a href="#cb99-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-425"><a href="#cb99-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-426"><a href="#cb99-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Mittelwert-Vergleich mit lm()</span></span>
<span id="cb99-427"><a href="#cb99-427" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb99-428"><a href="#cb99-428" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> dark_mode, </span>
<span id="cb99-429"><a href="#cb99-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb99-430"><a href="#cb99-430" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> W1<span class="sc">$</span>weights</span>
<span id="cb99-431"><a href="#cb99-431" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-432"><a href="#cb99-432" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span>
<span id="cb99-433"><a href="#cb99-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-434"><a href="#cb99-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-435"><a href="#cb99-435" aria-hidden="true" tabindex="-1"></a>Beachte, dass die von <span class="in">`summary()`</span> berechneten Standardfehler bei Entropy Balancing ung√ºltig sind. In Abschnitt @sec-bootmatching erl√§utern wir die Berechnung von Standardfehlern f√ºr Matching-Sch√§tzer mit dem Bootstrap.</span>
<span id="cb99-436"><a href="#cb99-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-437"><a href="#cb99-437" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mehrere Matching-Variablen und der Propensity Score {#sec-PSM}</span></span>
<span id="cb99-438"><a href="#cb99-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-439"><a href="#cb99-439" aria-hidden="true" tabindex="-1"></a>Bei mehreren Backdoor-Variablen kann eine Gewichtung anhand der Behandlungswahrscheinlichkeit (*Treatment Propensity*) erfolgen. Die Idee hierbei ist, dass der DGP wie in @fig-propCDdarkmode dargestellt werden kann.</span>
<span id="cb99-440"><a href="#cb99-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-443"><a href="#cb99-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{dot}</span></span>
<span id="cb99-444"><a href="#cb99-444" aria-hidden="true" tabindex="-1"></a>//| fig<span class="ot">-w</span>idth: <span class="dv">4</span></span>
<span id="cb99-445"><a href="#cb99-445" aria-hidden="true" tabindex="-1"></a>//| fig-height: <span class="dv">3</span></span>
<span id="cb99-446"><a href="#cb99-446" aria-hidden="true" tabindex="-1"></a>//| fig-align: <span class="ot">'</span><span class="ss">center</span><span class="ot">'</span></span>
<span id="cb99-447"><a href="#cb99-447" aria-hidden="true" tabindex="-1"></a>//| fig<span class="ot">-c</span>ap: <span class="ot">"</span><span class="st">Propensity im Website-Design-Beispiel</span><span class="ot">"</span></span>
<span id="cb99-448"><a href="#cb99-448" aria-hidden="true" tabindex="-1"></a>//| label: <span class="ot">"</span><span class="st">fig-propCDdarkmode</span><span class="ot">"</span> </span>
<span id="cb99-449"><a href="#cb99-449" aria-hidden="true" tabindex="-1"></a>digraph {</span>
<span id="cb99-450"><a href="#cb99-450" aria-hidden="true" tabindex="-1"></a>  layout=neato</span>
<span id="cb99-451"><a href="#cb99-451" aria-hidden="true" tabindex="-1"></a>  fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span></span>
<span id="cb99-452"><a href="#cb99-452" aria-hidden="true" tabindex="-1"></a>  node [fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span>]</span>
<span id="cb99-453"><a href="#cb99-453" aria-hidden="true" tabindex="-1"></a>  edge [fontname=<span class="ot">"</span><span class="st">Helvetica,Arial,sans-serif</span><span class="ot">"</span>]</span>
<span id="cb99-454"><a href="#cb99-454" aria-hidden="true" tabindex="-1"></a>  node [shape=none];</span>
<span id="cb99-455"><a href="#cb99-455" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">4,0.5!</span><span class="ot">"</span>]</span>
<span id="cb99-456"><a href="#cb99-456" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">0,0.5!</span><span class="ot">"</span>]</span>
<span id="cb99-457"><a href="#cb99-457" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">TreatmentPropensity</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">0,2!</span><span class="ot">"</span>]</span>
<span id="cb99-458"><a href="#cb99-458" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">2,-1!</span><span class="ot">"</span>]</span>
<span id="cb99-459"><a href="#cb99-459" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">age</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">2,2!</span><span class="ot">"</span>]</span>
<span id="cb99-460"><a href="#cb99-460" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">hours</span><span class="ot">"</span> [<span class="fu">pos</span>=<span class="ot">"</span><span class="st">4,2!</span><span class="ot">"</span>]</span>
<span id="cb99-461"><a href="#cb99-461" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">hours</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span></span>
<span id="cb99-462"><a href="#cb99-462" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">age</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">TreatmentPropensity</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-463"><a href="#cb99-463" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">age</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-464"><a href="#cb99-464" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">green</span><span class="ot">"</span>]</span>
<span id="cb99-465"><a href="#cb99-465" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">TreatmentPropensity</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-466"><a href="#cb99-466" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">male</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">read_time</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-467"><a href="#cb99-467" aria-hidden="true" tabindex="-1"></a>  <span class="ot">"</span><span class="st">TreatmentPropensity</span><span class="ot">"</span> -&gt; <span class="ot">"</span><span class="st">dark_mode</span><span class="ot">"</span> [color=<span class="ot">"</span><span class="st">red</span><span class="ot">"</span>]</span>
<span id="cb99-468"><a href="#cb99-468" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-469"><a href="#cb99-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-470"><a href="#cb99-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-471"><a href="#cb99-471" aria-hidden="true" tabindex="-1"></a>Hierbei beeinflussen die Backdoor-Variablen *age* und *male* die Behandlungsvariable *dark_mode* lediglich durch die Behandlungswahrscheinlichkeit *Treatment Propensity*. Diese Darstellung zeigt, das die mehrdimensionale Information bzgl. der √Ñhnlichkeit von Subjekten hinsichtlich der beobachteten Kovariablen in einer einzigen Variable zusammengefasst werden kann. Die Backdoor-Pfade k√∂nnen daher geschlossen werden, indem wir Subjekte anhand von *Treatment Propensity* derart gewichten, dass beide Gruppen hinsichtlich der Verteilung der Behandlungswahrscheinlichkeit vergleichbar sind. Betrachte erneut \eqref{eq:cia} und beachte, dass \begin{align}</span>
<span id="cb99-472"><a href="#cb99-472" aria-hidden="true" tabindex="-1"></a>  Y_i = Y_i^{(1)} D_i + Y_i^{(0)} (1-D_i).</span>
<span id="cb99-473"><a href="#cb99-473" aria-hidden="true" tabindex="-1"></a>\end{align} @RosenbaumRubin1983 zeigen, dass es hinsichtlich \eqref{eq:cia} √§quivalent ist f√ºr die *Treatment Propensity* $P_i(X_i):=P(B_i=1\vert X_i = x)$ zu kontrollieren, d.h. \begin{align}</span>
<span id="cb99-474"><a href="#cb99-474" aria-hidden="true" tabindex="-1"></a>  \left<span class="sc">\{</span>Y_i^{(1)},Y_i^{(0)}\right<span class="sc">\}</span> \perp B_i\vert X_i \quad\Leftrightarrow\quad \left<span class="sc">\{</span>Y_i^{(1)},Y_i^{(0)}\right<span class="sc">\}</span> \perp B_i\vert P_i(X_i).</span>
<span id="cb99-475"><a href="#cb99-475" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb99-476"><a href="#cb99-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-477"><a href="#cb99-477" aria-hidden="true" tabindex="-1"></a>Der Behandlungseffekt kann so als Differenz von gewichteten Gruppenmittelwerten berechnet werden, mit inversem Wahrscheinlichkeitsgewicht (IPW) $w_{i,B} = 1/P_i(X_i)$ f√ºr Beobachtungen in der Behandlungsgruppe und $w_{i,K} = 1/(1-P_i(X_i))$ f√ºr Beobachtungen in der Kontrollgruppe, \begin{align}</span>
<span id="cb99-478"><a href="#cb99-478" aria-hidden="true" tabindex="-1"></a>  \tau^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left<span class="co">[</span><span class="ot">\frac{B_i Y_i}{P_i(X_i)} - \frac{(1-B_i)Y_i}{1-P_i(X_i)} \right</span><span class="co">]</span>.\label{eq:tauipw}</span>
<span id="cb99-479"><a href="#cb99-479" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb99-480"><a href="#cb99-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-481"><a href="#cb99-481" aria-hidden="true" tabindex="-1"></a>Grunds√§tzlich ist *TreatmentPropensity* eine nicht beobachtbare Variable und muss daher aus den Daten gesch√§tzt werden. Eine gesch√§tzte Behandlungswahrscheinlichkeiten $\widehat{P}_i(X_i)$ wird als *Propensity Score* bezeichnet. In der Praxis erfolgt die Sch√§tzung von *Propensity Scores* meist mit logistischer Regression. Ein erwartungstreuer Sch√§tzer des ATE ist \begin{align}</span>
<span id="cb99-482"><a href="#cb99-482" aria-hidden="true" tabindex="-1"></a>  \widehat{\tau}^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left<span class="co">[</span><span class="ot">\frac{B_i Y_i}{\widehat{P}_i(X_i)} - \frac{(1-B_i)Y_i}{1-\widehat{P}_i(X_i)} \right</span><span class="co">]</span>.\label{eq:hattauipw}</span>
<span id="cb99-483"><a href="#cb99-483" aria-hidden="true" tabindex="-1"></a>\end{align} @Hiranoetal2003 diskutieren Alternativen zu \eqref{eq:hattauipw} f√ºr die Sch√§tzung anderer Typen von Behandlungseffekten.</span>
<span id="cb99-484"><a href="#cb99-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-485"><a href="#cb99-485" aria-hidden="true" tabindex="-1"></a>Wir sch√§tzen nachfolgend die *Propensity Scores* f√ºr unser Anwendungsbeispiel, erl√§utern die Berechnung der Gewichte sowie die Sch√§tzung von Behandlungseffekten mit gewichteter Regression. Hierbei betrachten wir eine Variante von \eqref{eq:hattauipw} mit normalisierten Gewichten $\tilde{w}_{i,B} = w_{i,B}/\sum_i w_{i,B}$ und $\tilde{w}_{i,K} = w_{i,K}/\sum_i w_{i,K}$ die sich jeweils zu 1 summieren.<span class="ot">[^matching-2]</span> Dies ergibt den H√°jek-Sch√§tzer<span class="ot">[^matching-3]</span> \begin{align}</span>
<span id="cb99-486"><a href="#cb99-486" aria-hidden="true" tabindex="-1"></a>    \widehat{\tau}_N^{\text{IPW}} = \frac{\sum_i\tilde{w}_{i,B}Y_i}{\sum_i\tilde{w}_{i,B}} -  \frac{\sum_i\tilde{w}_{i,K}Y_i}{\sum_i\tilde{w}_{i,K}}.\label{eq:hattauhajek}</span>
<span id="cb99-487"><a href="#cb99-487" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb99-488"><a href="#cb99-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-489"><a href="#cb99-489" aria-hidden="true" tabindex="-1"></a><span class="ot">[^matching-2]: </span>Eine Normalisierung der Gewichte reduziert die Varianz des Sch√§tzers, vgl. @Hiranoetal2003</span>
<span id="cb99-490"><a href="#cb99-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-491"><a href="#cb99-491" aria-hidden="true" tabindex="-1"></a><span class="ot">[^matching-3]: </span>Siehe @Hajek1971.</span>
<span id="cb99-492"><a href="#cb99-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-493"><a href="#cb99-493" aria-hidden="true" tabindex="-1"></a>Zun√§chst Sch√§tzen wir ein logistisches Regressionsmodell mit <span class="in">`age`</span>, <span class="in">`male`</span> und <span class="in">`hours`</span> als erkl√§rende Variablen f√ºr <span class="in">`dark_mode`</span>.</span>
<span id="cb99-494"><a href="#cb99-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-497"><a href="#cb99-497" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-498"><a href="#cb99-498" aria-hidden="true" tabindex="-1"></a><span class="co"># Logit-Modell mit 'glm()' sch√§tzen</span></span>
<span id="cb99-499"><a href="#cb99-499" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-500"><a href="#cb99-500" aria-hidden="true" tabindex="-1"></a>  darkmode_ps_logit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb99-501"><a href="#cb99-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours,</span>
<span id="cb99-502"><a href="#cb99-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> darkmode,</span>
<span id="cb99-503"><a href="#cb99-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial</span>
<span id="cb99-504"><a href="#cb99-504" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-505"><a href="#cb99-505" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-506"><a href="#cb99-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-507"><a href="#cb99-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-508"><a href="#cb99-508" aria-hidden="true" tabindex="-1"></a>Die *Propensity Scores* erhalten wir als angepasste Werte aus der Regression <span class="in">`darkmode_ps_logit`</span> mit <span class="in">`fitted()`</span>. Wir erweitern den Datensatz mit den Ergebnissen.</span>
<span id="cb99-509"><a href="#cb99-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-512"><a href="#cb99-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-513"><a href="#cb99-513" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz um Propensity Scores erweitern</span></span>
<span id="cb99-514"><a href="#cb99-514" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-515"><a href="#cb99-515" aria-hidden="true" tabindex="-1"></a>  darkmode_probs <span class="ot">&lt;-</span> </span>
<span id="cb99-516"><a href="#cb99-516" aria-hidden="true" tabindex="-1"></a>    darkmode <span class="sc">%&gt;%</span></span>
<span id="cb99-517"><a href="#cb99-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb99-518"><a href="#cb99-518" aria-hidden="true" tabindex="-1"></a>      <span class="at">PS =</span> <span class="fu">fitted</span>(darkmode_ps_logit)</span>
<span id="cb99-519"><a href="#cb99-519" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-520"><a href="#cb99-520" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-521"><a href="#cb99-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-522"><a href="#cb99-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-523"><a href="#cb99-523" aria-hidden="true" tabindex="-1"></a>Zur Beurteilung der √úberlappung (vgl. Annahme \eqref{eq:overlap} k√∂nnen wir die Verteilung der *Propensity Scores* nach Behandlungs-Indikator mit Histogrammen visualisieren.</span>
<span id="cb99-524"><a href="#cb99-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-527"><a href="#cb99-527" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-528"><a href="#cb99-528" aria-hidden="true" tabindex="-1"></a><span class="co"># √úberlappung pr√ºfen:</span></span>
<span id="cb99-529"><a href="#cb99-529" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogramme der PS nach Treatment-Indikator</span></span>
<span id="cb99-530"><a href="#cb99-530" aria-hidden="true" tabindex="-1"></a>darkmode_probs <span class="sc">%&gt;%</span></span>
<span id="cb99-531"><a href="#cb99-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb99-532"><a href="#cb99-532" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb99-533"><a href="#cb99-533" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> PS, </span>
<span id="cb99-534"><a href="#cb99-534" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="fu">factor</span>(dark_mode)</span>
<span id="cb99-535"><a href="#cb99-535" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-536"><a href="#cb99-536" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb99-537"><a href="#cb99-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb99-538"><a href="#cb99-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>, </span>
<span id="cb99-539"><a href="#cb99-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">25</span>, </span>
<span id="cb99-540"><a href="#cb99-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span></span>
<span id="cb99-541"><a href="#cb99-541" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-542"><a href="#cb99-542" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-543"><a href="#cb99-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-544"><a href="#cb99-544" aria-hidden="true" tabindex="-1"></a>Ein Vergleich der Histogramme zeigt, dass die √úberlappung der *Propensity Scores* in der linken Flanken der Verteilungen der Kontrollgruppe und in der rechten Flanke der Behandlungsgruppe schlechter wird. Wir entfernen zun√§chst Beobachtungen aus der Stichprobe deren *Propensity Scores* wenig bzw. keine √úberlappung aufweisen.</span>
<span id="cb99-545"><a href="#cb99-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-548"><a href="#cb99-548" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-549"><a href="#cb99-549" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz nach PS trimmen</span></span>
<span id="cb99-550"><a href="#cb99-550" aria-hidden="true" tabindex="-1"></a>darkmode_probs <span class="ot">&lt;-</span> darkmode_probs <span class="sc">%&gt;%</span> </span>
<span id="cb99-551"><a href="#cb99-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb99-552"><a href="#cb99-552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(</span>
<span id="cb99-553"><a href="#cb99-553" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> PS,</span>
<span id="cb99-554"><a href="#cb99-554" aria-hidden="true" tabindex="-1"></a>      <span class="at">left =</span> .<span class="dv">25</span>,</span>
<span id="cb99-555"><a href="#cb99-555" aria-hidden="true" tabindex="-1"></a>      <span class="at">right =</span> .<span class="dv">75</span></span>
<span id="cb99-556"><a href="#cb99-556" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-557"><a href="#cb99-557" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-558"><a href="#cb99-558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-559"><a href="#cb99-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-562"><a href="#cb99-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-563"><a href="#cb99-563" aria-hidden="true" tabindex="-1"></a><span class="co"># √úberlappung nach trimming pr√ºfen:</span></span>
<span id="cb99-564"><a href="#cb99-564" aria-hidden="true" tabindex="-1"></a><span class="co"># Dichtesch√§tzung der PS nach Treatment-Indikator</span></span>
<span id="cb99-565"><a href="#cb99-565" aria-hidden="true" tabindex="-1"></a>darkmode_probs <span class="sc">%&gt;%</span></span>
<span id="cb99-566"><a href="#cb99-566" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb99-567"><a href="#cb99-567" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb99-568"><a href="#cb99-568" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> PS, </span>
<span id="cb99-569"><a href="#cb99-569" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">factor</span>(dark_mode))</span>
<span id="cb99-570"><a href="#cb99-570" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb99-571"><a href="#cb99-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb99-572"><a href="#cb99-572" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>, </span>
<span id="cb99-573"><a href="#cb99-573" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">25</span>, </span>
<span id="cb99-574"><a href="#cb99-574" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span></span>
<span id="cb99-575"><a href="#cb99-575" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-576"><a href="#cb99-576" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-577"><a href="#cb99-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-578"><a href="#cb99-578" aria-hidden="true" tabindex="-1"></a>IPWs anhand der *Propensity Scores* k√∂nnen schnell mit der Vorschrift \begin{align}</span>
<span id="cb99-579"><a href="#cb99-579" aria-hidden="true" tabindex="-1"></a>  \text{IPW} = \frac{\text{dark<span class="sc">\_</span>mode}}{\text{PS}} + \frac{1 - \text{dark<span class="sc">\_</span>mode}}{1 - \text{PS}},</span>
<span id="cb99-580"><a href="#cb99-580" aria-hidden="true" tabindex="-1"></a>\end{align} berechnet werden.</span>
<span id="cb99-581"><a href="#cb99-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-584"><a href="#cb99-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-585"><a href="#cb99-585" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz um IPWs erweitern</span></span>
<span id="cb99-586"><a href="#cb99-586" aria-hidden="true" tabindex="-1"></a>darkmode_IPW <span class="ot">&lt;-</span> darkmode_probs <span class="sc">%&gt;%</span></span>
<span id="cb99-587"><a href="#cb99-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb99-588"><a href="#cb99-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">IPW =</span> dark_mode <span class="sc">/</span> PS <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> dark_mode) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> PS)</span>
<span id="cb99-589"><a href="#cb99-589" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-590"><a href="#cb99-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-591"><a href="#cb99-591" aria-hidden="true" tabindex="-1"></a>darkmode_IPW <span class="sc">%&gt;%</span> </span>
<span id="cb99-592"><a href="#cb99-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(IPW)</span>
<span id="cb99-593"><a href="#cb99-593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-594"><a href="#cb99-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-595"><a href="#cb99-595" aria-hidden="true" tabindex="-1"></a>Eine Sch√§tzung des durchschnittlichen Behandlungseffekts gem√§√ü \eqref{eq:hattauhajek} implementieren wir mit <span class="in">`dplyr`</span>.</span>
<span id="cb99-596"><a href="#cb99-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-599"><a href="#cb99-599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-600"><a href="#cb99-600" aria-hidden="true" tabindex="-1"></a>darkmode_IPW <span class="sc">%&gt;%</span></span>
<span id="cb99-601"><a href="#cb99-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span></span>
<span id="cb99-602"><a href="#cb99-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> IPW <span class="sc">/</span> <span class="fu">sum</span>(IPW)) <span class="sc">%&gt;%</span></span>
<span id="cb99-603"><a href="#cb99-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">weighted_mean =</span> <span class="fu">sum</span>(read_time <span class="sc">*</span> w)) <span class="sc">%&gt;%</span></span>
<span id="cb99-604"><a href="#cb99-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">diff =</span> <span class="fu">diff</span>(weighted_mean))</span>
<span id="cb99-605"><a href="#cb99-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-606"><a href="#cb99-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-607"><a href="#cb99-607" aria-hidden="true" tabindex="-1"></a>Diese Sch√§tzung des Behandlungseffekts ist √§quivalent zur gewichteten KQ-Sch√§tzung anhand eines einfachen linearen Regressionsmodells.</span>
<span id="cb99-608"><a href="#cb99-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-611"><a href="#cb99-611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-612"><a href="#cb99-612" aria-hidden="true" tabindex="-1"></a><span class="co"># Mit IPWs gewichteter KQ-Schaetzer berechnet den ATE</span></span>
<span id="cb99-613"><a href="#cb99-613" aria-hidden="true" tabindex="-1"></a>model_ipw <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb99-614"><a href="#cb99-614" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> dark_mode, </span>
<span id="cb99-615"><a href="#cb99-615" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode_IPW,</span>
<span id="cb99-616"><a href="#cb99-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> IPW</span>
<span id="cb99-617"><a href="#cb99-617" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-618"><a href="#cb99-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-619"><a href="#cb99-619" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_ipw)</span>
<span id="cb99-620"><a href="#cb99-620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-621"><a href="#cb99-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-622"><a href="#cb99-622" aria-hidden="true" tabindex="-1"></a>Unsere Sch√§tzung des ATE ist der gesch√§tzte Koeffizient von <span class="in">`dark_mode`</span>. Die ausgegebenen Standardfehler und Inferenzstatistiken sind jedoch *ung√ºltig* aufgrund der Gewichtung mit IPWs, den inversen *gesch√§tzten* Wahrscheinlichkeiten f√ºr eine Behandlung. Der Grund hierf√ºr ist, dass die Berechnung der Standardfehler in `summary()` die zus√§tzliche Unsicherheit durch die gesch√§tzen *Propensity Scores* nicht ber√ºcksichtigt! Sp√§ter im Kapitel erl√§utern wir die Berechnung g√ºltiger Standardfehler f√ºr IPW-Sch√§tzer basierend auf *Propensity Scores* mit dem Bootstrap.</span>
<span id="cb99-623"><a href="#cb99-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-624"><a href="#cb99-624" aria-hidden="true" tabindex="-1"></a><span class="fu">## Selektierende Matching-Verfahren</span></span>
<span id="cb99-625"><a href="#cb99-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-626"><a href="#cb99-626" aria-hidden="true" tabindex="-1"></a>Das grunds√§tzliche Konzept von selektierendem Matching wird in der nachstehenden interaktiven Grafik veranschaulicht. Hier betrachten wir beobachtete Auspr√§gungen von zwei (unabh√§ngig und identisch verteilten) Matching-Variablen f√ºr Subjekte in der Behandlungsgruppe (blau) sowie Kontrollgruppe (rot). Per Klick auf eine Beobachtung werden Matches aus der anderen Gruppe in cyan farblich kenntlich gemacht. Als Matches z√§hlen s√§mtliche Beobachtungen der anderen Gruppe, deren <span class="co">[</span><span class="ot">Euklidische Distanz</span><span class="co">](https://de.wikipedia.org/wiki/Euklidischer_Abstand)</span> zu dem ausgew√§hlten Punkt das √ºber den Slider eingestellte Maximum *Caliper* nicht √ºberschreitet.^<span class="co">[</span><span class="ot">Es handelt sich hierbei um einen Spezialfall von Matching anhand der Mahalanobis-Distanz.</span><span class="co">]</span> Diese Region wird durch den gestrichelten Kreis gekennzeichnet. Die Grafik illustriert inbesondere, dass Beobachtungen mehrfach (s.g. Matching mit zur√ºcklegen) oder gar nicht gematcht werden k√∂nnen.</span>
<span id="cb99-627"><a href="#cb99-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-628"><a href="#cb99-628" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;iframe</span> <span class="er">width</span><span class="ot">=</span><span class="st">"100%"</span> <span class="er">height</span><span class="ot">=</span><span class="st">"629"</span> <span class="er">frameborder</span><span class="ot">=</span><span class="st">"0"</span> <span class="er">src</span><span class="ot">=</span><span class="st">"https://observablehq.com/embed/62067a02a72c9f90?cells=theplot%2Cviewof+caliper%2Cstyles"</span><span class="kw">&gt;</span></span>
<span id="cb99-629"><a href="#cb99-629" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/iframe&gt;</span></span>
<span id="cb99-630"><a href="#cb99-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-631"><a href="#cb99-631" aria-hidden="true" tabindex="-1"></a>F√ºr die nachfolgenden Code-Beispiele verwenden wir das R-Paket <span class="in">`MatchIt`</span>. <span class="in">`MatchIt::matchit()`</span> nutzt standardm√§√üig Eins-zu-Eins-Matching (ohne Zur√ºcklegen) von Beobachtungen der Treatment-Gruppe mit Beobachtungen der Kontrollgruppe.^<span class="co">[</span><span class="ot">Dieses Schema zielt auf eine Sch√§tzung des ATT ab.</span><span class="co">]</span> Die f√ºr das Matching zu verwendenden Variablen werden √ºber das Argument <span class="in">`formula`</span> als Funktion des Behandlungsindikators definiert. <span class="in">`matchit()`</span> bereitet das Objekt f√ºr eine Sch√§tzung des ATT mit einer geeigneten Funktionen, s. <span class="in">`?matchit`</span> und hier insb. die Erl√§uterungen der Argumente <span class="in">`replace = F`</span>, <span class="in">`ratio = 1`</span> und <span class="in">`estimand = "ATT"`</span> f√ºr Details. Mit <span class="in">`cobalt::balt.tab()`</span> erhalten wir eine *balance table* f√ºr den gematchten Datensatz.</span>
<span id="cb99-632"><a href="#cb99-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-633"><a href="#cb99-633" aria-hidden="true" tabindex="-1"></a>Wir zeigen als n√§chstes, wie <span class="in">`MatchIt::matchit()`</span> f√ºr Matching anhand der Regressoren <span class="in">`age`</span>, <span class="in">`hours`</span>, und <span class="in">`male`</span> in unserem Website-Beispiel f√ºr unterschiedliche Varianten durchgef√ºhrt werden kann.</span>
<span id="cb99-634"><a href="#cb99-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-635"><a href="#cb99-635" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exaktes Matching </span></span>
<span id="cb99-636"><a href="#cb99-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-637"><a href="#cb99-637" aria-hidden="true" tabindex="-1"></a>Exaktes Matching ordnet einem Subjekt aus der Behandlungsgruppe ein oder mehrere Subjekte aus der Kontrollgruppe zu, wenn die boebachteten Auspr√§gung der Matching-Variablen *exakt* √ºbereinstimmen. Hierbei muss die 'Distanz' zwischen den Auspr√§gung der Matching-Variablen folglich $0$ sein. Dieses Verfahren findet meist bei ausschlie√ülich diskret verteilten Merkmalen Anwendung. Bei kontinuierlich verteilten Merkmalen (vgl. die obige interaktive Grafik) sind exakte Matches zwar theoretisch unm√∂glich, ergeben sich jedoch in der Praxis aus der Datenerfassung, bspw. durch Rundungsfehler. In <span class="in">`matchit()`</span> erhalten wir exaktes Ein-zu-eins-Matching mit <span class="in">`method = "exact"`</span>.</span>
<span id="cb99-638"><a href="#cb99-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-639"><a href="#cb99-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, error=TRUE}</span></span>
<span id="cb99-640"><a href="#cb99-640" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb99-641"><a href="#cb99-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-642"><a href="#cb99-642" aria-hidden="true" tabindex="-1"></a><span class="co"># Exaktes Eins-zu-Eins-Matching durchf√ºhren</span></span>
<span id="cb99-643"><a href="#cb99-643" aria-hidden="true" tabindex="-1"></a>res_em <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb99-644"><a href="#cb99-644" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb99-645"><a href="#cb99-645" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode,</span>
<span id="cb99-646"><a href="#cb99-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb99-647"><a href="#cb99-647" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"exact"</span></span>
<span id="cb99-648"><a href="#cb99-648" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-649"><a href="#cb99-649" aria-hidden="true" tabindex="-1"></a>res_em</span>
<span id="cb99-650"><a href="#cb99-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-651"><a href="#cb99-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-652"><a href="#cb99-652" aria-hidden="true" tabindex="-1"></a>Aufgrund der kontinulierliche Verteilten Variable <span class="in">`hours`</span> gibt es in unserem Website-Beispiel keine exakten Matches. Dieses Verfahren ist hier folglich ungeeignet.</span>
<span id="cb99-653"><a href="#cb99-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-654"><a href="#cb99-654" aria-hidden="true" tabindex="-1"></a><span class="fu">### Coarsened Exact Matching</span></span>
<span id="cb99-655"><a href="#cb99-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-656"><a href="#cb99-656" aria-hidden="true" tabindex="-1"></a>Bei dieser Methode werden kontinuierliche Matching-Variablen grob (Engl. *coarse*) klassiert, √§hnlich wie bei einem Histogram. Diese Diskretisierung erm√∂glicht es exakte √úbereinstimmungen zwischen Behandlungs- und Kontrollgruppenbeobachtungen hinsichtlich ihrer klassierten Auspr√§gungen zu finden. Sowohl Behandlungs- als auch Kontrollbeobachtungen die mindestents einen exakten Match haben, werden Teil des gematchten Datensatzes. In <span class="in">`matchit()`</span> wird Coarsened Exact Matching mit <span class="in">`method = "cem"`</span> durchgef√ºhrt. √úber das Argument <span class="in">`cutpoints`</span> geben wir an, dass <span class="in">`hours`</span> in 6 Klassen und <span class="in">`age`</span> in 4 Klassen eingeteilt werden soll.^<span class="co">[</span><span class="ot">Diese Werte wurden ad-hoc gew√§hlt da sie zu einem guten Ergebnis f√ºhren.</span><span class="co">]</span> Mit <span class="in">`k1k = TRUE`</span> erfolgt Eins-zu-eins-Matching: Bei mehreren exakten Matches wird die Beobachtung mit der geringsten Mahalanobis-Distanz (f√ºr die unklassierten Matching-Variablen) gew√§hlt.</span>
<span id="cb99-657"><a href="#cb99-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-660"><a href="#cb99-660" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-661"><a href="#cb99-661" aria-hidden="true" tabindex="-1"></a><span class="co"># Coarsened Exact Matching</span></span>
<span id="cb99-662"><a href="#cb99-662" aria-hidden="true" tabindex="-1"></a>res_CEM <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb99-663"><a href="#cb99-663" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb99-664"><a href="#cb99-664" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb99-665"><a href="#cb99-665" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb99-666"><a href="#cb99-666" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cem"</span>, </span>
<span id="cb99-667"><a href="#cb99-667" aria-hidden="true" tabindex="-1"></a>  <span class="at">k2k =</span> <span class="cn">TRUE</span>,</span>
<span id="cb99-668"><a href="#cb99-668" aria-hidden="true" tabindex="-1"></a>  <span class="at">cutpoints =</span> <span class="fu">list</span>(</span>
<span id="cb99-669"><a href="#cb99-669" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours"</span> <span class="ot">=</span> <span class="dv">6</span>, </span>
<span id="cb99-670"><a href="#cb99-670" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span> <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb99-671"><a href="#cb99-671" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb99-672"><a href="#cb99-672" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-673"><a href="#cb99-673" aria-hidden="true" tabindex="-1"></a>res_CEM</span>
<span id="cb99-674"><a href="#cb99-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-675"><a href="#cb99-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-678"><a href="#cb99-678" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-679"><a href="#cb99-679" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance-Table Coarsened Exact Matching</span></span>
<span id="cb99-680"><a href="#cb99-680" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_CEM)</span>
<span id="cb99-681"><a href="#cb99-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-682"><a href="#cb99-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-683"><a href="#cb99-683" aria-hidden="true" tabindex="-1"></a>Mit Coarsened Exact Matching erhalten wir einen Datensatz mit 82 Beobachtungen und guter Balance.</span>
<span id="cb99-684"><a href="#cb99-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-685"><a href="#cb99-685" aria-hidden="true" tabindex="-1"></a><span class="fu">### Matching mit der Mahalanobis-Distanz</span></span>
<span id="cb99-686"><a href="#cb99-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-687"><a href="#cb99-687" aria-hidden="true" tabindex="-1"></a>Die Euklidische Distanz misst den direkten Abstand zwischen zwei Punkten und ist nicht invariant gegen√ºber Transformationen, insbesondere bei unterschiedlichen Skalierungen und bei Korrelation der Matching-Variablen. Die Mahalanobis-Distanz hingegen ist ein standardisiertes Distanzma√ü, das unter Ber√ºcksichtigung der Varianz-Kovarianz-Struktur der Daten angibt, wie viele Standardabweichungen zwei Datenpunkte voneinander entfernt sind. Die Mahalanobis-Distanz ist invariant gegen√ºber linearen Transformationen (Skalierung, Translation und Rotation) der Daten und bietet ein genaueres Ma√ü f√ºr die Un√§hnlichkeit zweier Beobachtungen hinsichtlich ihrer Auspr√§gungen der Matching-Variablen. </span>
<span id="cb99-688"><a href="#cb99-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-689"><a href="#cb99-689" aria-hidden="true" tabindex="-1"></a>Betrachte die Datenpunkte $P_1=(X_1,Y_1)'$ und $P_2=(X_2,Y_2)'$ f√ºr die Matching-Variablen $X$ und $Y$. Die Mahalanobis-Distanz zwischen $P_1$ und $P_2$ ist definiert als</span>
<span id="cb99-690"><a href="#cb99-690" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb99-691"><a href="#cb99-691" aria-hidden="true" tabindex="-1"></a>  d_M(P_1,\,P_2) = \sqrt{(P_1 - P_2)'\boldsymbol{S}^{-1} (P_1 - P_2)},</span>
<span id="cb99-692"><a href="#cb99-692" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb99-693"><a href="#cb99-693" aria-hidden="true" tabindex="-1"></a>wobei $\boldsymbol{S}$ die Varianz-Kovarianz-Matrix von $X$ und $Y$ ist. Die Mahalanobis-Distanz $d_M(\cdot,\cdot)$ ist also die Euklidische Distanz zwischen den standardisierten Datenpunkten.</span>
<span id="cb99-694"><a href="#cb99-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-695"><a href="#cb99-695" aria-hidden="true" tabindex="-1"></a>F√ºr beobachtete Daten ersetzen wir die Komponenten der Varianz-Kovarianz-Matrix durch  Stichprobenma√üe. Dies ergibt die Formel</span>
<span id="cb99-696"><a href="#cb99-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-697"><a href="#cb99-697" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb99-698"><a href="#cb99-698" aria-hidden="true" tabindex="-1"></a>  \widehat{d}_M(P_1,\,P_2) = \sqrt{</span>
<span id="cb99-699"><a href="#cb99-699" aria-hidden="true" tabindex="-1"></a>  \begin{pmatrix}</span>
<span id="cb99-700"><a href="#cb99-700" aria-hidden="true" tabindex="-1"></a>    X_1 - X_2<span class="sc">\\</span></span>
<span id="cb99-701"><a href="#cb99-701" aria-hidden="true" tabindex="-1"></a>    Y_1 - Y_2</span>
<span id="cb99-702"><a href="#cb99-702" aria-hidden="true" tabindex="-1"></a>  \end{pmatrix}'</span>
<span id="cb99-703"><a href="#cb99-703" aria-hidden="true" tabindex="-1"></a>  \begin{pmatrix}</span>
<span id="cb99-704"><a href="#cb99-704" aria-hidden="true" tabindex="-1"></a>    \widehat{\text{Var}}(X^2) &amp; \widehat{\text{Cov}}(X, Y) <span class="sc">\\</span></span>
<span id="cb99-705"><a href="#cb99-705" aria-hidden="true" tabindex="-1"></a>     \widehat{\text{Cov}}(X, Y) &amp; \widehat{\text{Var}}(X^2) </span>
<span id="cb99-706"><a href="#cb99-706" aria-hidden="true" tabindex="-1"></a>  \end{pmatrix}^{-1}</span>
<span id="cb99-707"><a href="#cb99-707" aria-hidden="true" tabindex="-1"></a>    \begin{pmatrix}</span>
<span id="cb99-708"><a href="#cb99-708" aria-hidden="true" tabindex="-1"></a>    X_1 - X_2<span class="sc">\\</span></span>
<span id="cb99-709"><a href="#cb99-709" aria-hidden="true" tabindex="-1"></a>    Y_1 - Y_2</span>
<span id="cb99-710"><a href="#cb99-710" aria-hidden="true" tabindex="-1"></a>  \end{pmatrix}</span>
<span id="cb99-711"><a href="#cb99-711" aria-hidden="true" tabindex="-1"></a>}.</span>
<span id="cb99-712"><a href="#cb99-712" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb99-713"><a href="#cb99-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-714"><a href="#cb99-714" aria-hidden="true" tabindex="-1"></a>Die nachstehende interaktive Grafik zeigt Beobachtungen zweier Matching-Variablen, die aus einer bivariaten Normalverteilung mit positiver Korrelation generiert wurden. Diese bivariate Verteilung ist identisch f√ºr Beobachtungen aus der Kontrollgruppe (rot) und Beobachtungen aus der Behandlungsgruppe (blau). F√ºr die ausgew√§hlte Beobachtung aus der Behandlungsgruppe (schwarzer Rand) werden potentielle Matches in der Kontrollgruppe innerhalb der vorgegebenen Mahalanobis-Distanz in Cyan kenntlich gemacht. Beachte, dass die Mahalanobis-Distanz Varianzen und Kovarianzen der Daten ber√ºcksichtigt, sodass die gematchten Beobachtungen in einem elliptischen Bereich um die betrachtete behandelte Beobachtung liegen. Eine Euklidische Distanz hingegen (gestrichelte Linie) ignoriert die Skalierung der Daten.</span>
<span id="cb99-715"><a href="#cb99-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-716"><a href="#cb99-716" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;iframe</span> <span class="er">width</span><span class="ot">=</span><span class="st">"100%"</span> <span class="er">height</span><span class="ot">=</span><span class="st">"648"</span> <span class="er">frameborder</span><span class="ot">=</span><span class="st">"0"</span></span>
<span id="cb99-717"><a href="#cb99-717" aria-hidden="true" tabindex="-1"></a><span class="ot">  src=</span><span class="st">"https://observablehq.com/embed/1338355035acc056@687?cells=theplot%2Cviewof+caliper%2Cstyles"</span><span class="kw">&gt;&lt;/iframe&gt;</span></span>
<span id="cb99-718"><a href="#cb99-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-719"><a href="#cb99-719" aria-hidden="true" tabindex="-1"></a>F√ºr Eins-zu-Eins-Matching im Website-Beispiel anhand der Mahalanobis-Distanz mit <span class="in">`matchit()`</span> setzen wir <span class="in">`distance = "mahalanobis"`</span> und w√§hlen <span class="in">`method = "nearest"`</span>. Mit diesen Parametern wird jeder Behandlung aus der Behandlungsgruppe die gem√§√ü $d_M$ am ehesten vergleichbarste Beobachtung aus der Kontrollgruppe zugewiesen, wobei keine mehrfachen Matches zul√§ssig sind. </span>
<span id="cb99-720"><a href="#cb99-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-723"><a href="#cb99-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-724"><a href="#cb99-724" aria-hidden="true" tabindex="-1"></a><span class="co"># 1:1 Mahalanobis-Distanz-Matching</span></span>
<span id="cb99-725"><a href="#cb99-725" aria-hidden="true" tabindex="-1"></a>res_maha <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb99-726"><a href="#cb99-726" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb99-727"><a href="#cb99-727" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb99-728"><a href="#cb99-728" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb99-729"><a href="#cb99-729" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"mahalanobis"</span>, </span>
<span id="cb99-730"><a href="#cb99-730" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"nearest"</span></span>
<span id="cb99-731"><a href="#cb99-731" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-732"><a href="#cb99-732" aria-hidden="true" tabindex="-1"></a>res_maha</span>
<span id="cb99-733"><a href="#cb99-733" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-734"><a href="#cb99-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-737"><a href="#cb99-737" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-738"><a href="#cb99-738" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance-Table f√ºr 1:1 Mahalanobis-Matching</span></span>
<span id="cb99-739"><a href="#cb99-739" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_maha)</span>
<span id="cb99-740"><a href="#cb99-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-741"><a href="#cb99-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-742"><a href="#cb99-742" aria-hidden="true" tabindex="-1"></a>Die Ergebnisse zeigen, dass f√ºr s√§mtliche $149$ Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden werden konnte. Es werden lediglich $2$ Beobachtungen der $151$ Beobachtungen in der Kontrollgruppe nicht gematcht.</span>
<span id="cb99-743"><a href="#cb99-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-744"><a href="#cb99-744" aria-hidden="true" tabindex="-1"></a>Entsprechend zeigt die Balance-Table eine √§hnliche Diskrepanz beider Gruppen hinsichtlich der Matching-Variablen an.</span>
<span id="cb99-745"><a href="#cb99-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-746"><a href="#cb99-746" aria-hidden="true" tabindex="-1"></a>**Mahalanobis-Distanz mit Caliper .25 f√ºr Propensity Scores basierend auf logistischer Regression**</span>
<span id="cb99-747"><a href="#cb99-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-748"><a href="#cb99-748" aria-hidden="true" tabindex="-1"></a>F√ºr eine strengeres Matching-Kriterium kann ein *Caliper*, d.h. eine maximal zul√§ssige Distanz, herangezogen werden. Die Mahalanobis-Distanz hat jedoch keine einheitliche Skala: Ob eine Distanz als gro√ü oder klein betrachten werden kann, h√§ngt von der Anzahl der Matching-Variablen und dem √úberlappungsgrad zwischen den Gruppen ab. Daher wird die Beschr√§nkung durch einen Caliper nicht auf $\widehat{d}_M$ sondern auf Propensity Scores angewendet.</span>
<span id="cb99-749"><a href="#cb99-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-750"><a href="#cb99-750" aria-hidden="true" tabindex="-1"></a>Im n√§chsten Code-Beispiel spezifizieren wir mit <span class="in">`distance = "glm"`</span>, dass Propensity Scores gem√§√ü der Vorschrift in <span class="in">`formula`</span> gesch√§tzt werden. Mit <span class="in">`mahvars = ~ age + male + hours`</span> legen wir die Matching-Variablen f√ºr die Berechnung von $\widehat{d}_M$ fest. <span class="in">`caliper = .25`</span> legt fest, dass lediglich Beobachtungen der Kontrollgruppe bei einer absoluten Differenz der Propensity Scores von h√∂chstens $0.25$ Standardabweichungen als Match f√ºr eine Beobachtung in der Behandlungsgruppe qualifiziert sind.</span>
<span id="cb99-751"><a href="#cb99-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-754"><a href="#cb99-754" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-755"><a href="#cb99-755" aria-hidden="true" tabindex="-1"></a><span class="co"># Mahalanobis-Matchig mit PS-Caliper</span></span>
<span id="cb99-756"><a href="#cb99-756" aria-hidden="true" tabindex="-1"></a>res_mahaC <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb99-757"><a href="#cb99-757" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb99-758"><a href="#cb99-758" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb99-759"><a href="#cb99-759" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"glm"</span>,</span>
<span id="cb99-760"><a href="#cb99-760" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb99-761"><a href="#cb99-761" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb99-762"><a href="#cb99-762" aria-hidden="true" tabindex="-1"></a>  <span class="at">mahvars =</span> <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours,</span>
<span id="cb99-763"><a href="#cb99-763" aria-hidden="true" tabindex="-1"></a>  <span class="at">caliper =</span> .<span class="dv">25</span></span>
<span id="cb99-764"><a href="#cb99-764" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-765"><a href="#cb99-765" aria-hidden="true" tabindex="-1"></a>res_mahaC</span>
<span id="cb99-766"><a href="#cb99-766" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-767"><a href="#cb99-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-770"><a href="#cb99-770" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-771"><a href="#cb99-771" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance Table</span></span>
<span id="cb99-772"><a href="#cb99-772" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_mahaC)</span>
<span id="cb99-773"><a href="#cb99-773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-774"><a href="#cb99-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-775"><a href="#cb99-775" aria-hidden="true" tabindex="-1"></a>Die Balance-Table zeigt einen deutlichen Effekt der Beschr√§nkung qualifizierter Beobachtungen durch <span class="in">`caliper = .25`</span>: Aufgrund der oberen Grenze f√ºr die Propensity-Score-Differenz von $<span class="in">`r round(.25 * sd(fitted(darkmode_ps_logit)), 3)`</span>$ wird f√ºr lediglich $104$ Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden.^<span class="co">[</span><span class="ot">Die durch `caliper` implizierte Obergrenze ergibt sich als `.25 * sd(fitted(darkmode_ps_logit)))`.</span><span class="co">]</span> Weiterhin finden wir eine verbesserte Balance f√ºr den gematchten Datensatz.</span>
<span id="cb99-776"><a href="#cb99-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-777"><a href="#cb99-777" aria-hidden="true" tabindex="-1"></a><span class="fu">### Propensity Score Matching</span></span>
<span id="cb99-778"><a href="#cb99-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-779"><a href="#cb99-779" aria-hidden="true" tabindex="-1"></a>Eine g√§ngige Variante ist Matching ausschlie√ülich anhand von Propensity Scores innerhalb eines Calipers. </span>
<span id="cb99-780"><a href="#cb99-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-783"><a href="#cb99-783" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-784"><a href="#cb99-784" aria-hidden="true" tabindex="-1"></a><span class="co"># 1:1 Matching mit PS und Caliper</span></span>
<span id="cb99-785"><a href="#cb99-785" aria-hidden="true" tabindex="-1"></a>res_PSC <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb99-786"><a href="#cb99-786" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb99-787"><a href="#cb99-787" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb99-788"><a href="#cb99-788" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb99-789"><a href="#cb99-789" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"glm"</span>, </span>
<span id="cb99-790"><a href="#cb99-790" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"nearest"</span>, </span>
<span id="cb99-791"><a href="#cb99-791" aria-hidden="true" tabindex="-1"></a>  <span class="at">caliper =</span> .<span class="dv">25</span></span>
<span id="cb99-792"><a href="#cb99-792" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-793"><a href="#cb99-793" aria-hidden="true" tabindex="-1"></a>res_PSC</span>
<span id="cb99-794"><a href="#cb99-794" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-795"><a href="#cb99-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-798"><a href="#cb99-798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-799"><a href="#cb99-799" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance Table</span></span>
<span id="cb99-800"><a href="#cb99-800" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_PSC)</span>
<span id="cb99-801"><a href="#cb99-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-802"><a href="#cb99-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-803"><a href="#cb99-803" aria-hidden="true" tabindex="-1"></a>Laut Balance-Table f√ºhrt Eins-zu-Eins-Matching basierend auf Propensity Scores zu einem Datensatz mit $104$ gematchten Beobachtungen in der Behandlungsgruppe. Hinsichtlich der standardisierten Mittelwertdifferenz (<span class="in">`Diff.Adj`</span>) erzielt diese Methode die beste Balance unter den betrachteten Ans√§tzen.</span>
<span id="cb99-804"><a href="#cb99-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-805"><a href="#cb99-805" aria-hidden="true" tabindex="-1"></a>**Vergleich der Balance verschiedener Verfahren mit Love-Plot**</span>
<span id="cb99-806"><a href="#cb99-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-807"><a href="#cb99-807" aria-hidden="true" tabindex="-1"></a>Standardisierte Mittelwertdifferenzen f√ºr verschiedene Matching-Verfahren k√∂nnen grafisch mit einem Love-Plot <span class="co">[</span><span class="ot">@Love2004</span><span class="co">]</span> veranschaulicht werden. Hierzu nutzen wir <span class="in">`cobalt::love.plot()`</span> und √ºbergeben die mit <span class="in">`matchit()`</span> generierten Objekte im Argument <span class="in">`weights`</span>.</span>
<span id="cb99-808"><a href="#cb99-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-811"><a href="#cb99-811" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-812"><a href="#cb99-812" aria-hidden="true" tabindex="-1"></a><span class="co"># Love-Plot f√ºr</span></span>
<span id="cb99-813"><a href="#cb99-813" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(</span>
<span id="cb99-814"><a href="#cb99-814" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb99-815"><a href="#cb99-815" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="fu">list</span>(</span>
<span id="cb99-816"><a href="#cb99-816" aria-hidden="true" tabindex="-1"></a>    <span class="at">CEM =</span> res_CEM,</span>
<span id="cb99-817"><a href="#cb99-817" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mahalanobis =</span> res_maha,</span>
<span id="cb99-818"><a href="#cb99-818" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mahalanobis_Cal =</span> res_mahaC,</span>
<span id="cb99-819"><a href="#cb99-819" aria-hidden="true" tabindex="-1"></a>    <span class="at">PSC =</span> res_PSC</span>
<span id="cb99-820"><a href="#cb99-820" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb99-821"><a href="#cb99-821" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb99-822"><a href="#cb99-822" aria-hidden="true" tabindex="-1"></a>  <span class="at">line =</span> T,</span>
<span id="cb99-823"><a href="#cb99-823" aria-hidden="true" tabindex="-1"></a>  <span class="co"># absolute Mittelwertdifferenz plotten</span></span>
<span id="cb99-824"><a href="#cb99-824" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs =</span> T</span>
<span id="cb99-825"><a href="#cb99-825" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-826"><a href="#cb99-826" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-827"><a href="#cb99-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-828"><a href="#cb99-828" aria-hidden="true" tabindex="-1"></a>Die Grafik zeigt, dass Coarsened Exact Matching (CEM) unter allen betrachteten Verfahren die Stichprobe mit der besten Balance ergibt. Diesen gematchten Datensatz erhalten wir mit <span class="in">`MatchIt::match.data()`</span>.</span>
<span id="cb99-829"><a href="#cb99-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-832"><a href="#cb99-832" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-833"><a href="#cb99-833" aria-hidden="true" tabindex="-1"></a><span class="co"># gematchten Datensatz zuweisen</span></span>
<span id="cb99-834"><a href="#cb99-834" aria-hidden="true" tabindex="-1"></a>darkmode_matched_CEM <span class="ot">&lt;-</span> <span class="fu">match.data</span>(res_CEM)</span>
<span id="cb99-835"><a href="#cb99-835" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(darkmode_matched_CEM)</span>
<span id="cb99-836"><a href="#cb99-836" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-837"><a href="#cb99-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-838"><a href="#cb99-838" aria-hidden="true" tabindex="-1"></a><span class="in">`darkmode_matched`</span> enth√§lt Gewichte (<span class="in">`weights`</span>) f√ºr die jeweilige Gruppe zu denen gemachte Beobachtungen geh√∂ren (<span class="in">`subclass`</span>). Dies ist relevant, falls Beobachtungen mehrfach gematcht werden. Wegen Eins-zu-eins-Matching _ohne_ Zur√ºcklegen gibt es in unserem Beispiel <span class="in">`r length(unique(darkmode_matched_CEM$subclass))`</span> Beobachtungspaare und s√§mtliche Gewichte sind 1. Die Ber√ºcksichtigung der Gewicht in den nachfolgenden Aufrufen von Sch√§tzfunktionen (bspw.<span class="in">`lm()`</span>) ist daher nicht n√∂tig und erfolgt lediglich zur Illustration der grunds√§tzlichen Vorgehensweise.</span>
<span id="cb99-839"><a href="#cb99-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-840"><a href="#cb99-840" aria-hidden="true" tabindex="-1"></a>Eine Wiederholung der grafischen Analyse in @sec-balance zeigt eine deutlich verbesserte Vergleichbarkeit hinsichtlich der Verteilung der Matching-Variablen in <span class="in">`darkmode_matched`</span>.</span>
<span id="cb99-841"><a href="#cb99-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-842"><a href="#cb99-842" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message = F}</span></span>
<span id="cb99-843"><a href="#cb99-843" aria-hidden="true" tabindex="-1"></a>darkmode_matched_CEM <span class="sc">%&gt;%</span></span>
<span id="cb99-844"><a href="#cb99-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span></span>
<span id="cb99-845"><a href="#cb99-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, hours) <span class="sc">%&gt;%</span></span>
<span id="cb99-846"><a href="#cb99-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(scale) <span class="sc">%&gt;%</span></span>
<span id="cb99-847"><a href="#cb99-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="sc">-</span>dark_mode)) <span class="sc">%&gt;%</span></span>
<span id="cb99-848"><a href="#cb99-848" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-849"><a href="#cb99-849" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb99-850"><a href="#cb99-850" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> <span class="fu">as.factor</span>(dark_mode))</span>
<span id="cb99-851"><a href="#cb99-851" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb99-852"><a href="#cb99-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>( <span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb99-853"><a href="#cb99-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb99-854"><a href="#cb99-854" aria-hidden="true" tabindex="-1"></a>    <span class="at">facets =</span> <span class="sc">~</span> name, </span>
<span id="cb99-855"><a href="#cb99-855" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free"</span>, </span>
<span id="cb99-856"><a href="#cb99-856" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">3</span></span>
<span id="cb99-857"><a href="#cb99-857" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-858"><a href="#cb99-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-859"><a href="#cb99-859" aria-hidden="true" tabindex="-1"></a>darkmode_matched_CEM <span class="sc">%&gt;%</span> </span>
<span id="cb99-860"><a href="#cb99-860" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span></span>
<span id="cb99-861"><a href="#cb99-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb99-862"><a href="#cb99-862" aria-hidden="true" tabindex="-1"></a>    <span class="at">male =</span> <span class="fu">as.factor</span>(male), </span>
<span id="cb99-863"><a href="#cb99-863" aria-hidden="true" tabindex="-1"></a>    <span class="at">dark_mode =</span> <span class="fu">as.factor</span>(dark_mode)</span>
<span id="cb99-864"><a href="#cb99-864" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb99-865"><a href="#cb99-865" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-866"><a href="#cb99-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb99-867"><a href="#cb99-867" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> dark_mode, <span class="at">fill =</span> male)</span>
<span id="cb99-868"><a href="#cb99-868" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb99-869"><a href="#cb99-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">position =</span> <span class="st">"fill"</span>) <span class="sc">+</span></span>
<span id="cb99-870"><a href="#cb99-870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Anteil"</span>)</span>
<span id="cb99-871"><a href="#cb99-871" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-872"><a href="#cb99-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-873"><a href="#cb99-873" aria-hidden="true" tabindex="-1"></a>Wir beobachten eine bessere Balance bei <span class="in">`age`</span> und <span class="in">`hours`</span>. Inbesondere ist <span class="in">`male`</span> f√ºr Kontroll- und Behandlungsgruppe ausgeglichen.</span>
<span id="cb99-874"><a href="#cb99-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-875"><a href="#cb99-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-876"><a href="#cb99-876" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sch√§tzung und Inferenz f√ºr den Behandlungseffekt nach Matching</span></span>
<span id="cb99-877"><a href="#cb99-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-878"><a href="#cb99-878" aria-hidden="true" tabindex="-1"></a>Wir sch√§tzen nun den Behandlungseffekt von <span class="in">`dark_mode`</span> auf <span class="in">`read_time`</span> f√ºr die mit CEM und Propensity Score Matching ermittelten Datens√§tzen und vergleichen die Ergebniss anschlie√üend mit einer Regressionssch√§tzung ohne Matching. </span>
<span id="cb99-879"><a href="#cb99-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-880"><a href="#cb99-880" aria-hidden="true" tabindex="-1"></a>Wir kombinieren die Matching-Verfahren mit linearer Regression, d.h. wir Sch√§tzen den Behandlungseffekt anhand es gematchten Datensatzes als Mittelwertdifferenz nach zus√§tzlicher Kontrolle f√ºr die Matching-Variablen. Diese Kombination von Matching mit Regression wird in der Literatur als *Regression Adjustment* bezeichnet und ist insbesondere hilfreich, wenn Backdoors mit Matching geschlossen werden sollen, der kausale Effekt jedoch nur unter Verwendung einer nicht-trivialen Regressionsfunktion ermittelt werden kann. Zum Beispiel kann bei einer kontinuierlichen Behandlungsvariable und einem nicht-linearen Zusammenhang mit $Y$ der kausale Effekt nicht durch einen blo√üen Mittelwertvergleich erfasst werden, sondern erfordert eine ad√§quate Modellierung dieses Zusammenhangs in der Regressionsfunktion. Die zus√§tzliche Kontrolle f√ºr Matching-Variablen kann die Varianz der Sch√§tzung verringern und das Risiko einer verzerrten Sch√§tzung abmildern, falls nach Matching noch Unterschiede in der Balance von Behandlungs- und Kontrollgruppe vorliegen.</span>
<span id="cb99-881"><a href="#cb99-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-884"><a href="#cb99-884" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-885"><a href="#cb99-885" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT mit linearem Modell sch√§tzen: CEM Datensatz</span></span>
<span id="cb99-886"><a href="#cb99-886" aria-hidden="true" tabindex="-1"></a>ATT_mod_CEM <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb99-887"><a href="#cb99-887" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb99-888"><a href="#cb99-888" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode_matched_CEM, </span>
<span id="cb99-889"><a href="#cb99-889" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights </span>
<span id="cb99-890"><a href="#cb99-890" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-891"><a href="#cb99-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-892"><a href="#cb99-892" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATT_mod_CEM)</span>
<span id="cb99-893"><a href="#cb99-893" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-894"><a href="#cb99-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-897"><a href="#cb99-897" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-898"><a href="#cb99-898" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz f√ºr Propensity Score Matching zuweisen</span></span>
<span id="cb99-899"><a href="#cb99-899" aria-hidden="true" tabindex="-1"></a>darkmode_matched_PSC <span class="ot">&lt;-</span> <span class="fu">match.data</span>(res_PSC)</span>
<span id="cb99-900"><a href="#cb99-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-901"><a href="#cb99-901" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT mit linearem Modell sch√§tzen: PSM Datensatz</span></span>
<span id="cb99-902"><a href="#cb99-902" aria-hidden="true" tabindex="-1"></a>ATT_mod_PSC <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb99-903"><a href="#cb99-903" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb99-904"><a href="#cb99-904" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode_matched_PSC, </span>
<span id="cb99-905"><a href="#cb99-905" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights </span>
<span id="cb99-906"><a href="#cb99-906" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-907"><a href="#cb99-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-908"><a href="#cb99-908" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATT_mod_PSC)</span>
<span id="cb99-909"><a href="#cb99-909" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-910"><a href="#cb99-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-913"><a href="#cb99-913" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-914"><a href="#cb99-914" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT mit linearem Modell ohne Matching</span></span>
<span id="cb99-915"><a href="#cb99-915" aria-hidden="true" tabindex="-1"></a>ATT_mod_org <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb99-916"><a href="#cb99-916" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb99-917"><a href="#cb99-917" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode</span>
<span id="cb99-918"><a href="#cb99-918" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-919"><a href="#cb99-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-920"><a href="#cb99-920" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATT_mod_org)</span>
<span id="cb99-921"><a href="#cb99-921" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-922"><a href="#cb99-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-923"><a href="#cb99-923" aria-hidden="true" tabindex="-1"></a>Beachte, dass f√ºr die gematchten Datens√§tze jeweils ein durchschnittlicher Behandlungseffekt f√ºr die Beobachtungen _mit_ erfolgter Behandlung ermittelt wird: In s√§mtlichen oben gezeigten Matchibg-Verfahren werden mit <span class="in">`estimand = "ATT"`</span> vergleichbarere Kontrollbeobachtungen f√ºr die behandelten Beobachtungen ermittelt. Wir sch√§tzen den Effekt der Behandlung, indem wir die Ergebnisse von behandelten Personen mit denen von gematchten Personen vergleichen, die keine Behandlung erhalten haben. Diese Vergleichsgruppe dient als Ersatz f√ºr den hypothetischen Zustand der Behandlungsgruppe, wenn keine Behandlung erfolgt w√§re. Dies entspricht der Definition eines ATT --- ein average treatment effect *on the treated*.</span>
<span id="cb99-924"><a href="#cb99-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-925"><a href="#cb99-925" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cluster-robuste Standardfehler</span></span>
<span id="cb99-926"><a href="#cb99-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-927"><a href="#cb99-927" aria-hidden="true" tabindex="-1"></a>F√ºr Matching-Verfahren sind die mit <span class="in">`summary()`</span> berechneten Standardfehler (und damit auch Konfidenzintervalle, t-Statistiken und p-Werte) f√ºr den Behandlungseffekt *grunds√§tzlich ung√ºltig*. Je nach Matching-Verfahren liegen unterschiedliche Quellen von Sch√§tzunsicherheit vor, die bei der Berechnung von Standardfehlern zus√§tzlich zu der "√ºblichen" Stichproben-Variabilit√§t ber√ºcksichtig werden m√ºssen. Gr√ºnde hierf√ºr sind der Matching-Prozess ansich oder weitere Unsicherheit durch die Sch√§tzung zus√§tzlicher Parameter, etwa bei der Berechnung von Propensity Scores mit logistischer Regression. Eine weiterere Ursache zus√§tzlicher Variation durch den Matching-Prozess, die wir bisher nicht n√§her betrachtet haben ensteht durch Zur√ºcklegen, d.h. wenn Beobachtungen mehrfach gematcht werden k√∂nnen. Auch dieser Faktor wird in der von <span class="in">`summary()`</span> verwendeten Formel f√ºr den Standardfehler des Effekt-Sch√§tzers nicht ber√ºcksichtigt.</span>
<span id="cb99-928"><a href="#cb99-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-929"><a href="#cb99-929" aria-hidden="true" tabindex="-1"></a>Standardfehlerberechnung f√ºr Matching-Sch√§tzer von Behandlungseffekten ist Gegenstand aktueller Forschung. @AustinSmall2014 und @AbadieSpiess2022 belegen die G√ºltigkeit von cluster-robusten Standardfehlern mit Clustering auf Ebene der Beobachtungsgruppen (<span class="in">`subclass`</span> im output von <span class="in">`match.data()`</span>) bei Matching ohne Zur√ºcklegen. F√ºr Matching anhand von Propensity Scores (auch mit Zur√ºcklegen) zeigen @AbadieImbens2016, dass ignorieren der zus√§tzlichen Unsicherheit durch die Sch√§tzung der Propensity Scores zu konservativer Inferenz f√ºr den ATE anhand eines cluster-robusten Standardfehlersch√§tzers f√ºhrt, jedoch ung√ºltige Inferenz f√ºr die Sch√§tzung des ATT bedeuten kann. √Ñhnlich zu @AustinSmall2014 deuten die Ergebnisse der Simulationsstudie von @Bodoryetal2020 auf grunds√§tzlich bessere Eigenschaften der Sch√§tzung hin, wenn die Standardfehler nicht f√ºr die Sch√§tzung der Propensity Scores adjustiert werden.</span>
<span id="cb99-930"><a href="#cb99-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-931"><a href="#cb99-931" aria-hidden="true" tabindex="-1"></a>Weiterhin ist die Kontrolle f√ºr Kovariablen mit Erkl√§rungskraft f√ºr die Outcome-Variable und f√ºr die Matching-Variablen (wie oben erfolgt) mit *Regression Adjustment* f√ºr die Sch√§tzung des Behandlungseffekts nach Matching eine etablierte Strategie, vgl. @HillReiter2006 und @AbadieSpiess2022. So k√∂nnen die Varianz der Sch√§tzung und das Risiko einer Verzerrung der Standardfehler aufgrund verbleibender Imbalance von Behandlungs- und Kontrollgruppe nach Matching verringert werden.</span>
<span id="cb99-932"><a href="#cb99-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-933"><a href="#cb99-933" aria-hidden="true" tabindex="-1"></a>Zur Demonstration von (cluster)-robuster Inferenz und f√ºr eine  tabellarische Zusammenfassung der Ergebnisse nutzen wir die Pakete <span class="in">`marginaleffects`</span> und <span class="in">`modelsummary`</span>. Mit <span class="in">`marginaleffects::avg_comparisons()`</span> k√∂nnen p-Werte und Kofindenzintervalle unter Ber√ºcksichtigung von robuster Standardfehlern und der Gewichte aus dem Matching-Verfahren berechnet werden.</span>
<span id="cb99-934"><a href="#cb99-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-937"><a href="#cb99-937" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-938"><a href="#cb99-938" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb99-939"><a href="#cb99-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-940"><a href="#cb99-940" aria-hidden="true" tabindex="-1"></a><span class="co"># Inferenz: Multiple Regression, ungematchter Datensatz</span></span>
<span id="cb99-941"><a href="#cb99-941" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-942"><a href="#cb99-942" aria-hidden="true" tabindex="-1"></a>  sum_orig <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb99-943"><a href="#cb99-943" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> ATT_mod_org,</span>
<span id="cb99-944"><a href="#cb99-944" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="st">"dark_mode"</span>,</span>
<span id="cb99-945"><a href="#cb99-945" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Heteroskedastie-robuste SE:</span></span>
<span id="cb99-946"><a href="#cb99-946" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="st">"HC3"</span>, </span>
<span id="cb99-947"><a href="#cb99-947" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identifizierung der Kontrollgruppe:</span></span>
<span id="cb99-948"><a href="#cb99-948" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> <span class="fu">subset</span>(darkmode, dark_mode <span class="sc">==</span> <span class="dv">1</span>) </span>
<span id="cb99-949"><a href="#cb99-949" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-950"><a href="#cb99-950" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb99-951"><a href="#cb99-951" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-954"><a href="#cb99-954" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-955"><a href="#cb99-955" aria-hidden="true" tabindex="-1"></a><span class="co"># Inferenz: Multiple Regression bei CEM</span></span>
<span id="cb99-956"><a href="#cb99-956" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-957"><a href="#cb99-957" aria-hidden="true" tabindex="-1"></a>  sum_CEM <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb99-958"><a href="#cb99-958" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> ATT_mod_CEM ,</span>
<span id="cb99-959"><a href="#cb99-959" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"dark_mode"</span>,</span>
<span id="cb99-960"><a href="#cb99-960" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cluster-robuste SE</span></span>
<span id="cb99-961"><a href="#cb99-961" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> subclass, </span>
<span id="cb99-962"><a href="#cb99-962" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">subset</span>(darkmode_matched_CEM, dark_mode <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb99-963"><a href="#cb99-963" aria-hidden="true" tabindex="-1"></a>  <span class="at">wts =</span> <span class="st">"weights"</span></span>
<span id="cb99-964"><a href="#cb99-964" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-965"><a href="#cb99-965" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-966"><a href="#cb99-966" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-969"><a href="#cb99-969" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-970"><a href="#cb99-970" aria-hidden="true" tabindex="-1"></a><span class="co"># Inferenz: Multiple Regression bei PSM</span></span>
<span id="cb99-971"><a href="#cb99-971" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-972"><a href="#cb99-972" aria-hidden="true" tabindex="-1"></a>  sum_PSC <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb99-973"><a href="#cb99-973" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> ATT_mod_PSC ,</span>
<span id="cb99-974"><a href="#cb99-974" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="st">"dark_mode"</span>,</span>
<span id="cb99-975"><a href="#cb99-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="sc">~</span> subclass, </span>
<span id="cb99-976"><a href="#cb99-976" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> <span class="fu">subset</span>(darkmode_matched_PSC, dark_mode <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb99-977"><a href="#cb99-977" aria-hidden="true" tabindex="-1"></a>    <span class="at">wts =</span> <span class="st">"weights"</span></span>
<span id="cb99-978"><a href="#cb99-978" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-979"><a href="#cb99-979" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-980"><a href="#cb99-980" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-981"><a href="#cb99-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-982"><a href="#cb99-982" aria-hidden="true" tabindex="-1"></a>Wir fassen die Ergebnisse mit <span class="in">`modelsummary::modelsummary()`</span> tabellarisch zusammen.</span>
<span id="cb99-983"><a href="#cb99-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-986"><a href="#cb99-986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-987"><a href="#cb99-987" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb99-988"><a href="#cb99-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-989"><a href="#cb99-989" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabellarische Zusammenfassung erzeugen</span></span>
<span id="cb99-990"><a href="#cb99-990" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb99-991"><a href="#cb99-991" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb99-992"><a href="#cb99-992" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Kein Matching"</span> <span class="ot">=</span> sum_orig, </span>
<span id="cb99-993"><a href="#cb99-993" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Coarsened Exact"</span> <span class="ot">=</span> sum_CEM, </span>
<span id="cb99-994"><a href="#cb99-994" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Propensity Scores"</span> <span class="ot">=</span> sum_PSC</span>
<span id="cb99-995"><a href="#cb99-995" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb99-996"><a href="#cb99-996" aria-hidden="true" tabindex="-1"></a>  <span class="at">stars =</span> T, </span>
<span id="cb99-997"><a href="#cb99-997" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_map =</span> <span class="st">"nobs"</span>, </span>
<span id="cb99-998"><a href="#cb99-998" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"gt"</span></span>
<span id="cb99-999"><a href="#cb99-999" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb99-1000"><a href="#cb99-1000" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabopts</span>()</span>
<span id="cb99-1001"><a href="#cb99-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1002"><a href="#cb99-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1003"><a href="#cb99-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1004"><a href="#cb99-1004" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bootstrap-Sch√§tzung kausaler Effekte bei Matching {#sec-bootmatching}</span></span>
<span id="cb99-1005"><a href="#cb99-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1006"><a href="#cb99-1006" aria-hidden="true" tabindex="-1"></a>Ein Bootstrap-Verfahren generiert mit Resampling (wiederholtes Ziehen mit Zur√ºcklegen) aus dem Original-Datensatz (viele) k√ºnstliche Datens√§tze, f√ºr die der Sch√§tzer (d.h. das gesamte Verfahren inkl. Matching!) jeweils berechnet wird. Die Verteilung der so gewonnenen Bootstrap-Sch√§tzwerte approximiert die wahre, unbekannte Stichprobenverteilung des Sch√§tzers des Behandlungseffekts. Mit dieser simulierten Verteilung k√∂nnen wir Inferenz betreiben: Wir k√∂nnen einen Bootstrap-Punktsch√§tzer des Behandlungseffekts (Stichprobenmittel der Bootstrap-Sch√§tzungen) sowie Standardfehler (Standardabweichung der der Bootstrap-Sch√§tzungen) und p-Werte berechnen.</span>
<span id="cb99-1007"><a href="#cb99-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1008"><a href="#cb99-1008" aria-hidden="true" tabindex="-1"></a>Der Bootstrap kann hilfreich sein, wenn unklar ist, wie Standardfehler f√ºr die Unsicherheit des Matching-Prozesses zu adjustieren sind, um g√ºltige Inferenzsstatistiken zu erhalten. @AbadieImbens2008 zeigen analytisch, dass der Standard-Bootstrap  die Stichprobenverteilung f√ºr Sch√§tzer kausaler Effekte anhand von gematchten Datens√§tzen (d.h. bei Zuordnung/Selektion von Beobachtungen mit Matching) nicht korrekt abbilden kann. Grunds√§tzlich problematisch hierbei ist, wenn der Bootstrap eine verzerrte Sch√§tzung produziert und/oder zu kleine Standardfehler liefert. @AbadieImbens2008 belegen die Tendenz des Bootstraps zu *konservative* (d.h. zu gro√üe) Standardfehler zu produzieren. Simulationsnachweise <span class="co">[</span><span class="ot">@Bodoryetal2020; @HillReiter2006; @AustinSmall2014;@AustinStuart2017</span><span class="co">]</span> finden, dass Bootstrap-Standardfehler u.a. bei Propensity Score Matching mit Zur√ºcklegen leicht konservativ sind somit das gew√ºnschte nominale Signifikanzniveau eines Bootstrap-Hypothesentests nicht √ºberschritten wird, weshalb der Standard-Bootstrap trotz seiner Schw√§chen in der empirischen Forschung oft angewendet wird.</span>
<span id="cb99-1009"><a href="#cb99-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1010"><a href="#cb99-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1011"><a href="#cb99-1011" aria-hidden="true" tabindex="-1"></a>Wir betrachen als n√§chstes einen Bootstrap-Algorithmus f√ºr Inferenz bez√ºglich eines kausalen Effekts nach Matching und demonstrieren die Sch√§tzung anhand unseres Website-Beispiels f√ºr den ATT nach Propensity-Score-Matching.</span>
<span id="cb99-1012"><a href="#cb99-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1013"><a href="#cb99-1013" aria-hidden="true" tabindex="-1"></a>**Algorithmus: Bootstrap-Sch√§tzer f√ºr Propensity-Score-Matching**</span>
<span id="cb99-1014"><a href="#cb99-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1015"><a href="#cb99-1015" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Generiere eine Bootstrap-Stichprobe durch $N$ Z√ºge *mit Zur√ºcklegen* aus der $N$-elementigen originalen Stichprobe.</span>
<span id="cb99-1016"><a href="#cb99-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1017"><a href="#cb99-1017" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Wende das Matching-Verfahren f√ºr die Bootstrap-Stichprobe an. Sch√§tze den Behandlungseffekt $\beta$ anhand der gematchten Stichprobe mit Regression. Speichere den Punktsch√§tzer des Behandlungseffekts $\widehat{\beta}_b^*$.</span>
<span id="cb99-1018"><a href="#cb99-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1019"><a href="#cb99-1019" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>F√ºrhre die Schritte 1 und 2 f√ºr $b=1,\dots,B$ aus, wobei $B$ eine hinreichend gro√üe Anzahl von Bootstrap-Replikationen ist.</span>
<span id="cb99-1020"><a href="#cb99-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1021"><a href="#cb99-1021" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Berechne den Bootstrap-Sch√§tzer des Behandlungseffekts $\overline{\beta}^* = \frac{1}{B}\sum_{b=1} \widehat{\beta}_b^*$ und den Standardfehler $\text{SE}(\overline{\beta}^*) = \sqrt{\frac{1}{B-1}\sum_{b=1}^B(\widehat{\beta}_b^*-\overline{\beta}^*)^2}$. Berechne Inferenz-Statistiken mit den √ºblichen Formeln.</span>
<span id="cb99-1022"><a href="#cb99-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1023"><a href="#cb99-1023" aria-hidden="true" tabindex="-1"></a>Wir Implementieren nun einen Bootstrap-Sch√§tzer des ATT im Website-Beispiel f√ºr Propensity-Score-Matching. Hierzu definieren wir eine <span class="in">`R`</span>-Funktion <span class="in">`boot_fun()`</span> f√ºr die Schritte 1 und 2 im obigen Algorithmus.</span>
<span id="cb99-1024"><a href="#cb99-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1027"><a href="#cb99-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1028"><a href="#cb99-1028" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Funktion f√ºr Schritte 1 und 2</span></span>
<span id="cb99-1029"><a href="#cb99-1029" aria-hidden="true" tabindex="-1"></a>boot_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb99-1030"><a href="#cb99-1030" aria-hidden="true" tabindex="-1"></a>    data, <span class="co"># originale Stichprobe</span></span>
<span id="cb99-1031"><a href="#cb99-1031" aria-hidden="true" tabindex="-1"></a>    i     <span class="co"># Indexmenge f. Bootstrap-Stichprobe</span></span>
<span id="cb99-1032"><a href="#cb99-1032" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb99-1033"><a href="#cb99-1033" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1034"><a href="#cb99-1034" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bootstrap-Stichprobe</span></span>
<span id="cb99-1035"><a href="#cb99-1035" aria-hidden="true" tabindex="-1"></a>  boot_data <span class="ot">&lt;-</span> data[i, ]</span>
<span id="cb99-1036"><a href="#cb99-1036" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1037"><a href="#cb99-1037" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1:1 PS Matching</span></span>
<span id="cb99-1038"><a href="#cb99-1038" aria-hidden="true" tabindex="-1"></a>  match_res <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb99-1039"><a href="#cb99-1039" aria-hidden="true" tabindex="-1"></a>    dark_mode <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male,</span>
<span id="cb99-1040"><a href="#cb99-1040" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb99-1041"><a href="#cb99-1041" aria-hidden="true" tabindex="-1"></a>    <span class="at">distance =</span> <span class="st">"glm"</span>, </span>
<span id="cb99-1042"><a href="#cb99-1042" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"nearest"</span>, </span>
<span id="cb99-1043"><a href="#cb99-1043" aria-hidden="true" tabindex="-1"></a>    <span class="at">caliper =</span> .<span class="dv">25</span>,</span>
<span id="cb99-1044"><a href="#cb99-1044" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> boot_data</span>
<span id="cb99-1045"><a href="#cb99-1045" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb99-1046"><a href="#cb99-1046" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1047"><a href="#cb99-1047" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gematchten Datensatz zuweisen</span></span>
<span id="cb99-1048"><a href="#cb99-1048" aria-hidden="true" tabindex="-1"></a>  darkmode_matched <span class="ot">&lt;-</span> <span class="fu">match.data</span>(</span>
<span id="cb99-1049"><a href="#cb99-1049" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> match_res, </span>
<span id="cb99-1050"><a href="#cb99-1050" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> boot_data</span>
<span id="cb99-1051"><a href="#cb99-1051" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-1052"><a href="#cb99-1052" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1053"><a href="#cb99-1053" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome-Modell sch√§tzen</span></span>
<span id="cb99-1054"><a href="#cb99-1054" aria-hidden="true" tabindex="-1"></a>  ATT_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb99-1055"><a href="#cb99-1055" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb99-1056"><a href="#cb99-1056" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> darkmode_matched, </span>
<span id="cb99-1057"><a href="#cb99-1057" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> weights </span>
<span id="cb99-1058"><a href="#cb99-1058" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-1059"><a href="#cb99-1059" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1060"><a href="#cb99-1060" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  ATT-Sch√§tzung zur√ºckgeben</span></span>
<span id="cb99-1061"><a href="#cb99-1061" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb99-1062"><a href="#cb99-1062" aria-hidden="true" tabindex="-1"></a>    ATT_mod<span class="sc">$</span>coefficients[<span class="st">"dark_mode"</span>]  </span>
<span id="cb99-1063"><a href="#cb99-1063" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-1064"><a href="#cb99-1064" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-1065"><a href="#cb99-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1066"><a href="#cb99-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1067"><a href="#cb99-1067" aria-hidden="true" tabindex="-1"></a>Wir berechnen nun eine Bootstrap-Sch√§tzung des ATT von <span class="in">`dark_mode`</span> auf <span class="in">`readingtime`</span> nach Propensity Score Matching mit einem caliper von 0.25 sowie den zugeh√∂rigen Standardfehler und ein 95%-KI mit der zuvor definierten Funktion <span class="in">`boot_fun`</span>.</span>
<span id="cb99-1068"><a href="#cb99-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1069"><a href="#cb99-1069" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache = F}</span></span>
<span id="cb99-1070"><a href="#cb99-1070" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"boot"</span>)</span>
<span id="cb99-1071"><a href="#cb99-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4321</span>)</span>
<span id="cb99-1072"><a href="#cb99-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1073"><a href="#cb99-1073" aria-hidden="true" tabindex="-1"></a><span class="co"># Anz. Bootstrap-Replikationen</span></span>
<span id="cb99-1074"><a href="#cb99-1074" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">999</span></span>
<span id="cb99-1075"><a href="#cb99-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1076"><a href="#cb99-1076" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap durchf√ºhren</span></span>
<span id="cb99-1077"><a href="#cb99-1077" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb99-1078"><a href="#cb99-1078" aria-hidden="true" tabindex="-1"></a>  boot_out <span class="ot">&lt;-</span> <span class="fu">boot</span>(darkmode, boot_fun, <span class="at">R =</span> B)</span>
<span id="cb99-1079"><a href="#cb99-1079" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-1080"><a href="#cb99-1080" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1081"><a href="#cb99-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1082"><a href="#cb99-1082" aria-hidden="true" tabindex="-1"></a>Den Bootstrap-Sch√§tzer des ATT sowie den Bootstrap-Standardfehler berechnen wir mit <span class="in">`mean()`</span> und <span class="in">`sd()`</span> anhand der <span class="in">`r B`</span> Bootstrap-Replikationen in <span class="in">`boot_out$t`</span>.</span>
<span id="cb99-1083"><a href="#cb99-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1086"><a href="#cb99-1086" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1087"><a href="#cb99-1087" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Sch√§tzer f√ºr den Treatment-Effekt</span></span>
<span id="cb99-1088"><a href="#cb99-1088" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(boot_out<span class="sc">$</span>t) </span>
<span id="cb99-1089"><a href="#cb99-1089" aria-hidden="true" tabindex="-1"></a><span class="co"># = mean(t0) + bias = mean(Bootstrap_samples)</span></span>
<span id="cb99-1090"><a href="#cb99-1090" aria-hidden="true" tabindex="-1"></a><span class="co"># vgl. 't0 = boot_fun(darkmode, i = 1:1e3)'</span></span>
<span id="cb99-1091"><a href="#cb99-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1092"><a href="#cb99-1092" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Standardfehler</span></span>
<span id="cb99-1093"><a href="#cb99-1093" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(boot_out<span class="sc">$</span>t)</span>
<span id="cb99-1094"><a href="#cb99-1094" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1095"><a href="#cb99-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1096"><a href="#cb99-1096" aria-hidden="true" tabindex="-1"></a>Ein 95\%-Konfidenzintervall f√ºr den kausalen Effekt erhalten wir mit <span class="in">`boot::boot.ci()`</span>.^<span class="co">[</span><span class="ot">`type = "bca"` (bias-corrected accelerated) ist eine g√§ngige Implementierung f√ºr die Berechnung des Konfidenz-Intervalls.</span><span class="co">]</span></span>
<span id="cb99-1097"><a href="#cb99-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1100"><a href="#cb99-1100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1101"><a href="#cb99-1101" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% Bootstrap-KI f√ºr den Treatment-Effekt</span></span>
<span id="cb99-1102"><a href="#cb99-1102" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(</span>
<span id="cb99-1103"><a href="#cb99-1103" aria-hidden="true" tabindex="-1"></a>  <span class="at">boot.out =</span> boot_out, </span>
<span id="cb99-1104"><a href="#cb99-1104" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"bca"</span>, </span>
<span id="cb99-1105"><a href="#cb99-1105" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf =</span> .<span class="dv">95</span></span>
<span id="cb99-1106"><a href="#cb99-1106" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-1107"><a href="#cb99-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1108"><a href="#cb99-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1109"><a href="#cb99-1109" aria-hidden="true" tabindex="-1"></a>Beachte, dass der Bootstrap-Standardfehler sowie das Bootstrap-Konfidenzintervall nahe der mit <span class="in">`avg_comarisons`</span> berechneten Werte f√ºr <span class="in">`sum_PSC`</span> sind.</span>
<span id="cb99-1110"><a href="#cb99-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1111"><a href="#cb99-1111" aria-hidden="true" tabindex="-1"></a>**Bootstrap-Standardfehler f√ºr IPW-Sch√§tzer des ATE**</span>
<span id="cb99-1112"><a href="#cb99-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1113"><a href="#cb99-1113" aria-hidden="true" tabindex="-1"></a>Die obige Bootstrap-Funktion <span class="in">`boot_fun`</span> kann leicht f√ºr eine Sch√§tzung des Standardfehlers f√ºr den IPW-Sch√§tzer des ATE aus @sec-PSM angepasst werden. Statt einer Matching-Prozedur berechnen wir hierzu f√ºr $B$ Bootstrap-Stichproben den Sch√§tzer $\widehat{\tau}^\text{IPW}$.</span>
<span id="cb99-1114"><a href="#cb99-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1117"><a href="#cb99-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1118"><a href="#cb99-1118" aria-hidden="true" tabindex="-1"></a><span class="co"># IPW estimation with regression adjustment</span></span>
<span id="cb99-1119"><a href="#cb99-1119" aria-hidden="true" tabindex="-1"></a>ipw_boot <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb99-1120"><a href="#cb99-1120" aria-hidden="true" tabindex="-1"></a>    data, </span>
<span id="cb99-1121"><a href="#cb99-1121" aria-hidden="true" tabindex="-1"></a>    i</span>
<span id="cb99-1122"><a href="#cb99-1122" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb99-1123"><a href="#cb99-1123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1124"><a href="#cb99-1124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bootstrap-Stichprobe erstellen</span></span>
<span id="cb99-1125"><a href="#cb99-1125" aria-hidden="true" tabindex="-1"></a>  data_boot  <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb99-1126"><a href="#cb99-1126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(i)</span>
<span id="cb99-1127"><a href="#cb99-1127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1128"><a href="#cb99-1128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Logistischee Regression</span></span>
<span id="cb99-1129"><a href="#cb99-1129" aria-hidden="true" tabindex="-1"></a>  glm_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb99-1130"><a href="#cb99-1130" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male,</span>
<span id="cb99-1131"><a href="#cb99-1131" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_boot, </span>
<span id="cb99-1132"><a href="#cb99-1132" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial</span>
<span id="cb99-1133"><a href="#cb99-1133" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-1134"><a href="#cb99-1134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1135"><a href="#cb99-1135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Propensity Scores berechnen</span></span>
<span id="cb99-1136"><a href="#cb99-1136" aria-hidden="true" tabindex="-1"></a>  data_boot <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb99-1137"><a href="#cb99-1137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb99-1138"><a href="#cb99-1138" aria-hidden="true" tabindex="-1"></a>      <span class="at">ps =</span> <span class="fu">predict</span>(glm_fit, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb99-1139"><a href="#cb99-1139" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-1140"><a href="#cb99-1140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1141"><a href="#cb99-1141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Beobachtungen anhand Propensity Scores trimmen</span></span>
<span id="cb99-1142"><a href="#cb99-1142" aria-hidden="true" tabindex="-1"></a>  data_boot <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb99-1143"><a href="#cb99-1143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb99-1144"><a href="#cb99-1144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">between</span>(</span>
<span id="cb99-1145"><a href="#cb99-1145" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> ps,</span>
<span id="cb99-1146"><a href="#cb99-1146" aria-hidden="true" tabindex="-1"></a>        <span class="at">left =</span> .<span class="dv">2</span>,</span>
<span id="cb99-1147"><a href="#cb99-1147" aria-hidden="true" tabindex="-1"></a>        <span class="at">right =</span> .<span class="dv">7</span></span>
<span id="cb99-1148"><a href="#cb99-1148" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb99-1149"><a href="#cb99-1149" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-1150"><a href="#cb99-1150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1151"><a href="#cb99-1151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># IPW berechnen</span></span>
<span id="cb99-1152"><a href="#cb99-1152" aria-hidden="true" tabindex="-1"></a>  data_boot <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb99-1153"><a href="#cb99-1153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb99-1154"><a href="#cb99-1154" aria-hidden="true" tabindex="-1"></a>      <span class="at">ipw =</span> <span class="fu">case_when</span>(</span>
<span id="cb99-1155"><a href="#cb99-1155" aria-hidden="true" tabindex="-1"></a>        dark_mode <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> ps,</span>
<span id="cb99-1156"><a href="#cb99-1156" aria-hidden="true" tabindex="-1"></a>        dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb99-1157"><a href="#cb99-1157" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-1158"><a href="#cb99-1158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1159"><a href="#cb99-1159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gewichtete Mittelwerte der Gruppen   </span></span>
<span id="cb99-1160"><a href="#cb99-1160" aria-hidden="true" tabindex="-1"></a>  w_means <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb99-1161"><a href="#cb99-1161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span></span>
<span id="cb99-1162"><a href="#cb99-1162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">m =</span> <span class="fu">weighted.mean</span>(read_time, <span class="at">w =</span> ipw)) <span class="sc">%&gt;%</span></span>
<span id="cb99-1163"><a href="#cb99-1163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(dark_mode)</span>
<span id="cb99-1164"><a href="#cb99-1164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-1165"><a href="#cb99-1165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ATT-Sch√§tzwert</span></span>
<span id="cb99-1166"><a href="#cb99-1166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(w_means<span class="sc">$</span>m[<span class="dv">2</span>] <span class="sc">-</span> w_means<span class="sc">$</span>m[<span class="dv">1</span>])</span>
<span id="cb99-1167"><a href="#cb99-1167" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-1168"><a href="#cb99-1168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1169"><a href="#cb99-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1172"><a href="#cb99-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1173"><a href="#cb99-1173" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> darkmode,</span>
<span id="cb99-1174"><a href="#cb99-1174" aria-hidden="true" tabindex="-1"></a>          <span class="at">statistic =</span> ipw_boot, </span>
<span id="cb99-1175"><a href="#cb99-1175" aria-hidden="true" tabindex="-1"></a>          <span class="at">R =</span> <span class="dv">999</span>)</span>
<span id="cb99-1176"><a href="#cb99-1176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1177"><a href="#cb99-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1180"><a href="#cb99-1180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1181"><a href="#cb99-1181" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Sch√§tzer und Standardfehler</span></span>
<span id="cb99-1182"><a href="#cb99-1182" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(b<span class="sc">$</span>t)</span>
<span id="cb99-1183"><a href="#cb99-1183" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(b<span class="sc">$</span>t)</span>
<span id="cb99-1184"><a href="#cb99-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1185"><a href="#cb99-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1188"><a href="#cb99-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1189"><a href="#cb99-1189" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% Bootstrap-KI f√ºr den Treatment-Effekt</span></span>
<span id="cb99-1190"><a href="#cb99-1190" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(b, <span class="at">type =</span> <span class="st">"bca"</span>)</span>
<span id="cb99-1191"><a href="#cb99-1191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1192"><a href="#cb99-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1193"><a href="#cb99-1193" aria-hidden="true" tabindex="-1"></a><span class="fu">## Doubly-Robust-Sch√§tzung</span></span>
<span id="cb99-1194"><a href="#cb99-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1195"><a href="#cb99-1195" aria-hidden="true" tabindex="-1"></a>Implementieren und berechnen Sie einen Doubly-Robust-Sch√§tzer des ATT, vgl. @Wooldrige2010.</span>
<span id="cb99-1196"><a href="#cb99-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1199"><a href="#cb99-1199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1200"><a href="#cb99-1200" aria-hidden="true" tabindex="-1"></a><span class="co"># IPW estimation with regression adjustment</span></span>
<span id="cb99-1201"><a href="#cb99-1201" aria-hidden="true" tabindex="-1"></a>ipwra <span class="ot">&lt;-</span> <span class="cf">function</span>(br, <span class="at">index =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(br)) {</span>
<span id="cb99-1202"><a href="#cb99-1202" aria-hidden="true" tabindex="-1"></a>    <span class="co"># slice bootstrapped observations</span></span>
<span id="cb99-1203"><a href="#cb99-1203" aria-hidden="true" tabindex="-1"></a>    br <span class="ot">&lt;-</span> br <span class="sc">%&gt;%</span> <span class="fu">slice</span>(index)</span>
<span id="cb99-1204"><a href="#cb99-1204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-1205"><a href="#cb99-1205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># estimate and predict propensity score</span></span>
<span id="cb99-1206"><a href="#cb99-1206" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb99-1207"><a href="#cb99-1207" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male,</span>
<span id="cb99-1208"><a href="#cb99-1208" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> br, </span>
<span id="cb99-1209"><a href="#cb99-1209" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">'logit'</span>)</span>
<span id="cb99-1210"><a href="#cb99-1210" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-1211"><a href="#cb99-1211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-1212"><a href="#cb99-1212" aria-hidden="true" tabindex="-1"></a>    br <span class="ot">&lt;-</span> br <span class="sc">%&gt;%</span></span>
<span id="cb99-1213"><a href="#cb99-1213" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">ps =</span> <span class="fu">predict</span>(m, <span class="at">type =</span> <span class="st">'response'</span>))</span>
<span id="cb99-1214"><a href="#cb99-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1215"><a href="#cb99-1215" aria-hidden="true" tabindex="-1"></a>    br <span class="ot">&lt;-</span> br <span class="sc">%&gt;%</span></span>
<span id="cb99-1216"><a href="#cb99-1216" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb99-1217"><a href="#cb99-1217" aria-hidden="true" tabindex="-1"></a>        <span class="fu">between</span>(</span>
<span id="cb99-1218"><a href="#cb99-1218" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> ps,</span>
<span id="cb99-1219"><a href="#cb99-1219" aria-hidden="true" tabindex="-1"></a>          <span class="at">left =</span> .<span class="dv">2</span>,</span>
<span id="cb99-1220"><a href="#cb99-1220" aria-hidden="true" tabindex="-1"></a>          <span class="at">right =</span> .<span class="dv">7</span></span>
<span id="cb99-1221"><a href="#cb99-1221" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb99-1222"><a href="#cb99-1222" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb99-1223"><a href="#cb99-1223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-1224"><a href="#cb99-1224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute IPWs</span></span>
<span id="cb99-1225"><a href="#cb99-1225" aria-hidden="true" tabindex="-1"></a>    br <span class="ot">&lt;-</span> br <span class="sc">%&gt;%</span></span>
<span id="cb99-1226"><a href="#cb99-1226" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb99-1227"><a href="#cb99-1227" aria-hidden="true" tabindex="-1"></a>        <span class="at">ipw =</span> <span class="fu">case_when</span>(</span>
<span id="cb99-1228"><a href="#cb99-1228" aria-hidden="true" tabindex="-1"></a>          dark_mode <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> ps,</span>
<span id="cb99-1229"><a href="#cb99-1229" aria-hidden="true" tabindex="-1"></a>          dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb99-1230"><a href="#cb99-1230" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb99-1231"><a href="#cb99-1231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-1232"><a href="#cb99-1232" aria-hidden="true" tabindex="-1"></a><span class="co">#    Simple _ATT_ estimate:</span></span>
<span id="cb99-1233"><a href="#cb99-1233" aria-hidden="true" tabindex="-1"></a>    w_means <span class="ot">&lt;-</span> br <span class="sc">%&gt;%</span></span>
<span id="cb99-1234"><a href="#cb99-1234" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span></span>
<span id="cb99-1235"><a href="#cb99-1235" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarize</span>(<span class="at">m =</span> <span class="fu">weighted.mean</span>(read_time, <span class="at">w =</span> ipw)) <span class="sc">%&gt;%</span></span>
<span id="cb99-1236"><a href="#cb99-1236" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(dark_mode)</span>
<span id="cb99-1237"><a href="#cb99-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1238"><a href="#cb99-1238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># simple diff-in-means _ATT_ estimate</span></span>
<span id="cb99-1239"><a href="#cb99-1239" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(w_means<span class="sc">$</span>m[<span class="dv">2</span>] <span class="sc">-</span> w_means<span class="sc">$</span>m[<span class="dv">1</span>])</span>
<span id="cb99-1240"><a href="#cb99-1240" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-1241"><a href="#cb99-1241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do regression adjustment for _ATE_ estimate</span></span>
<span id="cb99-1242"><a href="#cb99-1242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TE prediction for whole sample based on TG model</span></span>
<span id="cb99-1243"><a href="#cb99-1243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mtreat &lt;- br %&gt;%</span></span>
<span id="cb99-1244"><a href="#cb99-1244" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   filter(dark_mode == 1) %&gt;%</span></span>
<span id="cb99-1245"><a href="#cb99-1245" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   lm(read_time ~ 1 + age + hours + male, data = ., weights = .$ipw) %&gt;%</span></span>
<span id="cb99-1246"><a href="#cb99-1246" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   predict(newdata = br) %&gt;%</span></span>
<span id="cb99-1247"><a href="#cb99-1247" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   mean()</span></span>
<span id="cb99-1248"><a href="#cb99-1248" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb99-1249"><a href="#cb99-1249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # TE prediction for whole sample based on CG model</span></span>
<span id="cb99-1250"><a href="#cb99-1250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mcont &lt;- br %&gt;%</span></span>
<span id="cb99-1251"><a href="#cb99-1251" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   filter(dark_mode == 0) %&gt;%</span></span>
<span id="cb99-1252"><a href="#cb99-1252" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   lm(read_time ~ 1 + age + hours + male, data = ., weights = .$ipw) %&gt;%</span></span>
<span id="cb99-1253"><a href="#cb99-1253" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   predict(newdata = br) %&gt;%</span></span>
<span id="cb99-1254"><a href="#cb99-1254" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   mean()</span></span>
<span id="cb99-1255"><a href="#cb99-1255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb99-1256"><a href="#cb99-1256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return(mtreat - mcont) # Regression adjusted _ATE_ estimate</span></span>
<span id="cb99-1257"><a href="#cb99-1257" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-1258"><a href="#cb99-1258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb99-1259"><a href="#cb99-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-1262"><a href="#cb99-1262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb99-1263"><a href="#cb99-1263" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">boot</span>(<span class="at">data =</span> darkmode, ipwra, <span class="at">R =</span> <span class="dv">999</span>)</span>
<span id="cb99-1264"><a href="#cb99-1264" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap estimate and standard error</span></span>
<span id="cb99-1265"><a href="#cb99-1265" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(b<span class="sc">$</span>t)</span>
<span id="cb99-1266"><a href="#cb99-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(b<span class="sc">$</span>t)</span>
<span id="cb99-1267"><a href="#cb99-1267" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% Bootstrap-KI f√ºr den Treatment-Effekt</span></span>
<span id="cb99-1268"><a href="#cb99-1268" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(b, <span class="at">type =</span> <span class="st">"perc"</span>)</span>
<span id="cb99-1269"><a href="#cb99-1269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>