<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="de" xml:lang="de"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Kausalanalyse mit R - 5&nbsp; Matching</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./FixedEffects.html" rel="next">
<link href="./Simulation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Keine Treffer",
    "search-matching-documents-text": "Treffer",
    "search-copy-link-title": "Link in die Suche kopieren",
    "search-hide-matches-text": "Zusätzliche Treffer verbergen",
    "search-more-match-text": "weitere Treffer in diesem Dokument",
    "search-more-matches-text": "weitere Treffer in diesem Dokument",
    "search-clear-button-title": "Zurücksetzen",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Abbrechen",
    "search-submit-button-title": "Abschicken",
    "search-label": "Suchen"
  }
}</script><meta name="robots" content="noindex">
<script>
  MathJax = {
    tex: {
      tags: 'ams'  // should be 'ams', 'none', or 'all'
    }
  };
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.js" integrity="sha512-aoZChv+8imY/U1O7KIHXvO87EOzCuKO0GhFtpD6G2Cyjo/xPeTgdf3/bchB10iB+AojMTDkMHDPLKNxPJVqDcw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
<style>
  .panel-tabset .tab-content {
    border: 0;
    padding: 1em 0 0 0;
  }
  
  .panel-tabset .nav-item a {
    border-radius: 5px 5px 0 0;
  }
  
  .scientific_borders {
    border: 0;
    border-top: 2px solid black !important; 
    border-bottom: 2px solid black !important;
  }
  .table:not(.gt_table) > :not(caption)>*>* {
    border-bottom-width: 0;
  }
  .table:not(.gt_table) > thead {
    border-bottom: 1px solid black;
  }
  .soft-box-shadow {
    border: 1px solid rgba(233,236,239,.9) !important;
    border-radius: .5rem !important;
    background-color: rgba(250,250,250,.9) !important;
    box-shadow: 0px 1px 2px rgba(0,0,0,.1),
                0px 3px 7px rgba(0,0,0,.1),
                0px 12px 30px rgba(0,0,0,.08);
    margin-top: 2rem !important;
    margin-bottom: 2.5rem !important;
    padding: .25rem !important;
  }
  .obs-soft-box-shadow {
    border: 1px solid rgba(233,236,239,.9) !important;
    border-radius: .5rem !important;
    background-color: white !important;
    box-shadow: 0px 1px 2px rgba(0,0,0,.1),
                0px 3px 7px rgba(0,0,0,.1),
                0px 12px 30px rgba(0,0,0,.08);
    margin-top: 2rem !important;
    margin-bottom: 2.5rem !important;
    padding: .25rem !important;
  }
  
</style>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    
    var gt_tables = document.querySelectorAll(".gt_table");
    gt_tables.forEach(function(table) {
      table.classList.remove("table-striped");
    });
    
    var tables = document.querySelectorAll("table.table:not(.gt_table)");
    tables.forEach(function(table) {
      table.classList.remove("table-striped");
      table.classList.add("scientific_borders");
    });
    
    document.querySelectorAll("div.sourceCode").forEach(function(block) {
      block.classList.add("soft-box-shadow");
    });
    
    document.querySelectorAll("div.bg-white").forEach(function(block) {
      block.classList.remove("bg-white");
    });
    
  });
</script><style>
.qwebr-code-output-stdout {background-color: powderblue;}

.qwebr-button-run {
 width = 100%; 
}

.centered-caption {
   text-align: center;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/quizdown@latest/public/build/quizdown.js"></script><script>quizdown.init();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<style type="text/css">
.monaco-editor pre {
  background-color: unset !important;
}

.qwebr-editor-toolbar {
  width: 100%;
  display: flex;
  justify-content: space-between;
  box-sizing: border-box;
}

.qwebr-editor-toolbar-left-buttons, .qwebr-editor-toolbar-right-buttons {
  display: flex;
}

.qwebr-non-interactive-loading-container.qwebr-cell-needs-evaluation, .qwebr-non-interactive-loading-container.qwebr-cell-evaluated {
  justify-content: center;
  display: flex;
  background-color: rgba(250, 250, 250, 0.65);
  border: 1px solid rgba(233, 236, 239, 0.65);
  border-radius: 0.5rem;
  margin-top: 15px;
  margin-bottom: 15px;
}

.qwebr-r-project-logo {
  color: #2767B0; /* R Project's blue color */
}

.qwebr-icon-status-spinner {
  color: #7894c4;
}

.qwebr-icon-run-code {
  color: #0d9c29
}

.qwebr-output-code-stdout {
  color: #111;
}

.qwebr-output-code-stderr {
  color: #db4133;
}

.qwebr-editor {
  border: 1px solid #EEEEEE;
}

.qwebr-editor-toolbar {
  background-color: #EEEEEE;
  padding: 0.2rem 0.5rem;
}

.qwebr-button {
  background-color: #EEEEEE;
  display: inline-block;
  font-weight: 400;
  line-height: 1;
  text-decoration: none;
  text-align: center;
  color: #000;
  border-color: #dee2e6;
  border: 1px solid rgba(0,0,0,0);
  padding: 0.375rem 0.75rem;
  font-size: .9rem;
  border-radius: 0.25rem;
  transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
}

.qwebr-button:hover {
  color: #000;
  background-color: #d9dce0;
  border-color: #c8ccd0;
}

.qwebr-button:disabled,.qwebr-button.disabled,fieldset:disabled .qwebr-button {
  pointer-events: none;
  opacity: .65
}

.qwebr-button-reset {
  color: #696969; /*#4682b4;*/
}

.qwebr-button-copy {
  color: #696969;
}


/* Custom styling for RevealJS Presentations*/

/* Reset the style of the interactive area */
.reveal div.qwebr-interactive-area {
  display: block;
  box-shadow: none;
  max-width: 100%;
  max-height: 100%;
  margin: 0;
  padding: 0;
} 

/* Provide space to entries */
.reveal div.qwebr-output-code-area pre div {
  margin: 1px 2px 1px 10px;
}

/* Collapse the inside code tags to avoid extra space between line outputs */
.reveal pre div code.qwebr-output-code-stdout, .reveal pre div code.qwebr-output-code-stderr {
  padding: 0;
  display: contents;
}

.reveal pre div code.qwebr-output-code-stdout {
  color: #111;
}

.reveal pre div code.qwebr-output-code-stderr {
  color: #db4133;
}


/* Create a border around console and output (does not effect graphs) */
.reveal div.qwebr-console-area {
  border: 1px solid #EEEEEE;
  box-shadow: 2px 2px 10px #EEEEEE;
}

/* Cap output height and allow text to scroll */
/* TODO: Is there a better way to fit contents/max it parallel to the monaco editor size? */
.reveal div.qwebr-output-code-area pre {
  max-height: 400px;
  overflow: scroll;
}

</style>
<script type="module">
// Document level settings ----

// Determine if we need to install R packages
globalThis.qwebrInstallRPackagesList = ['boot', 'cobalt', 'dplyr', 'ggplot2', 'marginaleffects', 'MatchIt', 'sandwich', 'tidyr'];

// Specify possible locations to search for the repository
globalThis.qwebrPackageRepoURLS = ['https://repo.r-wasm.org/'];

// Check to see if we have an empty array, if we do set to skip the installation.
globalThis.qwebrSetupRPackages = !(qwebrInstallRPackagesList.indexOf("") !== -1);
globalThis.qwebrAutoloadRPackages = true;

// Display a startup message?
globalThis.qwebrShowStartupMessage = true;
globalThis.qwebrShowHeaderMessage = false;

// Describe the webR settings that should be used
globalThis.qwebrCustomizedWebROptions = {
  "baseURL": "https://webr.r-wasm.org/v0.2.2/",
  "serviceWorkerUrl": "",
  "homedir": "/home/web_user", 
  "channelType": "ChannelType.Automatic"
};

// Store cell data
globalThis.qwebrCellDetails = [{"code":"# create dataset directory\ndir.create(\"datasets\")\n# Download the dataset\ndownload.file(\n    \"https://raw.githubusercontent.com/mca91/kausal_data/main/darkmode.csv\",\n    'datasets/darkmode.csv',\n)","options":{"label":"unnamed-chunk-1","fig-width":7,"fig-height":5,"dpi":72,"out-width":"700px","message":"true","results":"markup","comment":"","output":"true","warning":"true","classes":"","context":"setup","fig-cap":"","out-height":"","autorun":"true"},"id":1},{"code":"library(dplyr)\n# make darkmode available using read.csv for now\n# because there's some issue with readr::read_csv\n# I can't fix right now\ndarkmode <- read.csv(\n    file = \"datasets/darkmode.csv\", \n    colClasses = c(\"numeric\", \"logical\", \"numeric\", \"numeric\", \"numeric\") \n)\n\noptions(pillar.bold = TRUE, pillar.subtle = FALSE)","options":{"label":"unnamed-chunk-2","fig-width":7,"fig-height":5,"dpi":72,"out-width":"700px","message":"true","results":"markup","comment":"","output":"true","warning":"true","classes":"","context":"setup","fig-cap":"","out-height":"","autorun":"true"},"id":2},{"code":"# Logit-Modell mit 'glm()' schätzen\n(\n  darkmode_ps_logit <- glm(\n    formula = dark_mode ~ age + male + hours,\n    data = darkmode,\n    family = binomial\n  )\n)","options":{"label":"unnamed-chunk-3","fig-width":7,"fig-height":5,"dpi":72,"out-width":"700px","message":"true","results":"markup","comment":"","output":"true","warning":"true","classes":"","context":"setup","fig-cap":"","out-height":"","autorun":"true"},"id":3},{"code":".25 * sd(\n  fitted(darkmode_ps_logit)\n  )","options":{"label":"unnamed-chunk-4","fig-width":7,"fig-height":5,"dpi":72,"out-width":"700px","message":"true","results":"markup","comment":"","output":"true","warning":"true","classes":"","context":"interactive","fig-cap":"","out-height":"","autorun":"false"},"id":4}];

</script><script type="module">
// Declare startupMessageQWebR globally
globalThis.qwebrStartupMessage = document.createElement("p");


// Function to set the button text
globalThis.qwebrSetInteractiveButtonState = function(buttonText, enableCodeButton = true) {
  document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
    btn.innerHTML = buttonText;
    btn.disabled = !enableCodeButton;
  });
}

// Function to update the status message in non-interactive cells
globalThis.qwebrUpdateStatusMessage = function(message) {
  document.querySelectorAll(".qwebr-status-text.qwebr-cell-needs-evaluation").forEach((elem) => {
    elem.innerText = message;
  });
}

// Function to update the status message
globalThis.qwebrUpdateStatusHeader = function(message) {
  qwebrStartupMessage.innerHTML = `
    <i class="fa-solid fa-spinner fa-spin qwebr-icon-status-spinner"></i>
    <span>${message}</span>`;
}

// Function that attaches the document status message and diagnostics
function displayStartupMessage(showStartupMessage, showHeaderMessage) {
  if (!showStartupMessage) {
    return;
  }

  // Get references to header elements
  const headerHTML = document.getElementById("title-block-header");
  const headerRevealJS = document.getElementById("title-slide");

  // Create the outermost div element for metadata
  const quartoTitleMeta = document.createElement("div");
  quartoTitleMeta.classList.add("quarto-title-meta");

  // Create the first inner div element
  const firstInnerDiv = document.createElement("div");
  firstInnerDiv.setAttribute("id", "qwebr-status-message-area");

  // Create the second inner div element for "WebR Status" heading and contents
  const secondInnerDiv = document.createElement("div");
  secondInnerDiv.setAttribute("id", "qwebr-status-message-title");
  secondInnerDiv.classList.add("quarto-title-meta-heading");
  secondInnerDiv.innerText = "WebR Status";

  // Create another inner div for contents
  const secondInnerDivContents = document.createElement("div");
  secondInnerDivContents.setAttribute("id", "qwebr-status-message-body");
  secondInnerDivContents.classList.add("quarto-title-meta-contents");

  // Describe the WebR state
  qwebrStartupMessage.innerText = "🟡 Loading...";
  qwebrStartupMessage.setAttribute("id", "qwebr-status-message-text");
  // Add `aria-live` to auto-announce the startup status to screen readers
  qwebrStartupMessage.setAttribute("aria-live", "assertive");

  // Append the startup message to the contents
  secondInnerDivContents.appendChild(qwebrStartupMessage);

  // Add a status indicator for COOP and COEP Headers if needed
  if (showHeaderMessage) {
    const crossOriginMessage = document.createElement("p");
    crossOriginMessage.innerText = `${crossOriginIsolated ? '🟢' : '🟡'} COOP & COEP Headers`;
    crossOriginMessage.setAttribute("id", "qwebr-coop-coep-header");
    secondInnerDivContents.appendChild(crossOriginMessage);
  }

  // Combine the inner divs and contents
  firstInnerDiv.appendChild(secondInnerDiv);
  firstInnerDiv.appendChild(secondInnerDivContents);
  quartoTitleMeta.appendChild(firstInnerDiv);

  // Determine where to insert the quartoTitleMeta element
  if (headerHTML || headerRevealJS) {
    // Append to the existing "title-block-header" element or "title-slide" div
    (headerHTML || headerRevealJS).appendChild(quartoTitleMeta);
  } else {
    // If neither headerHTML nor headerRevealJS is found, insert after "webr-monaco-editor-init" script
    const monacoScript = document.getElementById("qwebr-monaco-editor-init");
    const header = document.createElement("header");
    header.setAttribute("id", "title-block-header");
    header.appendChild(quartoTitleMeta);
    monacoScript.after(header);
  }
}

displayStartupMessage(qwebrShowStartupMessage, qwebrShowHeaderMessage);
</script><script type="module">
// Supported Evaluation Types for Context
globalThis.EvalTypes = Object.freeze({
  Interactive: 'interactive',
  Setup: 'setup',
  Output: 'output',
});

// Function that dispatches the creation request
globalThis.qwebrCreateHTMLElement = function (
  cellData
) {

  // Extract key components
  const evalType = cellData.options.context;
  const qwebrCounter = cellData.id;

  // We make an assumption that insertion points are defined by the Lua filter as:
  // qwebr-insertion-location-{qwebrCounter} 
  const elementLocator = document.getElementById(`qwebr-insertion-location-${qwebrCounter}`);

  // Figure out the routine to use to insert the element.
  let qwebrElement;
  switch ( evalType ) {
    case EvalTypes.Interactive:
      qwebrElement = qwebrCreateInteractiveElement(qwebrCounter, cellData.options);
      break;
    case EvalTypes.Output: 
      qwebrElement = qwebrCreateNonInteractiveOutputElement(qwebrCounter, cellData.options);
      break;
    case EvalTypes.Setup: 
      qwebrElement = qwebrCreateNonInteractiveSetupElement(qwebrCounter, cellData.options);
      break;
    default: 
      qwebrElement = document.createElement('div');
      qwebrElement.textContent = 'Error creating `quarto-webr` element';
  }

  // Insert the dynamically generated object at the document location.
  elementLocator.appendChild(qwebrElement);
};

// Function that setups the interactive element creation
globalThis.qwebrCreateInteractiveElement = function (qwebrCounter, qwebrOptions) {

  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = 'qwebr-interactive-area-' + qwebrCounter;
  mainDiv.className = `qwebr-interactive-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }

  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }

  // Create toolbar div
  var toolbarDiv = document.createElement('div');
  toolbarDiv.className = 'qwebr-editor-toolbar';
  toolbarDiv.id = 'qwebr-editor-toolbar-' + qwebrCounter;

  // Create a div to hold the left buttons
  var leftButtonsDiv = document.createElement('div');
  leftButtonsDiv.className = 'qwebr-editor-toolbar-left-buttons';

  // Create a div to hold the right buttons
  var rightButtonsDiv = document.createElement('div');
  rightButtonsDiv.className = 'qwebr-editor-toolbar-right-buttons';

  // Create Run Code button
  var runCodeButton = document.createElement('button');
  runCodeButton.className = 'btn btn-default qwebr-button qwebr-button-run';
  runCodeButton.disabled = true;
  runCodeButton.type = 'button';
  runCodeButton.id = 'qwebr-button-run-' + qwebrCounter;
  runCodeButton.textContent = '🟡 Loading webR...';
  runCodeButton.title = `Run code (Shift + Enter)`;

  // Append buttons to the leftButtonsDiv
  leftButtonsDiv.appendChild(runCodeButton);

  // Create Reset button
  var resetButton = document.createElement('button');
  resetButton.className = 'btn btn-light btn-xs qwebr-button qwebr-button-reset';
  resetButton.type = 'button';
  resetButton.id = 'qwebr-button-reset-' + qwebrCounter;
  resetButton.title = 'Start over';
  resetButton.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i>';

  // Create Copy button
  var copyButton = document.createElement('button');
  copyButton.className = 'btn btn-light btn-xs qwebr-button qwebr-button-copy';
  copyButton.type = 'button';
  copyButton.id = 'qwebr-button-copy-' + qwebrCounter;
  copyButton.title = 'Copy code';
  copyButton.innerHTML = '<i class="fa-regular fa-copy"></i>';

  // Append buttons to the rightButtonsDiv
  rightButtonsDiv.appendChild(resetButton);
  rightButtonsDiv.appendChild(copyButton);

  // Create console area div
  var consoleAreaDiv = document.createElement('div');
  consoleAreaDiv.id = 'qwebr-console-area-' + qwebrCounter;
  consoleAreaDiv.className = 'qwebr-console-area';

  // Create editor div
  var editorDiv = document.createElement('div');
  editorDiv.id = 'qwebr-editor-' + qwebrCounter;
  editorDiv.className = 'qwebr-editor';

  // Create output code area div
  var outputCodeAreaDiv = document.createElement('div');
  outputCodeAreaDiv.id = 'qwebr-output-code-area-' + qwebrCounter;
  outputCodeAreaDiv.className = 'qwebr-output-code-area';
  outputCodeAreaDiv.setAttribute('aria-live', 'assertive');

  // Create pre element inside output code area
  var preElement = document.createElement('pre');
  preElement.style.visibility = 'hidden';
  outputCodeAreaDiv.appendChild(preElement);

  // Create output graph area div
  var outputGraphAreaDiv = document.createElement('div');
  outputGraphAreaDiv.id = 'qwebr-output-graph-area-' + qwebrCounter;
  outputGraphAreaDiv.className = 'qwebr-output-graph-area';

  // Append buttons to the toolbar
  toolbarDiv.appendChild(leftButtonsDiv);
  toolbarDiv.appendChild(rightButtonsDiv);

  // Append all elements to the main div
  consoleAreaDiv.appendChild(editorDiv);
  mainDiv.appendChild(consoleAreaDiv);
  mainDiv.appendChild(toolbarDiv);
  mainDiv.appendChild(outputCodeAreaDiv);
  mainDiv.appendChild(outputGraphAreaDiv);

  return mainDiv;
}

// Function that adds output structure for non-interactive output
globalThis.qwebrCreateNonInteractiveOutputElement = function(qwebrCounter, qwebrOptions) {
  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = 'qwebr-noninteractive-area-' + qwebrCounter;
  mainDiv.className = `qwebr-noninteractive-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }
  
  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }
  
  // Create a status container div
  var statusContainer = createLoadingContainer(qwebrCounter);

  // Create output code area div
  var outputCodeAreaDiv = document.createElement('div');
  outputCodeAreaDiv.id = 'qwebr-output-code-area-' + qwebrCounter;
  outputCodeAreaDiv.className = 'qwebr-output-code-area';
  outputCodeAreaDiv.setAttribute('aria-live', 'assertive');

  // Create pre element inside output code area
  var preElement = document.createElement('pre');
  preElement.style.visibility = 'hidden';
  outputCodeAreaDiv.appendChild(preElement);

  // Create output graph area div
  var outputGraphAreaDiv = document.createElement('div');
  outputGraphAreaDiv.id = 'qwebr-output-graph-area-' + qwebrCounter;
  outputGraphAreaDiv.className = 'qwebr-output-graph-area';

  // Append all elements to the main div
  mainDiv.appendChild(statusContainer);
  mainDiv.appendChild(outputCodeAreaDiv);
  mainDiv.appendChild(outputGraphAreaDiv);

  return mainDiv;
};

// Function that adds a stub in the page to indicate a setup cell was used.
globalThis.qwebrCreateNonInteractiveSetupElement = function(qwebrCounter, qwebrOptions) {
  // Create main div element
  var mainDiv = document.createElement('div');
  mainDiv.id = `qwebr-noninteractive-setup-area-${qwebrCounter}`;
  mainDiv.className = `qwebr-noninteractive-setup-area`;
  if (qwebrOptions.classes) {
    mainDiv.className += " " + qwebrOptions.classes
  }


  // Add a unique cell identifier that users can customize
  if (qwebrOptions.label) {
    mainDiv.setAttribute('data-id', qwebrOptions.label);
  }

  // Create a status container div
  var statusContainer = createLoadingContainer(qwebrCounter);

  // Append status onto the main div
  mainDiv.appendChild(statusContainer);

  return mainDiv;
}


// Function to create loading container with specified ID
globalThis.createLoadingContainer = function(qwebrCounter) {

  // Create a status container
  const container = document.createElement('div');
  container.id = `qwebr-non-interactive-loading-container-${qwebrCounter}`;
  container.className = 'qwebr-non-interactive-loading-container qwebr-cell-needs-evaluation';

  // Create an R project logo to indicate its a code space
  const rProjectIcon = document.createElement('i');
  rProjectIcon.className = 'fa-brands fa-r-project fa-3x qwebr-r-project-logo';

  // Setup a loading icon from font awesome
  const spinnerIcon = document.createElement('i');
  spinnerIcon.className = 'fa-solid fa-spinner fa-spin fa-1x qwebr-icon-status-spinner';

  // Add a section for status text
  const statusText = document.createElement('p');
  statusText.id = `qwebr-status-text-${qwebrCounter}`;
  statusText.className = `qwebr-status-text qwebr-cell-needs-evaluation`;
  statusText.innerText = 'Loading webR...';

  // Incorporate an inner container
  const innerContainer = document.createElement('div');

  // Append elements to the inner container
  innerContainer.appendChild(spinnerIcon);
  innerContainer.appendChild(statusText);

  // Append elements to the main container
  container.appendChild(rProjectIcon);
  container.appendChild(innerContainer);

  return container;
}
</script><script type="module">
// Function to install a single package
async function qwebrInstallRPackage(packageName) {
  await mainWebR.evalRVoid(`webr::install('${packageName}');`);
}

// Function to load a single package
async function qwebrLoadRPackage(packageName) {
  await mainWebR.evalRVoid(`require('${packageName}', quietly = TRUE)`);
}

// Generic function to process R packages
async function qwebrProcessRPackagesWithStatus(packages, processType, displayStatusMessageUpdate = true) {
  // Switch between contexts
  const messagePrefix = processType === 'install' ? 'Installing' : 'Loading';

  // Modify button state
  qwebrSetInteractiveButtonState(`🟡 ${messagePrefix} package ...`, false);

  // Iterate over packages
  for (let i = 0; i < packages.length; i++) {
    const activePackage = packages[i];
    const formattedMessage = `${messagePrefix} package ${i + 1} out of ${packages.length}: ${activePackage}`;

    // Display the update in header
    if (displayStatusMessageUpdate) {
      qwebrUpdateStatusHeader(formattedMessage);
    }

    // Display the update in non-active areas
    qwebrUpdateStatusMessage(formattedMessage);

    // Run package installation
    if (processType === 'install') {
      await qwebrInstallRPackage(activePackage);
    } else {
      await qwebrLoadRPackage(activePackage);
    }
  }

  // Clean slate
  if (processType === 'load') {
    await mainWebR.flush();
  }
}

// Start a timer
const initializeWebRTimerStart = performance.now();

// Encase with a dynamic import statement
globalThis.qwebrInstance = import(qwebrCustomizedWebROptions.baseURL + "webr.mjs").then(
  async ({ WebR, ChannelType }) => {
    // Populate WebR options with defaults or new values based on `webr` meta
    globalThis.mainWebR = new WebR(qwebrCustomizedWebROptions);

    // Initialization WebR
    await mainWebR.init();

    // Setup a shelter
    globalThis.mainWebRCodeShelter = await new mainWebR.Shelter();

    // Setup a pager to allow processing help documentation 
    await mainWebR.evalRVoid('webr::pager_install()'); 

    // Override the existing install.packages() to use webr::install()
    await mainWebR.evalRVoid('webr::shim_install()'); 

    // Specify the repositories to pull from
    // Note: webR does not use the `repos` option, but instead uses `webr_pkg_repos`
    // inside of `install()`. However, other R functions still pull from `repos`.
    await mainWebR.evalRVoid(`
      options(
        webr_pkg_repos = c(${qwebrPackageRepoURLS.map(repoURL => `'${repoURL}'`).join(',')}),
        repos = c(${qwebrPackageRepoURLS.map(repoURL => `'${repoURL}'`).join(',')})
      )
    `);

    // Check to see if any packages need to be installed
    if (qwebrSetupRPackages) {
      // Obtain only a unique list of packages
      const uniqueRPackageList = Array.from(new Set(qwebrInstallRPackagesList));

      // Install R packages one at a time (either silently or with a status update)
      await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'install', qwebrShowStartupMessage);

      if (qwebrAutoloadRPackages) {
        // Load R packages one at a time (either silently or with a status update)
        await qwebrProcessRPackagesWithStatus(uniqueRPackageList, 'load', qwebrShowStartupMessage);
      }
    }
  }
);

// Stop timer
const initializeWebRTimerEnd = performance.now();

</script><script type="module">
// Function to verify a given JavaScript Object is empty
globalThis.qwebrIsObjectEmpty = function (arr) {
    return Object.keys(arr).length === 0;
}

// Global version of the Escape HTML function that converts HTML 
// characters to their HTML entities.
globalThis.qwebrEscapeHTMLCharacters = function(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  };

// Passthrough results
globalThis.qwebrIdentity = function(x) {
    return x;
};

// Append a comment
globalThis.qwebrPrefixComment = function(x, comment) {
    return `${comment}${x}`;
};

// Function to parse the pager results
globalThis.qwebrParseTypePager = async function (msg) { 

    // Split out the event data
    const { path, title, deleteFile } = msg.data; 

    // Process the pager data by reading the information from disk
    const paged_data = await mainWebR.FS.readFile(path).then((data) => {
        // Obtain the file content
        let content = new TextDecoder().decode(data);

        // Remove excessive backspace characters until none remain
        while(content.match(/.[\b]/)){
        content = content.replace(/.[\b]/g, '');
        }

        // Returned cleaned data
        return content;
    });

    // Unlink file if needed
    if (deleteFile) { 
        await mainWebR.FS.unlink(path); 
    } 

    // Return extracted data with spaces
    return paged_data;
} 

// Function to run the code using webR and parse the output
globalThis.qwebrComputeEngine = async function(
    codeToRun, 
    elements, 
    options) {

    // Call into the R compute engine that persists within the document scope.
    // To be prepared for all scenarios, the following happens: 
    // 1. We setup a canvas device to write to by making a namespace call into the {webr} package
    // 2. We use values inside of the options array to set the figure size.
    // 3. We capture the output stream information (STDOUT and STERR)
    // 4. While parsing the results, we disable image creation.

    // Create a canvas variable for graphics
    let canvas = undefined;

    // Create a pager variable for help/file contents
    let pager = [];

    // Handle how output is processed
    let showMarkup = options.results === "markup" && options.output !== "asis";
    let processOutput;

    if (showMarkup) {
        processOutput = qwebrEscapeHTMLCharacters;
    } else {
        processOutput = qwebrIdentity;
    }

    // ---- 
    // Convert from Inches to Pixels by using DPI (dots per inch)
    // for bitmap devices (dpi * inches = pixels)
    let fig_width = options["fig-width"] * options["dpi"]
    let fig_height = options["fig-height"] * options["dpi"]

    // Initialize webR
    await mainWebR.init();

    // Setup a webR canvas by making a namespace call into the {webr} package
    await mainWebR.evalRVoid(`webr::canvas(width=${fig_width}, height=${fig_height})`);

    const result = await mainWebRCodeShelter.captureR(codeToRun, {
        withAutoprint: true,
        captureStreams: true,
        captureConditions: false//,
        // env: webR.objs.emptyEnv, // maintain a global environment for webR v0.2.0
    });

    // -----

    // Start attempting to parse the result data
    processResultOutput:try {

        // Stop creating images
        await mainWebR.evalRVoid("dev.off()");
        
        // Avoid running through output processing
        if (options.results === "hide" || options.output === "false") { 
            break processResultOutput; 
        }

        // Merge output streams of STDOUT and STDErr (messages and errors are combined.)
        // Require both `warning` and `message` to be true to display `STDErr`. 
        const out = result.output
        .filter(
            evt => evt.type === "stdout" || 
            ( evt.type === "stderr" && (options.warning === "true" && options.message === "true")) 
        )
        .map((evt, index) => {
            const className = `qwebr-output-code-${evt.type}`;
            const outputResult = qwebrPrefixComment(processOutput(evt.data), options.comment);
            return `<code id="${className}-editor-${elements.id}-result-${index + 1}" class="${className}">${outputResult}</code>`;
        })
        .join("\n");


        // Clean the state
        // We're now able to process both graphics and pager events.
        // As a result, we cannot maintain a true 1-to-1 output order 
        // without individually feeding each line
        const msgs = await mainWebR.flush();

        // Output each image event stored
        msgs.forEach((msg) => {
        // Determine if old canvas can be used or a new canvas is required.
        if (msg.type === 'canvas'){
            // Add image to the current canvas
            if (msg.data.event === 'canvasImage') {
                canvas.getContext('2d').drawImage(msg.data.image, 0, 0);
            } else if (msg.data.event === 'canvasNewPage') {

                // Generate a new canvas element
                canvas = document.createElement("canvas");
                canvas.setAttribute("width", 2 * fig_width);
                canvas.setAttribute("height", 2 * fig_height);
                canvas.style.width = options["out-width"] ? options["out-width"] : `${fig_width}px`;
                if (options["out-height"]) {
                    canvas.style.height = options["out-height"];
                }
                canvas.style.display = "block";
                canvas.style.margin = "auto";
            }
        } 
        });

        // Use `map` to process the filtered "pager" events asynchronously
        const pager = await Promise.all(
            msgs.filter(msg => msg.type === 'pager').map(
                async (msg) => {
                    return await qwebrParseTypePager(msg);
                }
            )
        );

        // Nullify the output area of content
        elements.outputCodeDiv.innerHTML = "";
        elements.outputGraphDiv.innerHTML = "";

        // Design an output object for messages
        const pre = document.createElement("pre");
        if (/\S/.test(out)) {
            // Display results as HTML elements to retain output styling
            const div = document.createElement("div");
            div.innerHTML = out;
            pre.appendChild(div);
        } else {
            // If nothing is present, hide the element.
            pre.style.visibility = "hidden";
        }

        elements.outputCodeDiv.appendChild(pre);

        // Place the graphics on the canvas
        if (canvas) {
            // Create figure element
            const figureElement = document.createElement('figure');

            // Append canvas to figure
            figureElement.appendChild(canvas);

            if (options['fig-cap']) {
                // Create figcaption element
                const figcaptionElement = document.createElement('figcaption');
                figcaptionElement.innerText = options['fig-cap'];
                // Append figcaption to figure
                figureElement.appendChild(figcaptionElement);    
            }

            elements.outputGraphDiv.appendChild(figureElement);
        }

        // Display the pager data
        if (pager) {
        // Use the `pre` element to preserve whitespace.
        pager.forEach((paged_data, index) => {
            let pre_pager = document.createElement("pre");
            pre_pager.innerText = paged_data;
            pre_pager.classList.add("qwebr-output-code-pager");
            pre_pager.setAttribute("id", `qwebr-output-code-pager-editor-${elements.id}-result-${index + 1}`);
            elements.outputCodeDiv.appendChild(pre_pager);
        });
        }
    } finally {
        // Clean up the remaining code
        mainWebRCodeShelter.purge();
    }
}

// Function to execute the code (accepts code as an argument)
globalThis.qwebrExecuteCode = async function (
    codeToRun,
    id,
    options = {}) {

    // If options are not passed, we fall back on the bare minimum to handle the computation
    if (qwebrIsObjectEmpty(options)) {
        options = { 
            "context": "interactive", 
            "fig-width": 7, "fig-height": 5, 
            "out-width": "700px", "out-height": "", 
            "dpi": 72,
            "results": "markup", 
            "warning": "true", "message": "true",
        };
    }

    // Next, we access the compute areas values
    const elements = {
        runButton: document.getElementById(`qwebr-button-run-${id}`),
        outputCodeDiv: document.getElementById(`qwebr-output-code-area-${id}`),
        outputGraphDiv: document.getElementById(`qwebr-output-graph-area-${id}`),
        id: id,
    }

    // Disallowing execution of other code cells
    document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
        btn.disabled = true;
    });

    if (options.context == EvalTypes.Interactive) {
        // Emphasize the active code cell
        elements.runButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin qwebr-icon-status-spinner"></i> <span>Run Code</span>';
    }

    // Evaluate the code and parse the output into the document
    await qwebrComputeEngine(codeToRun, elements, options);

    // Switch to allowing execution of code
    document.querySelectorAll(".qwebr-button-run").forEach((btn) => {
        btn.disabled = false;
    });

    if (options.context == EvalTypes.Interactive) {
        // Revert to the initial code cell state
        elements.runButton.innerHTML = '<i class="fa-solid fa-play qwebr-icon-run-code"></i> <span>Run Code</span>';
    }
}

</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Matching.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Matching</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./"></a><a href="./index.html">Kausalanalyse mit R</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Lesemodus umschalten">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Suchen"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Start</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./R_Einfuehrung.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistische Programmierung mit R</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Reg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Simulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Simulation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Matching.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Matching</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./FixedEffects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Panel-Daten</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./IV.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">IV-Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./DiD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Difference-in-Differences</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./EventStudies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Event Studies</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./RDD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Regression Discontiniuty Designs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./RegReg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Regularisierte Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Machine Learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Machine Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SyntheticControl.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Synthetic Control</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Literatur.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Literatur</span></a>
  </div>
</li>
    </ul>
</div>
    <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title"><a href="./index.html">Übersicht</a></h2>
   
  <ul>
<li>
<a href="#sec-balance" id="toc-sec-balance" class="nav-link active" data-scroll-target="#sec-balance"><span class="header-section-number">5.1</span> <em>Balance</em>: Vergleichbarkeit von Behandlungs- und Kontrollgruppe</a>
  <ul>
<li><a href="#matching-durch-gewichtung" id="toc-matching-durch-gewichtung" class="nav-link" data-scroll-target="#matching-durch-gewichtung"><span class="header-section-number">5.1.1</span> Matching durch Gewichtung</a></li>
  <li><a href="#entropy-balancing" id="toc-entropy-balancing" class="nav-link" data-scroll-target="#entropy-balancing"><span class="header-section-number">5.1.2</span> Entropy Balancing</a></li>
  <li><a href="#sec-PSM" id="toc-sec-PSM" class="nav-link" data-scroll-target="#sec-PSM"><span class="header-section-number">5.1.3</span> Mehrere Matching-Variablen und der Propensity Score</a></li>
  </ul>
</li>
  <li>
<a href="#selektierende-matching-verfahren" id="toc-selektierende-matching-verfahren" class="nav-link" data-scroll-target="#selektierende-matching-verfahren"><span class="header-section-number">5.2</span> Selektierende Matching-Verfahren</a>
  <ul>
<li><a href="#exaktes-matching" id="toc-exaktes-matching" class="nav-link" data-scroll-target="#exaktes-matching"><span class="header-section-number">5.2.1</span> Exaktes Matching</a></li>
  <li><a href="#coarsened-exact-matching" id="toc-coarsened-exact-matching" class="nav-link" data-scroll-target="#coarsened-exact-matching"><span class="header-section-number">5.2.2</span> Coarsened Exact Matching</a></li>
  <li><a href="#matching-mit-der-mahalanobis-distanz" id="toc-matching-mit-der-mahalanobis-distanz" class="nav-link" data-scroll-target="#matching-mit-der-mahalanobis-distanz"><span class="header-section-number">5.2.3</span> Matching mit der Mahalanobis-Distanz</a></li>
  <li><a href="#propensity-score-matching" id="toc-propensity-score-matching" class="nav-link" data-scroll-target="#propensity-score-matching"><span class="header-section-number">5.2.4</span> Propensity Score Matching</a></li>
  </ul>
</li>
  <li>
<a href="#sec-regadj" id="toc-sec-regadj" class="nav-link" data-scroll-target="#sec-regadj"><span class="header-section-number">5.3</span> Schätzung und Inferenz für den Behandlungseffekt nach Matching</a>
  <ul>
<li><a href="#cluster-robuste-standardfehler" id="toc-cluster-robuste-standardfehler" class="nav-link" data-scroll-target="#cluster-robuste-standardfehler"><span class="header-section-number">5.3.1</span> Cluster-robuste Standardfehler</a></li>
  </ul>
</li>
  <li><a href="#sec-bootmatching" id="toc-sec-bootmatching" class="nav-link" data-scroll-target="#sec-bootmatching"><span class="header-section-number">5.4</span> Bootstrap-Schätzung kausaler Effekte bei Matching</a></li>
  <li><a href="#regression-matching-und-doubly-robust-sch%C3%A4tzung" id="toc-regression-matching-und-doubly-robust-schätzung" class="nav-link" data-scroll-target="#regression-matching-und-doubly-robust-sch%C3%A4tzung"><span class="header-section-number">5.5</span> Regression, Matching und Doubly-Robust-Schätzung</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content"><script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script><script type="module" id="qwebr-monaco-editor-init">

  // Configure the Monaco Editor's loader
  require.config({
    paths: {
      'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs'
    }
  });
</script><script type="module">
// Global dictionary to store Monaco Editor instances
globalThis.qwebrEditorInstances = {};

// Function that builds and registers a Monaco Editor instance    
globalThis.qwebrCreateMonacoEditorInstance = function (cellData) {

  const initialCode = cellData.code;
  const qwebrCounter = cellData.id;
  const qwebrOptions = cellData.options;

  // Retrieve the previously created document elements
  let runButton = document.getElementById(`qwebr-button-run-${qwebrCounter}`);
  let resetButton = document.getElementById(`qwebr-button-reset-${qwebrCounter}`);
  let copyButton = document.getElementById(`qwebr-button-copy-${qwebrCounter}`);
  let editorDiv = document.getElementById(`qwebr-editor-${qwebrCounter}`);
  
  // Load the Monaco Editor and create an instance
  let editor;
  require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(editorDiv, {
      value: initialCode,
      language: 'r',
      theme: 'vs-light',
      automaticLayout: true,           // Works wonderfully with RevealJS
      scrollBeyondLastLine: false,
      minimap: {
        enabled: false
      },
      fontSize: '14pt',              // Bootstrap is 1 rem
      renderLineHighlight: "none",     // Disable current line highlighting
      hideCursorInOverviewRuler: true  // Remove cursor indictor in right hand side scroll bar
    });

    // Store the official counter ID to be used in keyboard shortcuts
    editor.__qwebrCounter = qwebrCounter;

    // Store the official div container ID
    editor.__qwebrEditorId = `qwebr-editor-${qwebrCounter}`;

    // Store the initial code value and options
    editor.__qwebrinitialCode = initialCode;
    editor.__qwebrOptions = qwebrOptions;

    // Set at the model level the preferred end of line (EOL) character to LF.
    // This prevent `\r\n` from being given to the webR engine if the user is on Windows.
    // See details in: https://github.com/coatless/quarto-webr/issues/94
    // Associated error text: 
    // Error: <text>:1:7 unexpected input

    // Retrieve the underlying model
    const model = editor.getModel();
    // Set EOL for the model
    model.setEOL(monaco.editor.EndOfLineSequence.LF);

    // Dynamically modify the height of the editor window if new lines are added.
    let ignoreEvent = false;
    const updateHeight = () => {
      const contentHeight = editor.getContentHeight();
      // We're avoiding a width change
      //editorDiv.style.width = `${width}px`;
      editorDiv.style.height = `${contentHeight}px`;
      try {
        ignoreEvent = true;

        // The key to resizing is this call
        editor.layout();
      } finally {
        ignoreEvent = false;
      }
    };

    // Helper function to check if selected text is empty
    function isEmptyCodeText(selectedCodeText) {
      return (selectedCodeText === null || selectedCodeText === undefined || selectedCodeText === "");
    }

    // Registry of keyboard shortcuts that should be re-added to each editor window
    // when focus changes.
    const addWebRKeyboardShortCutCommands = () => {
      // Add a keydown event listener for Shift+Enter to run all code in cell
      editor.addCommand(monaco.KeyMod.Shift | monaco.KeyCode.Enter, () => {

        // Retrieve all text inside the editor
        qwebrExecuteCode(editor.getValue(), editor.__qwebrCounter, editor.__qwebrOptions);
      });

      // Add a keydown event listener for CMD/Ctrl+Enter to run selected code
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {

        // Get the selected text from the editor
        const selectedText = editor.getModel().getValueInRange(editor.getSelection());
        // Check if no code is selected
        if (isEmptyCodeText(selectedText)) {
          // Obtain the current cursor position
          let currentPosition = editor.getPosition();
          // Retrieve the current line content
          let currentLine = editor.getModel().getLineContent(currentPosition.lineNumber);

          // Propose a new position to move the cursor to
          let newPosition = new monaco.Position(currentPosition.lineNumber + 1, 1);

          // Check if the new position is beyond the last line of the editor
          if (newPosition.lineNumber > editor.getModel().getLineCount()) {
            // Add a new line at the end of the editor
            editor.executeEdits("addNewLine", [{
            range: new monaco.Range(newPosition.lineNumber, 1, newPosition.lineNumber, 1),
            text: "\n", 
            forceMoveMarkers: true,
            }]);
          }
          
          // Run the entire line of code.
          qwebrExecuteCode(currentLine, editor.__qwebrCounter, editor.__qwebrOptions);

          // Move cursor to new position
          editor.setPosition(newPosition);
        } else {
          // Code to run when Ctrl+Enter is pressed with selected code
          qwebrExecuteCode(selectedText, editor.__qwebrCounter, editor.__qwebrOptions);
        }
      });
    }

    // Register an on focus event handler for when a code cell is selected to update
    // what keyboard shortcut commands should work.
    // This is a workaround to fix a regression that happened with multiple
    // editor windows since Monaco 0.32.0 
    // https://github.com/microsoft/monaco-editor/issues/2947
    editor.onDidFocusEditorText(addWebRKeyboardShortCutCommands);

    // Register an on change event for when new code is added to the editor window
    editor.onDidContentSizeChange(updateHeight);

    // Manually re-update height to account for the content we inserted into the call
    updateHeight();

    // Store the editor instance in the global dictionary
    qwebrEditorInstances[editor.__qwebrCounter] = editor;

  });

  // Add a click event listener to the run button
  runButton.onclick = function () {
    qwebrExecuteCode(editor.getValue(), editor.__qwebrCounter, editor.__qwebrOptions);
  };

  // Add a click event listener to the reset button
  copyButton.onclick = function () {
    // Retrieve current code data
    const data = editor.getValue();
    
    // Write code data onto the clipboard.
    navigator.clipboard.writeText(data || "");
  };
  
  // Add a click event listener to the copy button
  resetButton.onclick = function () {
    editor.setValue(editor.__qwebrinitialCode);
  };
  
}
</script><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Matching</span>
</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><style>
.qwebr-code-output-stdout {background-color: powderblue;}

.qwebr-button-run, .qwebr-button-reset, .qwebr-button-copy {
  background-color:  rgba(0, 0, 0, 0);
  border-style: none;
  font-weight: 400;
  color: white; 
  transition: none;
}

.qwebr-editor-toolbar {
  width: 100%;
  display: flex;
  justify-content: space-between;
  box-sizing: border-box;
  border-radius: 0 0 6px 6px;
  background-color: darkgreen;
  border-color: darkgreen;
  border-width: 1px;
  border-style: solid;
  padding: 0 0; 
  transition: color .1s ease-in-out, background-color .1s ease-in-out,border-color .1s ease-in-out,box-shadow .1s ease-in-out;
}

.qwebr-editor-toolbar:hover {
  background-color: white;
  border-color: darkgreen;
  border-width: 1px;
}

.qwebr-editor-toolbar:hover * {
  color: darkgreen;
}

.overflow-guard, .qwebr-editor, .monaco-editor {
  border-radius: 6px 6px 0 0;
  border-width: 1px 1px 0 1px;
  border-color: darkgreen;
}

</style>
<div class="cell">

</div>
<div id="qwebr-insertion-location-1"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
<div id="qwebr-insertion-location-2"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
<p>In randomisierten kontrollierten Studien stellt eine randomisierte Behandlung sicher, dass die Individuen beider Gruppen im Mittel vergleichbar sind, dass heißt es gibt keine systematischen Unterschiede der Studiensubjekte hinsichtlich der Verteilung von Charakteristika zwischen den Gruppen. Dann ist es plausibel eine beobachtete mittlere Differenz in der Outcome-Variable alleine auf die Behandlung zurückzuführen.</p>
<p>In der Praxis, insbesondere in ökonomischen Studien, sind randomisierte kontrollierte Studien aus ethischen und/oder finanziellen Gründen nicht durchführbar. Stattdessen werden nicht-experimentelle Daten genutzt, die jedoch nur sehr selten eine Vergleichbarkeit von Behandlungs- und Kontrollgruppe gewährleisten.</p>
<p>In diesem Kapitel betrachten wir Methoden, die in solchen Forschungsdesigns – bei hinreichenden Informationen über die Studiensubjekte – eine Schätzung kausaler Effekte ermöglichen, indem eine statistische Vergleichbarkeit von Behandlungs- und Kontrollgruppe hergestellt wird. Dies kann durch eine gezielte Gewichtung von Beobachtungen anhand invididueller Merkmale bei der Schätzung des Behandlungseffekts erfolgen. Andere etablierte Methoden schätzen den kausalen Effekt nach Selektion von vergleichbaren Teilmengen von Subjekten beider Gruppen aus der ursprünglichen Stichprobe, sogenanntes <em>selektierendes Matching</em>.</p>
<p>Da Matching Beobachtungen basierend auf beobachtbaren Merkmalen vergleicht, kann die Wahrscheinlichkeit einer verzerrten Schätzung des kausalen Effekt durch falsche Modellspezifikationen geringer sein als für eine Schätzung des Effekts anhand multipler Regression. Weiterhin basieren Matching-Methoden nicht auf der Annahme eines linearen Zusammenhangs zwischen Kovariablen und der erklärenden Variable und können für die Schätzung unterschiedlicher Spezifikationen von Behandlungseffekten herangezogen werden.</p>
<p>Für die Gültigkeit eines Schätzers basierend auf Matching sind zwei Annahmen erforderlich.</p>
<ol type="1">
<li><p><strong><em>Bedingte Unabhängigkeit.</em></strong> Seien <span class="math inline">\(Y^{(0)}_i\)</span> und <span class="math inline">\(Y^{(1)}_i\)</span> potentielle Ergebnisse der Outcome-Variable <span class="math inline">\(Y\)</span> für ein Subjekt <span class="math inline">\(i\)</span> mit <span class="math inline">\(B_i=0\)</span> (keine Zuweisung zur Behandlung) beziehungsweise <span class="math inline">\(B_i=1\)</span> (Behandlung) und <span class="math inline">\(X_i\)</span> die beobachteten Kovariablen. Wir nehmen an, dass <span class="math display">\[\begin{align}
  \left\{Y^{(0)}_i, Y^{(1)}_i\right\} \perp B_i\vert X_i, \label{eq:cia}
\end{align}\]</span> d.h. die Behandlungszuweisung/-selektion ist unanabhängig von den potentielle Ergebnissen <span class="math inline">\(Y^{(0)}_i\)</span> und <span class="math inline">\(Y^{(1)}_i\)</span>, wenn wir für die Kovariablen <span class="math inline">\(X\)</span> kontrollieren.</p></li>
<li><p><strong><em>Überlappung.</em></strong> Für jede mögliche Kombination von Kovariablen <span class="math inline">\(X_i\)</span> gibt es eine positive Wahrscheinlichkeit <span class="math inline">\(&lt;1\)</span>, sowohl zur Behandlungsgruppe (<span class="math inline">\(B_i = 1\)</span>) als auch zur Kontrollgruppe (<span class="math inline">\(B_i = 0\)</span>) zugewiesen zu werden, <span class="math display">\[\begin{align}
  0 &lt; \text{P}(B_i=1\lvert X_i) &lt; 1, \label{eq:overlap}
\end{align}\]</span> d.h. keine Beobachtung hat eine Behandlungswahrscheinlichkeit von exakt <span class="math inline">\(0\)</span> oder <span class="math inline">\(1\)</span>.</p></li>
</ol>
<p>Annahme 1 stellt sicher, dass die Zuweisung zur Behandlungsgruppe nach Kontrolle für die Kovariablen <span class="math inline">\(X\)</span> als zufällig betracht werden kann. Somit ist es möglich den kausalen Effekt der Behandlung zu identifizieren, indem wir hinsichtlich der Kovariablen <span class="math inline">\(X\)</span> ähnliche Subjekte (vgl. Annahme 2) aus Kontroll- und Behandlungsgruppe vergleichen.</p>
<p>Annahme 2 setzt vorraus, dass es eine ausreichende Überlappung in den Verteilungen der Kovariablen zwischen Behandlungs- und Kontrollgruppe gibt. Dann ist sichergestellt, dass für jedes Subjekt in einer Gruppe ein hinsichtlich seiner Charakteristika vergleichbares Subjekt in der anderen Gruppe geben kann, sodass ein Vergleich möglich ist.</p>
<section id="sec-balance" class="level2 page-columns page-full" data-number="5.1"><h2 data-number="5.1" class="anchored" data-anchor-id="sec-balance">
<span class="header-section-number">5.1</span> <em>Balance</em>: Vergleichbarkeit von Behandlungs- und Kontrollgruppe</h2>
<p>Der Lehrstuhl für Ökonometrie an der Universität Duisburg-Essen betreibt einen Ökonometrie-Blog und interessiert sich für den kausalen Effekt der Einführung eines <a href="https://en.wikipedia.org/wiki/Wikipedia:Dark_mode">darkmode</a> auf die Verweildauer der User auf der Webseite. Die Webseite ist zwar nicht-kommerziell, hat sich allerdings insb. für die Aquise internationaler Studierender für den Studiengang MSc. Econometrics als wichtiges Marketing-Instrument erwiesen. Ein anprechendes Design wird daher als hoch-relevant erachtet.</p>
<p>Idealerweise sollte der Effekt des Design-Relaunches auf die Nutzungsintensität in einem kontrollierten randomisierten Experiment untersucht werden. Hierbei würden wir Nutzern zufällig das neue oder das alte Design zuweisen und den Effekt als Differnz des durchschnittlichen Verweildauer für die Gruppen bestimmen. Eine solche Studie ist jedoch aus technischen und finanziellen Gründen nicht realisierbar, sodass die Auswirkungen des darkmode mit vorliegenden nicht-experimenellen Nutzungsstatistiken für die Webseite geschätzt werden sollen.</p>
<p>Die Nutzungsstatistiken sind im Datensatz <a href="https://raw.githubusercontent.com/mca91/kasa_data/main/darkmode.csv"><em>darkmode.csv</em></a> enthalten und sollen der Analyse des Effekts des darkmode (<code>dark_mode</code>) auf die Verweildauer der Leser auf der Webseite (<code>read_time</code>) dienen.</p>
<p><a href="#tbl-darkmode" class="quarto-xref">Tabelle&nbsp;<span>5.1</span></a> zeigt die Definitionen der Variablen in <em>darkmode.csv</em>.</p>
<div class="cell page-columns page-full">
<div id="tbl-darkmode" class="cell quarto-float anchored page-columns page-full">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full"><div aria-describedby="tbl-darkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<div id="psrzchicnx" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#psrzchicnx table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#psrzchicnx thead, #psrzchicnx tbody, #psrzchicnx tfoot, #psrzchicnx tr, #psrzchicnx td, #psrzchicnx th {
  border-style: none;
}

#psrzchicnx p {
  margin: 0;
  padding: 0;
}

#psrzchicnx .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #000000;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#psrzchicnx .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#psrzchicnx .gt_title {
  color: #000000;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#psrzchicnx .gt_subtitle {
  color: #000000;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#psrzchicnx .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#psrzchicnx .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#psrzchicnx .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #000000;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#psrzchicnx .gt_col_heading {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#psrzchicnx .gt_column_spanner_outer {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#psrzchicnx .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#psrzchicnx .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#psrzchicnx .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#psrzchicnx .gt_spanner_row {
  border-bottom-style: hidden;
}

#psrzchicnx .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#psrzchicnx .gt_empty_group_heading {
  padding: 0.5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#psrzchicnx .gt_from_md > :first-child {
  margin-top: 0;
}

#psrzchicnx .gt_from_md > :last-child {
  margin-bottom: 0;
}

#psrzchicnx .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#psrzchicnx .gt_stub {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#psrzchicnx .gt_stub_row_group {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#psrzchicnx .gt_row_group_first td {
  border-top-width: 2px;
}

#psrzchicnx .gt_row_group_first th {
  border-top-width: 2px;
}

#psrzchicnx .gt_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#psrzchicnx .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#psrzchicnx .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#psrzchicnx .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#psrzchicnx .gt_grand_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#psrzchicnx .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#psrzchicnx .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#psrzchicnx .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#psrzchicnx .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
}

#psrzchicnx .gt_footnotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#psrzchicnx .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#psrzchicnx .gt_sourcenotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#psrzchicnx .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#psrzchicnx .gt_left {
  text-align: left;
}

#psrzchicnx .gt_center {
  text-align: center;
}

#psrzchicnx .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#psrzchicnx .gt_font_normal {
  font-weight: normal;
}

#psrzchicnx .gt_font_bold {
  font-weight: bold;
}

#psrzchicnx .gt_font_italic {
  font-style: italic;
}

#psrzchicnx .gt_super {
  font-size: 65%;
}

#psrzchicnx .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#psrzchicnx .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#psrzchicnx .gt_indent_1 {
  text-indent: 5px;
}

#psrzchicnx .gt_indent_2 {
  text-indent: 10px;
}

#psrzchicnx .gt_indent_3 {
  text-indent: 15px;
}

#psrzchicnx .gt_indent_4 {
  text-indent: 20px;
}

#psrzchicnx .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="header gt_col_headings">
<th id="Variable" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Variable</th>
<th id="Beschreibung" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Beschreibung</th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="Variable">read_time</td>
<td class="gt_row gt_left" headers="Beschreibung">Lesezeit (Minuten/Woche)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Variable">dark_mode</td>
<td class="gt_row gt_left" headers="Beschreibung">Indikator: Beobachtung nach Einführung darkmode</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Variable">male</td>
<td class="gt_row gt_left" headers="Beschreibung">Indikator: Individuum männlich</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="Variable">age</td>
<td class="gt_row gt_left" headers="Beschreibung">Alter (in Jahren)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="Variable">hours</td>
<td class="gt_row gt_left" headers="Beschreibung">Bisherige Verweildauer auf der Seite</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-tbl margin-caption" id="tbl-darkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Tabelle&nbsp;5.1: Variablen im Datensatz <em>darkmode</em>
</figcaption></figure>
</div>
</div>
<p>Für die Analyse lesen wir zunächst den Datensatz <em>darkmode.csv</em> mit <code><a href="https://readr.tidyverse.org/reference/read_delim.html">readr::read_csv()</a></code> ein und verschaffen uns einen Überblick über die verfügbaren Variablen.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Paket `tidyverse` laden</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Datensatz 'darkmode' einlesen</span></span>
<span><span class="va">darkmode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="st">"datasets/darkmode.csv"</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>dark_mode</code> hat den Typ <code>logical</code>. Mit <code><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">dplyr::mutate_all()</a></code> können wir komfortabel alle Spalten in den Typ <code>numeric</code> transformieren.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Alle Variablen zu typ 'numeric' formatieren...</span></span>
<span><span class="va">darkmode</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span>.funs <span class="op">=</span> <span class="va">as.numeric</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ... und überprüfen</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">darkmode</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 300
Columns: 5
$ read_time &lt;dbl&gt; 14.4, 15.4, 20.9, 20.0, 21.5, 19.5, 22.0, 17.4, 23.6, 15.7, …
$ dark_mode &lt;dbl&gt; 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, …
$ male      &lt;dbl&gt; 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, …
$ age       &lt;dbl&gt; 43, 55, 23, 41, 29, 64, 18, 53, 59, 53, 43, 38, 42, 23, 39, …
$ hours     &lt;dbl&gt; 65.6, 125.4, 642.6, 129.1, 190.2, 185.3, 333.5, 279.3, 1302.…</code></pre>
</div>
</div>
<p>Eine naive Schätzung des durchschnittlichen Behandlungseffekts (ATE) <span class="math inline">\(\widehat{\tau}^{\text{naiv}}\)</span> erhalten wir als Mittelwertdifferenz von <code>read_time</code> für die Behandlungsgruppe (<code>dark_mode == 1</code>) und die Kontrollgruppe (<code>dark_mode == 0</code>) <span class="math display">\[\begin{align}
  \widehat{\tau}^{\text{naiv}} = \overline{\text{read\_time}}_{\text{Behandlung}} - \overline{\text{read\_time}}_{\text{Kontrolle}}.\label{eq:naivATEdarkmode}
\end{align}\]</span></p>
<p>Diese Berechnung ist schnell mit R durchgeführt.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Naiver Schätzer für ATE: </span></span>
<span><span class="co"># Differenz der Gruppen-Durchschnitte</span></span>
<span></span>
<span><span class="co"># Outcome in Behandlungsgruppe</span></span>
<span><span class="va">read_time_mTG</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"read_time"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Outcome in Kontrollgruppe</span></span>
<span><span class="va">read_time_mKG</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"read_time"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mittelwert-Differenz</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">read_time_mTG</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">read_time_mKG</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.4446331</code></pre>
</div>
</div>
<p>Die Schätzung ergibt einen negativen Behandlungseffekt, mit der Interpreation, dass das neue Design zu einer Reduktion der Lesezeit um etwa 0.44 Minuten pro Woche führt. Dieses Ergebnis ist allerdings zweifelhaft, weil eine Isolierung des Behandlungseffekts aufgrund von Backdoor-Pfaden im DGP vermutlich nicht gewähleistet ist. Ein Indikator hierfür sind systematische Unterschiede hinsichtlich von (möglicherweise unbeobachtbaren) Charakteristika von Kontrollgruppe und Behandlungsgruppe.</p>
<p>Da die User sich beim Aufrufen der Seite aktiv für oder gegen den das neue Design entscheiden müssen (und somit selektieren, ob Sie in der Behandlungs- oder Kontrollgruppe landen), liegt wahrscheinlich <em>Confounding</em> vor: Unsere Hypothese ist zunächst, dass männliche User eine durchschnittlich längere Lesezeit aufweisen <em>und</em> mit größerer Wahrscheinlichkeit auf das neue Design wechseln als nicht-männliche Leser. Dann ist <code>male</code> eine Backdoor-Variable. Diese Situation ist unter der Annahme, dass nur diese Faktoren den DGP bestimmen, in <a href="#fig-maleCDdarkmode" class="quarto-xref">Abbildung&nbsp;<span>5.1</span></a> dargestellt.</p>
<div class="cell page-columns page-full" data-fig-width="4" data-fig-height="3" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-maleCDdarkmode" class="quarto-figure quarto-figure-center quarto-float anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-maleCDdarkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<svg width="384" height="288" viewbox="0.00 0.00 371.48 152.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148)"><polygon fill="white" stroke="transparent" points="-4,4 -4,-148 367.48,-148 367.48,4 -4,4"></polygon><!-- read_time --><g id="node1" class="node"><title>read_time</title>
<text text-anchor="middle" x="327.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">read_time</text></g><!-- dark_mode --><g id="node2" class="node"><title>dark_mode</title>
<text text-anchor="middle" x="39.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">dark_mode</text></g><!-- dark_mode&#45;&gt;read_time --><g id="edge1" class="edge"><title>dark_mode-&gt;read_time</title>
<path fill="none" stroke="green" d="M79.23,-126C132,-126 225.02,-126 280.99,-126"></path><polygon fill="green" stroke="green" points="281.33,-129.5 291.33,-126 281.33,-122.5 281.33,-129.5"></polygon></g><!-- male --><g id="node3" class="node"><title>male</title>
<text text-anchor="middle" x="183.49" y="-13.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">male</text></g><!-- male&#45;&gt;read_time --><g id="edge3" class="edge"><title>male-&gt;read_time</title>
<path fill="none" stroke="red" d="M207.59,-36.08C231.58,-54.07 268.54,-81.79 295.09,-101.7"></path><polygon fill="red" stroke="red" points="293.21,-104.66 303.31,-107.86 297.41,-99.06 293.21,-104.66"></polygon></g><!-- male&#45;&gt;dark_mode --><g id="edge2" class="edge"><title>male-&gt;dark_mode</title>
<path fill="none" stroke="red" d="M159.39,-36.08C135.4,-54.07 98.44,-81.79 71.89,-101.7"></path><polygon fill="red" stroke="red" points="69.57,-99.06 63.67,-107.86 73.77,-104.66 69.57,-99.06"></polygon></g></g></svg>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-maleCDdarkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abbildung&nbsp;5.1: Backdoor durch ‘male’ im Website-Design-Bespiel
</figcaption></figure>
</div>
</div>
</div>
<p>Der DGP in <a href="#fig-maleCDdarkmode" class="quarto-xref">Abbildung&nbsp;<span>5.1</span></a> führt zu einer verzerrten Schätzung des kausalen Effekts von <code>dark_mode</code> auf <code>read_time</code> mit <span class="math inline">\(\eqref{eq:naivATEdarkmode}\)</span>, wenn das Verhältnis von männlichen und nicht-männlichen Usern in Bahandlungs- und Kontrollgruppe nicht ausgeglichen ist. Wir überprüfen dies mit R.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Anteile männlicher und nicht-männlicher User</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">anteile</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    gesamt <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    ant_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">male</span><span class="op">)</span>,</span>
<span>    ant_nm <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">ant_m</span>,</span>
<span>    anz_m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">male</span><span class="op">)</span>,</span>
<span>    anz_nm <span class="op">=</span> <span class="va">gesamt</span> <span class="op">-</span> <span class="va">anz_m</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  dark_mode gesamt ant_m ant_nm anz_m anz_nm
      &lt;dbl&gt;  &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1         0    151 0.338  0.662    51    100
2         1    149 0.658  0.342    98     51</code></pre>
</div>
</div>
<p>Die Zusammenfassung <code>anteile_m</code> zeigt, dass der Anteil männlicher User in der Behandlungsgruppe deutlich höher ist als in der Kontrollgruppe.</p>
<section id="matching-durch-gewichtung" class="level3 page-columns page-full" data-number="5.1.1"><h3 data-number="5.1.1" class="anchored" data-anchor-id="matching-durch-gewichtung">
<span class="header-section-number">5.1.1</span> Matching durch Gewichtung</h3>
<p>Matching eliminiert die Variation von <code>male</code> zwischen den Gruppen. Eine Möglichkeit hierfür ist die Gewichtung der Beobachtungen in der Kontrollgruppe entsprechend der Anteile von Männern und Nicht-Männern in der Behandlungsgruppe, sodass die Vergleichbarkeit mit der Behandlungsgruppe hinsichtlich des Geschlechts gewährleistet ist. Dies wird in der Literatur als <em>Balance</em> bezeichnet. Der Behandlungseffekt wird dann analog zu <span class="math inline">\(\eqref{eq:naivATEdarkmode}\)</span> geschätzt.</p>
<p>Die Gewichte für Beobachtungen in der Kontrollgruppe <span class="math inline">\(w_i\)</span> werden berechnet als <span class="math display">\[\begin{align}
  w_i =
  \begin{cases}
    \text{ant\_m}_B/\text{anz\_m}_{K}, &amp; \text{falls } \text{male}_i = 1\\
        \text{ant\_nm}_B/\text{anz\_nm}_{K}, &amp; \text{sonst.}\\
  \end{cases}\label{eq:darkmodeweights}
\end{align}\]</span> Anhand der Formel für einen gewichteten Durchschnitt, <span class="math display">\[\begin{align}
  \overline{X}_w = \frac{\sum_i w_i \cdot X_i}{\sum_i w_i},
\end{align}\]</span> berechnen wir die gewichteten Mittelwerte für <code>male</code> und <code>read_time</code> in der Kontrollgruppe.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Anteile und Anzahlen aus `anteile` auslesen</span></span>
<span><span class="va">anz_m_K</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">anz_m</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anz_nm_K</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">anz_nm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ant_m_B</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">ant_m</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ant_nm_B</span> <span class="op">&lt;-</span> <span class="va">anteile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">ant_nm</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Gewichtete Mittel für Kontrollgruppe berechnen</span></span>
<span><span class="op">(</span></span>
<span><span class="va">gew_K</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">read_time</span>, <span class="va">male</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">male</span> <span class="op">==</span> <span class="fl">1</span>, </span>
<span>    <span class="va">ant_m_B</span><span class="op">/</span><span class="va">anz_m_K</span>, </span>
<span>    <span class="va">ant_nm_B</span><span class="op">/</span><span class="va">anz_nm_K</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    male_k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">male</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span>,</span>
<span>    mean_read_time_wK <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  male_k mean_read_time_wK
   &lt;dbl&gt;             &lt;dbl&gt;
1  0.658              18.1</code></pre>
</div>
</div>
<p>Ein Vergleich des gewichteten Mittelwertes von <code>male</code> in der Kontrollgruppe mit dem Mittelwert in der Behandlungsgruppe (<code>male_k</code>) zeigt, dass die Gewichte die Variation in <code>male</code> zwischen beiden Gruppen eliminieren, sodass die Backdoor durch <code>male</code> geschlossen ist. Mit <code>wmean_read_time_K</code> haben wir einen entsprechend gewichteten Mittelwert der Verweildauer für die Kontrollgruppe berechnet. Wir schätzen den Behandlungseffekt nun als <span class="math display">\[\begin{align}
  \widehat{\tau}^{\text{w}} = \overline{\text{read\_time}}_{B} - \overline{\text{read\_time}}_{w,K}.\label{eq:weightedATEdarkmode}
\end{align}\]</span></p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">read_time_mTG</span><span class="op">)</span>  <span class="op">-</span> <span class="va">gew_K</span><span class="op">$</span><span class="va">mean_read_time_wK</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6383579</code></pre>
</div>
</div>
<p>Entgegen der naiven Schätzung andhand von <span class="math inline">\(\eqref{eq:naivATEdarkmode}\)</span> erhalten wir nach Matching für <code>male</code> eine positive Schätzung des Behandlungseffekts von etwa <span class="math inline">\(0.64\)</span>.</p>
<p>Die Schätzung des Behandlungseffekts anhand von <span class="math inline">\(\eqref{eq:weightedATEdarkmode}\)</span> entspricht dem geschätzten Koeffizienten <span class="math inline">\(\widehat{\beta}_1\)</span> aus einer gewichteten KQ-Regression im Modell <span class="math display">\[\begin{align*}
  \text{read\_time} = \beta_0 + \beta_1 \text{dark\_mode} + u,
\end{align*}\]</span> wobei die Beobachtungen der Kontrollgruppe wie in <span class="math inline">\(\eqref{eq:darkmodeweights}\)</span> gewichtet werden und <span class="math inline">\(w_i=1\)</span> für Beobachtungen der Behandlungsgruppe ist. Wir überprüfen dies mit R.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_w</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    w <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">male</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">ant_m_B</span><span class="op">/</span><span class="va">anz_m_K</span>,</span>
<span>      <span class="va">male</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">ant_nm_B</span><span class="op">/</span><span class="va">anz_nm_K</span>,</span>
<span>      <span class="cn">T</span> <span class="op">~</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">~</span> <span class="va">dark_mode</span>, weights <span class="op">=</span> <span class="va">w</span>, data <span class="op">=</span> <span class="va">darkmode_w</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ dark_mode, data = darkmode_w, weights = w)

Weighted Residuals:
     Min       1Q   Median       3Q      Max 
-11.4302  -0.6929   0.0814   0.7230  12.8698 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  18.0918     3.4796   5.199 3.72e-07 ***
dark_mode     0.6384     3.4912   0.183    0.855    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.48 on 298 degrees of freedom
Multiple R-squared:  0.0001122, Adjusted R-squared:  -0.003243 
F-statistic: 0.03343 on 1 and 298 DF,  p-value: 0.855</code></pre>
</div>
</div>
<p>Der geschätzte Koeffizient von <code>dark_mode</code> entspricht <span class="math inline">\(\widehat{\tau}^w\)</span>.</p>
<p>Da <code>male</code> eine binäre Variable ist, reduziert sich eine Beurteilung der Vergleichbarkeit der Verteilungen von <code>male</code> in Behandlungs- und Kontrollgruppe auf einen simplen Vergleich des Männeranteils beider Gruppen. In der Praxis gibt es meist eine Vielzahl potentieller Backdoor-Variablen, die zudem kontinuierlich verteilt sind. Es scheint plausibel, dass das Alter der Nutzer sowohl die Akzeptanz des Design-Updates als auch die Lesezeit beeinflusst. Die bisherige Verweildauer ist mindestens eine plausible Determinante der Lesezeit.</p>
<p>Der erweiterte DGP ist in Abbildung <a href="#fig-CDdarkmode" class="quarto-xref">Abbildung&nbsp;<span>5.2</span></a> dargestellt, wobei der zusätzliche Backdoor-Pfad durch <code>age</code> ebenfalls mit roten Pfeilen gekennzeichnet sind.</p>
<div class="cell page-columns page-full" data-fig-width="4" data-fig-height="3" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-CDdarkmode" class="quarto-figure quarto-figure-center quarto-float anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-CDdarkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<svg width="384" height="288" viewbox="0.00 0.00 371.48 260.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)"><polygon fill="white" stroke="transparent" points="-4,4 -4,-256 367.48,-256 367.48,4 -4,4"></polygon><!-- read_time --><g id="node1" class="node"><title>read_time</title>
<text text-anchor="middle" x="327.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">read_time</text></g><!-- dark_mode --><g id="node2" class="node"><title>dark_mode</title>
<text text-anchor="middle" x="39.49" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">dark_mode</text></g><!-- dark_mode&#45;&gt;read_time --><g id="edge4" class="edge"><title>dark_mode-&gt;read_time</title>
<path fill="none" stroke="green" d="M79.23,-126C132,-126 225.02,-126 280.99,-126"></path><polygon fill="green" stroke="green" points="281.33,-129.5 291.33,-126 281.33,-122.5 281.33,-129.5"></polygon></g><!-- male --><g id="node3" class="node"><title>male</title>
<text text-anchor="middle" x="183.49" y="-13.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">male</text></g><!-- male&#45;&gt;read_time --><g id="edge6" class="edge"><title>male-&gt;read_time</title>
<path fill="none" stroke="red" d="M207.59,-36.08C231.58,-54.07 268.54,-81.79 295.09,-101.7"></path><polygon fill="red" stroke="red" points="293.21,-104.66 303.31,-107.86 297.41,-99.06 293.21,-104.66"></polygon></g><!-- male&#45;&gt;dark_mode --><g id="edge5" class="edge"><title>male-&gt;dark_mode</title>
<path fill="none" stroke="red" d="M159.39,-36.08C135.4,-54.07 98.44,-81.79 71.89,-101.7"></path><polygon fill="red" stroke="red" points="69.57,-99.06 63.67,-107.86 73.77,-104.66 69.57,-99.06"></polygon></g><!-- age --><g id="node4" class="node"><title>age</title>
<text text-anchor="middle" x="183.49" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">age</text></g><!-- age&#45;&gt;read_time --><g id="edge3" class="edge"><title>age-&gt;read_time</title>
<path fill="none" stroke="red" d="M207.59,-215.92C231.58,-197.93 268.54,-170.21 295.09,-150.3"></path><polygon fill="red" stroke="red" points="297.41,-152.94 303.31,-144.14 293.21,-147.34 297.41,-152.94"></polygon></g><!-- age&#45;&gt;dark_mode --><g id="edge2" class="edge"><title>age-&gt;dark_mode</title>
<path fill="none" stroke="red" d="M159.39,-215.92C135.4,-197.93 98.44,-170.21 71.89,-150.3"></path><polygon fill="red" stroke="red" points="73.77,-147.34 63.67,-144.14 69.57,-152.94 73.77,-147.34"></polygon></g><!-- hours --><g id="node5" class="node"><title>hours</title>
<text text-anchor="middle" x="327.49" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">hours</text></g><!-- hours&#45;&gt;read_time --><g id="edge1" class="edge"><title>hours-&gt;read_time</title>
<path fill="none" stroke="black" d="M327.49,-215.68C327.49,-198.82 327.49,-173.57 327.49,-154.15"></path><polygon fill="black" stroke="black" points="330.99,-154.05 327.49,-144.05 323.99,-154.05 330.99,-154.05"></polygon></g></g></svg>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-CDdarkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abbildung&nbsp;5.2: Erweiterter DGP im Website-Design-Beispiel
</figcaption></figure>
</div>
</div>
</div>
<p>Die Beurteilung der <em>Balance</em> von Kontrollgruppe und Behandlungsgruppe kann durch eine grafische Gegenüberstellung der empirischen Verteilungen der Kovariablen beider Gruppen erfolgen. Wir visualisieren die empirischen Verteilungen mit <code>ggplot2</code>. Hierzu standardisieren wir <code>age</code> und <code>hours</code> zunächst mit <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz für graphische Darstellung formatieren</span></span>
<span><span class="va">darkmode_p</span> <span class="op">&lt;-</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># Standardisierung mit 'scale()'</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    dark_mode <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span>,</span>
<span>    age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, </span>
<span>    hours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">hours</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">darkmode_p</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  read_time dark_mode  male age[,1] hours[,1]
      &lt;dbl&gt; &lt;fct&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
1      14.4 0             0  0.0377    -0.591
2      15.4 0             1  1.11      -0.459
3      20.9 1             0 -1.74       0.684
4      20   0             0 -0.141     -0.451
5      21.5 1             0 -1.21      -0.316
6      19.5 0             0  1.91      -0.327</code></pre>
</div>
</div>
<p>Für <code>age</code> und <code>hours</code> eignen sich die geschätzten Dichtefunktionen für einen Vergleich der Verteilungen in Behandlungs- und Kontrollgruppe.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Vergleich mit Dichteschätzungen</span></span>
<span><span class="va">darkmode_p</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dark_mode</span>, <span class="va">hours</span>, <span class="va">age</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># in langes Format überführen</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">dark_mode</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    facets <span class="op">=</span> <span class="op">~</span> <span class="va">name</span>, </span>
<span>    scales <span class="op">=</span> <span class="st">"free"</span>, </span>
<span>    nrow <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="Matching_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Die graphische Analyse zeigt deutliche Unterschiede in den Verteilungen von <code>age</code> zwischen Kontroll- und Behandlungsgruppe. Für einen Beurteilung mit deskriptiven Statistiken wird häufig eine sogenannte <em>Balance Table</em> herangezogen. Wir berechnen diese für <code>age</code>, <code>hours</code> und <code>male</code> mit <code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">cobalt::bal.tab()</a></code></p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/cobalt/">cobalt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Balance table mit 'cobalt::bal.tab()'</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">hours</span>, <span class="va">male</span><span class="op">)</span>, </span>
<span>  treat <span class="op">=</span> <span class="va">darkmode</span><span class="op">$</span><span class="va">dark_mode</span>, </span>
<span>   <span class="co"># berechne SMD für KG und TG:</span></span>
<span>  disp <span class="op">=</span> <span class="st">"m"</span>, </span>
<span>  s.d.denom <span class="op">=</span> <span class="st">"pooled"</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
         Type   M.0.Un   M.1.Un Diff.Un
age   Contin.  46.0132  39.0940 -0.6469
hours Contin. 337.7775 328.5738 -0.0203
male   Binary   0.3377   0.6577  0.3200

Sample sizes
    Control Treated
All     151     149</code></pre>
</div>
</div>
<p>Die Einträge <code>M.0.Un</code> und <code>M.1.Un</code> zeigen die jeweiligen Stichprobenmittelwerte der Variablen für Kontroll- und Behandlungsgruppe. <code>Diff.Un</code> gibt eine standardisierte Mittelwertdifferenz <span class="math inline">\(SMD\)</span> an, wobei <span class="math display">\[\begin{align*}
  SMD_j := \left(\overline{X}_{j,B} - \overline{X}_{j,K}\right) \bigg/ \sqrt{\frac{1}{2}\left(\widehat{\text{Var}}(X_{j,B}) + \widehat{\text{Var}}(X_{j,K})\right)},
\end{align*}\]</span> mit Stichprobenmitteln <span class="math inline">\(\overline{X}_{j,B}\)</span> und <span class="math inline">\(\overline{X}_{j,K}\)</span> und Stichprobenvarianzen <span class="math inline">\(\widehat{\text{Var}}(X_{j,B})\)</span> und <span class="math inline">\(\widehat{\text{Var}}(X_{j,K})\)</span> für eine kontinuierliche Kovariable <span class="math inline">\(j\)</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> Obwohl es keinen einheitlichen Schwellenwert für die standardisierte Differenz gibt, der ein erhebliches Ungleichgewicht anzeigt, gilt für kontinuierliche Variablen eine standardisierte (absolute) Differenz von weniger als <span class="math inline">\(0.1\)</span> als Hinweis auf einen vernachlässigbaren Unterschied zwischen den Gruppen.</p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Siehe <span class="citation" data-cites="Austin2011">P. Austin (<a href="Literatur.html#ref-Austin2011" role="doc-biblioref">2011</a>)</span> für einen Überblick zu Balance-Statistiken.</p></div></div><p>Die Balance Table weist also auf einen vernachlässigbaren Unterschied für <code>hours</code> hin und bestätigt den aus den Grafiken abgeleiteten Eindruck einer relevanten Differenzen für <code>age</code>.</p>
</section><section id="entropy-balancing" class="level3" data-number="5.1.2"><h3 data-number="5.1.2" class="anchored" data-anchor-id="entropy-balancing">
<span class="header-section-number">5.1.2</span> Entropy Balancing</h3>
<p><em>Entropy Balancing</em> <span class="citation" data-cites="Hainmueller2012">(<a href="Literatur.html#ref-Hainmueller2012" role="doc-biblioref">Hainmueller 2012</a>)</span> ist eine weitere Methode zur Gewährleistung der Vergleichbarkeit von Behandlungs- und Kontrollgruppe anhand von Gewichten. Das Verfahren nutzt Konzepte aus der <a href="https://de.wikipedia.org/wiki/Informationstheorie">Informationstheorie</a> um die Gewichte für Subjekte in der Kontrollgruppe so anzupassen, dass die Verteilung der Matchingvariablen in der Kontrollgruppe die Verteilung in der Behandlungsgruppe möglichst gut approximiert. Dies geschieht unter der Restriktion, dass bestimmte empirische Momente (meist Mittelwerte und Varianzen) der Matchingvariablen exakt übereinstimmen. Mathematisch werden die Gewichte für Kontrollgruppenbeobachtungen durch Minimierung der <a href="https://de.wikipedia.org/wiki/Kullback-Leibler-Divergenz">Kullback-Leibler-Divergenz</a> zwischen den Verteilungen gefunden, wobei die Divergenz ein Maß für den Unterschied von Wahrscheinlichkeitsverteilungen ist.</p>
<p>Entropy Balancing ist im R-Paket <code>WeightIt</code> implementiert. Wir zeigen, wie die benötigten Gewichte für eine Schätzungen des ATT im Website-Beispiel mit <code>WeightIt::wightit()</code> bestimmt werden können. Über das Argument <code>moments</code> legen wir fest, dass die Gewichte unter der Restriktion übereinstimmender Mittelwerte aller Matching-Variablen zwischen Behandlungs- und Kontrollgruppe erfolgen soll.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/">WeightIt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Gewichte für Entropy Balancing</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html">weightit</a></span><span class="op">(</span></span>
<span>  <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"ebal"</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  moments <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span> <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A weightit object
 - method: "ebal" (entropy balancing)
 - number of obs.: 300
 - sampling weights: none
 - treatment: 2-category
 - estimand: ATT (focal: 1)
 - covariates: age, male, hours</code></pre>
</div>
</div>
<p>Wir schätzen den Behandlungseffekt nach Entropy Balancing mit gewichteter Regression.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mittelwert-Vergleich mit lm()</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">dark_mode</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">W1</span><span class="op">$</span><span class="va">weights</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ dark_mode, data = darkmode, weights = W1$weights)

Weighted Residuals:
     Min       1Q   Median       3Q      Max 
-16.6652  -2.3552   0.8786   2.9585  27.1808 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  17.7601     0.4093  43.395   &lt;2e-16 ***
dark_mode     0.9701     0.5807   1.671   0.0959 .  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.029 on 298 degrees of freedom
Multiple R-squared:  0.009278,  Adjusted R-squared:  0.005953 
F-statistic: 2.791 on 1 and 298 DF,  p-value: 0.09586</code></pre>
</div>
</div>
<p>Beachte, dass die von <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> berechneten Standardfehler bei Entropy Balancing ungültig sind. In Abschnitt <a href="#sec-bootmatching" class="quarto-xref"><span>Kapitel 5.4</span></a> erläutern wir die Berechnung von Standardfehlern für Matching-Schätzer mit dem Bootstrap.</p>
</section><section id="sec-PSM" class="level3 page-columns page-full" data-number="5.1.3"><h3 data-number="5.1.3" class="anchored" data-anchor-id="sec-PSM">
<span class="header-section-number">5.1.3</span> Mehrere Matching-Variablen und der Propensity Score</h3>
<p>Bei mehreren Backdoor-Variablen kann eine Gewichtung anhand der Behandlungswahrscheinlichkeit (<em>Treatment Propensity</em>) erfolgen. Die Idee hierbei ist, dass der DGP wie in <a href="#fig-propCDdarkmode" class="quarto-xref">Abbildung&nbsp;<span>5.3</span></a> dargestellt werden kann.</p>
<div class="cell page-columns page-full" data-fig-width="4" data-fig-height="3" data-layout-align="center">
<div class="cell-output-display page-columns page-full">
<div id="fig-propCDdarkmode" class="quarto-figure quarto-figure-center quarto-float anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full"><div aria-describedby="fig-propCDdarkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<svg width="384" height="288" viewbox="0.00 0.00 398.69 260.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)"><polygon fill="white" stroke="transparent" points="-4,4 -4,-256 394.69,-256 394.69,4 -4,4"></polygon><!-- read_time --><g id="node1" class="node"><title>read_time</title>
<text text-anchor="middle" x="354.71" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">read_time</text></g><!-- dark_mode --><g id="node2" class="node"><title>dark_mode</title>
<text text-anchor="middle" x="66.71" y="-121.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">dark_mode</text></g><!-- dark_mode&#45;&gt;read_time --><g id="edge4" class="edge"><title>dark_mode-&gt;read_time</title>
<path fill="none" stroke="green" d="M106.45,-126C159.22,-126 252.24,-126 308.21,-126"></path><polygon fill="green" stroke="green" points="308.55,-129.5 318.55,-126 308.55,-122.5 308.55,-129.5"></polygon></g><!-- TreatmentPropensity --><g id="node3" class="node"><title>TreatmentPropensity</title>
<text text-anchor="middle" x="66.71" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">TreatmentPropensity</text></g><!-- TreatmentPropensity&#45;&gt;dark_mode --><g id="edge7" class="edge"><title>TreatmentPropensity-&gt;dark_mode</title>
<path fill="none" stroke="red" d="M66.71,-215.68C66.71,-198.82 66.71,-173.57 66.71,-154.15"></path><polygon fill="red" stroke="red" points="70.21,-154.05 66.71,-144.05 63.21,-154.05 70.21,-154.05"></polygon></g><!-- male --><g id="node4" class="node"><title>male</title>
<text text-anchor="middle" x="210.71" y="-13.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">male</text></g><!-- male&#45;&gt;read_time --><g id="edge6" class="edge"><title>male-&gt;read_time</title>
<path fill="none" stroke="red" d="M234.81,-36.08C258.8,-54.07 295.76,-81.79 322.3,-101.7"></path><polygon fill="red" stroke="red" points="320.43,-104.66 330.53,-107.86 324.63,-99.06 320.43,-104.66"></polygon></g><!-- male&#45;&gt;TreatmentPropensity --><g id="edge5" class="edge"><title>male-&gt;TreatmentPropensity</title>
<path fill="none" stroke="red" d="M198.68,-36.04C173.32,-74.08 114.27,-162.66 84.52,-207.29"></path><polygon fill="red" stroke="red" points="81.44,-205.59 78.8,-215.85 87.26,-209.48 81.44,-205.59"></polygon></g><!-- age --><g id="node5" class="node"><title>age</title>
<text text-anchor="middle" x="210.71" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">age</text></g><!-- age&#45;&gt;read_time --><g id="edge3" class="edge"><title>age-&gt;read_time</title>
<path fill="none" stroke="red" d="M234.81,-215.92C258.8,-197.93 295.76,-170.21 322.3,-150.3"></path><polygon fill="red" stroke="red" points="324.63,-152.94 330.53,-144.14 320.43,-147.34 324.63,-152.94"></polygon></g><!-- age&#45;&gt;TreatmentPropensity --><g id="edge2" class="edge"><title>age-&gt;TreatmentPropensity</title>
<path fill="none" stroke="red" d="M183.62,-234C172.15,-234 158.14,-234 143.86,-234"></path><polygon fill="red" stroke="red" points="143.45,-230.5 133.45,-234 143.45,-237.5 143.45,-230.5"></polygon></g><!-- hours --><g id="node6" class="node"><title>hours</title>
<text text-anchor="middle" x="354.71" y="-229.8" font-family="Helvetica,Arial,sans-serif" font-size="14.00">hours</text></g><!-- hours&#45;&gt;read_time --><g id="edge1" class="edge"><title>hours-&gt;read_time</title>
<path fill="none" stroke="black" d="M354.71,-215.68C354.71,-198.82 354.71,-173.57 354.71,-154.15"></path><polygon fill="black" stroke="black" points="358.21,-154.05 354.71,-144.05 351.21,-154.05 358.21,-154.05"></polygon></g></g></svg>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-propCDdarkmode-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Abbildung&nbsp;5.3: Propensity im Website-Design-Beispiel
</figcaption></figure>
</div>
</div>
</div>
<p>Hierbei beeinflussen die Backdoor-Variablen <em>age</em> und <em>male</em> die Behandlungsvariable <em>dark_mode</em> lediglich durch die Behandlungswahrscheinlichkeit <em>Treatment Propensity</em>. Diese Darstellung zeigt, das die mehrdimensionale Information bzgl. der Ähnlichkeit von Subjekten hinsichtlich der beobachteten Kovariablen in einer einzigen Variable zusammengefasst werden kann. Die Backdoor-Pfade können daher geschlossen werden, indem wir Subjekte anhand von <em>Treatment Propensity</em> derart gewichten, dass beide Gruppen hinsichtlich der Verteilung der Behandlungswahrscheinlichkeit vergleichbar sind. Betrachte erneut <span class="math inline">\(\eqref{eq:cia}\)</span> und beachte, dass <span class="math display">\[\begin{align}
  Y_i = Y_i^{(1)} D_i + Y_i^{(0)} (1-D_i).
\end{align}\]</span> <span class="citation" data-cites="RosenbaumRubin1983">Rosenbaum und Rubin (<a href="Literatur.html#ref-RosenbaumRubin1983" role="doc-biblioref">1983</a>)</span> zeigen, dass es hinsichtlich <span class="math inline">\(\eqref{eq:cia}\)</span> äquivalent ist für die <em>Treatment Propensity</em> <span class="math inline">\(P_i(X_i):=P(B_i=1\vert X_i = x)\)</span> zu kontrollieren, d.h. <span class="math display">\[\begin{align}
  \left\{Y_i^{(1)},Y_i^{(0)}\right\} \perp B_i\vert X_i \quad\Leftrightarrow\quad \left\{Y_i^{(1)},Y_i^{(0)}\right\} \perp B_i\vert P_i(X_i).
\end{align}\]</span></p>
<p>Der Behandlungseffekt kann so als Differenz von gewichteten Gruppenmittelwerten berechnet werden, mit inversem Wahrscheinlichkeitsgewicht (IPW) <span class="math inline">\(w_{i,B} = 1/P_i(X_i)\)</span> für Beobachtungen in der Behandlungsgruppe und <span class="math inline">\(w_{i,K} = 1/(1-P_i(X_i))\)</span> für Beobachtungen in der Kontrollgruppe, <span class="math display">\[\begin{align}
  \tau^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left[\frac{B_i Y_i}{P_i(X_i)} - \frac{(1-B_i)Y_i}{1-P_i(X_i)} \right].\label{eq:tauipw}
\end{align}\]</span></p>
<p>Grundsätzlich ist <em>TreatmentPropensity</em> eine nicht beobachtbare Variable und muss daher aus den Daten geschätzt werden. Eine geschätzte Behandlungswahrscheinlichkeiten <span class="math inline">\(\widehat{P}_i(X_i)\)</span> wird als <em>Propensity Score</em> bezeichnet. In der Praxis erfolgt die Schätzung von <em>Propensity Scores</em> meist mit logistischer Regression. Ein erwartungstreuer Schätzer des ATE ist <span class="math display">\[\begin{align}
  \widehat{\tau}^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left[\frac{B_i Y_i}{\widehat{P}_i(X_i)} - \frac{(1-B_i)Y_i}{1-\widehat{P}_i(X_i)} \right].\label{eq:hattauipw}
\end{align}\]</span> <span class="citation" data-cites="Hiranoetal2003">Hirano, Imbens, und Ridder (<a href="Literatur.html#ref-Hiranoetal2003" role="doc-biblioref">2003</a>)</span> diskutieren Alternativen zu <span class="math inline">\(\eqref{eq:hattauipw}\)</span> für die Schätzung anderer Typen von Behandlungseffekten.</p>
<p>Wir schätzen nachfolgend die <em>Propensity Scores</em> für unser Anwendungsbeispiel, erläutern die Berechnung der Gewichte sowie die Schätzung von Behandlungseffekten mit gewichteter Regression. Hierbei betrachten wir eine Variante von <span class="math inline">\(\eqref{eq:hattauipw}\)</span> mit normalisierten Gewichten <span class="math inline">\(\tilde{w}_{i,B} = w_{i,B}/\sum_i w_{i,B}\)</span> und <span class="math inline">\(\tilde{w}_{i,K} = w_{i,K}/\sum_i w_{i,K}\)</span> die sich jeweils zu 1 summieren.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Dies ergibt den Hájek-Schätzer<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> <span class="math display">\[\begin{align}
    \widehat{\tau}_N^{\text{IPW}} = \frac{\sum_i\tilde{w}_{i,B}Y_i}{\sum_i\tilde{w}_{i,B}} -  \frac{\sum_i\tilde{w}_{i,K}Y_i}{\sum_i\tilde{w}_{i,K}}.\label{eq:hattauhajek}
\end{align}\]</span></p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Eine Normalisierung der Gewichte reduziert die Varianz des Schätzers, vgl. <span class="citation" data-cites="Hiranoetal2003">Hirano, Imbens, und Ridder (<a href="Literatur.html#ref-Hiranoetal2003" role="doc-biblioref">2003</a>)</span></p></div><div id="fn3"><p><sup>3</sup>&nbsp;Siehe <span class="citation" data-cites="Hajek1971">Hájek (<a href="Literatur.html#ref-Hajek1971" role="doc-biblioref">1971</a>)</span>.</p></div></div><p>Zunächst Schätzen wir ein logistisches Regressionsmodell mit <code>age</code>, <code>male</code> und <code>hours</code> als erklärende Variablen für <code>dark_mode</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Logit-Modell mit 'glm()' schätzen</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">darkmode_ps_logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>,</span>
<span>    data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>    family <span class="op">=</span> <span class="va">binomial</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  glm(formula = dark_mode ~ age + male + hours, family = binomial, 
    data = darkmode)

Coefficients:
(Intercept)          age         male        hours  
  2.330e+00   -7.330e-02    1.623e+00   -9.293e-05  

Degrees of Freedom: 299 Total (i.e. Null);  296 Residual
Null Deviance:      415.9 
Residual Deviance: 346.4    AIC: 354.4</code></pre>
</div>
</div>
<p>Die <em>Propensity Scores</em> erhalten wir als angepasste Werte aus der Regression <code>darkmode_ps_logit</code> mit <code><a href="https://rdrr.io/r/stats/fitted.values.html">fitted()</a></code>. Wir erweitern den Datensatz mit den Ergebnissen.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz um Propensity Scores erweitern</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">darkmode_probs</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">darkmode</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      PS <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">darkmode_ps_logit</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 300 × 6
   read_time dark_mode  male   age  hours     PS
       &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1      14.4         0     0    43   65.6 0.304 
 2      15.4         0     1    55  125.  0.478 
 3      20.9         1     0    23  643.  0.642 
 4      20           0     0    41  129.  0.335 
 5      21.5         1     0    29  190.  0.547 
 6      19.5         0     0    64  185.  0.0849
 7      22           1     0    18  334.  0.727 
 8      17.4         0     0    53  279.  0.171 
 9      23.6         0     0    59 1303.  0.108 
10      15.7         0     0    53   16.1 0.174 
# ℹ 290 more rows</code></pre>
</div>
</div>
<p>Zur Beurteilung der Überlappung (vgl. Annahme <span class="math inline">\(\eqref{eq:overlap}\)</span> können wir die Verteilung der <em>Propensity Scores</em> nach Behandlungs-Indikator mit Histogrammen visualisieren.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Überlappung prüfen:</span></span>
<span><span class="co"># Histogramme der PS nach Treatment-Indikator</span></span>
<span><span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">PS</span>, </span>
<span>      fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    alpha <span class="op">=</span> <span class="fl">.5</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">25</span>, </span>
<span>    position <span class="op">=</span> <span class="st">"identity"</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="Matching_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Ein Vergleich der Histogramme zeigt, dass die Überlappung der <em>Propensity Scores</em> in der linken Flanken der Verteilungen der Kontrollgruppe und in der rechten Flanke der Behandlungsgruppe schlechter wird. Wir entfernen zunächst Beobachtungen aus der Stichprobe deren <em>Propensity Scores</em> wenig bzw. keine Überlappung aufweisen.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz nach PS trimmen</span></span>
<span><span class="va">darkmode_probs</span> <span class="op">&lt;-</span> <span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">PS</span>,</span>
<span>      left <span class="op">=</span> <span class="fl">.25</span>,</span>
<span>      right <span class="op">=</span> <span class="fl">.75</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Überlappung nach trimming prüfen:</span></span>
<span><span class="co"># Dichteschätzung der PS nach Treatment-Indikator</span></span>
<span><span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>  mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">PS</span>, </span>
<span>    fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span></span>
<span>    alpha <span class="op">=</span> <span class="fl">.5</span>, </span>
<span>    bins <span class="op">=</span> <span class="fl">25</span>, </span>
<span>    position <span class="op">=</span> <span class="st">"identity"</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="Matching_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>IPWs anhand der <em>Propensity Scores</em> können schnell mit der Vorschrift <span class="math display">\[\begin{align}
  \text{IPW} = \frac{\text{dark\_mode}}{\text{PS}} + \frac{1 - \text{dark\_mode}}{1 - \text{PS}},
\end{align}\]</span> berechnet werden.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz um IPWs erweitern</span></span>
<span><span class="va">darkmode_IPW</span> <span class="op">&lt;-</span> <span class="va">darkmode_probs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    IPW <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">/</span> <span class="va">PS</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">dark_mode</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">PS</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">darkmode_IPW</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">IPW</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 194 × 1
     IPW
   &lt;dbl&gt;
 1  1.44
 2  1.91
 3  1.56
 4  1.50
 5  1.83
 6  1.38
 7  1.43
 8  1.47
 9  2.71
10  1.42
# ℹ 184 more rows</code></pre>
</div>
</div>
<p>Eine Schätzung des durchschnittlichen Behandlungseffekts gemäß <span class="math inline">\(\eqref{eq:hattauhajek}\)</span> implementieren wir mit <code>dplyr</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_IPW</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="va">IPW</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">IPW</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>weighted_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">weighted_mean</span><span class="op">)</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   diff
  &lt;dbl&gt;
1  1.90</code></pre>
</div>
</div>
<p>Diese Schätzung des Behandlungseffekts ist äquivalent zur gewichteten KQ-Schätzung anhand eines einfachen linearen Regressionsmodells.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mit IPWs gewichteter KQ-Schaetzer berechnet den ATE</span></span>
<span><span class="va">model_ipw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">dark_mode</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode_IPW</span>,</span>
<span>  weights <span class="op">=</span> <span class="va">IPW</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model_ipw</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ dark_mode, data = darkmode_IPW, weights = IPW)

Weighted Residuals:
     Min       1Q   Median       3Q      Max 
-18.5086  -4.4579   0.6096   4.1345  20.4566 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  17.9709     0.4942  36.362  &lt; 2e-16 ***
dark_mode     1.9011     0.6952   2.735  0.00683 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 6.913 on 192 degrees of freedom
Multiple R-squared:  0.03749,   Adjusted R-squared:  0.03248 
F-statistic: 7.478 on 1 and 192 DF,  p-value: 0.006829</code></pre>
</div>
</div>
<p>Unsere Schätzung des ATE ist der geschätzte Koeffizient von <code>dark_mode</code>. Die ausgegebenen Standardfehler und Inferenzstatistiken sind jedoch <em>ungültig</em> aufgrund der Gewichtung mit IPWs, den inversen <em>geschätzten</em> Wahrscheinlichkeiten für eine Behandlung. Der Grund hierfür ist, dass die Berechnung der Standardfehler in <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> die zusätzliche Unsicherheit durch die geschätzen <em>Propensity Scores</em> nicht berücksichtigt! Später im Kapitel erläutern wir die Berechnung gültiger Standardfehler für IPW-Schätzer basierend auf <em>Propensity Scores</em> mit dem Bootstrap.</p>
</section></section><section id="selektierende-matching-verfahren" class="level2 page-columns page-full" data-number="5.2"><h2 data-number="5.2" class="anchored" data-anchor-id="selektierende-matching-verfahren">
<span class="header-section-number">5.2</span> Selektierende Matching-Verfahren</h2>
<p>Das grundsätzliche Konzept von selektierendem Matching wird in der nachstehenden interaktiven Grafik veranschaulicht. Hier betrachten wir beobachtete Ausprägungen von zwei (unabhängig und identisch verteilten) Matching-Variablen für Subjekte in der Behandlungsgruppe (blau) sowie Kontrollgruppe (rot). Als Matches qualifizieren sich sämtliche Beobachtungen der anderen Gruppe, deren <a href="https://de.wikipedia.org/wiki/Euklidischer_Abstand">Euklidische Distanz</a> zu dem ausgewählten Punkt das über den Slider eingestellte Maximum <em>Caliper</em> nicht überschreitet.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Diese Region wird durch den gestrichelten Kreis gekennzeichnet und kann über den zugehörigen Slider angepasst werden. Per Klick auf eine Beobachtung werden Matches aus der anderen Gruppe durch eine verbindende Linie und farbliches Hervorheben kenntlich gemacht. Mit dem Slider für k wird festgelegt, dass nur die nahesten k qualifizierten Beobachtungen als Matches behandelt werden. Die Grafik illustriert inbesondere, dass Beobachtungen in Abhängigkeit von k und Caliper falls gewünscht mehrfach (s.g. Matching mit Zurücklegen) oder gar nicht gematcht werden können.</p>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;Es handelt sich hierbei um einen Spezialfall von Matching anhand der Mahalanobis-Distanz.</p></div></div><iframe width="100%" height="678" frameborder="0" src="https://observablehq.com/embed/62067a02a72c9f90@464?cells=theplot%2Cviewof+k%2Cviewof+caliper%2Cstyles">
</iframe>
<p>Für die nachfolgenden Code-Beispiele verwenden wir das R-Paket <code>MatchIt</code>. <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">MatchIt::matchit()</a></code> nutzt standardmäßig Eins-zu-Eins-Matching (ohne Zurücklegen) von Beobachtungen der Treatment-Gruppe mit Beobachtungen der Kontrollgruppe.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> Die für das Matching zu verwendenden Variablen werden über das Argument <code>formula</code> als Funktion des Behandlungsindikators definiert. <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> bereitet das Objekt für eine Schätzung des ATT mit einer geeigneten Funktionen, s. <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">?matchit</a></code> und hier insb. die Erläuterungen der Argumente <code>replace = F</code>, <code>ratio = 1</code> und <code>estimand = "ATT"</code> für Details. Mit <code>cobalt::balt.tab()</code> erhalten wir eine <em>balance table</em> für den gematchten Datensatz.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;Dieses Schema zielt auf eine Schätzung des ATT ab.</p></div></div><p>Wir zeigen als nächstes, wie <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">MatchIt::matchit()</a></code> für Matching anhand der Regressoren <code>age</code>, <code>hours</code>, und <code>male</code> in unserem Website-Beispiel für unterschiedliche Varianten durchgeführt werden kann.</p>
<section id="exaktes-matching" class="level3" data-number="5.2.1"><h3 data-number="5.2.1" class="anchored" data-anchor-id="exaktes-matching">
<span class="header-section-number">5.2.1</span> Exaktes Matching</h3>
<p>Exaktes Matching ordnet einem Subjekt aus der Behandlungsgruppe ein oder mehrere Subjekte aus der Kontrollgruppe zu, wenn die boebachteten Ausprägung der Matching-Variablen <em>exakt</em> übereinstimmen. Hierbei muss die ‘Distanz’ zwischen den Ausprägung der Matching-Variablen folglich <span class="math inline">\(0\)</span> sein. Dieses Verfahren findet meist bei ausschließlich diskret verteilten Merkmalen Anwendung. Bei kontinuierlich verteilten Merkmalen (vgl. die obige interaktive Grafik) sind exakte Matches zwar theoretisch unmöglich, ergeben sich jedoch in der Praxis aus der Datenerfassung, bspw. durch Rundungsfehler. In <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> erhalten wir exaktes Ein-zu-eins-Matching mit <code>method = "exact"</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/">MatchIt</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Exaktes Eins-zu-Eins-Matching durchführen</span></span>
<span><span class="va">res_em</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"exact"</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `matchit()`:
! No exact matches were found.</code></pre>
</div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">res_em</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'res_em' not found</code></pre>
</div>
</div>
<p>Aufgrund der kontinulierliche Verteilten Variable <code>hours</code> gibt es in unserem Website-Beispiel keine exakten Matches. Dieses Verfahren ist hier folglich ungeeignet.</p>
</section><section id="coarsened-exact-matching" class="level3 page-columns page-full" data-number="5.2.2"><h3 data-number="5.2.2" class="anchored" data-anchor-id="coarsened-exact-matching">
<span class="header-section-number">5.2.2</span> Coarsened Exact Matching</h3>
<p>Bei dieser Methode werden kontinuierliche Matching-Variablen grob (Engl. <em>coarse</em>) klassiert, ähnlich wie bei einem Histogram. Diese Diskretisierung ermöglicht es exakte Übereinstimmungen zwischen Behandlungs- und Kontrollgruppenbeobachtungen hinsichtlich ihrer klassierten Ausprägungen zu finden. Sowohl Behandlungs- als auch Kontrollbeobachtungen die mindestents einen exakten Match haben, werden Teil des gematchten Datensatzes. In <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> wird Coarsened Exact Matching mit <code>method = "cem"</code> durchgeführt. Über das Argument <code>cutpoints</code> geben wir an, dass <code>hours</code> in 6 Klassen und <code>age</code> in 4 Klassen eingeteilt werden soll.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> Mit <code>k1k = TRUE</code> erfolgt Eins-zu-eins-Matching: Bei mehreren exakten Matches wird die Beobachtung mit der geringsten Mahalanobis-Distanz (für die unklassierten Matching-Variablen) gewählt.</p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;Diese Werte wurden ad-hoc gewählt da sie zu einem guten Ergebnis führen.</p></div></div><div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Coarsened Exact Matching</span></span>
<span><span class="va">res_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"cem"</span>, </span>
<span>  k2k <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  cutpoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"hours"</span> <span class="op">=</span> <span class="fl">6</span>, </span>
<span>    <span class="st">"age"</span> <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="op">)</span></span>
<span><span class="va">res_CEM</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: Coarsened exact matching
 - number of obs.: 300 (original), 164 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance-Table Coarsened Exact Matching</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_CEM</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
         Type Diff.Adj
age   Contin.   0.0106
male   Binary   0.0000
hours Contin.  -0.0135

Sample sizes
          Control Treated
All           151     149
Matched        82      82
Unmatched      69      67</code></pre>
</div>
</div>
<p>Mit Coarsened Exact Matching erhalten wir einen Datensatz mit 82 Beobachtungen und guter Balance.</p>
</section><section id="matching-mit-der-mahalanobis-distanz" class="level3 page-columns page-full" data-number="5.2.3"><h3 data-number="5.2.3" class="anchored" data-anchor-id="matching-mit-der-mahalanobis-distanz">
<span class="header-section-number">5.2.3</span> Matching mit der Mahalanobis-Distanz</h3>
<p>Die Euklidische Distanz misst den direkten Abstand zwischen zwei Punkten und ist nicht invariant gegenüber Transformationen, insbesondere bei unterschiedlichen Skalierungen und bei Korrelation der Matching-Variablen. Die Mahalanobis-Distanz hingegen ist ein standardisiertes Distanzmaß, das unter Berücksichtigung der Varianz-Kovarianz-Struktur der Daten angibt, wie viele Standardabweichungen zwei Datenpunkte voneinander entfernt sind. Die Mahalanobis-Distanz ist invariant gegenüber linearen Transformationen (Skalierung, Translation und Rotation) der Daten und bietet ein genaueres Maß für die Unähnlichkeit zweier Beobachtungen hinsichtlich ihrer Ausprägungen der Matching-Variablen.</p>
<p>Betrachte die Datenpunkte <span class="math inline">\(P_1=(X_1,Y_1)'\)</span> und <span class="math inline">\(P_2=(X_2,Y_2)'\)</span> für die Matching-Variablen <span class="math inline">\(X\)</span> und <span class="math inline">\(Y\)</span>. Die Mahalanobis-Distanz zwischen <span class="math inline">\(P_1\)</span> und <span class="math inline">\(P_2\)</span> ist definiert als <span class="math display">\[\begin{align*}
  d_M(P_1,\,P_2) = \sqrt{(P_1 - P_2)'\boldsymbol{S}^{-1} (P_1 - P_2)},
\end{align*}\]</span> wobei <span class="math inline">\(\boldsymbol{S}\)</span> die Varianz-Kovarianz-Matrix von <span class="math inline">\(X\)</span> und <span class="math inline">\(Y\)</span> ist. Die Mahalanobis-Distanz <span class="math inline">\(d_M(P_1,\,P_2)\)</span> ist also die Euklidische Distanz zwischen den standardisierten Datenpunkten.</p>
<p>In empirischen Anwendungen ersetzen wir die (unbekannten) Komponenten der Varianz-Kovarianz-Matrix durch Stichprobenvarianten. Dies ergibt die Formel</p>
<p><span class="math display">\[\begin{align*}
  \widehat{d}_M(P_1,\,P_2) = \sqrt{
  \begin{pmatrix}
    X_1 - X_2\\
    Y_1 - Y_2
  \end{pmatrix}'
  \begin{pmatrix}
    \widehat{\text{Var}}(X^2) &amp; \widehat{\text{Cov}}(X, Y) \\
     \widehat{\text{Cov}}(X, Y) &amp; \widehat{\text{Var}}(Y^2)
  \end{pmatrix}^{-1}
    \begin{pmatrix}
    X_1 - X_2\\
    Y_1 - Y_2
  \end{pmatrix}
}.
\end{align*}\]</span></p>
<p>Die nachstehende interaktive Grafik zeigt Beobachtungen zweier Matching-Variablen, die aus einer bivariaten Normalverteilung mit positiver Korrelation generiert wurden. Diese bivariate Verteilung ist identisch für Beobachtungen aus der Kontrollgruppe (rot) und Beobachtungen aus der Behandlungsgruppe (blau). Für die ausgewählte Beobachtung aus der Behandlungsgruppe (schwarzer Rand) werden potentielle Matches in der Kontrollgruppe innerhalb der vorgegebenen Mahalanobis-Distanz in Cyan kenntlich gemacht. Beachte, dass die Mahalanobis-Distanz Varianzen und Kovarianzen der Daten berücksichtigt, sodass die gematchten Beobachtungen in einem elliptischen Bereich um die betrachtete behandelte Beobachtung liegen. Eine Euklidische Distanz hingegen (gestrichelte Linie) ignoriert die Skalierung der Daten.</p>
<div class="cell page-columns page-full">

<div class="no-row-height column-margin column-container"><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="img/EDM_qr.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div></div></div>
<iframe width="100%" height="648" frameborder="0" src="https://observablehq.com/embed/1338355035acc056@687?cells=theplot%2Cviewof+caliper%2Cstyles">
</iframe>
<p>Für Eins-zu-Eins-Matching im Website-Beispiel anhand der Mahalanobis-Distanz mit <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> setzen wir <code>distance = "mahalanobis"</code> und wählen <code>method = "nearest"</code>. Mit diesen Parametern wird jeder Behandlung aus der Behandlungsgruppe die gemäß <span class="math inline">\(d_M\)</span> am ehesten vergleichbarste Beobachtung aus der Kontrollgruppe zugewiesen, wobei keine mehrfachen Matches zulässig sind.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 1:1 Mahalanobis-Distanz-Matching</span></span>
<span><span class="va">res_maha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  distance <span class="op">=</span> <span class="st">"mahalanobis"</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_maha</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Mahalanobis
 - number of obs.: 300 (original), 298 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance-Table für 1:1 Mahalanobis-Matching</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_maha</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
         Type Diff.Adj
age   Contin.  -0.5826
male   Binary   0.3154
hours Contin.   0.0106

Sample sizes
          Control Treated
All           151     149
Matched       149     149
Unmatched       2       0</code></pre>
</div>
</div>
<p>Die Ergebnisse zeigen, dass für sämtliche <span class="math inline">\(149\)</span> Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden werden konnte. Es werden lediglich <span class="math inline">\(2\)</span> Beobachtungen der <span class="math inline">\(151\)</span> Beobachtungen in der Kontrollgruppe nicht gematcht.</p>
<p>Entsprechend zeigt die Balance-Table eine ähnliche Diskrepanz beider Gruppen hinsichtlich der Matching-Variablen an.</p>
<p><strong>Mahalanobis-Distanz mit Caliper .25 für Propensity Scores basierend auf logistischer Regression</strong></p>
<p>Für eine strengeres Matching-Kriterium kann ein <em>Caliper</em>, d.h. eine maximal zulässige Distanz, herangezogen werden. Die Mahalanobis-Distanz hat jedoch keine einheitliche Skala: Ob eine Distanz als groß oder klein betrachten werden kann, hängt von der Anzahl der Matching-Variablen und dem Überlappungsgrad zwischen den Gruppen ab. Daher wird die Beschränkung durch einen Caliper nicht auf <span class="math inline">\(\widehat{d}_M\)</span> sondern auf Propensity Scores angewendet.</p>
<p>Im nächsten Code-Beispiel spezifizieren wir mit <code>distance = "glm"</code>, dass Propensity Scores gemäß der Vorschrift in <code>formula</code> geschätzt werden. Mit <code>mahvars = ~ age + male + hours</code> legen wir die Matching-Variablen für die Berechnung von <span class="math inline">\(\widehat{d}_M\)</span> fest. <code>caliper = .25</code> legt fest, dass lediglich Beobachtungen der Kontrollgruppe bei einer absoluten Differenz der Propensity Scores von höchstens <span class="math inline">\(0.25\)</span> Standardabweichungen als Match für eine Beobachtung in der Behandlungsgruppe qualifiziert sind.</p>
<div id="qwebr-insertion-location-3"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Mahalanobis-Matchig mit PS-Caliper</span></span>
<span><span class="va">res_mahaC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  distance <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span>,</span>
<span>  mahvars <span class="op">=</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>,</span>
<span>  caliper <span class="op">=</span> <span class="fl">.25</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_mahaC</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Mahalanobis [matching]
             Propensity score [caliper]
             - estimated with logistic regression
 - caliper: &lt;distance&gt; (0.058)
 - number of obs.: 300 (original), 208 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance Table</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_mahaC</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
             Type Diff.Adj
distance Distance   0.1812
age       Contin.  -0.1176
male       Binary   0.0481
hours     Contin.  -0.0001

Sample sizes
          Control Treated
All           151     149
Matched       104     104
Unmatched      47      45</code></pre>
</div>
</div>
<p>Die Balance-Table zeigt einen deutlichen Effekt der Beschränkung qualifizierter Beobachtungen durch <code>caliper = .25</code>: Aufgrund der oberen Grenze für die Propensity-Score-Differenz von <span class="math inline">\(0.058\)</span> wird für lediglich <span class="math inline">\(104\)</span> Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> Weiterhin finden wir eine verbesserte Balance für den gematchten Datensatz.</p>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;Die durch <code>caliper</code> implizierte Obergrenze ergibt sich als <code>.25 * sd(fitted(darkmode_ps_logit)))</code>.</p></div></div><div id="qwebr-insertion-location-4"></div>
<noscript>Please enable JavaScript to experience the dynamic code cell content on this page.</noscript>
</section><section id="propensity-score-matching" class="level3" data-number="5.2.4"><h3 data-number="5.2.4" class="anchored" data-anchor-id="propensity-score-matching">
<span class="header-section-number">5.2.4</span> Propensity Score Matching</h3>
<p>Eine gängige Variante ist Matching ausschließlich anhand von Propensity Scores innerhalb eines Calipers.</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 1:1 Matching mit PS und Caliper</span></span>
<span><span class="va">res_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>  distance <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>  method <span class="op">=</span> <span class="st">"nearest"</span>, </span>
<span>  caliper <span class="op">=</span> <span class="fl">.25</span></span>
<span><span class="op">)</span></span>
<span><span class="va">res_PSC</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Propensity score [caliper]
             - estimated with logistic regression
 - caliper: &lt;distance&gt; (0.058)
 - number of obs.: 300 (original), 208 (matched)
 - target estimand: ATT
 - covariates: age, male, hours</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Balance Table</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html">bal.tab</a></span><span class="op">(</span><span class="va">res_PSC</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Balance Measures
             Type Diff.Adj
distance Distance   0.1640
age       Contin.  -0.0976
male       Binary   0.0481
hours     Contin.   0.0134

Sample sizes
          Control Treated
All           151     149
Matched       104     104
Unmatched      47      45</code></pre>
</div>
</div>
<p>Laut Balance-Table führt Eins-zu-Eins-Matching basierend auf Propensity Scores zu einem Datensatz mit <span class="math inline">\(104\)</span> gematchten Beobachtungen in der Behandlungsgruppe. Hinsichtlich der standardisierten Mittelwertdifferenz (<code>Diff.Adj</code>) erzielt diese Methode die beste Balance unter den betrachteten Ansätzen.</p>
<p><strong>Vergleich der Balance verschiedener Verfahren mit Love-Plot</strong></p>
<p>Standardisierte Mittelwertdifferenzen für verschiedene Matching-Verfahren können grafisch mit einem Love-Plot <span class="citation" data-cites="Love2004">(<a href="Literatur.html#ref-Love2004" role="doc-biblioref">Love 2004</a>)</span> veranschaulicht werden. Hierzu nutzen wir <code><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html">cobalt::love.plot()</a></code> und übergeben die mit <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit()</a></code> generierten Objekte im Argument <code>weights</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Love-Plot für</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/love.plot.html">love.plot</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span>, </span>
<span>  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    CEM <span class="op">=</span> <span class="va">res_CEM</span>,</span>
<span>    Mahalanobis <span class="op">=</span> <span class="va">res_maha</span>,</span>
<span>    Mahalanobis_Cal <span class="op">=</span> <span class="va">res_mahaC</span>,</span>
<span>    PSC <span class="op">=</span> <span class="va">res_PSC</span></span>
<span>  <span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>, </span>
<span>  line <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  <span class="co"># absolute Mittelwertdifferenz plotten</span></span>
<span>  abs <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="Matching_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Die Grafik zeigt, dass Coarsened Exact Matching (CEM) unter allen betrachteten Verfahren die Stichprobe mit der besten Balance ergibt. Diesen gematchten Datensatz erhalten wir mit <code><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">MatchIt::match.data()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># gematchten Datensatz zuweisen</span></span>
<span><span class="va">darkmode_matched_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">res_CEM</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">darkmode_matched_CEM</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  read_time dark_mode  male   age hours weights subclass
      &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;   
1      15.4         0     1    55  125.       1 26      
2      20.9         1     0    23  643.       1 70      
3      21.5         1     0    29  190.       1 79      
4      22           1     0    18  334.       1 80      
5      17.4         0     0    53  279.       1 11      
6      20.4         0     0    43  138.       1 9       </code></pre>
</div>
</div>
<p><code>darkmode_matched</code> enthält Gewichte (<code>weights</code>) für die jeweilige Gruppe zu denen gemachte Beobachtungen gehören (<code>subclass</code>). Dies ist relevant, falls Beobachtungen mehrfach gematcht werden. Wegen Eins-zu-eins-Matching <em>ohne</em> Zurücklegen gibt es in unserem Beispiel 82 Beobachtungspaare und sämtliche Gewichte sind 1. Die Berücksichtigung der Gewicht in den nachfolgenden Aufrufen von Schätzfunktionen (bspw.<code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>) ist daher nicht nötig und erfolgt lediglich zur Illustration der grundsätzlichen Vorgehensweise.</p>
<p>Eine Wiederholung der grafischen Analyse in <a href="#sec-balance" class="quarto-xref"><span>Kapitel 5.1</span></a> zeigt eine deutlich verbesserte Vergleichbarkeit hinsichtlich der Verteilung der Matching-Variablen in <code>darkmode_matched</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_matched_CEM</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">hours</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span><span class="op">(</span><span class="va">scale</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span> alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>    facets <span class="op">=</span> <span class="op">~</span> <span class="va">name</span>, </span>
<span>    scales <span class="op">=</span> <span class="st">"free"</span>, </span>
<span>    nrow <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="Matching_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">darkmode_matched_CEM</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    male <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">male</span><span class="op">)</span>, </span>
<span>    dark_mode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dark_mode</span>, fill <span class="op">=</span> <span class="va">male</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Anteil"</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="Matching_files/figure-html/unnamed-chunk-39-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Wir beobachten eine bessere Balance bei <code>age</code> und <code>hours</code>. Inbesondere ist <code>male</code> für Kontroll- und Behandlungsgruppe ausgeglichen.</p>
</section></section><section id="sec-regadj" class="level2" data-number="5.3"><h2 data-number="5.3" class="anchored" data-anchor-id="sec-regadj">
<span class="header-section-number">5.3</span> Schätzung und Inferenz für den Behandlungseffekt nach Matching</h2>
<p>Wir schätzen nun den Behandlungseffekt von <code>dark_mode</code> auf <code>read_time</code> für die mit CEM und Propensity Score Matching ermittelten Datensätzen und vergleichen die Ergebniss anschließend mit einer Regressionsschätzung ohne Matching.</p>
<p>Wir kombinieren die Matching-Verfahren mit linearer Regression, d.h. wir Schätzen den Behandlungseffekt anhand es gematchten Datensatzes als Mittelwertdifferenz nach zusätzlicher Kontrolle für die Matching-Variablen. Diese Kombination von Matching mit Regression wird in der Literatur als <em>Regression Adjustment</em> bezeichnet und ist insbesondere hilfreich, wenn Backdoors mit Matching geschlossen werden sollen, der kausale Effekt jedoch nur unter Verwendung einer nicht-trivialen Regressionsfunktion ermittelt werden kann. Zum Beispiel kann bei einer kontinuierlichen Behandlungsvariable und einem nicht-linearen Zusammenhang mit <span class="math inline">\(Y\)</span> der kausale Effekt nicht durch einen bloßen Mittelwertvergleich erfasst werden, sondern erfordert eine adäquate Modellierung dieses Zusammenhangs in der Regressionsfunktion. Die zusätzliche Kontrolle für Matching-Variablen kann die Varianz der Schätzung verringern und das Risiko einer verzerrten Schätzung abmildern, falls nach Matching noch Unterschiede in der Balance von Behandlungs- und Kontrollgruppe vorliegen.</p>
<div class="cell">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ATT mit linearem Modell schätzen: CEM Datensatz</span></span>
<span><span class="va">ATT_mod_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode_matched_CEM</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">weights</span> </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ATT_mod_CEM</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ age + male + hours + dark_mode, data = darkmode_matched_CEM, 
    weights = weights)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.9310 -2.3856 -0.0194  2.5407 14.0020 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 16.6088953  1.5255529  10.887  &lt; 2e-16 ***
age          0.0380982  0.0344699   1.105  0.27072    
male        -4.0915725  0.6858131  -5.966 1.53e-08 ***
hours        0.0050129  0.0006977   7.185 2.45e-11 ***
dark_mode    1.6532234  0.6149439   2.688  0.00794 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.937 on 159 degrees of freedom
Multiple R-squared:  0.414, Adjusted R-squared:  0.3992 
F-statistic: 28.08 on 4 and 159 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Datensatz für Propensity Score Matching zuweisen</span></span>
<span><span class="va">darkmode_matched_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span><span class="va">res_PSC</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ATT mit linearem Modell schätzen: PSM Datensatz</span></span>
<span><span class="va">ATT_mod_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode_matched_PSC</span>, </span>
<span>  weights <span class="op">=</span> <span class="va">weights</span> </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ATT_mod_PSC</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ age + male + hours + dark_mode, data = darkmode_matched_PSC, 
    weights = weights)

Residuals:
   Min     1Q Median     3Q    Max 
-9.972 -2.605 -0.044  2.587 14.951 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 17.3654519  1.2762648  13.606  &lt; 2e-16 ***
age          0.0283941  0.0301484   0.942  0.34741    
male        -3.9858702  0.6480072  -6.151 4.03e-09 ***
hours        0.0046119  0.0006685   6.899 6.53e-11 ***
dark_mode    1.6346636  0.5769812   2.833  0.00507 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.141 on 203 degrees of freedom
Multiple R-squared:  0.3171,    Adjusted R-squared:  0.3037 
F-statistic: 23.57 on 4 and 203 DF,  p-value: 5.098e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># ATT mit linearem Modell ohne Matching</span></span>
<span><span class="va">ATT_mod_org</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ATT_mod_org</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = read_time ~ age + male + hours + dark_mode, data = darkmode)

Residuals:
     Min       1Q   Median       3Q      Max 
-10.2697  -2.6710   0.0164   2.5909  14.5739 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 16.859075   1.082303  15.577  &lt; 2e-16 ***
age          0.051332   0.022215   2.311  0.02154 *  
male        -4.485545   0.498957  -8.990  &lt; 2e-16 ***
hours        0.004348   0.000516   8.427 1.58e-15 ***
dark_mode    1.385810   0.523793   2.646  0.00859 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 4.03 on 295 degrees of freedom
Multiple R-squared:  0.3434,    Adjusted R-squared:  0.3345 
F-statistic: 38.57 on 4 and 295 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Beachte, dass für die gematchten Datensätze jeweils ein durchschnittlicher Behandlungseffekt für die Beobachtungen <em>mit</em> erfolgter Behandlung ermittelt wird: In sämtlichen oben gezeigten Matchibg-Verfahren werden mit <code>estimand = "ATT"</code> vergleichbarere Kontrollbeobachtungen für die behandelten Beobachtungen ermittelt. Wir schätzen den Effekt der Behandlung, indem wir die Ergebnisse von behandelten Personen mit denen von gematchten Personen vergleichen, die keine Behandlung erhalten haben. Diese Vergleichsgruppe dient als Ersatz für den hypothetischen Zustand der Behandlungsgruppe, wenn keine Behandlung erfolgt wäre. Dies entspricht der Definition eines ATT — ein average treatment effect <em>on the treated</em>.</p>
<section id="cluster-robuste-standardfehler" class="level3" data-number="5.3.1"><h3 data-number="5.3.1" class="anchored" data-anchor-id="cluster-robuste-standardfehler">
<span class="header-section-number">5.3.1</span> Cluster-robuste Standardfehler</h3>
<p>Für Matching-Verfahren sind die mit <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> berechneten Standardfehler (und damit auch Konfidenzintervalle, t-Statistiken und p-Werte) für den Behandlungseffekt <em>grundsätzlich ungültig</em>. Je nach Matching-Verfahren liegen unterschiedliche Quellen von Schätzunsicherheit vor, die bei der Berechnung von Standardfehlern zusätzlich zu der “üblichen” Stichproben-Variabilität berücksichtig werden müssen. Gründe hierfür sind der Matching-Prozess ansich oder weitere Unsicherheit durch die Schätzung zusätzlicher Parameter, etwa bei der Berechnung von Propensity Scores mit logistischer Regression. Eine weiterere Ursache zusätzlicher Variation durch den Matching-Prozess, die wir bisher nicht näher betrachtet haben ensteht durch Zurücklegen, d.h. wenn Beobachtungen mehrfach gematcht werden können. Auch dieser Faktor wird in der von <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> verwendeten Formel für den Standardfehler des Effekt-Schätzers nicht berücksichtigt.</p>
<p>Die Standardfehlerberechnung für Matching-Schätzer von Behandlungseffekten ist ein Gegenstand aktueller methodischer Forschung. <span class="citation" data-cites="AustinSmall2014">P. C. Austin und Small (<a href="Literatur.html#ref-AustinSmall2014" role="doc-biblioref">2014</a>)</span> und <span class="citation" data-cites="AbadieSpiess2022">Abadie und Spiess (<a href="Literatur.html#ref-AbadieSpiess2022" role="doc-biblioref">2022</a>)</span> belegen die Gültigkeit von cluster-robusten Standardfehlern mit Clustering auf Ebene der Beobachtungsgruppen (<code>subclass</code> im output von <code><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data()</a></code>) bei Matching ohne Zurücklegen. Für Matching anhand von Propensity Scores (auch mit Zurücklegen) zeigt <span class="citation" data-cites="AbadieImbens2016">Imbens (<a href="Literatur.html#ref-AbadieImbens2016" role="doc-biblioref">2016</a>)</span>, dass ignorieren der zusätzlichen Unsicherheit durch die Schätzung der Propensity Scores zu konservativer Inferenz für den ATE anhand eines cluster-robusten Standardfehlerschätzers führt, jedoch ungültige Inferenz für die Schätzung des ATT bedeuten kann. Ähnlich zu <span class="citation" data-cites="AustinSmall2014">P. C. Austin und Small (<a href="Literatur.html#ref-AustinSmall2014" role="doc-biblioref">2014</a>)</span> deuten die Ergebnisse der Simulationsstudie von <span class="citation" data-cites="Bodoryetal2020">Bodory u.&nbsp;a. (<a href="Literatur.html#ref-Bodoryetal2020" role="doc-biblioref">2020</a>)</span> jedoch auf grundsätzlich bessere Eigenschaften der Schätzung hin, wenn die Standardfehler <em>nicht</em> für die Schätzung der Propensity Scores adjustiert werden.</p>
<p>Weiterhin ist die Kontrolle für Kovariablen mit Erklärungskraft für die Outcome-Variable und für die Matching-Variablen mit <em>Regression Adjustment</em> (vgl. <a href="#sec-regadj" class="quarto-xref"><span>Kapitel 5.3</span></a>) für die Schätzung des Behandlungseffekts nach Matching eine etablierte Strategie, vgl. <span class="citation" data-cites="HillReiter2006">Hill und Reiter (<a href="Literatur.html#ref-HillReiter2006" role="doc-biblioref">2006</a>)</span> und <span class="citation" data-cites="AbadieSpiess2022">Abadie und Spiess (<a href="Literatur.html#ref-AbadieSpiess2022" role="doc-biblioref">2022</a>)</span>. So können die Varianz der Schätzung und das Risiko einer Verzerrung der Standardfehler aufgrund verbleibender Imbalance von Behandlungs- und Kontrollgruppe nach Matching verringert werden.</p>
<p>Zur Demonstration von (cluster)-robuster Inferenz und für eine tabellarische Zusammenfassung der Ergebnisse nutzen wir die Pakete <code>marginaleffects</code> und <code>modelsummary</code>. Mit <code><a href="https://marginaleffects.com/man/comparisons.html">marginaleffects::avg_comparisons()</a></code> können p-Werte und Kofindenzintervalle unter Berücksichtigung von robuster Standardfehlern und der Gewichte aus dem Matching-Verfahren berechnet werden.</p>
<div class="cell">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inferenz: Multiple Regression, ungematchter Datensatz</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">sum_orig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://marginaleffects.com/man/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">ATT_mod_org</span>,</span>
<span>    variables <span class="op">=</span> <span class="st">"dark_mode"</span>,</span>
<span>    <span class="co"># Heteroskedastie-robuste SE:</span></span>
<span>    vcov <span class="op">=</span> <span class="st">"HC3"</span>, </span>
<span>    <span class="co"># Identifizierung der Kontrollgruppe:</span></span>
<span>    newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">darkmode</span>, <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term          Contrast Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %
 dark_mode mean(1) - mean(0)     1.39      0.537 2.58  0.00988 6.7 0.333   2.44

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted 
Type:  response </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Inferenz: Multiple Regression bei CEM</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">sum_CEM</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://marginaleffects.com/man/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">ATT_mod_CEM</span> ,</span>
<span>  variables <span class="op">=</span> <span class="st">"dark_mode"</span>,</span>
<span>  <span class="co"># Cluster-robuste SE</span></span>
<span>  vcov <span class="op">=</span> <span class="op">~</span> <span class="va">subclass</span>, </span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">darkmode_matched_CEM</span>, <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  wts <span class="op">=</span> <span class="st">"weights"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term          Contrast Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %
 dark_mode mean(1) - mean(0)     1.65      0.549 3.01  0.00262 8.6 0.576   2.73

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted 
Type:  response </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Inferenz: Multiple Regression bei PSM</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">sum_PSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://marginaleffects.com/man/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">ATT_mod_PSC</span> ,</span>
<span>    variables <span class="op">=</span> <span class="st">"dark_mode"</span>,</span>
<span>    vcov <span class="op">=</span> <span class="op">~</span> <span class="va">subclass</span>, </span>
<span>    newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">darkmode_matched_PSC</span>, <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    wts <span class="op">=</span> <span class="st">"weights"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
      Term          Contrast Estimate Std. Error    z Pr(&gt;|z|)   S 2.5 % 97.5 %
 dark_mode mean(1) - mean(0)     1.63      0.565 2.89  0.00381 8.0 0.527   2.74

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted 
Type:  response </code></pre>
</div>
</div>
<p>Wir fassen die Ergebnisse mit <code><a href="https://modelsummary.com/man/modelsummary.html">modelsummary::modelsummary()</a></code> tabellarisch zusammen.</p>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modelsummary.com">modelsummary</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Tabellarische Zusammenfassung erzeugen</span></span>
<span><span class="fu"><a href="https://modelsummary.com/man/modelsummary.html">modelsummary</a></span><span class="op">(</span></span>
<span>  models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>   <span class="st">"Kein Matching"</span> <span class="op">=</span> <span class="va">sum_orig</span>, </span>
<span>   <span class="st">"Coarsened Exact"</span> <span class="op">=</span> <span class="va">sum_CEM</span>, </span>
<span>   <span class="st">"Propensity Scores"</span> <span class="op">=</span> <span class="va">sum_PSC</span></span>
<span>  <span class="op">)</span>,</span>
<span>  stars <span class="op">=</span> <span class="cn">T</span>, </span>
<span>  gof_map <span class="op">=</span> <span class="st">"nobs"</span>, </span>
<span>  output <span class="op">=</span> <span class="st">"gt"</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tabopts</span><span class="op">(</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<div id="zmdivwjgqx" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#zmdivwjgqx table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zmdivwjgqx thead, #zmdivwjgqx tbody, #zmdivwjgqx tfoot, #zmdivwjgqx tr, #zmdivwjgqx td, #zmdivwjgqx th {
  border-style: none;
}

#zmdivwjgqx p {
  margin: 0;
  padding: 0;
}

#zmdivwjgqx .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #000000;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zmdivwjgqx .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zmdivwjgqx .gt_title {
  color: #000000;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zmdivwjgqx .gt_subtitle {
  color: #000000;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zmdivwjgqx .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zmdivwjgqx .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmdivwjgqx .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #000000;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zmdivwjgqx .gt_col_heading {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zmdivwjgqx .gt_column_spanner_outer {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: bold;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zmdivwjgqx .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zmdivwjgqx .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zmdivwjgqx .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zmdivwjgqx .gt_spanner_row {
  border-bottom-style: hidden;
}

#zmdivwjgqx .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zmdivwjgqx .gt_empty_group_heading {
  padding: 0.5px;
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zmdivwjgqx .gt_from_md > :first-child {
  margin-top: 0;
}

#zmdivwjgqx .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zmdivwjgqx .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zmdivwjgqx .gt_stub {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zmdivwjgqx .gt_stub_row_group {
  color: #000000;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zmdivwjgqx .gt_row_group_first td {
  border-top-width: 2px;
}

#zmdivwjgqx .gt_row_group_first th {
  border-top-width: 2px;
}

#zmdivwjgqx .gt_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmdivwjgqx .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zmdivwjgqx .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zmdivwjgqx .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zmdivwjgqx .gt_grand_summary_row {
  color: #000000;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmdivwjgqx .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zmdivwjgqx .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zmdivwjgqx .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zmdivwjgqx .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #000000;
}

#zmdivwjgqx .gt_footnotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zmdivwjgqx .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmdivwjgqx .gt_sourcenotes {
  color: #000000;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zmdivwjgqx .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zmdivwjgqx .gt_left {
  text-align: left;
}

#zmdivwjgqx .gt_center {
  text-align: center;
}

#zmdivwjgqx .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zmdivwjgqx .gt_font_normal {
  font-weight: normal;
}

#zmdivwjgqx .gt_font_bold {
  font-weight: bold;
}

#zmdivwjgqx .gt_font_italic {
  font-style: italic;
}

#zmdivwjgqx .gt_super {
  font-size: 65%;
}

#zmdivwjgqx .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zmdivwjgqx .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zmdivwjgqx .gt_indent_1 {
  text-indent: 5px;
}

#zmdivwjgqx .gt_indent_2 {
  text-indent: 10px;
}

#zmdivwjgqx .gt_indent_3 {
  text-indent: 15px;
}

#zmdivwjgqx .gt_indent_4 {
  text-indent: 20px;
}

#zmdivwjgqx .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead><tr class="header gt_col_headings">
<th id=" " class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"></th>
<th id="Kein Matching" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">Kein Matching</th>
<th id="Coarsened Exact" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">Coarsened Exact</th>
<th id="Propensity Scores" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col">Propensity Scores</th>
</tr></thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers=" ">dark_mode</td>
<td class="gt_row gt_center" headers="Kein Matching">1.386**</td>
<td class="gt_row gt_center" headers="Coarsened Exact">1.653**</td>
<td class="gt_row gt_center" headers="Propensity Scores">1.635**</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers=" " style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000"></td>
<td class="gt_row gt_center" headers="Kein Matching" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000">(0.537)</td>
<td class="gt_row gt_center" headers="Coarsened Exact" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000">(0.549)</td>
<td class="gt_row gt_center" headers="Propensity Scores" style="border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: #000000">(0.565)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers=" ">Num.Obs.</td>
<td class="gt_row gt_center" headers="Kein Matching">300</td>
<td class="gt_row gt_center" headers="Coarsened Exact">164</td>
<td class="gt_row gt_center" headers="Propensity Scores">208</td>
</tr>
</tbody>
<tfoot class="gt_sourcenotes"><tr class="even">
<td colspan="4" class="gt_sourcenote">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td>
</tr></tfoot>
</table>
</div>
</div>
</div>
</div>
</section></section><section id="sec-bootmatching" class="level2 page-columns page-full" data-number="5.4"><h2 data-number="5.4" class="anchored" data-anchor-id="sec-bootmatching">
<span class="header-section-number">5.4</span> Bootstrap-Schätzung kausaler Effekte bei Matching</h2>
<p>Ein Bootstrap-Verfahren generiert mit Resampling (wiederholtes Ziehen mit Zurücklegen) aus dem Original-Datensatz (viele) künstliche Datensätze, für die der Schätzer (d.h. das gesamte Verfahren inkl. Matching!) jeweils berechnet wird. Die Verteilung der so gewonnenen Bootstrap-Schätzwerte approximiert die wahre, unbekannte Stichprobenverteilung des Schätzers des Behandlungseffekts. Mit dieser simulierten Verteilung können wir Inferenz betreiben: Wir können einen Bootstrap-Punktschätzer des Behandlungseffekts (Stichprobenmittel der Bootstrap-Schätzungen) sowie Standardfehler (Standardabweichung der der Bootstrap-Schätzungen) und p-Werte berechnen.</p>
<p>Der Bootstrap kann hilfreich sein, wenn unklar ist, wie Standardfehler für die Unsicherheit des Matching-Prozesses zu adjustieren sind, um gültige Inferenzsstatistiken zu erhalten. <span class="citation" data-cites="AbadieImbens2008">Abadie und Imbens (<a href="Literatur.html#ref-AbadieImbens2008" role="doc-biblioref">2008</a>)</span> zeigen analytisch, dass der Standard-Bootstrap die Stichprobenverteilung für Schätzer kausaler Effekte anhand von gematchten Datensätzen (d.h. bei Zuordnung/Selektion von Beobachtungen mit Matching) nicht korrekt abbilden kann. Grundsätzlich problematisch hierbei ist, wenn der Bootstrap eine verzerrte Schätzung produziert und/oder zu kleine Standardfehler liefert. <span class="citation" data-cites="AbadieImbens2008">Abadie und Imbens (<a href="Literatur.html#ref-AbadieImbens2008" role="doc-biblioref">2008</a>)</span> belegen die Tendenz des Bootstraps zu <em>konservative</em> (d.h. zu große) Standardfehler zu produzieren. Simulationsnachweise <span class="citation" data-cites="Bodoryetal2020 HillReiter2006 AustinSmall2014 AustinStuart2017">(<a href="Literatur.html#ref-Bodoryetal2020" role="doc-biblioref">Bodory u.&nbsp;a. 2020</a>; <a href="Literatur.html#ref-HillReiter2006" role="doc-biblioref">Hill und Reiter 2006</a>; <a href="Literatur.html#ref-AustinSmall2014" role="doc-biblioref">P. C. Austin und Small 2014</a>; <a href="Literatur.html#ref-AustinStuart2017" role="doc-biblioref">P. C. Austin und Stuart 2017</a>)</span> finden, dass Bootstrap-Standardfehler u.a. bei Propensity Score Matching mit Zurücklegen leicht konservativ sind somit das gewünschte nominale Signifikanzniveau eines Bootstrap-Hypothesentests nicht überschritten wird, weshalb der Standard-Bootstrap trotz seiner Schwächen in der empirischen Forschung oft angewendet wird.</p>
<p>Wir betrachen als nächstes einen Bootstrap-Algorithmus für Inferenz bezüglich eines kausalen Effekts nach Matching und demonstrieren die Schätzung anhand unseres Website-Beispiels für den ATT nach Propensity-Score-Matching.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="**Algorithmus: Bootstrap-Schätzer für Matching mit Regression Adjustment**">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<strong>Algorithmus: Bootstrap-Schätzer für Matching mit Regression Adjustment</strong>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Generiere eine Bootstrap-Stichprobe durch <span class="math inline">\(N\)</span> Züge <em>mit Zurücklegen</em> aus der <span class="math inline">\(N\)</span>-elementigen originalen Stichprobe.</p></li>
<li><p>Wende das Matching-Verfahren für die Bootstrap-Stichprobe an. Schätze den Behandlungseffekt <span class="math inline">\(\beta\)</span> anhand der gematchten Stichprobe mit Regression. Speichere den Punktschätzer des Behandlungseffekts <span class="math inline">\(\widehat{\beta}_b^*\)</span>.</p></li>
<li><p>Fürhre die Schritte 1 und 2 für <span class="math inline">\(b=1,\dots,B\)</span> aus, wobei <span class="math inline">\(B\)</span> eine hinreichend große Anzahl von Bootstrap-Replikationen ist.</p></li>
<li><p>Berechne den Bootstrap-Schätzer des Behandlungseffekts <span class="math inline">\(\overline{\beta}^* = \frac{1}{B}\sum_{b=1} \widehat{\beta}_b^*\)</span> und den Standardfehler <span class="math inline">\(\text{SE}(\overline{\beta}^*) = \sqrt{\frac{1}{B-1}\sum_{b=1}^B(\widehat{\beta}_b^*-\overline{\beta}^*)^2}\)</span>. Berechne Inferenz-Statistiken mit den üblichen Formeln.</p></li>
</ol>
</div>
</div>
<p>Wir Implementieren nun einen Bootstrap-Schätzer des ATT im Website-Beispiel für Propensity-Score-Matching. Hierzu definieren wir eine <code>R</code>-Funktion <code>boot_fun()</code> für die Schritte 1 und 2 im obigen Algorithmus.</p>
<div class="cell">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Funktion für Schritte 1 und 2</span></span>
<span><span class="va">boot_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>, <span class="co"># originale Stichprobe</span></span>
<span>    <span class="va">i</span>     <span class="co"># Indexmenge f. Bootstrap-Stichprobe</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Bootstrap-Stichprobe</span></span>
<span>  <span class="va">boot_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># 1:1 PS Matching</span></span>
<span>  <span class="va">match_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span></span>
<span>    <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>,</span>
<span>    estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>    distance <span class="op">=</span> <span class="st">"glm"</span>, </span>
<span>    method <span class="op">=</span> <span class="st">"nearest"</span>, </span>
<span>    caliper <span class="op">=</span> <span class="fl">.25</span>,</span>
<span>    data <span class="op">=</span> <span class="va">boot_data</span></span>
<span>  <span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co"># Gematchten Datensatz zuweisen</span></span>
<span>  <span class="va">darkmode_matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match.data.html">match.data</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">match_res</span>, </span>
<span>    data <span class="op">=</span> <span class="va">boot_data</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Outcome-Modell schätzen</span></span>
<span>  <span class="va">ATT_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">male</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">dark_mode</span>,</span>
<span>    data <span class="op">=</span> <span class="va">darkmode_matched</span>, </span>
<span>    weights <span class="op">=</span> <span class="va">weights</span> </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#  ATT-Schätzung zurückgeben</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span></span>
<span>    <span class="va">ATT_mod</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">"dark_mode"</span><span class="op">]</span>  </span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Wir berechnen nun eine Bootstrap-Schätzung des ATT von <code>dark_mode</code> auf <code>readingtime</code> nach Propensity Score Matching mit einem caliper von 0.25 sowie den zugehörigen Standardfehler und ein 95%-KI mit der zuvor definierten Funktion <code>boot_fun</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"boot"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4321</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Anz. Bootstrap-Replikationen</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">999</span></span>
<span></span>
<span><span class="co"># Bootstrap durchführen</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">boot_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span><span class="va">darkmode</span>, <span class="va">boot_fun</span>, R <span class="op">=</span> <span class="va">B</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = darkmode, statistic = boot_fun, R = B)


Bootstrap Statistics :
    original      bias    std. error
t1* 1.634664 -0.08144129   0.5935746</code></pre>
</div>
</div>
<p>Den Bootstrap-Schätzer des ATT sowie den Bootstrap-Standardfehler berechnen wir mit <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> und <code><a href="https://rdrr.io/r/stats/sd.html">sd()</a></code> anhand der 999 Bootstrap-Replikationen in <code>boot_out$t</code>.</p>
<p>Beachte, dass der Bootstrap-Schätzer des Behandlungseffekts nicht unmittelbar von <code><a href="https://rdrr.io/pkg/boot/man/boot.html">boot()</a></code> ausgegeben wird. <code>original</code> ist die Schätzung anhand der gesamten Stichprobe (d.h. ohne Bootstrap) und <code>bias</code> ist die Differenz zwischen dieser Schätzung und dem Mittelwert der Bootstrap-Schätzungen.</p>
<div class="cell">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Schätzer für den Treatment-Effekt</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">boot_out</span><span class="op">$</span><span class="va">t</span><span class="op">)</span> </span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.553222</code></pre>
</div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># bootstrap - original = bias</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">boot_out</span><span class="op">$</span><span class="va">t</span><span class="op">)</span> <span class="op">-</span> <span class="va">boot_out</span><span class="op">$</span><span class="va">t0</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  dark_mode 
-0.08144129 </code></pre>
</div>
</div>
<p>Wir können prüfen, dass die Berechnung des Standardfehlers dem Stichprobenstandardabweichung der Bootstrap-Schätzungen entspricht.</p>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Standardfehler</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">boot_out</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5935746</code></pre>
</div>
</div>
<p>Ein 95%-Konfidenzintervall für den kausalen Effekt erhalten wir mit <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot::boot.ci()</a></code>.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;<code>type = "bca"</code> (bias-corrected accelerated) ist eine gängige Implementierung für die Berechnung des Konfidenz-Intervalls.</p></div></div><div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 95% Bootstrap-KI für den Treatment-Effekt</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span></span>
<span>  boot.out <span class="op">=</span> <span class="va">boot_out</span>, </span>
<span>  type <span class="op">=</span> <span class="st">"bca"</span>, </span>
<span>  conf <span class="op">=</span> <span class="fl">.95</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 999 bootstrap replicates

CALL : 
boot.ci(boot.out = boot_out, conf = 0.95, type = "bca")

Intervals : 
Level       BCa          
95%   ( 0.527,  2.839 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
<p>Beachte, dass der Bootstrap-Standardfehler sowie das Bootstrap-Konfidenzintervall nahe der mit <code>avg_comarisons</code> berechneten Werte für <code>sum_PSC</code> sind.</p>
<p><strong>Bootstrap-Standardfehler für IPW-Schätzer des ATE berechnen</strong></p>
<p>Die Bootstrap-Funktion <code>boot_fun</code> kann leicht für eine Schätzung des Standardfehlers für den IPW-Schätzer des ATE aus <a href="#sec-PSM" class="quarto-xref"><span>Kapitel 5.1.3</span></a> angepasst werden. Statt einer Matching-Prozedur berechnen wir hierzu für <span class="math inline">\(B\)</span> Bootstrap-Stichproben den Schätzer <span class="math inline">\(\widehat{\tau}^\text{IPW}\)</span> mit Trimming der Propensity Scores.</p>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># IPW estimation with regression adjustment</span></span>
<span><span class="va">IPW_boot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>, </span>
<span>    <span class="va">i</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Bootstrap-Stichprobe erstellen</span></span>
<span>  <span class="va">data_boot</span>  <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Logistischee Regression</span></span>
<span>  <span class="va">glm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>,</span>
<span>    data <span class="op">=</span> <span class="va">data_boot</span>, </span>
<span>    family <span class="op">=</span> <span class="va">binomial</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Propensity Scores berechnen</span></span>
<span>  <span class="va">data_boot</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">glm_fit</span>, type <span class="op">=</span> <span class="st">'response'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Beobachtungen anhand Propensity Scores trimmen</span></span>
<span>  <span class="va">data_boot</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">ps</span>,</span>
<span>        left <span class="op">=</span> <span class="fl">.2</span>,</span>
<span>        right <span class="op">=</span> <span class="fl">.7</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># IPW berechnen</span></span>
<span>  <span class="va">data_boot</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      ipw <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">ps</span>,</span>
<span>        <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ps</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Gewichtete Mittelwerte der Gruppen   </span></span>
<span>  <span class="va">w_means</span> <span class="op">&lt;-</span> <span class="va">data_boot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">read_time</span>, w <span class="op">=</span> <span class="va">ipw</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">dark_mode</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ATT-Schätzwert</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">w_means</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">w_means</span><span class="op">$</span><span class="va">m</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="co"># Bootstrap für IPW durchführen</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">b_IPW</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>    statistic <span class="op">=</span> <span class="va">IPW_boot</span>, </span>
<span>    R <span class="op">=</span> <span class="fl">999</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = darkmode, statistic = IPW_boot, R = 999)


Bootstrap Statistics :
    original     bias    std. error
t1* 1.962849 0.06297654   0.6599891</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Schätzer und Standardfehler berechnen</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">b_IPW</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.025826</code></pre>
</div>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">b_IPW</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6599891</code></pre>
</div>
</div>
<p>In diesem Fall ist der Bootstrap-Standardfehler von ca. 0.66 gut mit dem anhand von <code>summary(model_ipw)</code> berechneten Standardfehler vergleichbar. Ein 95%-Konfidenzintervall für den ATE erhalten wir wie zuvor mit <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 95% Bootstrap-KI für den ATE</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span><span class="va">b_IPW</span>, type <span class="op">=</span> <span class="st">"bca"</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 999 bootstrap replicates

CALL : 
boot.ci(boot.out = b_IPW, type = "bca")

Intervals : 
Level       BCa          
95%   ( 0.563,  3.134 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
</section><section id="regression-matching-und-doubly-robust-schätzung" class="level2 page-columns page-full" data-number="5.5"><h2 data-number="5.5" class="anchored" data-anchor-id="regression-matching-und-doubly-robust-schätzung">
<span class="header-section-number">5.5</span> Regression, Matching und Doubly-Robust-Schätzung</h2>
<p>Als <em>Doubly-Robust-Schätzer</em> bezeichnet man Methoden, die bei Fehlspezifikationen im Matching-Verfahrens <em>oder</em> der funktionalen Form der Regressionsfunktion für die Outcome-Variable eine zuverlässige Schätzungen des kausalen Effekts ermöglichen.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> Unter der Vorraussetzung, dass die verwendeten Matching-Variablen sämliche Backdoors schließen, ist so mit Doubly-Robust-Schätzung eine konsistente Schätzung des Behandlungseffekts unter abgeschwächten Annahmen gewähtleistet. Dies macht Doubly-Robust-Schätzer besonders nützlich in Forschungskontexten, in denen präzise Modellspezifikationen herausfordernd sind.</p>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;Bspw. kann eine falsche funktionale Form bei logistischer Regression eine verzerrte Schätzung von Propensity Scores und damit eine unzureichende Balance bedeuten.</p></div></div><p>Der von <span class="citation" data-cites="Wooldrige2010">Wooldridge (<a href="Literatur.html#ref-Wooldrige2010" role="doc-biblioref">2010</a>)</span> vorgeschlagene Doubly-Robust-Schätzer (IPWRA) für den ATE erreicht seine vorteilhaften Eigenschaften durch eine geschickte Kombination von IPW und Regression Adjustment.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled" title="**Algorithmus: IPWRA-Schätzer des ATE**">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<strong>Algorithmus: IPWRA-Schätzer des ATE</strong>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Vgl. <span class="citation" data-cites="Wooldrige2010">Wooldridge (<a href="Literatur.html#ref-Wooldrige2010" role="doc-biblioref">2010</a>)</span>.</p>
<ol type="1">
<li><p>Berechne IPW anhand von Propensity Score mit logistischer Regression unter Verwendung der Matching-Variablen.</p></li>
<li>
<p>Regression Adjustment:</p>
<ol type="a">
<li><p>Schätze lediglich für die <em>Behandlungsgruppe</em> eine mit den IPW gewichtete Regressionspezifikation der Outcome-Variable mit Kontrolle für die Matching-Variablen.</p></li>
<li><p>Wiederhole Schritt A für <em>Kontrollgruppe</em>.</p></li>
</ol>
</li>
<li><p>Berechne Vorhersagen der Outcome-Variable für die angepassten Modelle aus 2 (a) und 2 (b) anhand des <em>gesamten</em> Datensatzes.</p></li>
<li><p>Schätze den ATE als Mittelwert-Differenz der Vorhersagen aus Schritt 3.</p></li>
</ol>
</div>
</div>
<p>Wir implementieren den Doubly-Robust-Schätzer des ATE von <span class="citation" data-cites="Wooldrige2010">Wooldridge (<a href="Literatur.html#ref-Wooldrige2010" role="doc-biblioref">2010</a>)</span> für das Website-Beispiel in der Funktion <code>IPWRA()</code> under Adaption des Schemas von <code>IPW_boot()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># IPW estimation with regression adjustment</span></span>
<span><span class="va">IPWRA</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>, </span>
<span>    <span class="va">i</span> <span class="op">=</span> <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>    <span class="co"># Bootstrap-Stichprobe zuweisen</span></span>
<span>    <span class="va">b_data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Logistische Regression</span></span>
<span>    <span class="va">glm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span></span>
<span>      formula <span class="op">=</span> <span class="va">dark_mode</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>,</span>
<span>      data <span class="op">=</span> <span class="va">b_data</span>, </span>
<span>      family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">'logit'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Propensity Scores berechnen</span></span>
<span>    <span class="va">b_data</span> <span class="op">&lt;-</span> <span class="va">b_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">glm_fit</span>, type <span class="op">=</span> <span class="st">'response'</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Propensity Scores trimmen</span></span>
<span>    <span class="va">b_data</span> <span class="op">&lt;-</span> <span class="va">b_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span></span>
<span>          x <span class="op">=</span> <span class="va">ps</span>,</span>
<span>          left <span class="op">=</span> <span class="fl">.2</span>,</span>
<span>          right <span class="op">=</span> <span class="fl">.7</span></span>
<span>          <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># IPW berechnen</span></span>
<span>    <span class="va">b_data</span> <span class="op">&lt;-</span> <span class="va">b_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        IPW <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>          <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">ps</span>,</span>
<span>          <span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ps</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Regression Adjustment:</span></span>
<span>    </span>
<span>    <span class="co"># Schätzung des Behandlungseffekts für die ges. Stichprobe</span></span>
<span>    <span class="co"># mit Modell für Behandlungsgruppe</span></span>
<span>    <span class="va">mtreat</span> <span class="op">&lt;-</span> <span class="va">b_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>, data <span class="op">=</span> <span class="va">.</span>, weights <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">IPW</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">b_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Schätzung des Behandlungseffekts für die ges. Stichprobe</span></span>
<span>    <span class="co"># mit Modell für Kontrollgruppe   </span></span>
<span>    <span class="va">mcont</span> <span class="op">&lt;-</span> <span class="va">b_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">dark_mode</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">read_time</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">hours</span> <span class="op">+</span> <span class="va">male</span>, data <span class="op">=</span> <span class="va">.</span>, weights <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">ipw</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">b_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Regression adjusted ATE-Schätzer</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">mtreat</span> <span class="op">-</span> <span class="va">mcont</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Schätzung des ATE mit <code>IPWRA()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">IPWRA</span><span class="op">(</span>data <span class="op">=</span> <span class="va">darkmode</span>, i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">darkmode</span><span class="op">)</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.96847</code></pre>
</div>
</div>
<p>Wie bei <span class="math inline">\(\widehat{\tau}^\text{IPW}\)</span> gibt es keine formale Darstellung des Standardfehlers für den IPWRA-Schätzer, sodass auch hier der Bootstrap genutzt werden sollte.</p>
<div class="cell">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bootrstrap für IPWRA durchführen</span></span>
<span><span class="op">(</span></span>
<span>  <span class="va">b_IPWRA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html">boot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">darkmode</span>,</span>
<span>  statistic <span class="op">=</span> <span class="va">IPWRA</span>,</span>
<span>  R <span class="op">=</span> <span class="va">B</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
ORDINARY NONPARAMETRIC BOOTSTRAP


Call:
boot(data = darkmode, statistic = IPWRA, R = B)


Bootstrap Statistics :
    original       bias    std. error
t1*  1.96847 -0.001270721   0.5960465</code></pre>
</div>
</div>
<p>Wir berechnen die interessierenden Statistiken analog zu der Vorgehensweise in <a href="#sec-bootmatching" class="quarto-xref"><span>Kapitel 5.4</span></a>.</p>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-IPWRA-Schätzer des ATE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">b_IPWRA</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.967199</code></pre>
</div>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Bootstrap-Standardfehler</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">b_IPWRA</span><span class="op">$</span><span class="va">t</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5960465</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 95%-Bootstrap-KI für den ATE</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html">boot.ci</a></span><span class="op">(</span><span class="va">b_IPWRA</span>, type <span class="op">=</span> <span class="st">"bca"</span><span class="op">)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
Based on 999 bootstrap replicates

CALL : 
boot.ci(boot.out = b_IPWRA, type = "bca")

Intervals : 
Level       BCa          
95%   ( 0.787,  3.098 )  
Calculations and Intervals on Original Scale</code></pre>
</div>
</div>
<p>Die Bootstrap-Schätzung des ATE mit IPWRA ist mit den Ergebnissen für die Bootstrap-Variante von <span class="math inline">\(\widehat{\tau}^\text{IPW}\)</span> vergleichbar, hat allerdings einen etwas kleineren Standardfehler und ist somit genauer.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-AbadieImbens2008" class="csl-entry" role="listitem">
Abadie, Alberto, und Guido W. Imbens. 2008. <span>„On the Failure of the Bootstrap for Matching Estimators.“</span> <em>Econometrica. Journal of the Econometric Society</em> 76 (6): 1537–57. <a href="https://doi.org/10.3982/ECTA6474">https://doi.org/10.3982/ECTA6474</a>.
</div>
<div id="ref-AbadieSpiess2022" class="csl-entry" role="listitem">
Abadie, Alberto, und Jann Spiess. 2022. <span>„Robust Post-Matching Inference.“</span> <em>Journal of the American Statistical Association</em> 117 (538): 983–95. <a href="https://doi.org/10.1080/01621459.2020.1840383">https://doi.org/10.1080/01621459.2020.1840383</a>.
</div>
<div id="ref-Austin2011" class="csl-entry" role="listitem">
Austin, P. 2011. <span>„An Introduction to Propensity Score Methods for Reducing the Effects of Confounding in Observational Studies“</span>. <em>Multivariate Behavioral Research</em> 46 (3): 399–424. <a href="https://doi.org/10.1080/00273171.2011.568786">https://doi.org/10.1080/00273171.2011.568786</a>.
</div>
<div id="ref-AustinSmall2014" class="csl-entry" role="listitem">
Austin, Peter C., und Dylan S. Small. 2014. <span>„The use of bootstrapping when using propensity-score matching without replacement: A simulation study.“</span> <em>Statistics in Medicine</em> 33 (24): 4306–19. <a href="https://doi.org/10.1002/sim.6276">https://doi.org/10.1002/sim.6276</a>.
</div>
<div id="ref-AustinStuart2017" class="csl-entry" role="listitem">
Austin, Peter C., und Elizabeth A. Stuart. 2017. <span>„Estimating the Effect of Treatment on Binary Outcomes Using Full Matching on the Propensity Score.“</span> <em>Statistical Methods in Medical Research</em> 26 (6): 2505–25. <a href="https://doi.org/10.1177/0962280215601134">https://doi.org/10.1177/0962280215601134</a>.
</div>
<div id="ref-Bodoryetal2020" class="csl-entry" role="listitem">
Bodory, Hugo, Lorenzo Camponovo, Martin Huber, und Michael Lechner. 2020. <span>„The Finite Sample Performance of Inference Methods for Propensity Score Matching and Weighting Estimators.“</span> <em>Journal of Business &amp; Economic Statistics</em>. <a href="https://doi.org/10.2139/ssrn.2731969">https://doi.org/10.2139/ssrn.2731969</a>.
</div>
<div id="ref-Hainmueller2012" class="csl-entry" role="listitem">
Hainmueller, Jens. 2012. <span>„Entropy Balancing for Causal Effects: A Multivariate Reweighting Method to Produce Balanced Samples in Observational Studies“</span>. <em>Political Analysis</em> 20 (1): 25–46. <a href="https://doi.org/10.1093/pan/mpr025">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-Hajek1971" class="csl-entry" role="listitem">
Hájek, J. 1971. <span>„Comment on <span>‚An essay on the logical foundations of survey sampling‘</span> by Basu, D“</span>. <em>Foundations of Statistical Inference</em> 236.
</div>
<div id="ref-HillReiter2006" class="csl-entry" role="listitem">
Hill, Jennifer, und Jerome P. Reiter. 2006. <span>„Interval estimation for treatment effects using propensity score matching. Statistics in Medicine“</span>. <em>Statistics in Medicine</em> 25 (13): 2230–56. <a href="https://doi.org/10.1002/sim.2277">https://doi.org/10.1002/sim.2277</a>.
</div>
<div id="ref-Hiranoetal2003" class="csl-entry" role="listitem">
Hirano, Keisuke, Guido Imbens, und Geert Ridder. 2003. <span>„Efficient Estimation of Average Treatment Effects Using the Estimated Propensity Score.“</span> <em>Econometrica</em> 71 (4): 1161–89. <a href="https://doi.org/10.1111/1468-0262.00442">https://doi.org/10.1111/1468-0262.00442</a>.
</div>
<div id="ref-AbadieImbens2016" class="csl-entry" role="listitem">
Imbens. 2016. <span>„Matching on the Estimated Propensity Score.“</span> <em>Econometrica</em> 84 (2): 781–807. <a href="https://doi.org/10.3982/ecta11293">https://doi.org/10.3982/ecta11293</a>.
</div>
<div id="ref-Love2004" class="csl-entry" role="listitem">
Love, Thomas. 2004. <span>„Graphical display of covariate balance“</span>. Presentation.
</div>
<div id="ref-RosenbaumRubin1983" class="csl-entry" role="listitem">
Rosenbaum, Paul R., und Donald R. Rubin. 1983. <span>„The central role of the propensity score in observational studies for causal effects“</span>. <em>Biometrika</em> 70 (1): 170–84. <a href="https://doi.org/10.1017/cbo9780511810725.016">https://doi.org/10.1017/cbo9780511810725.016</a>.
</div>
<div id="ref-Wooldrige2010" class="csl-entry" role="listitem">
Wooldridge, Jeffrey. 2010. <em>Econometric Analysis of Cross Section and Panel Data</em>. Second edition. Cambridge, Massachusetts: MIT.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Kopiert");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Kopiert");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./Simulation.html" class="pagination-link" aria-label="Simulation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Simulation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./FixedEffects.html" class="pagination-link" aria-label="Panel-Daten">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Panel-Daten</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Quellcode</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb106" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span><span class="co"> </span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="co">  show-startup-message: true</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co">  packages: [</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="co">            'boot', </span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co">            'cobalt', </span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="co">            'dplyr',</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="co">            'ggplot2',</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="co">            'marginaleffects', </span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a><span class="co">            'MatchIt', </span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a><span class="co">            'sandwich',</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a><span class="co">            'tidyr',</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a><span class="co">            ]</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;style&gt;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="in">.qwebr-code-output-stdout {background-color: powderblue;}</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="in">.qwebr-button-run, .qwebr-button-reset, .qwebr-button-copy {</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="in">  background-color:  rgba(0, 0, 0, 0);</span></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a><span class="in">  border-style: none;</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a><span class="in">  font-weight: 400;</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a><span class="in">  color: white; </span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a><span class="in">  transition: none;</span></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a><span class="in">.qwebr-editor-toolbar {</span></span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a><span class="in">  width: 100%;</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a><span class="in">  display: flex;</span></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a><span class="in">  justify-content: space-between;</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a><span class="in">  box-sizing: border-box;</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a><span class="in">  border-radius: 0 0 6px 6px;</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a><span class="in">  background-color: darkgreen;</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a><span class="in">  border-color: darkgreen;</span></span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a><span class="in">  border-width: 1px;</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a><span class="in">  border-style: solid;</span></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a><span class="in">  padding: 0 0; </span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a><span class="in">  transition: color .1s ease-in-out, background-color .1s ease-in-out,border-color .1s ease-in-out,box-shadow .1s ease-in-out;</span></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a><span class="in">.qwebr-editor-toolbar:hover {</span></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a><span class="in">  background-color: white;</span></span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a><span class="in">  border-color: darkgreen;</span></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a><span class="in">  border-width: 1px;</span></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a><span class="in">.qwebr-editor-toolbar:hover * {</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a><span class="in">  color: darkgreen;</span></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a><span class="in">.overflow-guard, .qwebr-editor, .monaco-editor {</span></span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a><span class="in">  border-radius: 6px 6px 0 0;</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a><span class="in">  border-width: 1px 1px 0 1px;</span></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a><span class="in">  border-color: darkgreen;</span></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/style&gt;</span></span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a><span class="fu"># Matching</span></span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo=F, message=FALSE}</span></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a><span class="in">library(gt)</span></span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a><span class="in"># Formatierung von gt-Tabellen</span></span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a><span class="in">tabopts &lt;- function(x) {</span></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a><span class="in">    fmt_number(x, decimals = 3, drop_trailing_zeros = T) %&gt;%</span></span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a><span class="in">  tab_options(table_body.hlines.color = "white", </span></span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a><span class="in">              column_labels.border.bottom.color = "black", </span></span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a><span class="in">             column_labels.border.top.color = "black",</span></span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a><span class="in">             table_body.border.bottom.color = "black", </span></span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a><span class="in">             table.border.bottom.color = "black",</span></span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a><span class="in">             column_labels.font.weight = "bold", </span></span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a><span class="in">             table.font.color = "black", </span></span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a><span class="in">             table.font.size = 16)</span></span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a><span class="in">#| context: setup</span></span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a><span class="in"># create dataset directory</span></span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a><span class="in">dir.create("datasets")</span></span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a><span class="in"># Download the dataset</span></span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a><span class="in">download.file(</span></span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a><span class="in">    "https://raw.githubusercontent.com/mca91/kausal_data/main/darkmode.csv",</span></span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a><span class="in">    'datasets/darkmode.csv',</span></span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a><span class="in">#| context: setup</span></span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a><span class="in"># make darkmode available using read.csv for now</span></span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a><span class="in"># because there's some issue with readr::read_csv</span></span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a><span class="in"># I can't fix right now</span></span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a><span class="in">darkmode &lt;- read.csv(</span></span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a><span class="in">    file = "datasets/darkmode.csv", </span></span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a><span class="in">    colClasses = c("numeric", "logical", "numeric", "numeric", "numeric") </span></span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a><span class="in">options(pillar.bold = TRUE, pillar.subtle = FALSE)</span></span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a>In randomisierten kontrollierten Studien stellt eine randomisierte Behandlung sicher, dass die Individuen beider Gruppen im Mittel vergleichbar sind, dass heißt es gibt keine systematischen Unterschiede der Studiensubjekte hinsichtlich der Verteilung von Charakteristika zwischen den Gruppen. Dann ist es plausibel eine beobachtete mittlere Differenz in der Outcome-Variable alleine auf die Behandlung zurückzuführen.</span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a>In der Praxis, insbesondere in ökonomischen Studien, sind randomisierte kontrollierte Studien aus ethischen und/oder finanziellen Gründen nicht durchführbar. Stattdessen werden nicht-experimentelle Daten genutzt, die jedoch nur sehr selten eine Vergleichbarkeit von Behandlungs- und Kontrollgruppe gewährleisten.</span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a>In diesem Kapitel betrachten wir Methoden, die in solchen Forschungsdesigns -- bei hinreichenden Informationen über die Studiensubjekte -- eine Schätzung kausaler Effekte ermöglichen, indem eine statistische Vergleichbarkeit von Behandlungs- und Kontrollgruppe hergestellt wird. Dies kann durch eine gezielte Gewichtung von Beobachtungen anhand invididueller Merkmale bei der Schätzung des Behandlungseffekts erfolgen. Andere etablierte Methoden schätzen den kausalen Effekt nach Selektion von vergleichbaren Teilmengen von Subjekten beider Gruppen aus der ursprünglichen Stichprobe, sogenanntes *selektierendes Matching*.</span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a>Da Matching Beobachtungen basierend auf beobachtbaren Merkmalen vergleicht, kann die Wahrscheinlichkeit einer verzerrten Schätzung des kausalen Effekt durch falsche Modellspezifikationen geringer sein als für eine Schätzung des Effekts anhand multipler Regression. Weiterhin basieren Matching-Methoden nicht auf der Annahme eines linearen Zusammenhangs zwischen Kovariablen und der erklärenden Variable und können für die Schätzung unterschiedlicher Spezifikationen von Behandlungseffekten herangezogen werden.</span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a>Für die Gültigkeit eines Schätzers basierend auf Matching sind zwei Annahmen erforderlich.</span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>***Bedingte Unabhängigkeit.*** Seien $Y^{(0)}_i$ und $Y^{(1)}_i$ potentielle Ergebnisse der Outcome-Variable $Y$ für ein Subjekt $i$ mit $B_i=0$ (keine Zuweisung zur Behandlung) beziehungsweise $B_i=1$ (Behandlung) und $X_i$ die beobachteten Kovariablen. Wir nehmen an, dass \begin{align}</span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a>      \left<span class="sc">\{</span>Y^{(0)}_i, Y^{(1)}_i\right<span class="sc">\}</span> \perp B_i\vert X_i, \label{eq:cia}</span>
<span id="cb106-117"><a href="#cb106-117" aria-hidden="true" tabindex="-1"></a>    \end{align} d.h. die Behandlungszuweisung/-selektion ist unanabhängig von den potentielle Ergebnissen $Y^{(0)}_i$ und $Y^{(1)}_i$, wenn wir für die Kovariablen $X$ kontrollieren.</span>
<span id="cb106-118"><a href="#cb106-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>***Überlappung.*** Für jede mögliche Kombination von Kovariablen $X_i$ gibt es eine positive Wahrscheinlichkeit $&lt;1$, sowohl zur Behandlungsgruppe ($B_i = 1$) als auch zur Kontrollgruppe ($B_i = 0$) zugewiesen zu werden, \begin{align}</span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a>      0 &lt; \text{P}(B_i=1\lvert X_i) &lt; 1, \label{eq:overlap}</span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a>    \end{align} d.h. keine Beobachtung hat eine Behandlungswahrscheinlichkeit von exakt $0$ oder $1$.</span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a>Annahme 1 stellt sicher, dass die Zuweisung zur Behandlungsgruppe nach Kontrolle für die Kovariablen $X$ als zufällig betracht werden kann. Somit ist es möglich den kausalen Effekt der Behandlung zu identifizieren, indem wir hinsichtlich der Kovariablen $X$ ähnliche Subjekte (vgl. Annahme 2) aus Kontroll- und Behandlungsgruppe vergleichen.</span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-125"><a href="#cb106-125" aria-hidden="true" tabindex="-1"></a>Annahme 2 setzt vorraus, dass es eine ausreichende Überlappung in den Verteilungen der Kovariablen zwischen Behandlungs- und Kontrollgruppe gibt. Dann ist sichergestellt, dass für jedes Subjekt in einer Gruppe ein hinsichtlich seiner Charakteristika vergleichbares Subjekt in der anderen Gruppe geben kann, sodass ein Vergleich möglich ist.</span>
<span id="cb106-126"><a href="#cb106-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a><span class="fu">## *Balance*: Vergleichbarkeit von Behandlungs- und Kontrollgruppe {#sec-balance}</span></span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a>Der Lehrstuhl für Ökonometrie an der Universität Duisburg-Essen betreibt einen Ökonometrie-Blog und interessiert sich für den kausalen Effekt der Einführung eines <span class="co">[</span><span class="ot">darkmode</span><span class="co">](https://en.wikipedia.org/wiki/Wikipedia:Dark_mode)</span> auf die Verweildauer der User auf der Webseite. Die Webseite ist zwar nicht-kommerziell, hat sich allerdings insb. für die Aquise internationaler Studierender für den Studiengang MSc. Econometrics als wichtiges Marketing-Instrument erwiesen. Ein anprechendes Design wird daher als hoch-relevant erachtet.</span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a>Idealerweise sollte der Effekt des Design-Relaunches auf die Nutzungsintensität in einem kontrollierten randomisierten Experiment untersucht werden. Hierbei würden wir Nutzern zufällig das neue oder das alte Design zuweisen und den Effekt als Differnz des durchschnittlichen Verweildauer für die Gruppen bestimmen. Eine solche Studie ist jedoch aus technischen und finanziellen Gründen nicht realisierbar, sodass die Auswirkungen des darkmode mit vorliegenden nicht-experimenellen Nutzungsstatistiken für die Webseite geschätzt werden sollen.</span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-133"><a href="#cb106-133" aria-hidden="true" tabindex="-1"></a>Die Nutzungsstatistiken sind im Datensatz <span class="co">[</span><span class="ot">*darkmode.csv*</span><span class="co">](https://raw.githubusercontent.com/mca91/kasa_data/main/darkmode.csv)</span> enthalten und sollen der Analyse des Effekts des darkmode (<span class="in">`dark_mode`</span>) auf die Verweildauer der Leser auf der Webseite (<span class="in">`read_time`</span>) dienen.</span>
<span id="cb106-134"><a href="#cb106-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-135"><a href="#cb106-135" aria-hidden="true" tabindex="-1"></a>@tbl-darkmode zeigt die Definitionen der Variablen in *darkmode.csv*.</span>
<span id="cb106-136"><a href="#cb106-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-137"><a href="#cb106-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, echo = F}</span></span>
<span id="cb106-138"><a href="#cb106-138" aria-hidden="true" tabindex="-1"></a><span class="in">#| tbl-cap: "Variablen im Datensatz *darkmode*"</span></span>
<span id="cb106-139"><a href="#cb106-139" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: tbl-darkmode</span></span>
<span id="cb106-140"><a href="#cb106-140" aria-hidden="true" tabindex="-1"></a><span class="in">tibble(</span></span>
<span id="cb106-141"><a href="#cb106-141" aria-hidden="true" tabindex="-1"></a><span class="in">  Variable = c(</span></span>
<span id="cb106-142"><a href="#cb106-142" aria-hidden="true" tabindex="-1"></a><span class="in">    "read_time", </span></span>
<span id="cb106-143"><a href="#cb106-143" aria-hidden="true" tabindex="-1"></a><span class="in">    "dark_mode", </span></span>
<span id="cb106-144"><a href="#cb106-144" aria-hidden="true" tabindex="-1"></a><span class="in">    "male", </span></span>
<span id="cb106-145"><a href="#cb106-145" aria-hidden="true" tabindex="-1"></a><span class="in">    "age", </span></span>
<span id="cb106-146"><a href="#cb106-146" aria-hidden="true" tabindex="-1"></a><span class="in">    "hours"</span></span>
<span id="cb106-147"><a href="#cb106-147" aria-hidden="true" tabindex="-1"></a><span class="in">    ),</span></span>
<span id="cb106-148"><a href="#cb106-148" aria-hidden="true" tabindex="-1"></a><span class="in">  Beschreibung = c(</span></span>
<span id="cb106-149"><a href="#cb106-149" aria-hidden="true" tabindex="-1"></a><span class="in">    "Lesezeit (Minuten/Woche)",</span></span>
<span id="cb106-150"><a href="#cb106-150" aria-hidden="true" tabindex="-1"></a><span class="in">    "Indikator: Beobachtung nach Einführung darkmode",</span></span>
<span id="cb106-151"><a href="#cb106-151" aria-hidden="true" tabindex="-1"></a><span class="in">    "Indikator: Individuum männlich",</span></span>
<span id="cb106-152"><a href="#cb106-152" aria-hidden="true" tabindex="-1"></a><span class="in">    "Alter (in Jahren)",</span></span>
<span id="cb106-153"><a href="#cb106-153" aria-hidden="true" tabindex="-1"></a><span class="in">    "Bisherige Verweildauer auf der Seite"</span></span>
<span id="cb106-154"><a href="#cb106-154" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-155"><a href="#cb106-155" aria-hidden="true" tabindex="-1"></a><span class="in">) %&gt;%</span></span>
<span id="cb106-156"><a href="#cb106-156" aria-hidden="true" tabindex="-1"></a><span class="in">  gt() %&gt;%</span></span>
<span id="cb106-157"><a href="#cb106-157" aria-hidden="true" tabindex="-1"></a><span class="in">  tabopts</span></span>
<span id="cb106-158"><a href="#cb106-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-159"><a href="#cb106-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-160"><a href="#cb106-160" aria-hidden="true" tabindex="-1"></a>Für die Analyse lesen wir zunächst den Datensatz *darkmode.csv* mit <span class="in">`readr::read_csv()`</span> ein und verschaffen uns einen Überblick über die verfügbaren Variablen.</span>
<span id="cb106-161"><a href="#cb106-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-162"><a href="#cb106-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb106-163"><a href="#cb106-163" aria-hidden="true" tabindex="-1"></a><span class="in"># Paket `tidyverse` laden</span></span>
<span id="cb106-164"><a href="#cb106-164" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb106-165"><a href="#cb106-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-166"><a href="#cb106-166" aria-hidden="true" tabindex="-1"></a><span class="in"># Datensatz 'darkmode' einlesen</span></span>
<span id="cb106-167"><a href="#cb106-167" aria-hidden="true" tabindex="-1"></a><span class="in">darkmode &lt;- read_csv(</span></span>
<span id="cb106-168"><a href="#cb106-168" aria-hidden="true" tabindex="-1"></a><span class="in">  file = "datasets/darkmode.csv"</span></span>
<span id="cb106-169"><a href="#cb106-169" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-170"><a href="#cb106-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-171"><a href="#cb106-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-172"><a href="#cb106-172" aria-hidden="true" tabindex="-1"></a><span class="in">`dark_mode`</span> hat den Typ <span class="in">`logical`</span>. Mit <span class="in">`dplyr::mutate_all()`</span> können wir komfortabel alle Spalten in den Typ <span class="in">`numeric`</span> transformieren.</span>
<span id="cb106-173"><a href="#cb106-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-176"><a href="#cb106-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-177"><a href="#cb106-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Alle Variablen zu typ 'numeric' formatieren...</span></span>
<span id="cb106-178"><a href="#cb106-178" aria-hidden="true" tabindex="-1"></a>darkmode <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-179"><a href="#cb106-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_all</span>(<span class="at">.funs =</span> as.numeric)</span>
<span id="cb106-180"><a href="#cb106-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-181"><a href="#cb106-181" aria-hidden="true" tabindex="-1"></a><span class="co"># ... und überprüfen</span></span>
<span id="cb106-182"><a href="#cb106-182" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(darkmode)</span>
<span id="cb106-183"><a href="#cb106-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-184"><a href="#cb106-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-185"><a href="#cb106-185" aria-hidden="true" tabindex="-1"></a>Eine naive Schätzung des durchschnittlichen Behandlungseffekts (ATE) $\widehat{\tau}^{\text{naiv}}$ erhalten wir als Mittelwertdifferenz von <span class="in">`read_time`</span> für die Behandlungsgruppe (<span class="in">`dark_mode == 1`</span>) und die Kontrollgruppe (<span class="in">`dark_mode == 0`</span>) \begin{align}</span>
<span id="cb106-186"><a href="#cb106-186" aria-hidden="true" tabindex="-1"></a>  \widehat{\tau}^{\text{naiv}} = \overline{\text{read<span class="sc">\_</span>time}}_{\text{Behandlung}} - \overline{\text{read\_time}}_{\text{Kontrolle}}.\label{eq:naivATEdarkmode}</span>
<span id="cb106-187"><a href="#cb106-187" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb106-188"><a href="#cb106-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-189"><a href="#cb106-189" aria-hidden="true" tabindex="-1"></a>Diese Berechnung ist schnell mit R durchgeführt.</span>
<span id="cb106-190"><a href="#cb106-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-193"><a href="#cb106-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-194"><a href="#cb106-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Naiver Schätzer für ATE: </span></span>
<span id="cb106-195"><a href="#cb106-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Differenz der Gruppen-Durchschnitte</span></span>
<span id="cb106-196"><a href="#cb106-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-197"><a href="#cb106-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome in Behandlungsgruppe</span></span>
<span id="cb106-198"><a href="#cb106-198" aria-hidden="true" tabindex="-1"></a>read_time_mTG <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-199"><a href="#cb106-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-200"><a href="#cb106-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(<span class="st">"read_time"</span>)</span>
<span id="cb106-201"><a href="#cb106-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-202"><a href="#cb106-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome in Kontrollgruppe</span></span>
<span id="cb106-203"><a href="#cb106-203" aria-hidden="true" tabindex="-1"></a>read_time_mKG <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-204"><a href="#cb106-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-205"><a href="#cb106-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(<span class="st">"read_time"</span>)</span>
<span id="cb106-206"><a href="#cb106-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-207"><a href="#cb106-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Mittelwert-Differenz</span></span>
<span id="cb106-208"><a href="#cb106-208" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(read_time_mTG) <span class="sc">-</span> <span class="fu">mean</span>(read_time_mKG)</span>
<span id="cb106-209"><a href="#cb106-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-210"><a href="#cb106-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-211"><a href="#cb106-211" aria-hidden="true" tabindex="-1"></a>Die Schätzung ergibt einen negativen Behandlungseffekt, mit der Interpreation, dass das neue Design zu einer Reduktion der Lesezeit um etwa 0.44 Minuten pro Woche führt. Dieses Ergebnis ist allerdings zweifelhaft, weil eine Isolierung des Behandlungseffekts aufgrund von Backdoor-Pfaden im DGP vermutlich nicht gewähleistet ist. Ein Indikator hierfür sind systematische Unterschiede hinsichtlich von (möglicherweise unbeobachtbaren) Charakteristika von Kontrollgruppe und Behandlungsgruppe.</span>
<span id="cb106-212"><a href="#cb106-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-213"><a href="#cb106-213" aria-hidden="true" tabindex="-1"></a>Da die User sich beim Aufrufen der Seite aktiv für oder gegen den das neue Design entscheiden müssen (und somit selektieren, ob Sie in der Behandlungs- oder Kontrollgruppe landen), liegt wahrscheinlich *Confounding* vor: Unsere Hypothese ist zunächst, dass männliche User eine durchschnittlich längere Lesezeit aufweisen *und* mit größerer Wahrscheinlichkeit auf das neue Design wechseln als nicht-männliche Leser. Dann ist <span class="in">`male`</span> eine Backdoor-Variable. Diese Situation ist unter der Annahme, dass nur diese Faktoren den DGP bestimmen, in @fig-maleCDdarkmode dargestellt.</span>
<span id="cb106-214"><a href="#cb106-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-217"><a href="#cb106-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{dot}</span></span>
<span id="cb106-218"><a href="#cb106-218" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-width: 4</span></span>
<span id="cb106-219"><a href="#cb106-219" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-height: 3</span></span>
<span id="cb106-220"><a href="#cb106-220" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-align: 'center'</span></span>
<span id="cb106-221"><a href="#cb106-221" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-cap: "Backdoor durch 'male' im Website-Design-Bespiel"</span></span>
<span id="cb106-222"><a href="#cb106-222" aria-hidden="true" tabindex="-1"></a><span class="in">//| label: "fig-maleCDdarkmode" </span></span>
<span id="cb106-223"><a href="#cb106-223" aria-hidden="true" tabindex="-1"></a><span class="in">digraph {</span></span>
<span id="cb106-224"><a href="#cb106-224" aria-hidden="true" tabindex="-1"></a><span class="in">  layout=neato</span></span>
<span id="cb106-225"><a href="#cb106-225" aria-hidden="true" tabindex="-1"></a><span class="in">  fontname="Helvetica,Arial,sans-serif"</span></span>
<span id="cb106-226"><a href="#cb106-226" aria-hidden="true" tabindex="-1"></a><span class="in">  node [fontname="Helvetica,Arial,sans-serif"]</span></span>
<span id="cb106-227"><a href="#cb106-227" aria-hidden="true" tabindex="-1"></a><span class="in">  edge [fontname="Helvetica,Arial,sans-serif"]</span></span>
<span id="cb106-228"><a href="#cb106-228" aria-hidden="true" tabindex="-1"></a><span class="in">  node [shape=none];</span></span>
<span id="cb106-229"><a href="#cb106-229" aria-hidden="true" tabindex="-1"></a><span class="in">  "read_time" [pos="4,0.5!"]</span></span>
<span id="cb106-230"><a href="#cb106-230" aria-hidden="true" tabindex="-1"></a><span class="in">  "dark_mode" [pos="0,0.5!"]</span></span>
<span id="cb106-231"><a href="#cb106-231" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" [pos="2,-1!"]</span></span>
<span id="cb106-232"><a href="#cb106-232" aria-hidden="true" tabindex="-1"></a><span class="in">  "dark_mode" -&gt; "read_time" [color="green"]</span></span>
<span id="cb106-233"><a href="#cb106-233" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" -&gt; "dark_mode" [color="red"]</span></span>
<span id="cb106-234"><a href="#cb106-234" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" -&gt; "read_time" [color="red"]</span></span>
<span id="cb106-235"><a href="#cb106-235" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-236"><a href="#cb106-236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-237"><a href="#cb106-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-238"><a href="#cb106-238" aria-hidden="true" tabindex="-1"></a>Der DGP in @fig-maleCDdarkmode führt zu einer verzerrten Schätzung des kausalen Effekts von <span class="in">`dark_mode`</span> auf <span class="in">`read_time`</span> mit \eqref{eq:naivATEdarkmode}, wenn das Verhältnis von männlichen und nicht-männlichen Usern in Bahandlungs- und Kontrollgruppe nicht ausgeglichen ist. Wir überprüfen dies mit R.</span>
<span id="cb106-239"><a href="#cb106-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-242"><a href="#cb106-242" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-243"><a href="#cb106-243" aria-hidden="true" tabindex="-1"></a><span class="co"># Anteile männlicher und nicht-männlicher User</span></span>
<span id="cb106-244"><a href="#cb106-244" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-245"><a href="#cb106-245" aria-hidden="true" tabindex="-1"></a>  anteile <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-246"><a href="#cb106-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span> </span>
<span id="cb106-247"><a href="#cb106-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb106-248"><a href="#cb106-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">gesamt =</span> <span class="fu">n</span>(),</span>
<span id="cb106-249"><a href="#cb106-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">ant_m =</span> <span class="fu">mean</span>(male),</span>
<span id="cb106-250"><a href="#cb106-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">ant_nm =</span> <span class="dv">1</span> <span class="sc">-</span> ant_m,</span>
<span id="cb106-251"><a href="#cb106-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">anz_m =</span> <span class="fu">sum</span>(male),</span>
<span id="cb106-252"><a href="#cb106-252" aria-hidden="true" tabindex="-1"></a>    <span class="at">anz_nm =</span> gesamt <span class="sc">-</span> anz_m</span>
<span id="cb106-253"><a href="#cb106-253" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-254"><a href="#cb106-254" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-255"><a href="#cb106-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-256"><a href="#cb106-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-257"><a href="#cb106-257" aria-hidden="true" tabindex="-1"></a>Die Zusammenfassung <span class="in">`anteile_m`</span> zeigt, dass der Anteil männlicher User in der Behandlungsgruppe deutlich höher ist als in der Kontrollgruppe.</span>
<span id="cb106-258"><a href="#cb106-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-259"><a href="#cb106-259" aria-hidden="true" tabindex="-1"></a><span class="fu">### Matching durch Gewichtung</span></span>
<span id="cb106-260"><a href="#cb106-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-261"><a href="#cb106-261" aria-hidden="true" tabindex="-1"></a>Matching eliminiert die Variation von <span class="in">`male`</span> zwischen den Gruppen. Eine Möglichkeit hierfür ist die Gewichtung der Beobachtungen in der Kontrollgruppe entsprechend der Anteile von Männern und Nicht-Männern in der Behandlungsgruppe, sodass die Vergleichbarkeit mit der Behandlungsgruppe hinsichtlich des Geschlechts gewährleistet ist. Dies wird in der Literatur als *Balance* bezeichnet. Der Behandlungseffekt wird dann analog zu \eqref{eq:naivATEdarkmode} geschätzt.</span>
<span id="cb106-262"><a href="#cb106-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-263"><a href="#cb106-263" aria-hidden="true" tabindex="-1"></a>Die Gewichte für Beobachtungen in der Kontrollgruppe $w_i$ werden berechnet als \begin{align}</span>
<span id="cb106-264"><a href="#cb106-264" aria-hidden="true" tabindex="-1"></a>  w_i = </span>
<span id="cb106-265"><a href="#cb106-265" aria-hidden="true" tabindex="-1"></a>  \begin{cases}</span>
<span id="cb106-266"><a href="#cb106-266" aria-hidden="true" tabindex="-1"></a>    \text{ant<span class="sc">\_</span>m}_B/\text{anz\_m}_{K}, &amp; \text{falls } \text{male}_i = 1<span class="sc">\\</span></span>
<span id="cb106-267"><a href="#cb106-267" aria-hidden="true" tabindex="-1"></a>        \text{ant<span class="sc">\_</span>nm}_B/\text{anz\_nm}_{K}, &amp; \text{sonst.}<span class="sc">\\</span></span>
<span id="cb106-268"><a href="#cb106-268" aria-hidden="true" tabindex="-1"></a>  \end{cases}\label{eq:darkmodeweights}</span>
<span id="cb106-269"><a href="#cb106-269" aria-hidden="true" tabindex="-1"></a>\end{align} Anhand der Formel für einen gewichteten Durchschnitt, \begin{align}</span>
<span id="cb106-270"><a href="#cb106-270" aria-hidden="true" tabindex="-1"></a>  \overline{X}_w = \frac{\sum_i w_i \cdot X_i}{\sum_i w_i},</span>
<span id="cb106-271"><a href="#cb106-271" aria-hidden="true" tabindex="-1"></a>\end{align} berechnen wir die gewichteten Mittelwerte für <span class="in">`male`</span> und <span class="in">`read_time`</span> in der Kontrollgruppe.</span>
<span id="cb106-272"><a href="#cb106-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-275"><a href="#cb106-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-276"><a href="#cb106-276" aria-hidden="true" tabindex="-1"></a><span class="co"># Anteile und Anzahlen aus `anteile` auslesen</span></span>
<span id="cb106-277"><a href="#cb106-277" aria-hidden="true" tabindex="-1"></a>anz_m_K <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb106-278"><a href="#cb106-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(anz_m)</span>
<span id="cb106-279"><a href="#cb106-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-280"><a href="#cb106-280" aria-hidden="true" tabindex="-1"></a>anz_nm_K <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb106-281"><a href="#cb106-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(anz_nm)</span>
<span id="cb106-282"><a href="#cb106-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-283"><a href="#cb106-283" aria-hidden="true" tabindex="-1"></a>ant_m_B <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb106-284"><a href="#cb106-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ant_m)</span>
<span id="cb106-285"><a href="#cb106-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-286"><a href="#cb106-286" aria-hidden="true" tabindex="-1"></a>ant_nm_B <span class="ot">&lt;-</span> anteile <span class="sc">%&gt;%</span> </span>
<span id="cb106-287"><a href="#cb106-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ant_nm)</span>
<span id="cb106-288"><a href="#cb106-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-289"><a href="#cb106-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-292"><a href="#cb106-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-293"><a href="#cb106-293" aria-hidden="true" tabindex="-1"></a><span class="co"># Gewichtete Mittel für Kontrollgruppe berechnen</span></span>
<span id="cb106-294"><a href="#cb106-294" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-295"><a href="#cb106-295" aria-hidden="true" tabindex="-1"></a>gew_K <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-296"><a href="#cb106-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-297"><a href="#cb106-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(read_time, male) <span class="sc">%&gt;%</span></span>
<span id="cb106-298"><a href="#cb106-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> <span class="fu">ifelse</span>(</span>
<span id="cb106-299"><a href="#cb106-299" aria-hidden="true" tabindex="-1"></a>    male <span class="sc">==</span> <span class="dv">1</span>, </span>
<span id="cb106-300"><a href="#cb106-300" aria-hidden="true" tabindex="-1"></a>    ant_m_B<span class="sc">/</span>anz_m_K, </span>
<span id="cb106-301"><a href="#cb106-301" aria-hidden="true" tabindex="-1"></a>    ant_nm_B<span class="sc">/</span>anz_nm_K)</span>
<span id="cb106-302"><a href="#cb106-302" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb106-303"><a href="#cb106-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb106-304"><a href="#cb106-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">male_k =</span> <span class="fu">sum</span>(male <span class="sc">*</span> w) <span class="sc">/</span> <span class="fu">sum</span>(w),</span>
<span id="cb106-305"><a href="#cb106-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_read_time_wK =</span> <span class="fu">sum</span>(read_time <span class="sc">*</span> w) <span class="sc">/</span> <span class="fu">sum</span>(w)</span>
<span id="cb106-306"><a href="#cb106-306" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-307"><a href="#cb106-307" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-308"><a href="#cb106-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-309"><a href="#cb106-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-310"><a href="#cb106-310" aria-hidden="true" tabindex="-1"></a>Ein Vergleich des gewichteten Mittelwertes von <span class="in">`male`</span> in der Kontrollgruppe mit dem Mittelwert in der Behandlungsgruppe (<span class="in">`male_k`</span>) zeigt, dass die Gewichte die Variation in <span class="in">`male`</span> zwischen beiden Gruppen eliminieren, sodass die Backdoor durch <span class="in">`male`</span> geschlossen ist. Mit <span class="in">`wmean_read_time_K`</span> haben wir einen entsprechend gewichteten Mittelwert der Verweildauer für die Kontrollgruppe berechnet. Wir schätzen den Behandlungseffekt nun als \begin{align}</span>
<span id="cb106-311"><a href="#cb106-311" aria-hidden="true" tabindex="-1"></a>  \widehat{\tau}^{\text{w}} = \overline{\text{read<span class="sc">\_</span>time}}_{B} - \overline{\text{read\_time}}_{w,K}.\label{eq:weightedATEdarkmode}</span>
<span id="cb106-312"><a href="#cb106-312" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb106-313"><a href="#cb106-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-316"><a href="#cb106-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-317"><a href="#cb106-317" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(read_time_mTG)  <span class="sc">-</span> gew_K<span class="sc">$</span>mean_read_time_wK</span>
<span id="cb106-318"><a href="#cb106-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-319"><a href="#cb106-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-320"><a href="#cb106-320" aria-hidden="true" tabindex="-1"></a>Entgegen der naiven Schätzung andhand von \eqref{eq:naivATEdarkmode} erhalten wir nach Matching für <span class="in">`male`</span> eine positive Schätzung des Behandlungseffekts von etwa $<span class="in">`r round(mean(read_time_mTG) - gew_K$mean_read_time_wK, 2)`</span>$.</span>
<span id="cb106-321"><a href="#cb106-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-322"><a href="#cb106-322" aria-hidden="true" tabindex="-1"></a>Die Schätzung des Behandlungseffekts anhand von \eqref{eq:weightedATEdarkmode} entspricht dem geschätzten Koeffizienten $\widehat{\beta}_1$ aus einer gewichteten KQ-Regression im Modell \begin{align*}</span>
<span id="cb106-323"><a href="#cb106-323" aria-hidden="true" tabindex="-1"></a>  \text{read<span class="sc">\_</span>time} = \beta_0 + \beta_1 \text{dark<span class="sc">\_</span>mode} + u,</span>
<span id="cb106-324"><a href="#cb106-324" aria-hidden="true" tabindex="-1"></a>\end{align*} </span>
<span id="cb106-325"><a href="#cb106-325" aria-hidden="true" tabindex="-1"></a>wobei die Beobachtungen der Kontrollgruppe wie in \eqref{eq:darkmodeweights} gewichtet werden und $w_i=1$ für Beobachtungen der Behandlungsgruppe ist. Wir überprüfen dies mit R.</span>
<span id="cb106-326"><a href="#cb106-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-329"><a href="#cb106-329" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-330"><a href="#cb106-330" aria-hidden="true" tabindex="-1"></a>darkmode_w <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-331"><a href="#cb106-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb106-332"><a href="#cb106-332" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> <span class="fu">case_when</span>(</span>
<span id="cb106-333"><a href="#cb106-333" aria-hidden="true" tabindex="-1"></a>      male <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> ant_m_B<span class="sc">/</span>anz_m_K,</span>
<span id="cb106-334"><a href="#cb106-334" aria-hidden="true" tabindex="-1"></a>      male <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> ant_nm_B<span class="sc">/</span>anz_nm_K,</span>
<span id="cb106-335"><a href="#cb106-335" aria-hidden="true" tabindex="-1"></a>      T <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb106-336"><a href="#cb106-336" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-337"><a href="#cb106-337" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb106-338"><a href="#cb106-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-339"><a href="#cb106-339" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(read_time <span class="sc">~</span> dark_mode, <span class="at">weights =</span> w, <span class="at">data =</span> darkmode_w) <span class="sc">%&gt;%</span></span>
<span id="cb106-340"><a href="#cb106-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb106-341"><a href="#cb106-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-342"><a href="#cb106-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-343"><a href="#cb106-343" aria-hidden="true" tabindex="-1"></a>Der geschätzte Koeffizient von <span class="in">`dark_mode`</span> entspricht $\widehat{\tau}^w$.</span>
<span id="cb106-344"><a href="#cb106-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-345"><a href="#cb106-345" aria-hidden="true" tabindex="-1"></a>Da <span class="in">`male`</span> eine binäre Variable ist, reduziert sich eine Beurteilung der Vergleichbarkeit der Verteilungen von <span class="in">`male`</span> in Behandlungs- und Kontrollgruppe auf einen simplen Vergleich des Männeranteils beider Gruppen. In der Praxis gibt es meist eine Vielzahl potentieller Backdoor-Variablen, die zudem kontinuierlich verteilt sind. Es scheint plausibel, dass das Alter der Nutzer sowohl die Akzeptanz des Design-Updates als auch die Lesezeit beeinflusst. Die bisherige Verweildauer ist mindestens eine plausible Determinante der Lesezeit.</span>
<span id="cb106-346"><a href="#cb106-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-347"><a href="#cb106-347" aria-hidden="true" tabindex="-1"></a>Der erweiterte DGP ist in Abbildung @fig-CDdarkmode dargestellt, wobei der zusätzliche Backdoor-Pfad durch <span class="in">`age`</span> ebenfalls mit roten Pfeilen gekennzeichnet sind.</span>
<span id="cb106-348"><a href="#cb106-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-351"><a href="#cb106-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{dot}</span></span>
<span id="cb106-352"><a href="#cb106-352" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-width: 4</span></span>
<span id="cb106-353"><a href="#cb106-353" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-height: 3</span></span>
<span id="cb106-354"><a href="#cb106-354" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-align: 'center'</span></span>
<span id="cb106-355"><a href="#cb106-355" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-cap: "Erweiterter DGP im Website-Design-Beispiel"</span></span>
<span id="cb106-356"><a href="#cb106-356" aria-hidden="true" tabindex="-1"></a><span class="in">//| label: "fig-CDdarkmode" </span></span>
<span id="cb106-357"><a href="#cb106-357" aria-hidden="true" tabindex="-1"></a><span class="in">digraph {</span></span>
<span id="cb106-358"><a href="#cb106-358" aria-hidden="true" tabindex="-1"></a><span class="in">  layout=neato</span></span>
<span id="cb106-359"><a href="#cb106-359" aria-hidden="true" tabindex="-1"></a><span class="in">  fontname="Helvetica,Arial,sans-serif"</span></span>
<span id="cb106-360"><a href="#cb106-360" aria-hidden="true" tabindex="-1"></a><span class="in">  node [fontname="Helvetica,Arial,sans-serif"]</span></span>
<span id="cb106-361"><a href="#cb106-361" aria-hidden="true" tabindex="-1"></a><span class="in">  edge [fontname="Helvetica,Arial,sans-serif"]</span></span>
<span id="cb106-362"><a href="#cb106-362" aria-hidden="true" tabindex="-1"></a><span class="in">  node [shape=none];</span></span>
<span id="cb106-363"><a href="#cb106-363" aria-hidden="true" tabindex="-1"></a><span class="in">  "read_time" [pos="4,0.5!"]</span></span>
<span id="cb106-364"><a href="#cb106-364" aria-hidden="true" tabindex="-1"></a><span class="in">  "dark_mode" [pos="0,0.5!"]</span></span>
<span id="cb106-365"><a href="#cb106-365" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" [pos="2,-1!"]</span></span>
<span id="cb106-366"><a href="#cb106-366" aria-hidden="true" tabindex="-1"></a><span class="in">  "age" [pos="2,2!"]</span></span>
<span id="cb106-367"><a href="#cb106-367" aria-hidden="true" tabindex="-1"></a><span class="in">  "hours" [pos="4,2!"]</span></span>
<span id="cb106-368"><a href="#cb106-368" aria-hidden="true" tabindex="-1"></a><span class="in">  "hours" -&gt; "read_time"</span></span>
<span id="cb106-369"><a href="#cb106-369" aria-hidden="true" tabindex="-1"></a><span class="in">  "age" -&gt; "dark_mode" [color="red"]</span></span>
<span id="cb106-370"><a href="#cb106-370" aria-hidden="true" tabindex="-1"></a><span class="in">  "age" -&gt; "read_time" [color="red"]</span></span>
<span id="cb106-371"><a href="#cb106-371" aria-hidden="true" tabindex="-1"></a><span class="in">  "dark_mode" -&gt; "read_time" [color="green"]</span></span>
<span id="cb106-372"><a href="#cb106-372" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" -&gt; "dark_mode" [color="red"]</span></span>
<span id="cb106-373"><a href="#cb106-373" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" -&gt; "read_time" [color="red"]</span></span>
<span id="cb106-374"><a href="#cb106-374" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-375"><a href="#cb106-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-376"><a href="#cb106-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-377"><a href="#cb106-377" aria-hidden="true" tabindex="-1"></a>Die Beurteilung der *Balance* von Kontrollgruppe und Behandlungsgruppe kann durch eine grafische Gegenüberstellung der empirischen Verteilungen der Kovariablen beider Gruppen erfolgen. Wir visualisieren die empirischen Verteilungen mit <span class="in">`ggplot2`</span>. Hierzu standardisieren wir <span class="in">`age`</span> und <span class="in">`hours`</span> zunächst mit <span class="in">`scale()`</span>.</span>
<span id="cb106-378"><a href="#cb106-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-381"><a href="#cb106-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-382"><a href="#cb106-382" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz für graphische Darstellung formatieren</span></span>
<span id="cb106-383"><a href="#cb106-383" aria-hidden="true" tabindex="-1"></a>darkmode_p <span class="ot">&lt;-</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-384"><a href="#cb106-384" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardisierung mit 'scale()'</span></span>
<span id="cb106-385"><a href="#cb106-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb106-386"><a href="#cb106-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">dark_mode =</span> <span class="fu">as_factor</span>(dark_mode),</span>
<span id="cb106-387"><a href="#cb106-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">scale</span>(age), </span>
<span id="cb106-388"><a href="#cb106-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours =</span> <span class="fu">scale</span>(hours)</span>
<span id="cb106-389"><a href="#cb106-389" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-390"><a href="#cb106-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-391"><a href="#cb106-391" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(darkmode_p)</span>
<span id="cb106-392"><a href="#cb106-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-393"><a href="#cb106-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-394"><a href="#cb106-394" aria-hidden="true" tabindex="-1"></a>Für <span class="in">`age`</span> und <span class="in">`hours`</span> eignen sich die geschätzten Dichtefunktionen für einen Vergleich der Verteilungen in Behandlungs- und Kontrollgruppe.</span>
<span id="cb106-395"><a href="#cb106-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-398"><a href="#cb106-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-399"><a href="#cb106-399" aria-hidden="true" tabindex="-1"></a><span class="co"># Vergleich mit Dichteschätzungen</span></span>
<span id="cb106-400"><a href="#cb106-400" aria-hidden="true" tabindex="-1"></a>darkmode_p <span class="sc">%&gt;%</span></span>
<span id="cb106-401"><a href="#cb106-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dark_mode, hours, age) <span class="sc">%&gt;%</span></span>
<span id="cb106-402"><a href="#cb106-402" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in langes Format überführen</span></span>
<span id="cb106-403"><a href="#cb106-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="sc">-</span>dark_mode)) <span class="sc">%&gt;%</span></span>
<span id="cb106-404"><a href="#cb106-404" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-405"><a href="#cb106-405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb106-406"><a href="#cb106-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> dark_mode)</span>
<span id="cb106-407"><a href="#cb106-407" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb106-408"><a href="#cb106-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> .<span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb106-409"><a href="#cb106-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb106-410"><a href="#cb106-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">facets =</span> <span class="sc">~</span> name, </span>
<span id="cb106-411"><a href="#cb106-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">"free"</span>, </span>
<span id="cb106-412"><a href="#cb106-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span></span>
<span id="cb106-413"><a href="#cb106-413" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-414"><a href="#cb106-414" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-415"><a href="#cb106-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-416"><a href="#cb106-416" aria-hidden="true" tabindex="-1"></a>Die graphische Analyse zeigt deutliche Unterschiede in den Verteilungen von <span class="in">`age`</span> zwischen Kontroll- und Behandlungsgruppe. Für einen Beurteilung mit deskriptiven Statistiken wird häufig eine sogenannte *Balance Table* herangezogen. Wir berechnen diese für <span class="in">`age`</span>, <span class="in">`hours`</span> und <span class="in">`male`</span> mit <span class="in">`cobalt::bal.tab()`</span></span>
<span id="cb106-417"><a href="#cb106-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-420"><a href="#cb106-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-421"><a href="#cb106-421" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb106-422"><a href="#cb106-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-423"><a href="#cb106-423" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance table mit 'cobalt::bal.tab()'</span></span>
<span id="cb106-424"><a href="#cb106-424" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(</span>
<span id="cb106-425"><a href="#cb106-425" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> darkmode <span class="sc">%&gt;%</span> </span>
<span id="cb106-426"><a href="#cb106-426" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(age, hours, male), </span>
<span id="cb106-427"><a href="#cb106-427" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat =</span> darkmode<span class="sc">$</span>dark_mode, </span>
<span id="cb106-428"><a href="#cb106-428" aria-hidden="true" tabindex="-1"></a>   <span class="co"># berechne SMD für KG und TG:</span></span>
<span id="cb106-429"><a href="#cb106-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">disp =</span> <span class="st">"m"</span>, </span>
<span id="cb106-430"><a href="#cb106-430" aria-hidden="true" tabindex="-1"></a>  <span class="at">s.d.denom =</span> <span class="st">"pooled"</span></span>
<span id="cb106-431"><a href="#cb106-431" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-432"><a href="#cb106-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-433"><a href="#cb106-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-434"><a href="#cb106-434" aria-hidden="true" tabindex="-1"></a>Die Einträge <span class="in">`M.0.Un`</span> und <span class="in">`M.1.Un`</span> zeigen die jeweiligen Stichprobenmittelwerte der Variablen für Kontroll- und Behandlungsgruppe. <span class="in">`Diff.Un`</span> gibt eine standardisierte Mittelwertdifferenz $SMD$ an, wobei \begin{align*}</span>
<span id="cb106-435"><a href="#cb106-435" aria-hidden="true" tabindex="-1"></a>  SMD_j := \left(\overline{X}_{j,B} - \overline{X}_{j,K}\right) \bigg/ \sqrt{\frac{1}{2}\left(\widehat{\text{Var}}(X_{j,B}) + \widehat{\text{Var}}(X_{j,K})\right)},</span>
<span id="cb106-436"><a href="#cb106-436" aria-hidden="true" tabindex="-1"></a>\end{align*} mit Stichprobenmitteln $\overline{X}_{j,B}$ und $\overline{X}_{j,K}$ und Stichprobenvarianzen $\widehat{\text{Var}}(X_{j,B})$ und $\widehat{\text{Var}}(X_{j,K})$ für eine kontinuierliche Kovariable $j$.<span class="ot">[^matching-1]</span> Obwohl es keinen einheitlichen Schwellenwert für die standardisierte Differenz gibt, der ein erhebliches Ungleichgewicht anzeigt, gilt für kontinuierliche Variablen eine standardisierte (absolute) Differenz von weniger als $0.1$ als Hinweis auf einen vernachlässigbaren Unterschied zwischen den Gruppen.</span>
<span id="cb106-437"><a href="#cb106-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-438"><a href="#cb106-438" aria-hidden="true" tabindex="-1"></a><span class="ot">[^matching-1]: </span>Siehe @Austin2011 für einen Überblick zu Balance-Statistiken.</span>
<span id="cb106-439"><a href="#cb106-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-440"><a href="#cb106-440" aria-hidden="true" tabindex="-1"></a>Die Balance Table weist also auf einen vernachlässigbaren Unterschied für <span class="in">`hours`</span> hin und bestätigt den aus den Grafiken abgeleiteten Eindruck einer relevanten Differenzen für <span class="in">`age`</span>.</span>
<span id="cb106-441"><a href="#cb106-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-442"><a href="#cb106-442" aria-hidden="true" tabindex="-1"></a><span class="fu">### Entropy Balancing</span></span>
<span id="cb106-443"><a href="#cb106-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-444"><a href="#cb106-444" aria-hidden="true" tabindex="-1"></a>*Entropy Balancing* <span class="co">[</span><span class="ot">@Hainmueller2012</span><span class="co">]</span> ist eine weitere Methode zur Gewährleistung der Vergleichbarkeit von Behandlungs- und Kontrollgruppe anhand von Gewichten. Das Verfahren nutzt Konzepte aus der <span class="co">[</span><span class="ot">Informationstheorie</span><span class="co">](https://de.wikipedia.org/wiki/Informationstheorie)</span> um die Gewichte für Subjekte in der Kontrollgruppe so anzupassen, dass die Verteilung der Matchingvariablen in der Kontrollgruppe die Verteilung in der Behandlungsgruppe möglichst gut approximiert. Dies geschieht unter der Restriktion, dass bestimmte empirische Momente (meist Mittelwerte und Varianzen) der Matchingvariablen exakt übereinstimmen. Mathematisch werden die Gewichte für Kontrollgruppenbeobachtungen durch Minimierung der <span class="co">[</span><span class="ot">Kullback-Leibler-Divergenz</span><span class="co">](https://de.wikipedia.org/wiki/Kullback-Leibler-Divergenz)</span> zwischen den Verteilungen gefunden, wobei die Divergenz ein Maß für den Unterschied von Wahrscheinlichkeitsverteilungen ist.</span>
<span id="cb106-445"><a href="#cb106-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-446"><a href="#cb106-446" aria-hidden="true" tabindex="-1"></a>Entropy Balancing ist im R-Paket <span class="in">`WeightIt`</span> implementiert. Wir zeigen, wie die benötigten Gewichte für eine Schätzungen des ATT im Website-Beispiel mit <span class="in">`WeightIt::wightit()`</span> bestimmt werden können. Über das Argument <span class="in">`moments`</span> legen wir fest, dass die Gewichte unter der Restriktion übereinstimmender Mittelwerte aller Matching-Variablen zwischen Behandlungs- und Kontrollgruppe erfolgen soll. </span>
<span id="cb106-447"><a href="#cb106-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-450"><a href="#cb106-450" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-451"><a href="#cb106-451" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb106-452"><a href="#cb106-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-453"><a href="#cb106-453" aria-hidden="true" tabindex="-1"></a><span class="co"># Gewichte für Entropy Balancing</span></span>
<span id="cb106-454"><a href="#cb106-454" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-455"><a href="#cb106-455" aria-hidden="true" tabindex="-1"></a>  W1 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(</span>
<span id="cb106-456"><a href="#cb106-456" aria-hidden="true" tabindex="-1"></a>  dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours,</span>
<span id="cb106-457"><a href="#cb106-457" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode,</span>
<span id="cb106-458"><a href="#cb106-458" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb106-459"><a href="#cb106-459" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb106-460"><a href="#cb106-460" aria-hidden="true" tabindex="-1"></a>  <span class="at">moments =</span> <span class="dv">1</span></span>
<span id="cb106-461"><a href="#cb106-461" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-462"><a href="#cb106-462" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb106-463"><a href="#cb106-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-464"><a href="#cb106-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-465"><a href="#cb106-465" aria-hidden="true" tabindex="-1"></a>Wir schätzen den Behandlungseffekt nach Entropy Balancing mit gewichteter Regression.</span>
<span id="cb106-466"><a href="#cb106-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-469"><a href="#cb106-469" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-470"><a href="#cb106-470" aria-hidden="true" tabindex="-1"></a><span class="co"># Mittelwert-Vergleich mit lm()</span></span>
<span id="cb106-471"><a href="#cb106-471" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb106-472"><a href="#cb106-472" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> dark_mode, </span>
<span id="cb106-473"><a href="#cb106-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb106-474"><a href="#cb106-474" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> W1<span class="sc">$</span>weights</span>
<span id="cb106-475"><a href="#cb106-475" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-476"><a href="#cb106-476" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span>
<span id="cb106-477"><a href="#cb106-477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-478"><a href="#cb106-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-479"><a href="#cb106-479" aria-hidden="true" tabindex="-1"></a>Beachte, dass die von <span class="in">`summary()`</span> berechneten Standardfehler bei Entropy Balancing ungültig sind. In Abschnitt @sec-bootmatching erläutern wir die Berechnung von Standardfehlern für Matching-Schätzer mit dem Bootstrap.</span>
<span id="cb106-480"><a href="#cb106-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-481"><a href="#cb106-481" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mehrere Matching-Variablen und der Propensity Score {#sec-PSM}</span></span>
<span id="cb106-482"><a href="#cb106-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-483"><a href="#cb106-483" aria-hidden="true" tabindex="-1"></a>Bei mehreren Backdoor-Variablen kann eine Gewichtung anhand der Behandlungswahrscheinlichkeit (*Treatment Propensity*) erfolgen. Die Idee hierbei ist, dass der DGP wie in @fig-propCDdarkmode dargestellt werden kann.</span>
<span id="cb106-484"><a href="#cb106-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-487"><a href="#cb106-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{dot}</span></span>
<span id="cb106-488"><a href="#cb106-488" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-width: 4</span></span>
<span id="cb106-489"><a href="#cb106-489" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-height: 3</span></span>
<span id="cb106-490"><a href="#cb106-490" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-align: 'center'</span></span>
<span id="cb106-491"><a href="#cb106-491" aria-hidden="true" tabindex="-1"></a><span class="in">//| fig-cap: "Propensity im Website-Design-Beispiel"</span></span>
<span id="cb106-492"><a href="#cb106-492" aria-hidden="true" tabindex="-1"></a><span class="in">//| label: "fig-propCDdarkmode" </span></span>
<span id="cb106-493"><a href="#cb106-493" aria-hidden="true" tabindex="-1"></a><span class="in">digraph {</span></span>
<span id="cb106-494"><a href="#cb106-494" aria-hidden="true" tabindex="-1"></a><span class="in">  layout=neato</span></span>
<span id="cb106-495"><a href="#cb106-495" aria-hidden="true" tabindex="-1"></a><span class="in">  fontname="Helvetica,Arial,sans-serif"</span></span>
<span id="cb106-496"><a href="#cb106-496" aria-hidden="true" tabindex="-1"></a><span class="in">  node [fontname="Helvetica,Arial,sans-serif"]</span></span>
<span id="cb106-497"><a href="#cb106-497" aria-hidden="true" tabindex="-1"></a><span class="in">  edge [fontname="Helvetica,Arial,sans-serif"]</span></span>
<span id="cb106-498"><a href="#cb106-498" aria-hidden="true" tabindex="-1"></a><span class="in">  node [shape=none];</span></span>
<span id="cb106-499"><a href="#cb106-499" aria-hidden="true" tabindex="-1"></a><span class="in">  "read_time" [pos="4,0.5!"]</span></span>
<span id="cb106-500"><a href="#cb106-500" aria-hidden="true" tabindex="-1"></a><span class="in">  "dark_mode" [pos="0,0.5!"]</span></span>
<span id="cb106-501"><a href="#cb106-501" aria-hidden="true" tabindex="-1"></a><span class="in">  "TreatmentPropensity" [pos="0,2!"]</span></span>
<span id="cb106-502"><a href="#cb106-502" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" [pos="2,-1!"]</span></span>
<span id="cb106-503"><a href="#cb106-503" aria-hidden="true" tabindex="-1"></a><span class="in">  "age" [pos="2,2!"]</span></span>
<span id="cb106-504"><a href="#cb106-504" aria-hidden="true" tabindex="-1"></a><span class="in">  "hours" [pos="4,2!"]</span></span>
<span id="cb106-505"><a href="#cb106-505" aria-hidden="true" tabindex="-1"></a><span class="in">  "hours" -&gt; "read_time"</span></span>
<span id="cb106-506"><a href="#cb106-506" aria-hidden="true" tabindex="-1"></a><span class="in">  "age" -&gt; "TreatmentPropensity" [color="red"]</span></span>
<span id="cb106-507"><a href="#cb106-507" aria-hidden="true" tabindex="-1"></a><span class="in">  "age" -&gt; "read_time" [color="red"]</span></span>
<span id="cb106-508"><a href="#cb106-508" aria-hidden="true" tabindex="-1"></a><span class="in">  "dark_mode" -&gt; "read_time" [color="green"]</span></span>
<span id="cb106-509"><a href="#cb106-509" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" -&gt; "TreatmentPropensity" [color="red"]</span></span>
<span id="cb106-510"><a href="#cb106-510" aria-hidden="true" tabindex="-1"></a><span class="in">  "male" -&gt; "read_time" [color="red"]</span></span>
<span id="cb106-511"><a href="#cb106-511" aria-hidden="true" tabindex="-1"></a><span class="in">  "TreatmentPropensity" -&gt; "dark_mode" [color="red"]</span></span>
<span id="cb106-512"><a href="#cb106-512" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb106-513"><a href="#cb106-513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-514"><a href="#cb106-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-515"><a href="#cb106-515" aria-hidden="true" tabindex="-1"></a>Hierbei beeinflussen die Backdoor-Variablen *age* und *male* die Behandlungsvariable *dark_mode* lediglich durch die Behandlungswahrscheinlichkeit *Treatment Propensity*. Diese Darstellung zeigt, das die mehrdimensionale Information bzgl. der Ähnlichkeit von Subjekten hinsichtlich der beobachteten Kovariablen in einer einzigen Variable zusammengefasst werden kann. Die Backdoor-Pfade können daher geschlossen werden, indem wir Subjekte anhand von *Treatment Propensity* derart gewichten, dass beide Gruppen hinsichtlich der Verteilung der Behandlungswahrscheinlichkeit vergleichbar sind. Betrachte erneut \eqref{eq:cia} und beachte, dass \begin{align}</span>
<span id="cb106-516"><a href="#cb106-516" aria-hidden="true" tabindex="-1"></a>  Y_i = Y_i^{(1)} D_i + Y_i^{(0)} (1-D_i).</span>
<span id="cb106-517"><a href="#cb106-517" aria-hidden="true" tabindex="-1"></a>\end{align} @RosenbaumRubin1983 zeigen, dass es hinsichtlich \eqref{eq:cia} äquivalent ist für die *Treatment Propensity* $P_i(X_i):=P(B_i=1\vert X_i = x)$ zu kontrollieren, d.h. \begin{align}</span>
<span id="cb106-518"><a href="#cb106-518" aria-hidden="true" tabindex="-1"></a>  \left<span class="sc">\{</span>Y_i^{(1)},Y_i^{(0)}\right<span class="sc">\}</span> \perp B_i\vert X_i \quad\Leftrightarrow\quad \left<span class="sc">\{</span>Y_i^{(1)},Y_i^{(0)}\right<span class="sc">\}</span> \perp B_i\vert P_i(X_i).</span>
<span id="cb106-519"><a href="#cb106-519" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb106-520"><a href="#cb106-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-521"><a href="#cb106-521" aria-hidden="true" tabindex="-1"></a>Der Behandlungseffekt kann so als Differenz von gewichteten Gruppenmittelwerten berechnet werden, mit inversem Wahrscheinlichkeitsgewicht (IPW) $w_{i,B} = 1/P_i(X_i)$ für Beobachtungen in der Behandlungsgruppe und $w_{i,K} = 1/(1-P_i(X_i))$ für Beobachtungen in der Kontrollgruppe, \begin{align}</span>
<span id="cb106-522"><a href="#cb106-522" aria-hidden="true" tabindex="-1"></a>  \tau^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left<span class="co">[</span><span class="ot">\frac{B_i Y_i}{P_i(X_i)} - \frac{(1-B_i)Y_i}{1-P_i(X_i)} \right</span><span class="co">]</span>.\label{eq:tauipw}</span>
<span id="cb106-523"><a href="#cb106-523" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb106-524"><a href="#cb106-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-525"><a href="#cb106-525" aria-hidden="true" tabindex="-1"></a>Grundsätzlich ist *TreatmentPropensity* eine nicht beobachtbare Variable und muss daher aus den Daten geschätzt werden. Eine geschätzte Behandlungswahrscheinlichkeiten $\widehat{P}_i(X_i)$ wird als *Propensity Score* bezeichnet. In der Praxis erfolgt die Schätzung von *Propensity Scores* meist mit logistischer Regression. Ein erwartungstreuer Schätzer des ATE ist \begin{align}</span>
<span id="cb106-526"><a href="#cb106-526" aria-hidden="true" tabindex="-1"></a>  \widehat{\tau}^{\text{IPW}} = \frac{1}{n}\sum_{i=1}^n \left<span class="co">[</span><span class="ot">\frac{B_i Y_i}{\widehat{P}_i(X_i)} - \frac{(1-B_i)Y_i}{1-\widehat{P}_i(X_i)} \right</span><span class="co">]</span>.\label{eq:hattauipw}</span>
<span id="cb106-527"><a href="#cb106-527" aria-hidden="true" tabindex="-1"></a>\end{align} @Hiranoetal2003 diskutieren Alternativen zu \eqref{eq:hattauipw} für die Schätzung anderer Typen von Behandlungseffekten.</span>
<span id="cb106-528"><a href="#cb106-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-529"><a href="#cb106-529" aria-hidden="true" tabindex="-1"></a>Wir schätzen nachfolgend die *Propensity Scores* für unser Anwendungsbeispiel, erläutern die Berechnung der Gewichte sowie die Schätzung von Behandlungseffekten mit gewichteter Regression. Hierbei betrachten wir eine Variante von \eqref{eq:hattauipw} mit normalisierten Gewichten $\tilde{w}_{i,B} = w_{i,B}/\sum_i w_{i,B}$ und $\tilde{w}_{i,K} = w_{i,K}/\sum_i w_{i,K}$ die sich jeweils zu 1 summieren.<span class="ot">[^matching-2]</span> Dies ergibt den Hájek-Schätzer<span class="ot">[^matching-3]</span> \begin{align}</span>
<span id="cb106-530"><a href="#cb106-530" aria-hidden="true" tabindex="-1"></a>    \widehat{\tau}_N^{\text{IPW}} = \frac{\sum_i\tilde{w}_{i,B}Y_i}{\sum_i\tilde{w}_{i,B}} -  \frac{\sum_i\tilde{w}_{i,K}Y_i}{\sum_i\tilde{w}_{i,K}}.\label{eq:hattauhajek}</span>
<span id="cb106-531"><a href="#cb106-531" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb106-532"><a href="#cb106-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-533"><a href="#cb106-533" aria-hidden="true" tabindex="-1"></a><span class="ot">[^matching-2]: </span>Eine Normalisierung der Gewichte reduziert die Varianz des Schätzers, vgl. @Hiranoetal2003</span>
<span id="cb106-534"><a href="#cb106-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-535"><a href="#cb106-535" aria-hidden="true" tabindex="-1"></a><span class="ot">[^matching-3]: </span>Siehe @Hajek1971.</span>
<span id="cb106-536"><a href="#cb106-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-537"><a href="#cb106-537" aria-hidden="true" tabindex="-1"></a>Zunächst Schätzen wir ein logistisches Regressionsmodell mit <span class="in">`age`</span>, <span class="in">`male`</span> und <span class="in">`hours`</span> als erklärende Variablen für <span class="in">`dark_mode`</span>.</span>
<span id="cb106-538"><a href="#cb106-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-541"><a href="#cb106-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-542"><a href="#cb106-542" aria-hidden="true" tabindex="-1"></a><span class="co"># Logit-Modell mit 'glm()' schätzen</span></span>
<span id="cb106-543"><a href="#cb106-543" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-544"><a href="#cb106-544" aria-hidden="true" tabindex="-1"></a>  darkmode_ps_logit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb106-545"><a href="#cb106-545" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours,</span>
<span id="cb106-546"><a href="#cb106-546" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> darkmode,</span>
<span id="cb106-547"><a href="#cb106-547" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial</span>
<span id="cb106-548"><a href="#cb106-548" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-549"><a href="#cb106-549" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-550"><a href="#cb106-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-551"><a href="#cb106-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-552"><a href="#cb106-552" aria-hidden="true" tabindex="-1"></a>Die *Propensity Scores* erhalten wir als angepasste Werte aus der Regression <span class="in">`darkmode_ps_logit`</span> mit <span class="in">`fitted()`</span>. Wir erweitern den Datensatz mit den Ergebnissen.</span>
<span id="cb106-553"><a href="#cb106-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-556"><a href="#cb106-556" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-557"><a href="#cb106-557" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz um Propensity Scores erweitern</span></span>
<span id="cb106-558"><a href="#cb106-558" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-559"><a href="#cb106-559" aria-hidden="true" tabindex="-1"></a>  darkmode_probs <span class="ot">&lt;-</span> </span>
<span id="cb106-560"><a href="#cb106-560" aria-hidden="true" tabindex="-1"></a>    darkmode <span class="sc">%&gt;%</span></span>
<span id="cb106-561"><a href="#cb106-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb106-562"><a href="#cb106-562" aria-hidden="true" tabindex="-1"></a>      <span class="at">PS =</span> <span class="fu">fitted</span>(darkmode_ps_logit)</span>
<span id="cb106-563"><a href="#cb106-563" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-564"><a href="#cb106-564" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-565"><a href="#cb106-565" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-566"><a href="#cb106-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-567"><a href="#cb106-567" aria-hidden="true" tabindex="-1"></a>Zur Beurteilung der Überlappung (vgl. Annahme \eqref{eq:overlap} können wir die Verteilung der *Propensity Scores* nach Behandlungs-Indikator mit Histogrammen visualisieren.</span>
<span id="cb106-568"><a href="#cb106-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-571"><a href="#cb106-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-572"><a href="#cb106-572" aria-hidden="true" tabindex="-1"></a><span class="co"># Überlappung prüfen:</span></span>
<span id="cb106-573"><a href="#cb106-573" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogramme der PS nach Treatment-Indikator</span></span>
<span id="cb106-574"><a href="#cb106-574" aria-hidden="true" tabindex="-1"></a>darkmode_probs <span class="sc">%&gt;%</span></span>
<span id="cb106-575"><a href="#cb106-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb106-576"><a href="#cb106-576" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb106-577"><a href="#cb106-577" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> PS, </span>
<span id="cb106-578"><a href="#cb106-578" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="fu">factor</span>(dark_mode)</span>
<span id="cb106-579"><a href="#cb106-579" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-580"><a href="#cb106-580" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb106-581"><a href="#cb106-581" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb106-582"><a href="#cb106-582" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>, </span>
<span id="cb106-583"><a href="#cb106-583" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">25</span>, </span>
<span id="cb106-584"><a href="#cb106-584" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span></span>
<span id="cb106-585"><a href="#cb106-585" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-586"><a href="#cb106-586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-587"><a href="#cb106-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-588"><a href="#cb106-588" aria-hidden="true" tabindex="-1"></a>Ein Vergleich der Histogramme zeigt, dass die Überlappung der *Propensity Scores* in der linken Flanken der Verteilungen der Kontrollgruppe und in der rechten Flanke der Behandlungsgruppe schlechter wird. Wir entfernen zunächst Beobachtungen aus der Stichprobe deren *Propensity Scores* wenig bzw. keine Überlappung aufweisen.</span>
<span id="cb106-589"><a href="#cb106-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-592"><a href="#cb106-592" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-593"><a href="#cb106-593" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz nach PS trimmen</span></span>
<span id="cb106-594"><a href="#cb106-594" aria-hidden="true" tabindex="-1"></a>darkmode_probs <span class="ot">&lt;-</span> darkmode_probs <span class="sc">%&gt;%</span> </span>
<span id="cb106-595"><a href="#cb106-595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb106-596"><a href="#cb106-596" aria-hidden="true" tabindex="-1"></a>    <span class="fu">between</span>(</span>
<span id="cb106-597"><a href="#cb106-597" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> PS,</span>
<span id="cb106-598"><a href="#cb106-598" aria-hidden="true" tabindex="-1"></a>      <span class="at">left =</span> .<span class="dv">25</span>,</span>
<span id="cb106-599"><a href="#cb106-599" aria-hidden="true" tabindex="-1"></a>      <span class="at">right =</span> .<span class="dv">75</span></span>
<span id="cb106-600"><a href="#cb106-600" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-601"><a href="#cb106-601" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-602"><a href="#cb106-602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-603"><a href="#cb106-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-606"><a href="#cb106-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-607"><a href="#cb106-607" aria-hidden="true" tabindex="-1"></a><span class="co"># Überlappung nach trimming prüfen:</span></span>
<span id="cb106-608"><a href="#cb106-608" aria-hidden="true" tabindex="-1"></a><span class="co"># Dichteschätzung der PS nach Treatment-Indikator</span></span>
<span id="cb106-609"><a href="#cb106-609" aria-hidden="true" tabindex="-1"></a>darkmode_probs <span class="sc">%&gt;%</span></span>
<span id="cb106-610"><a href="#cb106-610" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb106-611"><a href="#cb106-611" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb106-612"><a href="#cb106-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> PS, </span>
<span id="cb106-613"><a href="#cb106-613" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">factor</span>(dark_mode))</span>
<span id="cb106-614"><a href="#cb106-614" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb106-615"><a href="#cb106-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb106-616"><a href="#cb106-616" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>, </span>
<span id="cb106-617"><a href="#cb106-617" aria-hidden="true" tabindex="-1"></a>    <span class="at">bins =</span> <span class="dv">25</span>, </span>
<span id="cb106-618"><a href="#cb106-618" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"identity"</span></span>
<span id="cb106-619"><a href="#cb106-619" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-620"><a href="#cb106-620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-621"><a href="#cb106-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-622"><a href="#cb106-622" aria-hidden="true" tabindex="-1"></a>IPWs anhand der *Propensity Scores* können schnell mit der Vorschrift \begin{align}</span>
<span id="cb106-623"><a href="#cb106-623" aria-hidden="true" tabindex="-1"></a>  \text{IPW} = \frac{\text{dark<span class="sc">\_</span>mode}}{\text{PS}} + \frac{1 - \text{dark<span class="sc">\_</span>mode}}{1 - \text{PS}},</span>
<span id="cb106-624"><a href="#cb106-624" aria-hidden="true" tabindex="-1"></a>\end{align} berechnet werden.</span>
<span id="cb106-625"><a href="#cb106-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-628"><a href="#cb106-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-629"><a href="#cb106-629" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz um IPWs erweitern</span></span>
<span id="cb106-630"><a href="#cb106-630" aria-hidden="true" tabindex="-1"></a>darkmode_IPW <span class="ot">&lt;-</span> darkmode_probs <span class="sc">%&gt;%</span></span>
<span id="cb106-631"><a href="#cb106-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb106-632"><a href="#cb106-632" aria-hidden="true" tabindex="-1"></a>    <span class="at">IPW =</span> dark_mode <span class="sc">/</span> PS <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> dark_mode) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> PS)</span>
<span id="cb106-633"><a href="#cb106-633" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-634"><a href="#cb106-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-635"><a href="#cb106-635" aria-hidden="true" tabindex="-1"></a>darkmode_IPW <span class="sc">%&gt;%</span> </span>
<span id="cb106-636"><a href="#cb106-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(IPW)</span>
<span id="cb106-637"><a href="#cb106-637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-638"><a href="#cb106-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-639"><a href="#cb106-639" aria-hidden="true" tabindex="-1"></a>Eine Schätzung des durchschnittlichen Behandlungseffekts gemäß \eqref{eq:hattauhajek} implementieren wir mit <span class="in">`dplyr`</span>.</span>
<span id="cb106-640"><a href="#cb106-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-643"><a href="#cb106-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-644"><a href="#cb106-644" aria-hidden="true" tabindex="-1"></a>darkmode_IPW <span class="sc">%&gt;%</span></span>
<span id="cb106-645"><a href="#cb106-645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span></span>
<span id="cb106-646"><a href="#cb106-646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> IPW <span class="sc">/</span> <span class="fu">sum</span>(IPW)) <span class="sc">%&gt;%</span></span>
<span id="cb106-647"><a href="#cb106-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">weighted_mean =</span> <span class="fu">sum</span>(read_time <span class="sc">*</span> w)) <span class="sc">%&gt;%</span></span>
<span id="cb106-648"><a href="#cb106-648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">diff =</span> <span class="fu">diff</span>(weighted_mean))</span>
<span id="cb106-649"><a href="#cb106-649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-650"><a href="#cb106-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-651"><a href="#cb106-651" aria-hidden="true" tabindex="-1"></a>Diese Schätzung des Behandlungseffekts ist äquivalent zur gewichteten KQ-Schätzung anhand eines einfachen linearen Regressionsmodells.</span>
<span id="cb106-652"><a href="#cb106-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-655"><a href="#cb106-655" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-656"><a href="#cb106-656" aria-hidden="true" tabindex="-1"></a><span class="co"># Mit IPWs gewichteter KQ-Schaetzer berechnet den ATE</span></span>
<span id="cb106-657"><a href="#cb106-657" aria-hidden="true" tabindex="-1"></a>model_ipw <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb106-658"><a href="#cb106-658" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> dark_mode, </span>
<span id="cb106-659"><a href="#cb106-659" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode_IPW,</span>
<span id="cb106-660"><a href="#cb106-660" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> IPW</span>
<span id="cb106-661"><a href="#cb106-661" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-662"><a href="#cb106-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-663"><a href="#cb106-663" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_ipw)</span>
<span id="cb106-664"><a href="#cb106-664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-665"><a href="#cb106-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-666"><a href="#cb106-666" aria-hidden="true" tabindex="-1"></a>Unsere Schätzung des ATE ist der geschätzte Koeffizient von <span class="in">`dark_mode`</span>. Die ausgegebenen Standardfehler und Inferenzstatistiken sind jedoch *ungültig* aufgrund der Gewichtung mit IPWs, den inversen *geschätzten* Wahrscheinlichkeiten für eine Behandlung. Der Grund hierfür ist, dass die Berechnung der Standardfehler in `summary()` die zusätzliche Unsicherheit durch die geschätzen *Propensity Scores* nicht berücksichtigt! Später im Kapitel erläutern wir die Berechnung gültiger Standardfehler für IPW-Schätzer basierend auf *Propensity Scores* mit dem Bootstrap.</span>
<span id="cb106-667"><a href="#cb106-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-668"><a href="#cb106-668" aria-hidden="true" tabindex="-1"></a><span class="fu">## Selektierende Matching-Verfahren</span></span>
<span id="cb106-669"><a href="#cb106-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-670"><a href="#cb106-670" aria-hidden="true" tabindex="-1"></a>Das grundsätzliche Konzept von selektierendem Matching wird in der nachstehenden interaktiven Grafik veranschaulicht. Hier betrachten wir beobachtete Ausprägungen von zwei (unabhängig und identisch verteilten) Matching-Variablen für Subjekte in der Behandlungsgruppe (blau) sowie Kontrollgruppe (rot). Als Matches qualifizieren sich sämtliche Beobachtungen der anderen Gruppe, deren <span class="co">[</span><span class="ot">Euklidische Distanz</span><span class="co">](https://de.wikipedia.org/wiki/Euklidischer_Abstand)</span> zu dem ausgewählten Punkt das über den Slider eingestellte Maximum *Caliper* nicht überschreitet.^<span class="co">[</span><span class="ot">Es handelt sich hierbei um einen Spezialfall von Matching anhand der Mahalanobis-Distanz.</span><span class="co">]</span> Diese Region wird durch den gestrichelten Kreis gekennzeichnet und kann über den zugehörigen Slider angepasst werden. Per Klick auf eine Beobachtung werden Matches aus der anderen Gruppe durch eine verbindende Linie und farbliches Hervorheben kenntlich gemacht. Mit dem Slider für k wird festgelegt, dass nur die nahesten k qualifizierten Beobachtungen als Matches behandelt werden. Die Grafik illustriert inbesondere, dass Beobachtungen in Abhängigkeit von k und Caliper falls gewünscht mehrfach (s.g. Matching mit Zurücklegen) oder gar nicht gematcht werden können.</span>
<span id="cb106-671"><a href="#cb106-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-672"><a href="#cb106-672" aria-hidden="true" tabindex="-1"></a>&lt;iframe width="100%" height="678" frameborder="0"</span>
<span id="cb106-673"><a href="#cb106-673" aria-hidden="true" tabindex="-1"></a>  src="https://observablehq.com/embed/62067a02a72c9f90@464?cells=theplot%2Cviewof+k%2Cviewof+caliper%2Cstyles"&gt;&lt;/iframe&gt;</span>
<span id="cb106-674"><a href="#cb106-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-675"><a href="#cb106-675" aria-hidden="true" tabindex="-1"></a>Für die nachfolgenden Code-Beispiele verwenden wir das R-Paket <span class="in">`MatchIt`</span>. <span class="in">`MatchIt::matchit()`</span> nutzt standardmäßig Eins-zu-Eins-Matching (ohne Zurücklegen) von Beobachtungen der Treatment-Gruppe mit Beobachtungen der Kontrollgruppe.^<span class="co">[</span><span class="ot">Dieses Schema zielt auf eine Schätzung des ATT ab.</span><span class="co">]</span> Die für das Matching zu verwendenden Variablen werden über das Argument <span class="in">`formula`</span> als Funktion des Behandlungsindikators definiert. <span class="in">`matchit()`</span> bereitet das Objekt für eine Schätzung des ATT mit einer geeigneten Funktionen, s. <span class="in">`?matchit`</span> und hier insb. die Erläuterungen der Argumente <span class="in">`replace = F`</span>, <span class="in">`ratio = 1`</span> und <span class="in">`estimand = "ATT"`</span> für Details. Mit <span class="in">`cobalt::balt.tab()`</span> erhalten wir eine *balance table* für den gematchten Datensatz.</span>
<span id="cb106-676"><a href="#cb106-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-677"><a href="#cb106-677" aria-hidden="true" tabindex="-1"></a>Wir zeigen als nächstes, wie <span class="in">`MatchIt::matchit()`</span> für Matching anhand der Regressoren <span class="in">`age`</span>, <span class="in">`hours`</span>, und <span class="in">`male`</span> in unserem Website-Beispiel für unterschiedliche Varianten durchgeführt werden kann.</span>
<span id="cb106-678"><a href="#cb106-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-679"><a href="#cb106-679" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exaktes Matching </span></span>
<span id="cb106-680"><a href="#cb106-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-681"><a href="#cb106-681" aria-hidden="true" tabindex="-1"></a>Exaktes Matching ordnet einem Subjekt aus der Behandlungsgruppe ein oder mehrere Subjekte aus der Kontrollgruppe zu, wenn die boebachteten Ausprägung der Matching-Variablen *exakt* übereinstimmen. Hierbei muss die 'Distanz' zwischen den Ausprägung der Matching-Variablen folglich $0$ sein. Dieses Verfahren findet meist bei ausschließlich diskret verteilten Merkmalen Anwendung. Bei kontinuierlich verteilten Merkmalen (vgl. die obige interaktive Grafik) sind exakte Matches zwar theoretisch unmöglich, ergeben sich jedoch in der Praxis aus der Datenerfassung, bspw. durch Rundungsfehler. In <span class="in">`matchit()`</span> erhalten wir exaktes Ein-zu-eins-Matching mit <span class="in">`method = "exact"`</span>.</span>
<span id="cb106-682"><a href="#cb106-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-683"><a href="#cb106-683" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, error=TRUE}</span></span>
<span id="cb106-684"><a href="#cb106-684" aria-hidden="true" tabindex="-1"></a><span class="in">library(MatchIt)</span></span>
<span id="cb106-685"><a href="#cb106-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-686"><a href="#cb106-686" aria-hidden="true" tabindex="-1"></a><span class="in"># Exaktes Eins-zu-Eins-Matching durchführen</span></span>
<span id="cb106-687"><a href="#cb106-687" aria-hidden="true" tabindex="-1"></a><span class="in">res_em &lt;- matchit(</span></span>
<span id="cb106-688"><a href="#cb106-688" aria-hidden="true" tabindex="-1"></a><span class="in">  formula = dark_mode ~ age + male + hours, </span></span>
<span id="cb106-689"><a href="#cb106-689" aria-hidden="true" tabindex="-1"></a><span class="in">  data = darkmode,</span></span>
<span id="cb106-690"><a href="#cb106-690" aria-hidden="true" tabindex="-1"></a><span class="in">  estimand = "ATT",</span></span>
<span id="cb106-691"><a href="#cb106-691" aria-hidden="true" tabindex="-1"></a><span class="in">  method = "exact"</span></span>
<span id="cb106-692"><a href="#cb106-692" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-693"><a href="#cb106-693" aria-hidden="true" tabindex="-1"></a><span class="in">res_em</span></span>
<span id="cb106-694"><a href="#cb106-694" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-695"><a href="#cb106-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-696"><a href="#cb106-696" aria-hidden="true" tabindex="-1"></a>Aufgrund der kontinulierliche Verteilten Variable <span class="in">`hours`</span> gibt es in unserem Website-Beispiel keine exakten Matches. Dieses Verfahren ist hier folglich ungeeignet.</span>
<span id="cb106-697"><a href="#cb106-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-698"><a href="#cb106-698" aria-hidden="true" tabindex="-1"></a><span class="fu">### Coarsened Exact Matching</span></span>
<span id="cb106-699"><a href="#cb106-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-700"><a href="#cb106-700" aria-hidden="true" tabindex="-1"></a>Bei dieser Methode werden kontinuierliche Matching-Variablen grob (Engl. *coarse*) klassiert, ähnlich wie bei einem Histogram. Diese Diskretisierung ermöglicht es exakte Übereinstimmungen zwischen Behandlungs- und Kontrollgruppenbeobachtungen hinsichtlich ihrer klassierten Ausprägungen zu finden. Sowohl Behandlungs- als auch Kontrollbeobachtungen die mindestents einen exakten Match haben, werden Teil des gematchten Datensatzes. In <span class="in">`matchit()`</span> wird Coarsened Exact Matching mit <span class="in">`method = "cem"`</span> durchgeführt. Über das Argument <span class="in">`cutpoints`</span> geben wir an, dass <span class="in">`hours`</span> in 6 Klassen und <span class="in">`age`</span> in 4 Klassen eingeteilt werden soll.^<span class="co">[</span><span class="ot">Diese Werte wurden ad-hoc gewählt da sie zu einem guten Ergebnis führen.</span><span class="co">]</span> Mit <span class="in">`k1k = TRUE`</span> erfolgt Eins-zu-eins-Matching: Bei mehreren exakten Matches wird die Beobachtung mit der geringsten Mahalanobis-Distanz (für die unklassierten Matching-Variablen) gewählt.</span>
<span id="cb106-701"><a href="#cb106-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-704"><a href="#cb106-704" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-705"><a href="#cb106-705" aria-hidden="true" tabindex="-1"></a><span class="co"># Coarsened Exact Matching</span></span>
<span id="cb106-706"><a href="#cb106-706" aria-hidden="true" tabindex="-1"></a>res_CEM <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb106-707"><a href="#cb106-707" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb106-708"><a href="#cb106-708" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb106-709"><a href="#cb106-709" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb106-710"><a href="#cb106-710" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cem"</span>, </span>
<span id="cb106-711"><a href="#cb106-711" aria-hidden="true" tabindex="-1"></a>  <span class="at">k2k =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-712"><a href="#cb106-712" aria-hidden="true" tabindex="-1"></a>  <span class="at">cutpoints =</span> <span class="fu">list</span>(</span>
<span id="cb106-713"><a href="#cb106-713" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours"</span> <span class="ot">=</span> <span class="dv">6</span>, </span>
<span id="cb106-714"><a href="#cb106-714" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span> <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb106-715"><a href="#cb106-715" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb106-716"><a href="#cb106-716" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-717"><a href="#cb106-717" aria-hidden="true" tabindex="-1"></a>res_CEM</span>
<span id="cb106-718"><a href="#cb106-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-719"><a href="#cb106-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-722"><a href="#cb106-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-723"><a href="#cb106-723" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance-Table Coarsened Exact Matching</span></span>
<span id="cb106-724"><a href="#cb106-724" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_CEM)</span>
<span id="cb106-725"><a href="#cb106-725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-726"><a href="#cb106-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-727"><a href="#cb106-727" aria-hidden="true" tabindex="-1"></a>Mit Coarsened Exact Matching erhalten wir einen Datensatz mit 82 Beobachtungen und guter Balance.</span>
<span id="cb106-728"><a href="#cb106-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-729"><a href="#cb106-729" aria-hidden="true" tabindex="-1"></a><span class="fu">### Matching mit der Mahalanobis-Distanz</span></span>
<span id="cb106-730"><a href="#cb106-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-731"><a href="#cb106-731" aria-hidden="true" tabindex="-1"></a>Die Euklidische Distanz misst den direkten Abstand zwischen zwei Punkten und ist nicht invariant gegenüber Transformationen, insbesondere bei unterschiedlichen Skalierungen und bei Korrelation der Matching-Variablen. Die Mahalanobis-Distanz hingegen ist ein standardisiertes Distanzmaß, das unter Berücksichtigung der Varianz-Kovarianz-Struktur der Daten angibt, wie viele Standardabweichungen zwei Datenpunkte voneinander entfernt sind. Die Mahalanobis-Distanz ist invariant gegenüber linearen Transformationen (Skalierung, Translation und Rotation) der Daten und bietet ein genaueres Maß für die Unähnlichkeit zweier Beobachtungen hinsichtlich ihrer Ausprägungen der Matching-Variablen. </span>
<span id="cb106-732"><a href="#cb106-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-733"><a href="#cb106-733" aria-hidden="true" tabindex="-1"></a>Betrachte die Datenpunkte $P_1=(X_1,Y_1)'$ und $P_2=(X_2,Y_2)'$ für die Matching-Variablen $X$ und $Y$. Die Mahalanobis-Distanz zwischen $P_1$ und $P_2$ ist definiert als</span>
<span id="cb106-734"><a href="#cb106-734" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb106-735"><a href="#cb106-735" aria-hidden="true" tabindex="-1"></a>  d_M(P_1,\,P_2) = \sqrt{(P_1 - P_2)'\boldsymbol{S}^{-1} (P_1 - P_2)},</span>
<span id="cb106-736"><a href="#cb106-736" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb106-737"><a href="#cb106-737" aria-hidden="true" tabindex="-1"></a>wobei $\boldsymbol{S}$ die Varianz-Kovarianz-Matrix von $X$ und $Y$ ist. Die Mahalanobis-Distanz $d_M(P_1,\,P_2)$ ist also die Euklidische Distanz zwischen den standardisierten Datenpunkten.</span>
<span id="cb106-738"><a href="#cb106-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-739"><a href="#cb106-739" aria-hidden="true" tabindex="-1"></a>In empirischen Anwendungen ersetzen wir die (unbekannten) Komponenten der Varianz-Kovarianz-Matrix durch Stichprobenvarianten. Dies ergibt die Formel</span>
<span id="cb106-740"><a href="#cb106-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-741"><a href="#cb106-741" aria-hidden="true" tabindex="-1"></a>\begin{align*}</span>
<span id="cb106-742"><a href="#cb106-742" aria-hidden="true" tabindex="-1"></a>  \widehat{d}_M(P_1,\,P_2) = \sqrt{</span>
<span id="cb106-743"><a href="#cb106-743" aria-hidden="true" tabindex="-1"></a>  \begin{pmatrix}</span>
<span id="cb106-744"><a href="#cb106-744" aria-hidden="true" tabindex="-1"></a>    X_1 - X_2<span class="sc">\\</span></span>
<span id="cb106-745"><a href="#cb106-745" aria-hidden="true" tabindex="-1"></a>    Y_1 - Y_2</span>
<span id="cb106-746"><a href="#cb106-746" aria-hidden="true" tabindex="-1"></a>  \end{pmatrix}'</span>
<span id="cb106-747"><a href="#cb106-747" aria-hidden="true" tabindex="-1"></a>  \begin{pmatrix}</span>
<span id="cb106-748"><a href="#cb106-748" aria-hidden="true" tabindex="-1"></a>    \widehat{\text{Var}}(X^2) &amp; \widehat{\text{Cov}}(X, Y) <span class="sc">\\</span></span>
<span id="cb106-749"><a href="#cb106-749" aria-hidden="true" tabindex="-1"></a>     \widehat{\text{Cov}}(X, Y) &amp; \widehat{\text{Var}}(Y^2) </span>
<span id="cb106-750"><a href="#cb106-750" aria-hidden="true" tabindex="-1"></a>  \end{pmatrix}^{-1}</span>
<span id="cb106-751"><a href="#cb106-751" aria-hidden="true" tabindex="-1"></a>    \begin{pmatrix}</span>
<span id="cb106-752"><a href="#cb106-752" aria-hidden="true" tabindex="-1"></a>    X_1 - X_2<span class="sc">\\</span></span>
<span id="cb106-753"><a href="#cb106-753" aria-hidden="true" tabindex="-1"></a>    Y_1 - Y_2</span>
<span id="cb106-754"><a href="#cb106-754" aria-hidden="true" tabindex="-1"></a>  \end{pmatrix}</span>
<span id="cb106-755"><a href="#cb106-755" aria-hidden="true" tabindex="-1"></a>}.</span>
<span id="cb106-756"><a href="#cb106-756" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb106-757"><a href="#cb106-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-758"><a href="#cb106-758" aria-hidden="true" tabindex="-1"></a>Die nachstehende interaktive Grafik zeigt Beobachtungen zweier Matching-Variablen, die aus einer bivariaten Normalverteilung mit positiver Korrelation generiert wurden. Diese bivariate Verteilung ist identisch für Beobachtungen aus der Kontrollgruppe (rot) und Beobachtungen aus der Behandlungsgruppe (blau). Für die ausgewählte Beobachtung aus der Behandlungsgruppe (schwarzer Rand) werden potentielle Matches in der Kontrollgruppe innerhalb der vorgegebenen Mahalanobis-Distanz in Cyan kenntlich gemacht. Beachte, dass die Mahalanobis-Distanz Varianzen und Kovarianzen der Daten berücksichtigt, sodass die gematchten Beobachtungen in einem elliptischen Bereich um die betrachtete behandelte Beobachtung liegen. Eine Euklidische Distanz hingegen (gestrichelte Linie) ignoriert die Skalierung der Daten.</span>
<span id="cb106-759"><a href="#cb106-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-762"><a href="#cb106-762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-763"><a href="#cb106-763" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-764"><a href="#cb106-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| column: margin</span></span>
<span id="cb106-765"><a href="#cb106-765" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsvg)</span>
<span id="cb106-766"><a href="#cb106-766" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(qrcode)</span>
<span id="cb106-767"><a href="#cb106-767" aria-hidden="true" tabindex="-1"></a>code <span class="ot">&lt;-</span> <span class="fu">qr_code</span>(<span class="st">"https://observablehq.com/d/62067a02a72c9f90"</span>)</span>
<span id="cb106-768"><a href="#cb106-768" aria-hidden="true" tabindex="-1"></a>path <span class="ot">&lt;-</span> <span class="st">"img/EDM_qr.svg"</span></span>
<span id="cb106-769"><a href="#cb106-769" aria-hidden="true" tabindex="-1"></a>qrcode<span class="sc">::</span><span class="fu">generate_svg</span>(</span>
<span id="cb106-770"><a href="#cb106-770" aria-hidden="true" tabindex="-1"></a>  <span class="at">qrcode =</span> code, </span>
<span id="cb106-771"><a href="#cb106-771" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span>  <span class="st">"img/EDM_qr.svg"</span></span>
<span id="cb106-772"><a href="#cb106-772" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-773"><a href="#cb106-773" aria-hidden="true" tabindex="-1"></a>rsvg<span class="sc">::</span><span class="fu">rsvg_png</span>(</span>
<span id="cb106-774"><a href="#cb106-774" aria-hidden="true" tabindex="-1"></a>  <span class="st">"img/EDM_qr.svg"</span>, <span class="st">"img/EDM_qr.png"</span>,</span>
<span id="cb106-775"><a href="#cb106-775" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">200</span>, <span class="at">height =</span> <span class="dv">200</span></span>
<span id="cb106-776"><a href="#cb106-776" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-777"><a href="#cb106-777" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="at">path =</span> <span class="st">"img/EDM_qr.png"</span>, <span class="at">dpi =</span> <span class="dv">490</span>)</span>
<span id="cb106-778"><a href="#cb106-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-779"><a href="#cb106-779" aria-hidden="true" tabindex="-1"></a>&lt;iframe width="100%" height="648" frameborder="0"</span>
<span id="cb106-780"><a href="#cb106-780" aria-hidden="true" tabindex="-1"></a>  src="https://observablehq.com/embed/1338355035acc056@687?cells=theplot%2Cviewof+caliper%2Cstyles"&gt;&lt;/iframe&gt;</span>
<span id="cb106-781"><a href="#cb106-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-782"><a href="#cb106-782" aria-hidden="true" tabindex="-1"></a>Für Eins-zu-Eins-Matching im Website-Beispiel anhand der Mahalanobis-Distanz mit <span class="in">`matchit()`</span> setzen wir <span class="in">`distance = "mahalanobis"`</span> und wählen <span class="in">`method = "nearest"`</span>. Mit diesen Parametern wird jeder Behandlung aus der Behandlungsgruppe die gemäß $d_M$ am ehesten vergleichbarste Beobachtung aus der Kontrollgruppe zugewiesen, wobei keine mehrfachen Matches zulässig sind. </span>
<span id="cb106-783"><a href="#cb106-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-786"><a href="#cb106-786" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-787"><a href="#cb106-787" aria-hidden="true" tabindex="-1"></a><span class="co"># 1:1 Mahalanobis-Distanz-Matching</span></span>
<span id="cb106-788"><a href="#cb106-788" aria-hidden="true" tabindex="-1"></a>res_maha <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb106-789"><a href="#cb106-789" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb106-790"><a href="#cb106-790" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb106-791"><a href="#cb106-791" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb106-792"><a href="#cb106-792" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"mahalanobis"</span>, </span>
<span id="cb106-793"><a href="#cb106-793" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"nearest"</span></span>
<span id="cb106-794"><a href="#cb106-794" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-795"><a href="#cb106-795" aria-hidden="true" tabindex="-1"></a>res_maha</span>
<span id="cb106-796"><a href="#cb106-796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-797"><a href="#cb106-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-800"><a href="#cb106-800" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-801"><a href="#cb106-801" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance-Table für 1:1 Mahalanobis-Matching</span></span>
<span id="cb106-802"><a href="#cb106-802" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_maha)</span>
<span id="cb106-803"><a href="#cb106-803" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-804"><a href="#cb106-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-805"><a href="#cb106-805" aria-hidden="true" tabindex="-1"></a>Die Ergebnisse zeigen, dass für sämtliche $149$ Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden werden konnte. Es werden lediglich $2$ Beobachtungen der $151$ Beobachtungen in der Kontrollgruppe nicht gematcht.</span>
<span id="cb106-806"><a href="#cb106-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-807"><a href="#cb106-807" aria-hidden="true" tabindex="-1"></a>Entsprechend zeigt die Balance-Table eine ähnliche Diskrepanz beider Gruppen hinsichtlich der Matching-Variablen an.</span>
<span id="cb106-808"><a href="#cb106-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-809"><a href="#cb106-809" aria-hidden="true" tabindex="-1"></a>**Mahalanobis-Distanz mit Caliper .25 für Propensity Scores basierend auf logistischer Regression**</span>
<span id="cb106-810"><a href="#cb106-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-811"><a href="#cb106-811" aria-hidden="true" tabindex="-1"></a>Für eine strengeres Matching-Kriterium kann ein *Caliper*, d.h. eine maximal zulässige Distanz, herangezogen werden. Die Mahalanobis-Distanz hat jedoch keine einheitliche Skala: Ob eine Distanz als groß oder klein betrachten werden kann, hängt von der Anzahl der Matching-Variablen und dem Überlappungsgrad zwischen den Gruppen ab. Daher wird die Beschränkung durch einen Caliper nicht auf $\widehat{d}_M$ sondern auf Propensity Scores angewendet.</span>
<span id="cb106-812"><a href="#cb106-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-813"><a href="#cb106-813" aria-hidden="true" tabindex="-1"></a>Im nächsten Code-Beispiel spezifizieren wir mit <span class="in">`distance = "glm"`</span>, dass Propensity Scores gemäß der Vorschrift in <span class="in">`formula`</span> geschätzt werden. Mit <span class="in">`mahvars = ~ age + male + hours`</span> legen wir die Matching-Variablen für die Berechnung von $\widehat{d}_M$ fest. <span class="in">`caliper = .25`</span> legt fest, dass lediglich Beobachtungen der Kontrollgruppe bei einer absoluten Differenz der Propensity Scores von höchstens $0.25$ Standardabweichungen als Match für eine Beobachtung in der Behandlungsgruppe qualifiziert sind.</span>
<span id="cb106-814"><a href="#cb106-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-815"><a href="#cb106-815" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb106-816"><a href="#cb106-816" aria-hidden="true" tabindex="-1"></a><span class="in">#| context: setup</span></span>
<span id="cb106-817"><a href="#cb106-817" aria-hidden="true" tabindex="-1"></a><span class="in"># Logit-Modell mit 'glm()' schätzen</span></span>
<span id="cb106-818"><a href="#cb106-818" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb106-819"><a href="#cb106-819" aria-hidden="true" tabindex="-1"></a><span class="in">  darkmode_ps_logit &lt;- glm(</span></span>
<span id="cb106-820"><a href="#cb106-820" aria-hidden="true" tabindex="-1"></a><span class="in">    formula = dark_mode ~ age + male + hours,</span></span>
<span id="cb106-821"><a href="#cb106-821" aria-hidden="true" tabindex="-1"></a><span class="in">    data = darkmode,</span></span>
<span id="cb106-822"><a href="#cb106-822" aria-hidden="true" tabindex="-1"></a><span class="in">    family = binomial</span></span>
<span id="cb106-823"><a href="#cb106-823" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-824"><a href="#cb106-824" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-825"><a href="#cb106-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-828"><a href="#cb106-828" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-829"><a href="#cb106-829" aria-hidden="true" tabindex="-1"></a><span class="co"># Mahalanobis-Matchig mit PS-Caliper</span></span>
<span id="cb106-830"><a href="#cb106-830" aria-hidden="true" tabindex="-1"></a>res_mahaC <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb106-831"><a href="#cb106-831" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb106-832"><a href="#cb106-832" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb106-833"><a href="#cb106-833" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"glm"</span>,</span>
<span id="cb106-834"><a href="#cb106-834" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb106-835"><a href="#cb106-835" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb106-836"><a href="#cb106-836" aria-hidden="true" tabindex="-1"></a>  <span class="at">mahvars =</span> <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours,</span>
<span id="cb106-837"><a href="#cb106-837" aria-hidden="true" tabindex="-1"></a>  <span class="at">caliper =</span> .<span class="dv">25</span></span>
<span id="cb106-838"><a href="#cb106-838" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-839"><a href="#cb106-839" aria-hidden="true" tabindex="-1"></a>res_mahaC</span>
<span id="cb106-840"><a href="#cb106-840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-841"><a href="#cb106-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-844"><a href="#cb106-844" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-845"><a href="#cb106-845" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance Table</span></span>
<span id="cb106-846"><a href="#cb106-846" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_mahaC)</span>
<span id="cb106-847"><a href="#cb106-847" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-848"><a href="#cb106-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-849"><a href="#cb106-849" aria-hidden="true" tabindex="-1"></a>Die Balance-Table zeigt einen deutlichen Effekt der Beschränkung qualifizierter Beobachtungen durch <span class="in">`caliper = .25`</span>: Aufgrund der oberen Grenze für die Propensity-Score-Differenz von $<span class="in">`r round(.25 * sd(fitted(darkmode_ps_logit)), 3)`</span>$ wird für lediglich $104$ Beobachtungen aus der Behandlungsgruppe ein individueller Match in der Kontrollgruppe gefunden.^<span class="co">[</span><span class="ot">Die durch `caliper` implizierte Obergrenze ergibt sich als `.25 * sd(fitted(darkmode_ps_logit)))`.</span><span class="co">]</span> Weiterhin finden wir eine verbesserte Balance für den gematchten Datensatz.</span>
<span id="cb106-850"><a href="#cb106-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-851"><a href="#cb106-851" aria-hidden="true" tabindex="-1"></a>:::{.column-margin .content-visible when-format="html"}</span>
<span id="cb106-852"><a href="#cb106-852" aria-hidden="true" tabindex="-1"></a><span class="in">```{webr-r}</span></span>
<span id="cb106-853"><a href="#cb106-853" aria-hidden="true" tabindex="-1"></a><span class="in">.25 * sd(</span></span>
<span id="cb106-854"><a href="#cb106-854" aria-hidden="true" tabindex="-1"></a><span class="in">  fitted(darkmode_ps_logit)</span></span>
<span id="cb106-855"><a href="#cb106-855" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-856"><a href="#cb106-856" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-857"><a href="#cb106-857" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-858"><a href="#cb106-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-859"><a href="#cb106-859" aria-hidden="true" tabindex="-1"></a><span class="fu">### Propensity Score Matching</span></span>
<span id="cb106-860"><a href="#cb106-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-861"><a href="#cb106-861" aria-hidden="true" tabindex="-1"></a>Eine gängige Variante ist Matching ausschließlich anhand von Propensity Scores innerhalb eines Calipers. </span>
<span id="cb106-862"><a href="#cb106-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-865"><a href="#cb106-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-866"><a href="#cb106-866" aria-hidden="true" tabindex="-1"></a><span class="co"># 1:1 Matching mit PS und Caliper</span></span>
<span id="cb106-867"><a href="#cb106-867" aria-hidden="true" tabindex="-1"></a>res_PSC <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb106-868"><a href="#cb106-868" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb106-869"><a href="#cb106-869" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb106-870"><a href="#cb106-870" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb106-871"><a href="#cb106-871" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"glm"</span>, </span>
<span id="cb106-872"><a href="#cb106-872" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"nearest"</span>, </span>
<span id="cb106-873"><a href="#cb106-873" aria-hidden="true" tabindex="-1"></a>  <span class="at">caliper =</span> .<span class="dv">25</span></span>
<span id="cb106-874"><a href="#cb106-874" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-875"><a href="#cb106-875" aria-hidden="true" tabindex="-1"></a>res_PSC</span>
<span id="cb106-876"><a href="#cb106-876" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-877"><a href="#cb106-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-880"><a href="#cb106-880" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-881"><a href="#cb106-881" aria-hidden="true" tabindex="-1"></a><span class="co"># Balance Table</span></span>
<span id="cb106-882"><a href="#cb106-882" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.tab</span>(res_PSC)</span>
<span id="cb106-883"><a href="#cb106-883" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-884"><a href="#cb106-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-885"><a href="#cb106-885" aria-hidden="true" tabindex="-1"></a>Laut Balance-Table führt Eins-zu-Eins-Matching basierend auf Propensity Scores zu einem Datensatz mit $104$ gematchten Beobachtungen in der Behandlungsgruppe. Hinsichtlich der standardisierten Mittelwertdifferenz (<span class="in">`Diff.Adj`</span>) erzielt diese Methode die beste Balance unter den betrachteten Ansätzen.</span>
<span id="cb106-886"><a href="#cb106-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-887"><a href="#cb106-887" aria-hidden="true" tabindex="-1"></a>**Vergleich der Balance verschiedener Verfahren mit Love-Plot**</span>
<span id="cb106-888"><a href="#cb106-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-889"><a href="#cb106-889" aria-hidden="true" tabindex="-1"></a>Standardisierte Mittelwertdifferenzen für verschiedene Matching-Verfahren können grafisch mit einem Love-Plot <span class="co">[</span><span class="ot">@Love2004</span><span class="co">]</span> veranschaulicht werden. Hierzu nutzen wir <span class="in">`cobalt::love.plot()`</span> und übergeben die mit <span class="in">`matchit()`</span> generierten Objekte im Argument <span class="in">`weights`</span>.</span>
<span id="cb106-890"><a href="#cb106-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-893"><a href="#cb106-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-894"><a href="#cb106-894" aria-hidden="true" tabindex="-1"></a><span class="co"># Love-Plot für</span></span>
<span id="cb106-895"><a href="#cb106-895" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(</span>
<span id="cb106-896"><a href="#cb106-896" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours, </span>
<span id="cb106-897"><a href="#cb106-897" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="fu">list</span>(</span>
<span id="cb106-898"><a href="#cb106-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">CEM =</span> res_CEM,</span>
<span id="cb106-899"><a href="#cb106-899" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mahalanobis =</span> res_maha,</span>
<span id="cb106-900"><a href="#cb106-900" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mahalanobis_Cal =</span> res_mahaC,</span>
<span id="cb106-901"><a href="#cb106-901" aria-hidden="true" tabindex="-1"></a>    <span class="at">PSC =</span> res_PSC</span>
<span id="cb106-902"><a href="#cb106-902" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb106-903"><a href="#cb106-903" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode, </span>
<span id="cb106-904"><a href="#cb106-904" aria-hidden="true" tabindex="-1"></a>  <span class="at">line =</span> T,</span>
<span id="cb106-905"><a href="#cb106-905" aria-hidden="true" tabindex="-1"></a>  <span class="co"># absolute Mittelwertdifferenz plotten</span></span>
<span id="cb106-906"><a href="#cb106-906" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs =</span> T</span>
<span id="cb106-907"><a href="#cb106-907" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-908"><a href="#cb106-908" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-909"><a href="#cb106-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-910"><a href="#cb106-910" aria-hidden="true" tabindex="-1"></a>Die Grafik zeigt, dass Coarsened Exact Matching (CEM) unter allen betrachteten Verfahren die Stichprobe mit der besten Balance ergibt. Diesen gematchten Datensatz erhalten wir mit <span class="in">`MatchIt::match.data()`</span>.</span>
<span id="cb106-911"><a href="#cb106-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-914"><a href="#cb106-914" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-915"><a href="#cb106-915" aria-hidden="true" tabindex="-1"></a><span class="co"># gematchten Datensatz zuweisen</span></span>
<span id="cb106-916"><a href="#cb106-916" aria-hidden="true" tabindex="-1"></a>darkmode_matched_CEM <span class="ot">&lt;-</span> <span class="fu">match.data</span>(res_CEM)</span>
<span id="cb106-917"><a href="#cb106-917" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(darkmode_matched_CEM)</span>
<span id="cb106-918"><a href="#cb106-918" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-919"><a href="#cb106-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-920"><a href="#cb106-920" aria-hidden="true" tabindex="-1"></a><span class="in">`darkmode_matched`</span> enthält Gewichte (<span class="in">`weights`</span>) für die jeweilige Gruppe zu denen gemachte Beobachtungen gehören (<span class="in">`subclass`</span>). Dies ist relevant, falls Beobachtungen mehrfach gematcht werden. Wegen Eins-zu-eins-Matching _ohne_ Zurücklegen gibt es in unserem Beispiel <span class="in">`r length(unique(darkmode_matched_CEM$subclass))`</span> Beobachtungspaare und sämtliche Gewichte sind 1. Die Berücksichtigung der Gewicht in den nachfolgenden Aufrufen von Schätzfunktionen (bspw.<span class="in">`lm()`</span>) ist daher nicht nötig und erfolgt lediglich zur Illustration der grundsätzlichen Vorgehensweise.</span>
<span id="cb106-921"><a href="#cb106-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-922"><a href="#cb106-922" aria-hidden="true" tabindex="-1"></a>Eine Wiederholung der grafischen Analyse in @sec-balance zeigt eine deutlich verbesserte Vergleichbarkeit hinsichtlich der Verteilung der Matching-Variablen in <span class="in">`darkmode_matched`</span>.</span>
<span id="cb106-923"><a href="#cb106-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-924"><a href="#cb106-924" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, warning=FALSE, message = F}</span></span>
<span id="cb106-925"><a href="#cb106-925" aria-hidden="true" tabindex="-1"></a><span class="in">darkmode_matched_CEM %&gt;%</span></span>
<span id="cb106-926"><a href="#cb106-926" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dark_mode) %&gt;%</span></span>
<span id="cb106-927"><a href="#cb106-927" aria-hidden="true" tabindex="-1"></a><span class="in">  select(age, hours) %&gt;%</span></span>
<span id="cb106-928"><a href="#cb106-928" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate_all(scale) %&gt;%</span></span>
<span id="cb106-929"><a href="#cb106-929" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(cols = c(-dark_mode)) %&gt;%</span></span>
<span id="cb106-930"><a href="#cb106-930" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-931"><a href="#cb106-931" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(</span></span>
<span id="cb106-932"><a href="#cb106-932" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(x = value, fill = as.factor(dark_mode))</span></span>
<span id="cb106-933"><a href="#cb106-933" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-934"><a href="#cb106-934" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_density( alpha = .5) + </span></span>
<span id="cb106-935"><a href="#cb106-935" aria-hidden="true" tabindex="-1"></a><span class="in">  facet_wrap(</span></span>
<span id="cb106-936"><a href="#cb106-936" aria-hidden="true" tabindex="-1"></a><span class="in">    facets = ~ name, </span></span>
<span id="cb106-937"><a href="#cb106-937" aria-hidden="true" tabindex="-1"></a><span class="in">    scales = "free", </span></span>
<span id="cb106-938"><a href="#cb106-938" aria-hidden="true" tabindex="-1"></a><span class="in">    nrow = 3</span></span>
<span id="cb106-939"><a href="#cb106-939" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb106-940"><a href="#cb106-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-941"><a href="#cb106-941" aria-hidden="true" tabindex="-1"></a><span class="in">darkmode_matched_CEM %&gt;% </span></span>
<span id="cb106-942"><a href="#cb106-942" aria-hidden="true" tabindex="-1"></a><span class="in">  group_by(dark_mode) %&gt;%</span></span>
<span id="cb106-943"><a href="#cb106-943" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb106-944"><a href="#cb106-944" aria-hidden="true" tabindex="-1"></a><span class="in">    male = as.factor(male), </span></span>
<span id="cb106-945"><a href="#cb106-945" aria-hidden="true" tabindex="-1"></a><span class="in">    dark_mode = as.factor(dark_mode)</span></span>
<span id="cb106-946"><a href="#cb106-946" aria-hidden="true" tabindex="-1"></a><span class="in">  ) %&gt;%</span></span>
<span id="cb106-947"><a href="#cb106-947" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb106-948"><a href="#cb106-948" aria-hidden="true" tabindex="-1"></a><span class="in">  ggplot(</span></span>
<span id="cb106-949"><a href="#cb106-949" aria-hidden="true" tabindex="-1"></a><span class="in">    aes(x = dark_mode, fill = male)</span></span>
<span id="cb106-950"><a href="#cb106-950" aria-hidden="true" tabindex="-1"></a><span class="in">  ) +</span></span>
<span id="cb106-951"><a href="#cb106-951" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_bar(position = "fill") +</span></span>
<span id="cb106-952"><a href="#cb106-952" aria-hidden="true" tabindex="-1"></a><span class="in">  ylab("Anteil")</span></span>
<span id="cb106-953"><a href="#cb106-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-954"><a href="#cb106-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-955"><a href="#cb106-955" aria-hidden="true" tabindex="-1"></a>Wir beobachten eine bessere Balance bei <span class="in">`age`</span> und <span class="in">`hours`</span>. Inbesondere ist <span class="in">`male`</span> für Kontroll- und Behandlungsgruppe ausgeglichen.</span>
<span id="cb106-956"><a href="#cb106-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-957"><a href="#cb106-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-958"><a href="#cb106-958" aria-hidden="true" tabindex="-1"></a><span class="fu">## Schätzung und Inferenz für den Behandlungseffekt nach Matching {#sec-regadj}</span></span>
<span id="cb106-959"><a href="#cb106-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-960"><a href="#cb106-960" aria-hidden="true" tabindex="-1"></a>Wir schätzen nun den Behandlungseffekt von <span class="in">`dark_mode`</span> auf <span class="in">`read_time`</span> für die mit CEM und Propensity Score Matching ermittelten Datensätzen und vergleichen die Ergebniss anschließend mit einer Regressionsschätzung ohne Matching. </span>
<span id="cb106-961"><a href="#cb106-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-962"><a href="#cb106-962" aria-hidden="true" tabindex="-1"></a>Wir kombinieren die Matching-Verfahren mit linearer Regression, d.h. wir Schätzen den Behandlungseffekt anhand es gematchten Datensatzes als Mittelwertdifferenz nach zusätzlicher Kontrolle für die Matching-Variablen. Diese Kombination von Matching mit Regression wird in der Literatur als *Regression Adjustment* bezeichnet und ist insbesondere hilfreich, wenn Backdoors mit Matching geschlossen werden sollen, der kausale Effekt jedoch nur unter Verwendung einer nicht-trivialen Regressionsfunktion ermittelt werden kann. Zum Beispiel kann bei einer kontinuierlichen Behandlungsvariable und einem nicht-linearen Zusammenhang mit $Y$ der kausale Effekt nicht durch einen bloßen Mittelwertvergleich erfasst werden, sondern erfordert eine adäquate Modellierung dieses Zusammenhangs in der Regressionsfunktion. Die zusätzliche Kontrolle für Matching-Variablen kann die Varianz der Schätzung verringern und das Risiko einer verzerrten Schätzung abmildern, falls nach Matching noch Unterschiede in der Balance von Behandlungs- und Kontrollgruppe vorliegen.</span>
<span id="cb106-963"><a href="#cb106-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-966"><a href="#cb106-966" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-967"><a href="#cb106-967" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT mit linearem Modell schätzen: CEM Datensatz</span></span>
<span id="cb106-968"><a href="#cb106-968" aria-hidden="true" tabindex="-1"></a>ATT_mod_CEM <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb106-969"><a href="#cb106-969" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb106-970"><a href="#cb106-970" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode_matched_CEM, </span>
<span id="cb106-971"><a href="#cb106-971" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights </span>
<span id="cb106-972"><a href="#cb106-972" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-973"><a href="#cb106-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-974"><a href="#cb106-974" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATT_mod_CEM)</span>
<span id="cb106-975"><a href="#cb106-975" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-976"><a href="#cb106-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-979"><a href="#cb106-979" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-980"><a href="#cb106-980" aria-hidden="true" tabindex="-1"></a><span class="co"># Datensatz für Propensity Score Matching zuweisen</span></span>
<span id="cb106-981"><a href="#cb106-981" aria-hidden="true" tabindex="-1"></a>darkmode_matched_PSC <span class="ot">&lt;-</span> <span class="fu">match.data</span>(res_PSC)</span>
<span id="cb106-982"><a href="#cb106-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-983"><a href="#cb106-983" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT mit linearem Modell schätzen: PSM Datensatz</span></span>
<span id="cb106-984"><a href="#cb106-984" aria-hidden="true" tabindex="-1"></a>ATT_mod_PSC <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb106-985"><a href="#cb106-985" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb106-986"><a href="#cb106-986" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode_matched_PSC, </span>
<span id="cb106-987"><a href="#cb106-987" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> weights </span>
<span id="cb106-988"><a href="#cb106-988" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-989"><a href="#cb106-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-990"><a href="#cb106-990" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATT_mod_PSC)</span>
<span id="cb106-991"><a href="#cb106-991" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-992"><a href="#cb106-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-995"><a href="#cb106-995" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-996"><a href="#cb106-996" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT mit linearem Modell ohne Matching</span></span>
<span id="cb106-997"><a href="#cb106-997" aria-hidden="true" tabindex="-1"></a>ATT_mod_org <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb106-998"><a href="#cb106-998" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb106-999"><a href="#cb106-999" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode</span>
<span id="cb106-1000"><a href="#cb106-1000" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1001"><a href="#cb106-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1002"><a href="#cb106-1002" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ATT_mod_org)</span>
<span id="cb106-1003"><a href="#cb106-1003" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1004"><a href="#cb106-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1005"><a href="#cb106-1005" aria-hidden="true" tabindex="-1"></a>Beachte, dass für die gematchten Datensätze jeweils ein durchschnittlicher Behandlungseffekt für die Beobachtungen _mit_ erfolgter Behandlung ermittelt wird: In sämtlichen oben gezeigten Matchibg-Verfahren werden mit <span class="in">`estimand = "ATT"`</span> vergleichbarere Kontrollbeobachtungen für die behandelten Beobachtungen ermittelt. Wir schätzen den Effekt der Behandlung, indem wir die Ergebnisse von behandelten Personen mit denen von gematchten Personen vergleichen, die keine Behandlung erhalten haben. Diese Vergleichsgruppe dient als Ersatz für den hypothetischen Zustand der Behandlungsgruppe, wenn keine Behandlung erfolgt wäre. Dies entspricht der Definition eines ATT --- ein average treatment effect *on the treated*.</span>
<span id="cb106-1006"><a href="#cb106-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1007"><a href="#cb106-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cluster-robuste Standardfehler</span></span>
<span id="cb106-1008"><a href="#cb106-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1009"><a href="#cb106-1009" aria-hidden="true" tabindex="-1"></a>Für Matching-Verfahren sind die mit <span class="in">`summary()`</span> berechneten Standardfehler (und damit auch Konfidenzintervalle, t-Statistiken und p-Werte) für den Behandlungseffekt *grundsätzlich ungültig*. Je nach Matching-Verfahren liegen unterschiedliche Quellen von Schätzunsicherheit vor, die bei der Berechnung von Standardfehlern zusätzlich zu der "üblichen" Stichproben-Variabilität berücksichtig werden müssen. Gründe hierfür sind der Matching-Prozess ansich oder weitere Unsicherheit durch die Schätzung zusätzlicher Parameter, etwa bei der Berechnung von Propensity Scores mit logistischer Regression. Eine weiterere Ursache zusätzlicher Variation durch den Matching-Prozess, die wir bisher nicht näher betrachtet haben ensteht durch Zurücklegen, d.h. wenn Beobachtungen mehrfach gematcht werden können. Auch dieser Faktor wird in der von <span class="in">`summary()`</span> verwendeten Formel für den Standardfehler des Effekt-Schätzers nicht berücksichtigt.</span>
<span id="cb106-1010"><a href="#cb106-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1011"><a href="#cb106-1011" aria-hidden="true" tabindex="-1"></a>Die Standardfehlerberechnung für Matching-Schätzer von Behandlungseffekten ist ein Gegenstand aktueller methodischer Forschung. @AustinSmall2014 und @AbadieSpiess2022 belegen die Gültigkeit von cluster-robusten Standardfehlern mit Clustering auf Ebene der Beobachtungsgruppen (<span class="in">`subclass`</span> im output von <span class="in">`match.data()`</span>) bei Matching ohne Zurücklegen. Für Matching anhand von Propensity Scores (auch mit Zurücklegen) zeigt @AbadieImbens2016, dass ignorieren der zusätzlichen Unsicherheit durch die Schätzung der Propensity Scores zu konservativer Inferenz für den ATE anhand eines cluster-robusten Standardfehlerschätzers führt, jedoch ungültige Inferenz für die Schätzung des ATT bedeuten kann. Ähnlich zu @AustinSmall2014 deuten die Ergebnisse der Simulationsstudie von @Bodoryetal2020 jedoch auf grundsätzlich bessere Eigenschaften der Schätzung hin, wenn die Standardfehler *nicht* für die Schätzung der Propensity Scores adjustiert werden.</span>
<span id="cb106-1012"><a href="#cb106-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1013"><a href="#cb106-1013" aria-hidden="true" tabindex="-1"></a>Weiterhin ist die Kontrolle für Kovariablen mit Erklärungskraft für die Outcome-Variable und für die Matching-Variablen mit *Regression Adjustment* (vgl. @sec-regadj) für die Schätzung des Behandlungseffekts nach Matching eine etablierte Strategie, vgl. @HillReiter2006 und @AbadieSpiess2022. So können die Varianz der Schätzung und das Risiko einer Verzerrung der Standardfehler aufgrund verbleibender Imbalance von Behandlungs- und Kontrollgruppe nach Matching verringert werden.</span>
<span id="cb106-1014"><a href="#cb106-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1015"><a href="#cb106-1015" aria-hidden="true" tabindex="-1"></a>Zur Demonstration von (cluster)-robuster Inferenz und für eine  tabellarische Zusammenfassung der Ergebnisse nutzen wir die Pakete <span class="in">`marginaleffects`</span> und <span class="in">`modelsummary`</span>. Mit <span class="in">`marginaleffects::avg_comparisons()`</span> können p-Werte und Kofindenzintervalle unter Berücksichtigung von robuster Standardfehlern und der Gewichte aus dem Matching-Verfahren berechnet werden.</span>
<span id="cb106-1016"><a href="#cb106-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1019"><a href="#cb106-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1020"><a href="#cb106-1020" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(marginaleffects)</span>
<span id="cb106-1021"><a href="#cb106-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1022"><a href="#cb106-1022" aria-hidden="true" tabindex="-1"></a><span class="co"># Inferenz: Multiple Regression, ungematchter Datensatz</span></span>
<span id="cb106-1023"><a href="#cb106-1023" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-1024"><a href="#cb106-1024" aria-hidden="true" tabindex="-1"></a>  sum_orig <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb106-1025"><a href="#cb106-1025" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> ATT_mod_org,</span>
<span id="cb106-1026"><a href="#cb106-1026" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="st">"dark_mode"</span>,</span>
<span id="cb106-1027"><a href="#cb106-1027" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Heteroskedastie-robuste SE:</span></span>
<span id="cb106-1028"><a href="#cb106-1028" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="st">"HC3"</span>, </span>
<span id="cb106-1029"><a href="#cb106-1029" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identifizierung der Kontrollgruppe:</span></span>
<span id="cb106-1030"><a href="#cb106-1030" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> <span class="fu">subset</span>(darkmode, dark_mode <span class="sc">==</span> <span class="dv">1</span>) </span>
<span id="cb106-1031"><a href="#cb106-1031" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1032"><a href="#cb106-1032" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb106-1033"><a href="#cb106-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1036"><a href="#cb106-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1037"><a href="#cb106-1037" aria-hidden="true" tabindex="-1"></a><span class="co"># Inferenz: Multiple Regression bei CEM</span></span>
<span id="cb106-1038"><a href="#cb106-1038" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-1039"><a href="#cb106-1039" aria-hidden="true" tabindex="-1"></a>  sum_CEM <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb106-1040"><a href="#cb106-1040" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> ATT_mod_CEM ,</span>
<span id="cb106-1041"><a href="#cb106-1041" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">"dark_mode"</span>,</span>
<span id="cb106-1042"><a href="#cb106-1042" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cluster-robuste SE</span></span>
<span id="cb106-1043"><a href="#cb106-1043" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> subclass, </span>
<span id="cb106-1044"><a href="#cb106-1044" aria-hidden="true" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">subset</span>(darkmode_matched_CEM, dark_mode <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb106-1045"><a href="#cb106-1045" aria-hidden="true" tabindex="-1"></a>  <span class="at">wts =</span> <span class="st">"weights"</span></span>
<span id="cb106-1046"><a href="#cb106-1046" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1047"><a href="#cb106-1047" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1048"><a href="#cb106-1048" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1051"><a href="#cb106-1051" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1052"><a href="#cb106-1052" aria-hidden="true" tabindex="-1"></a><span class="co"># Inferenz: Multiple Regression bei PSM</span></span>
<span id="cb106-1053"><a href="#cb106-1053" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-1054"><a href="#cb106-1054" aria-hidden="true" tabindex="-1"></a>  sum_PSC <span class="ot">&lt;-</span> <span class="fu">avg_comparisons</span>(</span>
<span id="cb106-1055"><a href="#cb106-1055" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> ATT_mod_PSC ,</span>
<span id="cb106-1056"><a href="#cb106-1056" aria-hidden="true" tabindex="-1"></a>    <span class="at">variables =</span> <span class="st">"dark_mode"</span>,</span>
<span id="cb106-1057"><a href="#cb106-1057" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="sc">~</span> subclass, </span>
<span id="cb106-1058"><a href="#cb106-1058" aria-hidden="true" tabindex="-1"></a>    <span class="at">newdata =</span> <span class="fu">subset</span>(darkmode_matched_PSC, dark_mode <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb106-1059"><a href="#cb106-1059" aria-hidden="true" tabindex="-1"></a>    <span class="at">wts =</span> <span class="st">"weights"</span></span>
<span id="cb106-1060"><a href="#cb106-1060" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1061"><a href="#cb106-1061" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1062"><a href="#cb106-1062" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1063"><a href="#cb106-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1064"><a href="#cb106-1064" aria-hidden="true" tabindex="-1"></a>Wir fassen die Ergebnisse mit <span class="in">`modelsummary::modelsummary()`</span> tabellarisch zusammen.</span>
<span id="cb106-1065"><a href="#cb106-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1068"><a href="#cb106-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1069"><a href="#cb106-1069" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb106-1070"><a href="#cb106-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1071"><a href="#cb106-1071" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabellarische Zusammenfassung erzeugen</span></span>
<span id="cb106-1072"><a href="#cb106-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb106-1073"><a href="#cb106-1073" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb106-1074"><a href="#cb106-1074" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Kein Matching"</span> <span class="ot">=</span> sum_orig, </span>
<span id="cb106-1075"><a href="#cb106-1075" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Coarsened Exact"</span> <span class="ot">=</span> sum_CEM, </span>
<span id="cb106-1076"><a href="#cb106-1076" aria-hidden="true" tabindex="-1"></a>   <span class="st">"Propensity Scores"</span> <span class="ot">=</span> sum_PSC</span>
<span id="cb106-1077"><a href="#cb106-1077" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb106-1078"><a href="#cb106-1078" aria-hidden="true" tabindex="-1"></a>  <span class="at">stars =</span> T, </span>
<span id="cb106-1079"><a href="#cb106-1079" aria-hidden="true" tabindex="-1"></a>  <span class="at">gof_map =</span> <span class="st">"nobs"</span>, </span>
<span id="cb106-1080"><a href="#cb106-1080" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"gt"</span></span>
<span id="cb106-1081"><a href="#cb106-1081" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb106-1082"><a href="#cb106-1082" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tabopts</span>()</span>
<span id="cb106-1083"><a href="#cb106-1083" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1084"><a href="#cb106-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1085"><a href="#cb106-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1086"><a href="#cb106-1086" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bootstrap-Schätzung kausaler Effekte bei Matching {#sec-bootmatching}</span></span>
<span id="cb106-1087"><a href="#cb106-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1088"><a href="#cb106-1088" aria-hidden="true" tabindex="-1"></a>Ein Bootstrap-Verfahren generiert mit Resampling (wiederholtes Ziehen mit Zurücklegen) aus dem Original-Datensatz (viele) künstliche Datensätze, für die der Schätzer (d.h. das gesamte Verfahren inkl. Matching!) jeweils berechnet wird. Die Verteilung der so gewonnenen Bootstrap-Schätzwerte approximiert die wahre, unbekannte Stichprobenverteilung des Schätzers des Behandlungseffekts. Mit dieser simulierten Verteilung können wir Inferenz betreiben: Wir können einen Bootstrap-Punktschätzer des Behandlungseffekts (Stichprobenmittel der Bootstrap-Schätzungen) sowie Standardfehler (Standardabweichung der der Bootstrap-Schätzungen) und p-Werte berechnen.</span>
<span id="cb106-1089"><a href="#cb106-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1090"><a href="#cb106-1090" aria-hidden="true" tabindex="-1"></a>Der Bootstrap kann hilfreich sein, wenn unklar ist, wie Standardfehler für die Unsicherheit des Matching-Prozesses zu adjustieren sind, um gültige Inferenzsstatistiken zu erhalten. @AbadieImbens2008 zeigen analytisch, dass der Standard-Bootstrap  die Stichprobenverteilung für Schätzer kausaler Effekte anhand von gematchten Datensätzen (d.h. bei Zuordnung/Selektion von Beobachtungen mit Matching) nicht korrekt abbilden kann. Grundsätzlich problematisch hierbei ist, wenn der Bootstrap eine verzerrte Schätzung produziert und/oder zu kleine Standardfehler liefert. @AbadieImbens2008 belegen die Tendenz des Bootstraps zu *konservative* (d.h. zu große) Standardfehler zu produzieren. Simulationsnachweise <span class="co">[</span><span class="ot">@Bodoryetal2020; @HillReiter2006; @AustinSmall2014;@AustinStuart2017</span><span class="co">]</span> finden, dass Bootstrap-Standardfehler u.a. bei Propensity Score Matching mit Zurücklegen leicht konservativ sind somit das gewünschte nominale Signifikanzniveau eines Bootstrap-Hypothesentests nicht überschritten wird, weshalb der Standard-Bootstrap trotz seiner Schwächen in der empirischen Forschung oft angewendet wird.</span>
<span id="cb106-1091"><a href="#cb106-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1092"><a href="#cb106-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1093"><a href="#cb106-1093" aria-hidden="true" tabindex="-1"></a>Wir betrachen als nächstes einen Bootstrap-Algorithmus für Inferenz bezüglich eines kausalen Effekts nach Matching und demonstrieren die Schätzung anhand unseres Website-Beispiels für den ATT nach Propensity-Score-Matching.</span>
<span id="cb106-1094"><a href="#cb106-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1095"><a href="#cb106-1095" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="**Algorithmus: Bootstrap-Schätzer für Matching mit Regression Adjustment**" icon=false}</span>
<span id="cb106-1096"><a href="#cb106-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1097"><a href="#cb106-1097" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Generiere eine Bootstrap-Stichprobe durch $N$ Züge *mit Zurücklegen* aus der $N$-elementigen originalen Stichprobe.</span>
<span id="cb106-1098"><a href="#cb106-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1099"><a href="#cb106-1099" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Wende das Matching-Verfahren für die Bootstrap-Stichprobe an. Schätze den Behandlungseffekt $\beta$ anhand der gematchten Stichprobe mit Regression. Speichere den Punktschätzer des Behandlungseffekts $\widehat{\beta}_b^*$.</span>
<span id="cb106-1100"><a href="#cb106-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1101"><a href="#cb106-1101" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Fürhre die Schritte 1 und 2 für $b=1,\dots,B$ aus, wobei $B$ eine hinreichend große Anzahl von Bootstrap-Replikationen ist.</span>
<span id="cb106-1102"><a href="#cb106-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1103"><a href="#cb106-1103" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Berechne den Bootstrap-Schätzer des Behandlungseffekts $\overline{\beta}^* = \frac{1}{B}\sum_{b=1} \widehat{\beta}_b^*$ und den Standardfehler $\text{SE}(\overline{\beta}^*) = \sqrt{\frac{1}{B-1}\sum_{b=1}^B(\widehat{\beta}_b^*-\overline{\beta}^*)^2}$. Berechne Inferenz-Statistiken mit den üblichen Formeln.</span>
<span id="cb106-1104"><a href="#cb106-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1105"><a href="#cb106-1105" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-1106"><a href="#cb106-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1107"><a href="#cb106-1107" aria-hidden="true" tabindex="-1"></a>Wir Implementieren nun einen Bootstrap-Schätzer des ATT im Website-Beispiel für Propensity-Score-Matching. Hierzu definieren wir eine <span class="in">`R`</span>-Funktion <span class="in">`boot_fun()`</span> für die Schritte 1 und 2 im obigen Algorithmus.</span>
<span id="cb106-1108"><a href="#cb106-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1111"><a href="#cb106-1111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1112"><a href="#cb106-1112" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Funktion für Schritte 1 und 2</span></span>
<span id="cb106-1113"><a href="#cb106-1113" aria-hidden="true" tabindex="-1"></a>boot_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb106-1114"><a href="#cb106-1114" aria-hidden="true" tabindex="-1"></a>    data, <span class="co"># originale Stichprobe</span></span>
<span id="cb106-1115"><a href="#cb106-1115" aria-hidden="true" tabindex="-1"></a>    i     <span class="co"># Indexmenge f. Bootstrap-Stichprobe</span></span>
<span id="cb106-1116"><a href="#cb106-1116" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb106-1117"><a href="#cb106-1117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1118"><a href="#cb106-1118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bootstrap-Stichprobe</span></span>
<span id="cb106-1119"><a href="#cb106-1119" aria-hidden="true" tabindex="-1"></a>  boot_data <span class="ot">&lt;-</span> data[i, ]</span>
<span id="cb106-1120"><a href="#cb106-1120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1121"><a href="#cb106-1121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1:1 PS Matching</span></span>
<span id="cb106-1122"><a href="#cb106-1122" aria-hidden="true" tabindex="-1"></a>  match_res <span class="ot">&lt;-</span> <span class="fu">matchit</span>(</span>
<span id="cb106-1123"><a href="#cb106-1123" aria-hidden="true" tabindex="-1"></a>    dark_mode <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male,</span>
<span id="cb106-1124"><a href="#cb106-1124" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb106-1125"><a href="#cb106-1125" aria-hidden="true" tabindex="-1"></a>    <span class="at">distance =</span> <span class="st">"glm"</span>, </span>
<span id="cb106-1126"><a href="#cb106-1126" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"nearest"</span>, </span>
<span id="cb106-1127"><a href="#cb106-1127" aria-hidden="true" tabindex="-1"></a>    <span class="at">caliper =</span> .<span class="dv">25</span>,</span>
<span id="cb106-1128"><a href="#cb106-1128" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> boot_data</span>
<span id="cb106-1129"><a href="#cb106-1129" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb106-1130"><a href="#cb106-1130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1131"><a href="#cb106-1131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gematchten Datensatz zuweisen</span></span>
<span id="cb106-1132"><a href="#cb106-1132" aria-hidden="true" tabindex="-1"></a>  darkmode_matched <span class="ot">&lt;-</span> <span class="fu">match.data</span>(</span>
<span id="cb106-1133"><a href="#cb106-1133" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> match_res, </span>
<span id="cb106-1134"><a href="#cb106-1134" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> boot_data</span>
<span id="cb106-1135"><a href="#cb106-1135" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1136"><a href="#cb106-1136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1137"><a href="#cb106-1137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Outcome-Modell schätzen</span></span>
<span id="cb106-1138"><a href="#cb106-1138" aria-hidden="true" tabindex="-1"></a>  ATT_mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb106-1139"><a href="#cb106-1139" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> read_time <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> hours <span class="sc">+</span> dark_mode,</span>
<span id="cb106-1140"><a href="#cb106-1140" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> darkmode_matched, </span>
<span id="cb106-1141"><a href="#cb106-1141" aria-hidden="true" tabindex="-1"></a>    <span class="at">weights =</span> weights </span>
<span id="cb106-1142"><a href="#cb106-1142" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1143"><a href="#cb106-1143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1144"><a href="#cb106-1144" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  ATT-Schätzung zurückgeben</span></span>
<span id="cb106-1145"><a href="#cb106-1145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb106-1146"><a href="#cb106-1146" aria-hidden="true" tabindex="-1"></a>    ATT_mod<span class="sc">$</span>coefficients[<span class="st">"dark_mode"</span>]  </span>
<span id="cb106-1147"><a href="#cb106-1147" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1148"><a href="#cb106-1148" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1149"><a href="#cb106-1149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1150"><a href="#cb106-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1151"><a href="#cb106-1151" aria-hidden="true" tabindex="-1"></a>Wir berechnen nun eine Bootstrap-Schätzung des ATT von <span class="in">`dark_mode`</span> auf <span class="in">`readingtime`</span> nach Propensity Score Matching mit einem caliper von 0.25 sowie den zugehörigen Standardfehler und ein 95%-KI mit der zuvor definierten Funktion <span class="in">`boot_fun`</span>.</span>
<span id="cb106-1152"><a href="#cb106-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1153"><a href="#cb106-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, cache = F}</span></span>
<span id="cb106-1154"><a href="#cb106-1154" aria-hidden="true" tabindex="-1"></a><span class="in">library("boot")</span></span>
<span id="cb106-1155"><a href="#cb106-1155" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(4321)</span></span>
<span id="cb106-1156"><a href="#cb106-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1157"><a href="#cb106-1157" aria-hidden="true" tabindex="-1"></a><span class="in"># Anz. Bootstrap-Replikationen</span></span>
<span id="cb106-1158"><a href="#cb106-1158" aria-hidden="true" tabindex="-1"></a><span class="in">B &lt;- 999</span></span>
<span id="cb106-1159"><a href="#cb106-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1160"><a href="#cb106-1160" aria-hidden="true" tabindex="-1"></a><span class="in"># Bootstrap durchführen</span></span>
<span id="cb106-1161"><a href="#cb106-1161" aria-hidden="true" tabindex="-1"></a><span class="in">(</span></span>
<span id="cb106-1162"><a href="#cb106-1162" aria-hidden="true" tabindex="-1"></a><span class="in">  boot_out &lt;- boot(darkmode, boot_fun, R = B)</span></span>
<span id="cb106-1163"><a href="#cb106-1163" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb106-1164"><a href="#cb106-1164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1165"><a href="#cb106-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1166"><a href="#cb106-1166" aria-hidden="true" tabindex="-1"></a>Den Bootstrap-Schätzer des ATT sowie den Bootstrap-Standardfehler berechnen wir mit <span class="in">`mean()`</span> und <span class="in">`sd()`</span> anhand der <span class="in">`r B`</span> Bootstrap-Replikationen in <span class="in">`boot_out$t`</span>.</span>
<span id="cb106-1167"><a href="#cb106-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1168"><a href="#cb106-1168" aria-hidden="true" tabindex="-1"></a>Beachte, dass der Bootstrap-Schätzer des Behandlungseffekts nicht unmittelbar von <span class="in">`boot()`</span> ausgegeben wird. <span class="in">`original`</span> ist die Schätzung anhand der gesamten Stichprobe (d.h. ohne Bootstrap) und <span class="in">`bias`</span> ist die Differenz zwischen dieser Schätzung und dem Mittelwert der Bootstrap-Schätzungen.</span>
<span id="cb106-1169"><a href="#cb106-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1172"><a href="#cb106-1172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1173"><a href="#cb106-1173" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Schätzer für den Treatment-Effekt</span></span>
<span id="cb106-1174"><a href="#cb106-1174" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(boot_out<span class="sc">$</span>t) </span>
<span id="cb106-1175"><a href="#cb106-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1176"><a href="#cb106-1176" aria-hidden="true" tabindex="-1"></a><span class="co"># bootstrap - original = bias</span></span>
<span id="cb106-1177"><a href="#cb106-1177" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(boot_out<span class="sc">$</span>t) <span class="sc">-</span> boot_out<span class="sc">$</span>t0</span>
<span id="cb106-1178"><a href="#cb106-1178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1179"><a href="#cb106-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1180"><a href="#cb106-1180" aria-hidden="true" tabindex="-1"></a>Wir können prüfen, dass die Berechnung des Standardfehlers dem Stichprobenstandardabweichung der Bootstrap-Schätzungen entspricht.</span>
<span id="cb106-1181"><a href="#cb106-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1184"><a href="#cb106-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1185"><a href="#cb106-1185" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Standardfehler</span></span>
<span id="cb106-1186"><a href="#cb106-1186" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(boot_out<span class="sc">$</span>t)</span>
<span id="cb106-1187"><a href="#cb106-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1188"><a href="#cb106-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1189"><a href="#cb106-1189" aria-hidden="true" tabindex="-1"></a>Ein 95\%-Konfidenzintervall für den kausalen Effekt erhalten wir mit <span class="in">`boot::boot.ci()`</span>.^<span class="co">[</span><span class="ot">`type = "bca"` (bias-corrected accelerated) ist eine gängige Implementierung für die Berechnung des Konfidenz-Intervalls.</span><span class="co">]</span></span>
<span id="cb106-1190"><a href="#cb106-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1193"><a href="#cb106-1193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1194"><a href="#cb106-1194" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% Bootstrap-KI für den Treatment-Effekt</span></span>
<span id="cb106-1195"><a href="#cb106-1195" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(</span>
<span id="cb106-1196"><a href="#cb106-1196" aria-hidden="true" tabindex="-1"></a>  <span class="at">boot.out =</span> boot_out, </span>
<span id="cb106-1197"><a href="#cb106-1197" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"bca"</span>, </span>
<span id="cb106-1198"><a href="#cb106-1198" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf =</span> .<span class="dv">95</span></span>
<span id="cb106-1199"><a href="#cb106-1199" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1200"><a href="#cb106-1200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1201"><a href="#cb106-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1202"><a href="#cb106-1202" aria-hidden="true" tabindex="-1"></a>Beachte, dass der Bootstrap-Standardfehler sowie das Bootstrap-Konfidenzintervall nahe der mit <span class="in">`avg_comarisons`</span> berechneten Werte für <span class="in">`sum_PSC`</span> sind.</span>
<span id="cb106-1203"><a href="#cb106-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1204"><a href="#cb106-1204" aria-hidden="true" tabindex="-1"></a>**Bootstrap-Standardfehler für IPW-Schätzer des ATE berechnen**</span>
<span id="cb106-1205"><a href="#cb106-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1206"><a href="#cb106-1206" aria-hidden="true" tabindex="-1"></a>Die Bootstrap-Funktion <span class="in">`boot_fun`</span> kann leicht für eine Schätzung des Standardfehlers für den IPW-Schätzer des ATE aus @sec-PSM angepasst werden. Statt einer Matching-Prozedur berechnen wir hierzu für $B$ Bootstrap-Stichproben den Schätzer $\widehat{\tau}^\text{IPW}$ mit Trimming der Propensity Scores.</span>
<span id="cb106-1207"><a href="#cb106-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1210"><a href="#cb106-1210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1211"><a href="#cb106-1211" aria-hidden="true" tabindex="-1"></a><span class="co"># IPW estimation with regression adjustment</span></span>
<span id="cb106-1212"><a href="#cb106-1212" aria-hidden="true" tabindex="-1"></a>IPW_boot <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb106-1213"><a href="#cb106-1213" aria-hidden="true" tabindex="-1"></a>    data, </span>
<span id="cb106-1214"><a href="#cb106-1214" aria-hidden="true" tabindex="-1"></a>    i</span>
<span id="cb106-1215"><a href="#cb106-1215" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb106-1216"><a href="#cb106-1216" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1217"><a href="#cb106-1217" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bootstrap-Stichprobe erstellen</span></span>
<span id="cb106-1218"><a href="#cb106-1218" aria-hidden="true" tabindex="-1"></a>  data_boot  <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb106-1219"><a href="#cb106-1219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(i)</span>
<span id="cb106-1220"><a href="#cb106-1220" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1221"><a href="#cb106-1221" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Logistischee Regression</span></span>
<span id="cb106-1222"><a href="#cb106-1222" aria-hidden="true" tabindex="-1"></a>  glm_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb106-1223"><a href="#cb106-1223" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male,</span>
<span id="cb106-1224"><a href="#cb106-1224" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_boot, </span>
<span id="cb106-1225"><a href="#cb106-1225" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial</span>
<span id="cb106-1226"><a href="#cb106-1226" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1227"><a href="#cb106-1227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1228"><a href="#cb106-1228" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Propensity Scores berechnen</span></span>
<span id="cb106-1229"><a href="#cb106-1229" aria-hidden="true" tabindex="-1"></a>  data_boot <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb106-1230"><a href="#cb106-1230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb106-1231"><a href="#cb106-1231" aria-hidden="true" tabindex="-1"></a>      <span class="at">ps =</span> <span class="fu">predict</span>(glm_fit, <span class="at">type =</span> <span class="st">'response'</span>)</span>
<span id="cb106-1232"><a href="#cb106-1232" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1233"><a href="#cb106-1233" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1234"><a href="#cb106-1234" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Beobachtungen anhand Propensity Scores trimmen</span></span>
<span id="cb106-1235"><a href="#cb106-1235" aria-hidden="true" tabindex="-1"></a>  data_boot <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb106-1236"><a href="#cb106-1236" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb106-1237"><a href="#cb106-1237" aria-hidden="true" tabindex="-1"></a>      <span class="fu">between</span>(</span>
<span id="cb106-1238"><a href="#cb106-1238" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> ps,</span>
<span id="cb106-1239"><a href="#cb106-1239" aria-hidden="true" tabindex="-1"></a>        <span class="at">left =</span> .<span class="dv">2</span>,</span>
<span id="cb106-1240"><a href="#cb106-1240" aria-hidden="true" tabindex="-1"></a>        <span class="at">right =</span> .<span class="dv">7</span></span>
<span id="cb106-1241"><a href="#cb106-1241" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-1242"><a href="#cb106-1242" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1243"><a href="#cb106-1243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1244"><a href="#cb106-1244" aria-hidden="true" tabindex="-1"></a>  <span class="co"># IPW berechnen</span></span>
<span id="cb106-1245"><a href="#cb106-1245" aria-hidden="true" tabindex="-1"></a>  data_boot <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb106-1246"><a href="#cb106-1246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb106-1247"><a href="#cb106-1247" aria-hidden="true" tabindex="-1"></a>      <span class="at">ipw =</span> <span class="fu">case_when</span>(</span>
<span id="cb106-1248"><a href="#cb106-1248" aria-hidden="true" tabindex="-1"></a>        dark_mode <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> ps,</span>
<span id="cb106-1249"><a href="#cb106-1249" aria-hidden="true" tabindex="-1"></a>        dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb106-1250"><a href="#cb106-1250" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1251"><a href="#cb106-1251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1252"><a href="#cb106-1252" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gewichtete Mittelwerte der Gruppen   </span></span>
<span id="cb106-1253"><a href="#cb106-1253" aria-hidden="true" tabindex="-1"></a>  w_means <span class="ot">&lt;-</span> data_boot <span class="sc">%&gt;%</span></span>
<span id="cb106-1254"><a href="#cb106-1254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(dark_mode) <span class="sc">%&gt;%</span></span>
<span id="cb106-1255"><a href="#cb106-1255" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">m =</span> <span class="fu">weighted.mean</span>(read_time, <span class="at">w =</span> ipw)) <span class="sc">%&gt;%</span></span>
<span id="cb106-1256"><a href="#cb106-1256" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(dark_mode)</span>
<span id="cb106-1257"><a href="#cb106-1257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1258"><a href="#cb106-1258" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ATT-Schätzwert</span></span>
<span id="cb106-1259"><a href="#cb106-1259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(w_means<span class="sc">$</span>m[<span class="dv">2</span>] <span class="sc">-</span> w_means<span class="sc">$</span>m[<span class="dv">1</span>])</span>
<span id="cb106-1260"><a href="#cb106-1260" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1261"><a href="#cb106-1261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1262"><a href="#cb106-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1265"><a href="#cb106-1265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1266"><a href="#cb106-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb106-1267"><a href="#cb106-1267" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap für IPW durchführen</span></span>
<span id="cb106-1268"><a href="#cb106-1268" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-1269"><a href="#cb106-1269" aria-hidden="true" tabindex="-1"></a>  b_IPW <span class="ot">&lt;-</span> <span class="fu">boot</span>(</span>
<span id="cb106-1270"><a href="#cb106-1270" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> darkmode,</span>
<span id="cb106-1271"><a href="#cb106-1271" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> IPW_boot, </span>
<span id="cb106-1272"><a href="#cb106-1272" aria-hidden="true" tabindex="-1"></a>    <span class="at">R =</span> <span class="dv">999</span></span>
<span id="cb106-1273"><a href="#cb106-1273" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1274"><a href="#cb106-1274" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1275"><a href="#cb106-1275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1276"><a href="#cb106-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1279"><a href="#cb106-1279" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1280"><a href="#cb106-1280" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Schätzer und Standardfehler berechnen</span></span>
<span id="cb106-1281"><a href="#cb106-1281" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(b_IPW<span class="sc">$</span>t)</span>
<span id="cb106-1282"><a href="#cb106-1282" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(b_IPW<span class="sc">$</span>t)</span>
<span id="cb106-1283"><a href="#cb106-1283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1284"><a href="#cb106-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1285"><a href="#cb106-1285" aria-hidden="true" tabindex="-1"></a>In diesem Fall ist der Bootstrap-Standardfehler von ca. <span class="in">`r round(sd(b_IPW$t), 2)`</span> gut mit dem anhand von <span class="in">`summary(model_ipw)`</span> berechneten Standardfehler vergleichbar. Ein 95\%-Konfidenzintervall für den ATE erhalten wir wie zuvor mit <span class="in">`boot.ci()`</span>.</span>
<span id="cb106-1286"><a href="#cb106-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1289"><a href="#cb106-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1290"><a href="#cb106-1290" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% Bootstrap-KI für den ATE</span></span>
<span id="cb106-1291"><a href="#cb106-1291" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(b_IPW, <span class="at">type =</span> <span class="st">"bca"</span>)</span>
<span id="cb106-1292"><a href="#cb106-1292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1293"><a href="#cb106-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1294"><a href="#cb106-1294" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regression, Matching und Doubly-Robust-Schätzung</span></span>
<span id="cb106-1295"><a href="#cb106-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1296"><a href="#cb106-1296" aria-hidden="true" tabindex="-1"></a>Als *Doubly-Robust-Schätzer* bezeichnet man Methoden, die bei Fehlspezifikationen im Matching-Verfahrens *oder* der funktionalen Form der Regressionsfunktion für die Outcome-Variable eine zuverlässige Schätzungen des kausalen Effekts ermöglichen.^<span class="co">[</span><span class="ot">Bspw. kann eine falsche funktionale Form bei logistischer Regression eine verzerrte Schätzung von Propensity Scores und damit eine unzureichende Balance bedeuten.</span><span class="co">]</span> Unter der Vorraussetzung, dass die verwendeten Matching-Variablen sämliche Backdoors schließen, ist so mit Doubly-Robust-Schätzung eine konsistente Schätzung des Behandlungseffekts unter abgeschwächten Annahmen gewähtleistet. Dies macht Doubly-Robust-Schätzer besonders nützlich in Forschungskontexten, in denen präzise Modellspezifikationen herausfordernd sind.</span>
<span id="cb106-1297"><a href="#cb106-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1298"><a href="#cb106-1298" aria-hidden="true" tabindex="-1"></a>Der von @Wooldrige2010 vorgeschlagene Doubly-Robust-Schätzer (IPWRA) für den ATE erreicht seine vorteilhaften Eigenschaften durch eine geschickte Kombination von IPW und Regression Adjustment.</span>
<span id="cb106-1299"><a href="#cb106-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1300"><a href="#cb106-1300" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip title="**Algorithmus: IPWRA-Schätzer des ATE**" icon=false}</span>
<span id="cb106-1301"><a href="#cb106-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1302"><a href="#cb106-1302" aria-hidden="true" tabindex="-1"></a>Vgl. @Wooldrige2010.</span>
<span id="cb106-1303"><a href="#cb106-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1304"><a href="#cb106-1304" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Berechne IPW anhand von Propensity Score mit logistischer Regression unter Verwendung der Matching-Variablen.</span>
<span id="cb106-1305"><a href="#cb106-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1306"><a href="#cb106-1306" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Regression Adjustment:</span>
<span id="cb106-1307"><a href="#cb106-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1308"><a href="#cb106-1308" aria-hidden="true" tabindex="-1"></a>    (a) Schätze lediglich für die *Behandlungsgruppe* eine mit den IPW gewichtete Regressionspezifikation der Outcome-Variable mit Kontrolle für die Matching-Variablen.</span>
<span id="cb106-1309"><a href="#cb106-1309" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1310"><a href="#cb106-1310" aria-hidden="true" tabindex="-1"></a>    (b) Wiederhole Schritt A für *Kontrollgruppe*.</span>
<span id="cb106-1311"><a href="#cb106-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1312"><a href="#cb106-1312" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Berechne Vorhersagen der Outcome-Variable für die angepassten Modelle aus 2 (a) und 2 (b) anhand des *gesamten* Datensatzes.</span>
<span id="cb106-1313"><a href="#cb106-1313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1314"><a href="#cb106-1314" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Schätze den ATE als Mittelwert-Differenz der Vorhersagen aus Schritt 3.</span>
<span id="cb106-1315"><a href="#cb106-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1316"><a href="#cb106-1316" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb106-1317"><a href="#cb106-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1318"><a href="#cb106-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1319"><a href="#cb106-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1320"><a href="#cb106-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1321"><a href="#cb106-1321" aria-hidden="true" tabindex="-1"></a>Wir implementieren den Doubly-Robust-Schätzer des ATE von @Wooldrige2010 für das Website-Beispiel in der Funktion <span class="in">`IPWRA()`</span> under Adaption des Schemas von <span class="in">`IPW_boot()`</span>.</span>
<span id="cb106-1322"><a href="#cb106-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1325"><a href="#cb106-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1326"><a href="#cb106-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># IPW estimation with regression adjustment</span></span>
<span id="cb106-1327"><a href="#cb106-1327" aria-hidden="true" tabindex="-1"></a>IPWRA <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb106-1328"><a href="#cb106-1328" aria-hidden="true" tabindex="-1"></a>    data, </span>
<span id="cb106-1329"><a href="#cb106-1329" aria-hidden="true" tabindex="-1"></a>    <span class="at">i =</span> i) {</span>
<span id="cb106-1330"><a href="#cb106-1330" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-1331"><a href="#cb106-1331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap-Stichprobe zuweisen</span></span>
<span id="cb106-1332"><a href="#cb106-1332" aria-hidden="true" tabindex="-1"></a>    b_data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb106-1333"><a href="#cb106-1333" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice</span>(i)</span>
<span id="cb106-1334"><a href="#cb106-1334" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-1335"><a href="#cb106-1335" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Logistische Regression</span></span>
<span id="cb106-1336"><a href="#cb106-1336" aria-hidden="true" tabindex="-1"></a>    glm_fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb106-1337"><a href="#cb106-1337" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> dark_mode <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male,</span>
<span id="cb106-1338"><a href="#cb106-1338" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> b_data, </span>
<span id="cb106-1339"><a href="#cb106-1339" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">'logit'</span>)</span>
<span id="cb106-1340"><a href="#cb106-1340" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1341"><a href="#cb106-1341" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-1342"><a href="#cb106-1342" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propensity Scores berechnen</span></span>
<span id="cb106-1343"><a href="#cb106-1343" aria-hidden="true" tabindex="-1"></a>    b_data <span class="ot">&lt;-</span> b_data <span class="sc">%&gt;%</span></span>
<span id="cb106-1344"><a href="#cb106-1344" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">ps =</span> <span class="fu">predict</span>(glm_fit, <span class="at">type =</span> <span class="st">'response'</span>))</span>
<span id="cb106-1345"><a href="#cb106-1345" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-1346"><a href="#cb106-1346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Propensity Scores trimmen</span></span>
<span id="cb106-1347"><a href="#cb106-1347" aria-hidden="true" tabindex="-1"></a>    b_data <span class="ot">&lt;-</span> b_data <span class="sc">%&gt;%</span></span>
<span id="cb106-1348"><a href="#cb106-1348" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb106-1349"><a href="#cb106-1349" aria-hidden="true" tabindex="-1"></a>        <span class="fu">between</span>(</span>
<span id="cb106-1350"><a href="#cb106-1350" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> ps,</span>
<span id="cb106-1351"><a href="#cb106-1351" aria-hidden="true" tabindex="-1"></a>          <span class="at">left =</span> .<span class="dv">2</span>,</span>
<span id="cb106-1352"><a href="#cb106-1352" aria-hidden="true" tabindex="-1"></a>          <span class="at">right =</span> .<span class="dv">7</span></span>
<span id="cb106-1353"><a href="#cb106-1353" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb106-1354"><a href="#cb106-1354" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-1355"><a href="#cb106-1355" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-1356"><a href="#cb106-1356" aria-hidden="true" tabindex="-1"></a>    <span class="co"># IPW berechnen</span></span>
<span id="cb106-1357"><a href="#cb106-1357" aria-hidden="true" tabindex="-1"></a>    b_data <span class="ot">&lt;-</span> b_data <span class="sc">%&gt;%</span></span>
<span id="cb106-1358"><a href="#cb106-1358" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb106-1359"><a href="#cb106-1359" aria-hidden="true" tabindex="-1"></a>        <span class="at">IPW =</span> <span class="fu">case_when</span>(</span>
<span id="cb106-1360"><a href="#cb106-1360" aria-hidden="true" tabindex="-1"></a>          dark_mode <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> ps,</span>
<span id="cb106-1361"><a href="#cb106-1361" aria-hidden="true" tabindex="-1"></a>          dark_mode <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> ps))</span>
<span id="cb106-1362"><a href="#cb106-1362" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb106-1363"><a href="#cb106-1363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-1364"><a href="#cb106-1364" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Regression Adjustment:</span></span>
<span id="cb106-1365"><a href="#cb106-1365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-1366"><a href="#cb106-1366" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Schätzung des Behandlungseffekts für die ges. Stichprobe</span></span>
<span id="cb106-1367"><a href="#cb106-1367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mit Modell für Behandlungsgruppe</span></span>
<span id="cb106-1368"><a href="#cb106-1368" aria-hidden="true" tabindex="-1"></a>    mtreat <span class="ot">&lt;-</span> b_data <span class="sc">%&gt;%</span></span>
<span id="cb106-1369"><a href="#cb106-1369" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-1370"><a href="#cb106-1370" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lm</span>(read_time <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male, <span class="at">data =</span> ., <span class="at">weights =</span> .<span class="sc">$</span>IPW) <span class="sc">%&gt;%</span></span>
<span id="cb106-1371"><a href="#cb106-1371" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(<span class="at">newdata =</span> b_data) <span class="sc">%&gt;%</span></span>
<span id="cb106-1372"><a href="#cb106-1372" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>()</span>
<span id="cb106-1373"><a href="#cb106-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1374"><a href="#cb106-1374" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Schätzung des Behandlungseffekts für die ges. Stichprobe</span></span>
<span id="cb106-1375"><a href="#cb106-1375" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mit Modell für Kontrollgruppe   </span></span>
<span id="cb106-1376"><a href="#cb106-1376" aria-hidden="true" tabindex="-1"></a>    mcont <span class="ot">&lt;-</span> b_data <span class="sc">%&gt;%</span></span>
<span id="cb106-1377"><a href="#cb106-1377" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(dark_mode <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-1378"><a href="#cb106-1378" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lm</span>(read_time <span class="sc">~</span> age <span class="sc">+</span> hours <span class="sc">+</span> male, <span class="at">data =</span> ., <span class="at">weights =</span> .<span class="sc">$</span>ipw) <span class="sc">%&gt;%</span></span>
<span id="cb106-1379"><a href="#cb106-1379" aria-hidden="true" tabindex="-1"></a>      <span class="fu">predict</span>(<span class="at">newdata =</span> b_data) <span class="sc">%&gt;%</span></span>
<span id="cb106-1380"><a href="#cb106-1380" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>()</span>
<span id="cb106-1381"><a href="#cb106-1381" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb106-1382"><a href="#cb106-1382" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Regression adjusted ATE-Schätzer</span></span>
<span id="cb106-1383"><a href="#cb106-1383" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(mtreat <span class="sc">-</span> mcont)</span>
<span id="cb106-1384"><a href="#cb106-1384" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-1385"><a href="#cb106-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1386"><a href="#cb106-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1387"><a href="#cb106-1387" aria-hidden="true" tabindex="-1"></a>Schätzung des ATE mit <span class="in">`IPWRA()`</span>:</span>
<span id="cb106-1388"><a href="#cb106-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1391"><a href="#cb106-1391" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1392"><a href="#cb106-1392" aria-hidden="true" tabindex="-1"></a><span class="fu">IPWRA</span>(<span class="at">data =</span> darkmode, <span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(darkmode))</span>
<span id="cb106-1393"><a href="#cb106-1393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1394"><a href="#cb106-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1395"><a href="#cb106-1395" aria-hidden="true" tabindex="-1"></a>Wie bei $\widehat{\tau}^\text{IPW}$ gibt es keine formale Darstellung des Standardfehlers für den IPWRA-Schätzer, sodass auch hier der Bootstrap genutzt werden sollte.</span>
<span id="cb106-1396"><a href="#cb106-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1399"><a href="#cb106-1399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1400"><a href="#cb106-1400" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb106-1401"><a href="#cb106-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1402"><a href="#cb106-1402" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootrstrap für IPWRA durchführen</span></span>
<span id="cb106-1403"><a href="#cb106-1403" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb106-1404"><a href="#cb106-1404" aria-hidden="true" tabindex="-1"></a>  b_IPWRA <span class="ot">&lt;-</span> <span class="fu">boot</span>(</span>
<span id="cb106-1405"><a href="#cb106-1405" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> darkmode,</span>
<span id="cb106-1406"><a href="#cb106-1406" aria-hidden="true" tabindex="-1"></a>  <span class="at">statistic =</span> IPWRA,</span>
<span id="cb106-1407"><a href="#cb106-1407" aria-hidden="true" tabindex="-1"></a>  <span class="at">R =</span> B</span>
<span id="cb106-1408"><a href="#cb106-1408" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb106-1409"><a href="#cb106-1409" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-1410"><a href="#cb106-1410" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1411"><a href="#cb106-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1412"><a href="#cb106-1412" aria-hidden="true" tabindex="-1"></a>Wir berechnen die interessierenden Statistiken analog zu der Vorgehensweise in @sec-bootmatching.</span>
<span id="cb106-1413"><a href="#cb106-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1416"><a href="#cb106-1416" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1417"><a href="#cb106-1417" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-IPWRA-Schätzer des ATE</span></span>
<span id="cb106-1418"><a href="#cb106-1418" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(b_IPWRA<span class="sc">$</span>t)</span>
<span id="cb106-1419"><a href="#cb106-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1420"><a href="#cb106-1420" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap-Standardfehler</span></span>
<span id="cb106-1421"><a href="#cb106-1421" aria-hidden="true" tabindex="-1"></a><span class="fu">sd</span>(b_IPWRA<span class="sc">$</span>t)</span>
<span id="cb106-1422"><a href="#cb106-1422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1423"><a href="#cb106-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1426"><a href="#cb106-1426" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1427"><a href="#cb106-1427" aria-hidden="true" tabindex="-1"></a><span class="co"># 95%-Bootstrap-KI für den ATE</span></span>
<span id="cb106-1428"><a href="#cb106-1428" aria-hidden="true" tabindex="-1"></a><span class="fu">boot.ci</span>(b_IPWRA, <span class="at">type =</span> <span class="st">"bca"</span>)</span>
<span id="cb106-1429"><a href="#cb106-1429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1430"><a href="#cb106-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1431"><a href="#cb106-1431" aria-hidden="true" tabindex="-1"></a>Die Bootstrap-Schätzung des ATE mit IPWRA ist mit den Ergebnissen für die Bootstrap-Variante von $\widehat{\tau}^\text{IPW}$ vergleichbar, hat allerdings einen etwas kleineren Standardfehler und ist somit genauer.</span>
</code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<script type="module">
// Handle cell initialization initialization
qwebrCellDetails.map(
  (entry) => {
    // Handle the creation of the element
    qwebrCreateHTMLElement(entry);
    // In the event of interactive, initialize the monaco editor
    if (entry.options.context == EvalTypes.Interactive) {
      qwebrCreateMonacoEditorInstance(entry);
    }
  }
);

// Identify non-interactive cells (in order)
const filteredEntries = qwebrCellDetails.filter(entry => {
  const contextOption = entry.options && entry.options.context;
  return ['output', 'setup'].includes(contextOption) || (contextOption == "interactive" && entry.options && entry.options.autorun === 'true');
});

// Condition non-interactive cells to only be run after webR finishes its initialization.
qwebrInstance.then(
  async () => {
    const nHiddenCells = filteredEntries.length;
    var currentHiddenCell = 0;


    // Modify button state
    qwebrSetInteractiveButtonState(`🟡 Running hidden code cells ...`, false);

    // Begin processing non-interactive sections
    // Due to the iteration policy, we must use a for() loop.
    // Otherwise, we would need to switch to using reduce with an empty
    // starting promise
    for (const entry of filteredEntries) {

      // Determine cell being examined
      currentHiddenCell = currentHiddenCell + 1;
      const formattedMessage = `Evaluating hidden cell ${currentHiddenCell} out of ${nHiddenCells}`;

      // Update the document status header
      if (qwebrShowStartupMessage) {
        qwebrUpdateStatusHeader(formattedMessage);
      }

      // Display the update in non-active areas
      qwebrUpdateStatusMessage(formattedMessage);

      // Extract details on the active cell
      const evalType = entry.options.context;
      const cellCode = entry.code;
      const qwebrCounter = entry.id;

      if (['output', 'setup'].includes(evalType)) {
        // Disable further global status updates
        const activeContainer = document.getElementById(`qwebr-non-interactive-loading-container-${qwebrCounter}`);
        activeContainer.classList.remove('qwebr-cell-needs-evaluation');
        activeContainer.classList.add('qwebr-cell-evaluated');

        // Update status on the code cell
        const activeStatus = document.getElementById(`qwebr-status-text-${qwebrCounter}`);
        activeStatus.innerText = " Evaluating hidden code cell...";
        activeStatus.classList.remove('qwebr-cell-needs-evaluation');
        activeStatus.classList.add('qwebr-cell-evaluated');
      }

      switch (evalType) {
        case 'interactive':
          // TODO: Make this more standardized.
          // At the moment, we're overriding the interactive status update by pretending its
          // output-like. 
          const tempOptions = entry.options;
          tempOptions["context"] = "output"
          // Run the code in a non-interactive state that is geared to displaying output
          await qwebrExecuteCode(`${cellCode}`, qwebrCounter, tempOptions);
          break;
        case 'output':
          // Run the code in a non-interactive state that is geared to displaying output
          await qwebrExecuteCode(`${cellCode}`, qwebrCounter, entry.options);
          break;
        case 'setup':
          const activeDiv = document.getElementById(`qwebr-noninteractive-setup-area-${qwebrCounter}`);
          // Run the code in a non-interactive state with all output thrown away
          await mainWebR.evalRVoid(`${cellCode}`);
          break;
        default: 
          break; 
      }

      if (['output', 'setup'].includes(evalType)) {
        // Disable further global status updates
        const activeContainer = document.getElementById(`qwebr-non-interactive-loading-container-${qwebrCounter}`);
        // Disable visibility
        activeContainer.style.visibility = 'hidden';
        activeContainer.style.display = 'none';
      }
    }
  }
).then(
  () => {
    // Release document status as ready

    if (qwebrShowStartupMessage) {
      qwebrStartupMessage.innerText = "🟢 Ready!"
    }
  
    qwebrSetInteractiveButtonState(
      `<i class="fa-solid fa-play qwebr-icon-run-code"></i> <span>Run Code</span>`, 
      true
    );  
  }
);
</script>


</body></html>